[{"id":"2683001c.e8587","type":"tab","label":"Flow 1"},{"id":"cf9f81ac.496e1","type":"tab","label":"DEV"},{"id":"ff01d09f.6d81a","type":"tab","label":"PROD Rahnu"},{"id":"1001a228.b10a4e","type":"tab","label":"1C"},{"id":"30d3b88a.5d85c8","type":"MySQLdatabase","z":"","host":"10.107.12.19","port":"3306","db":"oik_thermo","tz":""},{"id":"1756cec1.daced1","type":"tls-config","z":"","name":"","cert":"","key":"","ca":"","verifyservercert":false},{"id":"94f0ca9.0c10038","type":"mysql","z":"2683001c.e8587","mydb":"30d3b88a.5d85c8","name":"","x":455,"y":175,"wires":[["e58853f8.da83a","c53eeef2.db58b","38c1d390.3542cc"]]},{"id":"cb7fc98.93b2438","type":"inject","z":"cf9f81ac.496e1","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":140,"y":120,"wires":[["4dc2506e.c1be2"]]},{"id":"b0bc17ed.e99d08","type":"comment","z":"cf9f81ac.496e1","name":"Інформація по підключенню","info":"10.98.254.16 - сервер термометрії\nНазва бази даних: OIK_DBA\nЛогін: root\nПароль: manager","x":160,"y":80,"wires":[]},{"id":"4dc2506e.c1be2","type":"function","z":"cf9f81ac.496e1","name":"SHOW TABLES","func":"msg.topic = 'SHOW TABLES'\nreturn msg;","outputs":1,"noerr":0,"x":320,"y":120,"wires":[["6e8f3fd2.fa9df"]]},{"id":"6e8f3fd2.fa9df","type":"debug","z":"cf9f81ac.496e1","name":"","active":true,"console":false,"complete":"false","x":790,"y":180,"wires":[]},{"id":"a11a0f05.0dc7f","type":"debug","z":"cf9f81ac.496e1","name":"","active":false,"console":false,"complete":"false","x":970,"y":280,"wires":[]},{"id":"ed693c46.0b6da","type":"function","z":"cf9f81ac.496e1","name":"","func":"msg.payload = {\n    GroupSensor: [\n        {\n            silos: '1234',\n            SerialNumber: '010101',\n            Name: 'П01',\n            GroupBob: [\n                {\n                    name: 'Sensor0001',\n                    name_R: 'Датчик01'\n                },\n                {\n                    name: 'Sensor0002',\n                    name_R: 'Датчик02'\n                },\n                {\n                    name: 'Sensor0003',\n                    name_R: 'Датчик03'\n                }\n                ]\n        },\n        {\n            silos: '1235',\n            SerialNumber: '010105',\n            Name: 'П05',\n            GroupBob: [\n                {\n                    name: 'Sensor0005',\n                    name_R: 'Датчик05'\n                },\n                {\n                    name: 'Sensor0006',\n                    name_R: 'Датчик06'\n                },\n                {\n                    name: 'Sensor0006',\n                    name_R: 'Датчик07'\n                }\n                ]\n        }]\n}\nreturn msg;","outputs":1,"noerr":0,"x":400,"y":660,"wires":[["6337f85f.26a238","340ab175.7459fe"]]},{"id":"6337f85f.26a238","type":"debug","z":"cf9f81ac.496e1","name":"","active":true,"console":false,"complete":"false","x":540,"y":600,"wires":[]},{"id":"340ab175.7459fe","type":"http response","z":"cf9f81ac.496e1","name":"","x":600,"y":660,"wires":[]},{"id":"8c5a05b7.427408","type":"function","z":"cf9f81ac.496e1","name":"SHOW LOG_RECNO = 584","func":"var Select = `\nSELECT * FROM TLMAX\nWHERE LOG_RECNO = 199\nORDER BY DATETIME DESC;`\n\n\n\nmsg.topic = Select;\n\nreturn msg;","outputs":1,"noerr":0,"x":360,"y":200,"wires":[[]]},{"id":"cb30f6a.bb1c308","type":"inject","z":"cf9f81ac.496e1","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":140,"y":200,"wires":[["8c5a05b7.427408","65e801ca.9caec"]]},{"id":"65e801ca.9caec","type":"template","z":"cf9f81ac.496e1","name":"","field":"topic","fieldType":"msg","format":"text","syntax":"mustache","template":"SELECT * FROM TLMAX\nWHERE LOG_RECNO = 584\nORDER BY DATETIME DESC;","x":300,"y":240,"wires":[[]]},{"id":"fb009324.bc51d","type":"comment","z":"cf9f81ac.496e1","name":"info ","info":"LOG_RECNO: 153\nDATETIME: \"2021-12-28T12:50:05.\n\nLOG_RECNO: 152\nDATETIME: \"2021-12-28T12:26:16.000Z\"\n\n\n","x":1410,"y":100,"wires":[]},{"id":"d543c497.80ee98","type":"function","z":"cf9f81ac.496e1","name":"","func":"var inputDate = msg.payload;\nvar id = msg.payload[0].LOG_RECNO;\nvar Zam_date = msg.payload[0].DATETIME\nvar sensorArray = [];\n\n\nfor(let i = 0; i < inputDate.length; i++){\n    sensorArray[i] = {\n        'name':inputDate[i].SILAGE_ID + '_' + inputDate[i].LEVEL,\n        'temp:': inputDate[i].USER_VALUE\n    }\n}\n\n\n\n\n\n\n\nmsg.payload = {\n    DTLINECREATE: Zam_date,\n    id: id,\n    sensor: sensorArray\n}\nreturn msg;","outputs":1,"noerr":0,"x":800,"y":280,"wires":[["a11a0f05.0dc7f"]]},{"id":"d6eaa1f1.7cd8","type":"debug","z":"cf9f81ac.496e1","name":"","active":true,"console":false,"complete":"false","x":1050,"y":220,"wires":[]},{"id":"8c1e291f.e27d08","type":"inject","z":"cf9f81ac.496e1","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":140,"y":320,"wires":[["9aa7a181.0b60c"]]},{"id":"9aa7a181.0b60c","type":"function","z":"cf9f81ac.496e1","name":"SHOW LAST ","func":"var Select = `\nSELECT * FROM TLMAX \nORDER BY LOG_RECNO DESC LIMIT 4320;`\n\n\n\nmsg.topic = Select;\n\nreturn msg;\n//","outputs":1,"noerr":0,"x":330,"y":320,"wires":[[]]},{"id":"9fa44712.9be598","type":"inject","z":"cf9f81ac.496e1","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":160,"y":820,"wires":[["9e98e137.97712"]]},{"id":"9e98e137.97712","type":"function","z":"cf9f81ac.496e1","name":"SENSORS","func":"var Select = `\nSELECT * FROM SENSORS;`\n\n\n\nmsg.topic = Select;\n\nreturn msg;\n//","outputs":1,"noerr":0,"x":350,"y":820,"wires":[[]]},{"id":"3938dc70.cfbcf4","type":"debug","z":"cf9f81ac.496e1","name":"","active":true,"console":false,"complete":"false","x":790,"y":900,"wires":[]},{"id":"f353eca9.f3b07","type":"inject","z":"cf9f81ac.496e1","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":160,"y":880,"wires":[["94a9e4bd.f0b8e8"]]},{"id":"94a9e4bd.f0b8e8","type":"function","z":"cf9f81ac.496e1","name":"LAVALIERS","func":"var Select = `\nSELECT * FROM LAVALIERS;`\n\n\n\nmsg.topic = Select;\n\nreturn msg;\n//","outputs":1,"noerr":0,"x":350,"y":880,"wires":[[]]},{"id":"ee6d8713.410c28","type":"inject","z":"cf9f81ac.496e1","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":160,"y":1000,"wires":[["4a8e9e61.4af28"]]},{"id":"4a8e9e61.4af28","type":"function","z":"cf9f81ac.496e1","name":"DEVICES","func":"var Select = `\nSELECT * FROM SILAGES;`\n\n\n\nmsg.topic = Select;\n\nreturn msg;\n//","outputs":1,"noerr":0,"x":340,"y":1000,"wires":[[]]},{"id":"f95620bb.71813","type":"http in","z":"cf9f81ac.496e1","name":"","url":"SILAGES_all","method":"get","swaggerDoc":"","x":150,"y":1060,"wires":[["4a8e9e61.4af28"]]},{"id":"99874a55.25d368","type":"inject","z":"cf9f81ac.496e1","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":120,"y":1140,"wires":[[]]},{"id":"cd6fdd5b.afa01","type":"debug","z":"cf9f81ac.496e1","name":"","active":true,"console":false,"complete":"false","x":730,"y":1120,"wires":[]},{"id":"6e5d3e75.fca93","type":"http in","z":"cf9f81ac.496e1","name":"","url":"/get/id_sensors","method":"get","swaggerDoc":"","x":130,"y":1240,"wires":[["3a36630a.986d9c"]]},{"id":"eaee3a93.ce2238","type":"http in","z":"cf9f81ac.496e1","name":"","url":"/get/getSensor2","method":"get","swaggerDoc":"","x":140,"y":280,"wires":[["8c5a05b7.427408"]]},{"id":"57506ba8.6f09d4","type":"http response","z":"cf9f81ac.496e1","name":"","x":890,"y":1280,"wires":[]},{"id":"a3b7183c.6e7868","type":"http in","z":"cf9f81ac.496e1","name":"","url":"/SENSORS2","method":"get","swaggerDoc":"","x":160,"y":1860,"wires":[["f08be008.e947b"]]},{"id":"f08be008.e947b","type":"function","z":"cf9f81ac.496e1","name":"SENSORS","func":"var Select = `\nSELECT * FROM SENSORS;`\n\n\n\nmsg.topic = Select;\n\nreturn msg;\n//","outputs":1,"noerr":0,"x":370,"y":1860,"wires":[[]]},{"id":"4da5763d.e5a9d8","type":"http response","z":"cf9f81ac.496e1","name":"","x":890,"y":1860,"wires":[]},{"id":"8b16046c.e683a8","type":"inject","z":"cf9f81ac.496e1","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":190,"y":1900,"wires":[["f08be008.e947b"]]},{"id":"257964ab.5de05c","type":"inject","z":"cf9f81ac.496e1","name":"","topic":"","repeat":"","crontab":"","once":false,"x":100,"y":1200,"wires":[["3a36630a.986d9c"]]},{"id":"3a36630a.986d9c","type":"function","z":"cf9f81ac.496e1","name":"Query to DB","func":"var id = Number(msg.req.query.id)\n\n\nvar Select = `\nSELECT * FROM TLMAX\nWHERE LOG_RECNO = ${id}\nORDER BY DATETIME DESC`\n\n\n\nmsg.topic = Select;\n\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":1200,"wires":[[]]},{"id":"1161b81d.4bfe68","type":"function","z":"cf9f81ac.496e1","name":"","func":"var inputDate = msg.payload;\nvar id = msg.payload[0].LOG_RECNO;\nvar Zam_date = msg.payload[0].DATETIME\nvar sensorArray = [];\n\n\nfor(let i = 0; i < inputDate.length; i++){\n    sensorArray[i] = {\n        'name':inputDate[i].SILAGE_ID + '_' + inputDate[i].LEVEL,\n        'temp:': inputDate[i].USER_VALUE\n    }\n}\n\nsensorArray.splice(70,4192);\n\n\n\n\n\nmsg.payload = {\n    DTLINECREATE: Zam_date,\n    id: id,\n    sensors: sensorArray\n}\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":1200,"wires":[["b850b526.56a678"]]},{"id":"b850b526.56a678","type":"debug","z":"cf9f81ac.496e1","name":"","active":false,"console":false,"complete":"false","x":930,"y":1160,"wires":[]},{"id":"65562799.69a5f8","type":"debug","z":"cf9f81ac.496e1","name":"","active":true,"console":false,"complete":"false","x":750,"y":1820,"wires":[]},{"id":"ef803465.1e1048","type":"inject","z":"cf9f81ac.496e1","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":210,"y":1400,"wires":[[]]},{"id":"11e58d37.55d1a3","type":"function","z":"cf9f81ac.496e1","name":"","func":"var in_date = msg.payload;\nvar SILAGE_ID = []\nfor(let i = 0; i < in_date.length; i++){\n    SILAGE_ID.push(in_date[i].SILAGE_ID)\n}\n\n\nfunction unique(arr){\n    let result = []\n    \n    for(let str of arr){\n        if(!result.includes(str)){\n            result.push(str);\n        }\n    }\n    \n    return result;\n}\n\nfunction sortFunction(a,b){\n    return parseInt(a) - parseInt(b)\n}\n\n\n\nmsg.payload = unique(SILAGE_ID).sort(sortFunction);\n\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":1240,"wires":[["4cb1bd66.5c4444","57506ba8.6f09d4"]]},{"id":"4cb1bd66.5c4444","type":"debug","z":"cf9f81ac.496e1","name":"","active":true,"console":false,"complete":"false","x":910,"y":1240,"wires":[]},{"id":"ee687366.8a72a","type":"function","z":"cf9f81ac.496e1","name":"","func":"var in_date = msg.payload;\nvar SILAGE_ID = []\nfor(let i = 0; i < in_date.length; i++){\n    SILAGE_ID.push(in_date[i].TSB_ID)\n}\n\n\nfunction unique(arr){\n    let result = []\n    \n    for(let str of arr){\n        if(!result.includes(str)){\n            result.push(str);\n        }\n    }\n    \n    return result;\n}\n\nfunction sortFunction(a,b){\n    return parseInt(a) - parseInt(b)\n}\n\n\n\nmsg.payload = unique(SILAGE_ID).sort(sortFunction);\n\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":1860,"wires":[["4da5763d.e5a9d8"]]},{"id":"e8299295.f7f1f","type":"inject","z":"cf9f81ac.496e1","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":430,"y":1400,"wires":[[]]},{"id":"512c8aaf.89a3f4","type":"http in","z":"cf9f81ac.496e1","name":"","url":"LAVALIERS","method":"get","swaggerDoc":"","x":180,"y":1980,"wires":[["3c189b0a.ffa6a4"]]},{"id":"3c189b0a.ffa6a4","type":"function","z":"cf9f81ac.496e1","name":"LAVALIERS","func":"var Select = `\nSELECT * FROM LAVALIERS;`\n\n\n\nmsg.topic = Select;\n\nreturn msg;\n//","outputs":1,"noerr":0,"x":370,"y":1980,"wires":[[]]},{"id":"8bdf4fce.4af2a","type":"function","z":"cf9f81ac.496e1","name":"","func":"var in_date = msg.payload;\nvar SILAGE_ID = []\n\n\n\n\n\nfor(let i = 0; i < in_date.length; i++){\n    let jsonDate = {\n        ID:in_date[i].ID,\n        NO:in_date[i].NO,\n        SILAGE_ID:in_date[i].SILAGE_ID,\n    }\n    SILAGE_ID.push(jsonDate)\n}\n\n\nfunction unique(arr){\n    let result = []\n    \n    for(let str of arr){\n        if(!result.includes(str)){\n            result.push(str);\n        }\n    }\n    \n    return result;\n}\n\n\n\n\n\n\n\nmsg.payload = SILAGE_ID;\n\nreturn msg;","outputs":1,"noerr":0,"x":720,"y":2020,"wires":[["e98da1b8.df3bd"]]},{"id":"be369014.24079","type":"debug","z":"cf9f81ac.496e1","name":"","active":true,"console":false,"complete":"false","x":730,"y":1940,"wires":[]},{"id":"e98da1b8.df3bd","type":"http response","z":"cf9f81ac.496e1","name":"","x":850,"y":1980,"wires":[]},{"id":"2694c6e3.39248a","type":"inject","z":"cf9f81ac.496e1","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":180,"y":1680,"wires":[["312417fd.490a28"]]},{"id":"312417fd.490a28","type":"function","z":"cf9f81ac.496e1","name":"query DB","func":"var Select = `\nSELECT  \nLAVALIERS.ID, LAVALIERS.NO, LAVALIERS.SILAGE_ID, LAVALIERS.LevelCount, LAVALIERS.LevelOffs, LAVALIERS.LoadLevels, LAVALIERS.DeviceAddr,\nSENSORS.TSB_ID, SENSORS.LEVEL, SENSORS.ONLINE, SENSORS.USER_T\nFROM LAVALIERS, SENSORS\nWHERE LAVALIERS.ID = SENSORS.TSB_ID\nORDER BY SENSORS.TSB_ID ASC LIMIT 4192`\n\nmsg.topic = Select;\n\nreturn msg;\n//","outputs":1,"noerr":0,"x":360,"y":1680,"wires":[[]]},{"id":"8be0e139.1497","type":"debug","z":"cf9f81ac.496e1","name":"","active":true,"console":false,"complete":"false","x":730,"y":1680,"wires":[]},{"id":"8d35fa70.556dd8","type":"http in","z":"cf9f81ac.496e1","name":"","url":"/stryctyre","method":"get","swaggerDoc":"","x":150,"y":1720,"wires":[["312417fd.490a28"]]},{"id":"73840aeb.2ea1d4","type":"http response","z":"cf9f81ac.496e1","name":"","x":710,"y":1720,"wires":[]},{"id":"13be7ddb.0c25b2","type":"function","z":"cf9f81ac.496e1","name":"","func":"var inputDate = msg.payload;\nvar id = msg.payload[0].LOG_RECNO;\nvar Zam_date = msg.payload[0].DATETIME\nvar sensorArray = [];\n\n\nfor(let i = 0; i < inputDate.length; i++){\n    sensorArray.push({\n        SENSOR_STATE: inputDate[i].SENSOR_STATE,\n        SENSOR_ONLINE: inputDate[i].SENSOR_ONLINE,\n        USER_VALUE: inputDate[i].USER_VALUE,\n        dffdfdf: -8\n    })\n}\n\n\n\n\n\n\n\nmsg.payload = {\n    sensor: sensorArray\n}\nreturn msg;","outputs":1,"noerr":0,"x":800,"y":320,"wires":[["70b62221.a813ec"]]},{"id":"70b62221.a813ec","type":"debug","z":"cf9f81ac.496e1","name":"","active":false,"console":false,"complete":"false","x":970,"y":320,"wires":[]},{"id":"9aada5f3.b0e978","type":"http response","z":"cf9f81ac.496e1","name":"","x":1010,"y":180,"wires":[]},{"id":"a599569f.5faf68","type":"function","z":"cf9f81ac.496e1","name":"","func":"var inputDate = msg.payload;\nvar id = msg.payload[0].LOG_RECNO;\nvar Zam_date = msg.payload[0].DATETIME\nvar sensorArray = [];\nvar nullState = []\nvar obruv = []\n\n\nfor(let i = 0; i < inputDate.length; i++){\n    if(inputDate[i].SILAGE_ID >= 271){\n        let podves = {\n            [inputDate[i].SILAGE_ID]: inputDate[i]\n        }\n        sensorArray.push(podves)\n        \n        if(inputDate[i].SENSOR_STATE == 64){\n            let podves = {\n                [inputDate[i].SILAGE_ID]: inputDate[i]\n            }\n            obruv.push(podves)\n        }\n        \n        if(inputDate[i].SENSOR_STATE == null){\n            let podves = {\n                [inputDate[i].SILAGE_ID]: inputDate[i]\n            }\n            nullState.push(podves)\n        }\n        \n        \n        \n        \n    }\n    \n        \n        \n        \n        \n    \n    \n}\n\nmsg.payload = {\n    all: sensorArray,\n    obruv: obruv,\n    nullState: nullState\n    \n}\nreturn msg;","outputs":1,"noerr":0,"x":800,"y":360,"wires":[["299e5e2e.2bc782"]]},{"id":"299e5e2e.2bc782","type":"debug","z":"cf9f81ac.496e1","name":"","active":false,"console":false,"complete":"false","x":970,"y":360,"wires":[]},{"id":"b017d0f.0165e3","type":"inject","z":"cf9f81ac.496e1","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":120,"y":2180,"wires":[["a6b90708.a5b1b8"]]},{"id":"a6b90708.a5b1b8","type":"function","z":"cf9f81ac.496e1","name":"SHOW LAST ","func":"// var Select = `\n// SELECT * FROM TMAX \n// ORDER BY LOG_RECNO DESC LIMIT 286;`\n\nvar Select = `SELECT * FROM tlmax_d\nWHERE LOG_RECNO = 1\nORDER BY DATETIME DESC;`\n\nmsg.topic = Select;\n\nreturn msg;\n//","outputs":1,"noerr":0,"x":310,"y":2180,"wires":[[]]},{"id":"b22e363f.7a0758","type":"debug","z":"cf9f81ac.496e1","name":"TMAX ","active":true,"console":false,"complete":"payload","x":730,"y":2180,"wires":[]},{"id":"4dd8621.909d59c","type":"inject","z":"cf9f81ac.496e1","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":120,"y":2120,"wires":[["562f65c2.62eddc"]]},{"id":"562f65c2.62eddc","type":"function","z":"cf9f81ac.496e1","name":"SHOW LAST ","func":"var Select = `\nSELECT * FROM TLMAX \nORDER BY LOG_RECNO DESC LIMIT 4192;`\n\n\n\nmsg.topic = Select;\n\nreturn msg;\n//","outputs":1,"noerr":0,"x":310,"y":2120,"wires":[[]]},{"id":"1b47f694.4f3039","type":"debug","z":"cf9f81ac.496e1","name":"TLMAX ","active":true,"console":false,"complete":"payload","x":740,"y":2120,"wires":[]},{"id":"834a019c.c21ef","type":"http in","z":"cf9f81ac.496e1","name":"","url":"tmax","method":"get","swaggerDoc":"","x":140,"y":2220,"wires":[["a6b90708.a5b1b8"]]},{"id":"3b931.1c0076cfe","type":"http response","z":"cf9f81ac.496e1","name":"","x":730,"y":2220,"wires":[]},{"id":"b22afa63.13dbd8","type":"function","z":"cf9f81ac.496e1","name":"SHOW LOG_RECNO = 584","func":"var Select = `\nSELECT * FROM TLMAX\nWHERE LOG_RECNO = 584\nORDER BY DATETIME DESC;`\n\n\n\nmsg.topic = Select;\n\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":2280,"wires":[[]]},{"id":"c3751ee2.f493f","type":"inject","z":"cf9f81ac.496e1","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":210,"y":1940,"wires":[["3c189b0a.ffa6a4"]]},{"id":"88797ff2.c4ce5","type":"inject","z":"cf9f81ac.496e1","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":180,"y":2020,"wires":[["c5d7a11d.f1f3b"]]},{"id":"c5d7a11d.f1f3b","type":"function","z":"cf9f81ac.496e1","name":"SILAGES","func":"var Select = `\nSELECT * FROM SILAGES;`\n\n\n\nmsg.topic = Select;\n\nreturn msg;\n//","outputs":1,"noerr":0,"x":360,"y":2020,"wires":[[]]},{"id":"44df4813.9e80e8","type":"comment","z":"cf9f81ac.496e1","name":"","info":"DATETIME: \"2021-12-30T11:28:01.000Z\nDATETIME: \"2021-12-30T10:26:18.000Z\nDATETIME: \"2021-12-30T09:24:31.000Z\nDATETIME: \"2021-12-30T08:22:45.000Z\"","x":600,"y":60,"wires":[]},{"id":"43e284f1.0587bc","type":"inject","z":"2683001c.e8587","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":124,"y":81,"wires":[["3352bc4c.aa2b84"]]},{"id":"3352bc4c.aa2b84","type":"function","z":"2683001c.e8587","name":"SHOW TABLES","func":"msg.topic = 'SHOW TABLES'\nreturn msg;","outputs":1,"noerr":0,"x":304,"y":81,"wires":[["94f0ca9.0c10038"]]},{"id":"e58853f8.da83a","type":"debug","z":"2683001c.e8587","name":"","active":true,"console":"false","complete":"false","x":690,"y":160,"wires":[]},{"id":"a2f2f96c.bfa178","type":"function","z":"2683001c.e8587","name":"Query to DB","func":"//var id = Number(msg.req.query.id)\nvar id = 200\n\n\nvar Select = `\nSELECT * FROM TLMAX\nWHERE LOG_RECNO = ${id}\nORDER BY DATETIME DESC`\n\n\n\nmsg.topic = Select;\n\nreturn msg;","outputs":1,"noerr":0,"x":256,"y":226,"wires":[["94f0ca9.0c10038"]]},{"id":"38c1d390.3542cc","type":"function","z":"2683001c.e8587","name":"","func":"var inputDate = msg.payload;\nvar id = msg.payload[0].LOG_RECNO;\nvar Zam_date = msg.payload[0].DATETIME\nvar sensorArray = [];\nvar out_temp = ''\nvar out_name = ''\n\nfor(let i = 0; i < inputDate.length; i++){\n    sensorArray[i] = {\n        'name': inputDate[i].SILAGE_ID + '_' + inputDate[i].LEVEL,\n        'temp': inputDate[i].USER_VALUE\n    }\n}\n\nconst idx_out = sensorArray.findIndex((element, index) => {\n    if(element.name === \"305_0\"){\n        return true\n    }\n});\n//out_temp = sensorArray[idx_out].temp\n//out_name = sensorArray[idx_out].name\n//sensorArray.splice(idx_out, 1);\n\n//var ary = sensorArray.slice(70,80);\n\n\n\n\nmsg.payload = {\n    DTLINECREATE: Zam_date,\n    id: id,\n    //out_temp,\n    //out_name,\n    sensors: sensorArray\n}\nreturn msg;","outputs":1,"noerr":0,"x":544,"y":290,"wires":[["e58853f8.da83a"]]},{"id":"f99fd93.7eb1028","type":"inject","z":"2683001c.e8587","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":102,"y":225,"wires":[["a2f2f96c.bfa178"]]},{"id":"2666d772.dcb3e8","type":"function","z":"2683001c.e8587","name":"query DB Group","func":"var Select = `\nSELECT  \nLAVALIERS.ID, LAVALIERS.NO, LAVALIERS.SILAGE_ID, LAVALIERS.LevelCount, LAVALIERS.LevelOffs, LAVALIERS.LoadLevels, LAVALIERS.DeviceAddr,\nSENSORS.TSB_ID, SENSORS.LEVEL, SENSORS.ONLINE, SENSORS.USER_T\nFROM LAVALIERS, SENSORS\nWHERE LAVALIERS.ID = SENSORS.TSB_ID\nORDER BY SENSORS.TSB_ID ASC LIMIT 4192`\n\nmsg.topic = Select;\n\nreturn msg;\n//","outputs":1,"noerr":0,"x":259,"y":273,"wires":[["94f0ca9.0c10038"]]},{"id":"7f66d8b.7e77a28","type":"inject","z":"2683001c.e8587","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":105,"y":269,"wires":[["2666d772.dcb3e8"]]},{"id":"23a0a931.371da6","type":"inject","z":"2683001c.e8587","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":101,"y":309,"wires":[["cf16449b.bb9b58"]]},{"id":"cf16449b.bb9b58","type":"function","z":"2683001c.e8587","name":"query DB SILAGES","func":"var Select = `\nSELECT *\nFROM SILAGES`\n\nmsg.topic = Select;\n\nreturn msg;\n//","outputs":1,"noerr":0,"x":287,"y":311,"wires":[["94f0ca9.0c10038"]]},{"id":"1c317984.ba8496","type":"inject","z":"2683001c.e8587","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":99,"y":403,"wires":[["80ff383b.189bc8"]]},{"id":"80ff383b.189bc8","type":"function","z":"2683001c.e8587","name":"query DB DEVICES","func":"var Select = `\nSELECT *\nFROM DEVICES`\n\nmsg.topic = Select;\n\nreturn msg;\n//","outputs":1,"noerr":0,"x":289,"y":403,"wires":[["94f0ca9.0c10038"]]},{"id":"5db16828.4be888","type":"http in","z":"2683001c.e8587","name":"","url":"/SILAGES","method":"get","swaggerDoc":"","x":151,"y":355,"wires":[["cf16449b.bb9b58"]]},{"id":"c53eeef2.db58b","type":"http response","z":"2683001c.e8587","name":"","x":671,"y":215,"wires":[]},{"id":"43fed98e.be8d48","type":"http in","z":"2683001c.e8587","name":"","url":"/DEVICES","method":"get","swaggerDoc":"","x":145,"y":449,"wires":[["80ff383b.189bc8"]]},{"id":"13fc7ac7.22ef05","type":"inject","z":"2683001c.e8587","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":97,"y":502,"wires":[["20b92b3d.7f9e14"]]},{"id":"20b92b3d.7f9e14","type":"function","z":"2683001c.e8587","name":"query DB LAVALIERS","func":"var Select = `\nSELECT *\nFROM LAVALIERS`\n\nmsg.topic = Select;\n\nreturn msg;\n//","outputs":1,"noerr":0,"x":298,"y":502,"wires":[["94f0ca9.0c10038"]]},{"id":"9ad3e753.928a18","type":"http in","z":"2683001c.e8587","name":"","url":"/LAVALIERS","method":"get","swaggerDoc":"","x":143,"y":548,"wires":[["20b92b3d.7f9e14"]]},{"id":"fac5c9e4.cb5e68","type":"function","z":"2683001c.e8587","name":"Group","func":"//допомыжны функцыъ\nfunction silageName2(numberSilos){\n    if(numberSilos >= 1 && numberSilos <=14) return '156 (1)'\n    else if(numberSilos >= 15 && numberSilos <= 28) return '165 (2)'\n    else if(numberSilos >= 29 && numberSilos <= 42) return '157 (3)'\n    else if(numberSilos >= 43 && numberSilos <= 56) return '166 (4)'\n    else if(numberSilos >= 57 && numberSilos <= 70) return '158 (5)'\n    else if(numberSilos >= 71 && numberSilos <= 84) return '167 (6)'\n    else if(numberSilos >= 85 && numberSilos <= 98) return '159 (7)'\n    else if(numberSilos >= 99 && numberSilos <= 112) return '168 (8)'\n    else if(numberSilos >= 113 && numberSilos <= 126) return '160 (9)'\n    else if(numberSilos >= 127 && numberSilos <= 140) return '169 (10)'\n    else if(numberSilos >= 141 && numberSilos <= 154) return '161 (11)'\n    else if(numberSilos >= 155 && numberSilos <= 168) return '170 (12)'\n    else if(numberSilos >= 169 && numberSilos <= 182) return '162 (13)'\n    else if(numberSilos >= 183 && numberSilos <= 196) return '171 (14)'\n    else if(numberSilos >= 197 && numberSilos <= 210) return '163 (15)'\n    else if(numberSilos >= 211 && numberSilos <= 224) return '172 (16)'\n    else if(numberSilos >= 225 && numberSilos <= 238) return '164 (17)'\n    else if(numberSilos >= 239 && numberSilos <= 252) return '173 (18)'\n    else if(numberSilos >= 301 && numberSilos <= 318) return '10/2'\n    else if(numberSilos >= 319 && numberSilos <= 334) return '10/1'\n    else return numberSilos\n}\n\n\nfunction silageName2(numberSilos){\n    if(numberSilos >= 1 && numberSilos <=14) return '1'\n    else if(numberSilos >= 15 && numberSilos <= 28) return '2'\n    else if(numberSilos >= 29 && numberSilos <= 42) return '3'\n    else if(numberSilos >= 43 && numberSilos <= 56) return '4'\n    else return numberSilos\n}\n\n\n\n\n\nfunction serialid(serial){\n    if(serial >= 1 && serial <=14) return 1\n    else if(serial >= 15 && serial <= 28) return 2\n    else if(serial >= 29 && serial <= 42) return 3\n    else if(serial >= 43 && serial <= 56) return 4\n    else if(serial >= 57 && serial <= 70) return 5\n    else if(serial >= 71 && serial <= 84) return 6\n    else if(serial >= 85 && serial <= 98) return 7\n    else if(serial >= 99 && serial <= 112) return 8\n    else if(serial >= 113 && serial <= 126) return 9\n    else if(serial >= 127 && serial <= 140) return 10\n    else if(serial >= 141 && serial <= 154) return 11\n    else if(serial >= 155 && serial <= 168) return 12\n    else if(serial >= 169 && serial <= 182) return 13\n    else if(serial >= 183 && serial <= 196) return 14\n    else if(serial >= 197 && serial <= 210) return 15\n    else if(serial >= 211 && serial <= 224) return 16\n    else if(serial >= 225 && serial <= 238) return 17\n    else if(serial >= 239 && serial <= 252) return 18\n    else if(serial >= 301 && serial <= 311) return 19\n    else if(serial >= 312 && serial <= 322) return 20\n    else if(serial >= 323 && serial <= 334) return 21\n    else return serial\n}\n\nfunction renameSerialNumber(number){\n    if(number > 300){\n        return Number(number.toString().replace(\"3\",''))\n    }\n    return number\n}\n\n\n\n\n\nfunction sortFunction(a,b){\n    return parseInt(a.LEVEL) - parseInt(b.LEVEL)\n}\n\n\n//ыныцыализацыя\n\nvar inData = msg.payload;\nvar IdArray = [];\nvar GroupIdOut = [];\n\n//групування по ID\nfor(let i = 0; i < inData.length; i++){\n    IdArray.push(inData[i].TSB_ID)\n}\n\nfor(let i = 0; i < inData.length; i++){\n    let ArrayID = []\n    for(let j = 0; j < IdArray.length; j++){\n        if(inData[i].TSB_ID == IdArray[j]){\n            ArrayID.push(inData[j])\n        }\n    }\n    ArrayID.sort(sortFunction)\n    GroupIdOut[inData[i].TSB_ID] = ArrayID\n\n}\nGroupIdOut.splice(0,1);\n//формування ответа\n\nvar GroupSensor = []\n\n for(let i = 0; i < GroupIdOut.length; i++){\n    let group = {\n        GroupBob:[]\n    }\n    for(let j = 0; j < GroupIdOut[i].length; j++){\n        group.silos = silageName(GroupIdOut[i][j].NO);\n        let jsonGroup =\n            {\n              name: GroupIdOut[i][j].SILAGE_ID + '_' + GroupIdOut[i][j].LEVEL,\n              name_r:(j < 10) ? `Датчик0${j}` : `Датчик${j}`,\n              name_l:`Рiвень ${j}`,\n            }\n        group.GroupBob.push(jsonGroup)    \n        group.SerialNumber = GroupIdOut[i][j].SILAGE_ID\n        group.Name = renameSerialNumber(GroupIdOut[i][j].NO)   \n         \n    }\n    GroupSensor.push(group) \n }\n\n\n//присвоэння выдповыды\n\nmsg.payload = {\n    GroupSensor: GroupSensor\n};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":561,"y":349,"wires":[["b52550a7.561c4"]]},{"id":"b52550a7.561c4","type":"debug","z":"2683001c.e8587","name":"","active":true,"console":"false","complete":"false","x":708,"y":348,"wires":[]},{"id":"5c75c78a.72cda8","type":"mysql","z":"2683001c.e8587","mydb":"30d3b88a.5d85c8","name":"","x":489.0000305175781,"y":806.0000610351562,"wires":[["314347fd.659248","41f29d85.74a424"]]},{"id":"6e197b1e.a10824","type":"inject","z":"2683001c.e8587","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":126,"y":813.0000200271606,"wires":[["ec598177.8a048"]]},{"id":"ec598177.8a048","type":"function","z":"2683001c.e8587","name":"query DB Group","func":"var Select = `\nSELECT  \nLAVALIERS.ID, LAVALIERS.NO, LAVALIERS.SILAGE_ID, LAVALIERS.LevelCount, LAVALIERS.LevelOffs, LAVALIERS.LoadLevels, LAVALIERS.DeviceAddr,\nSENSORS.TSB_ID, SENSORS.LEVEL, SENSORS.ONLINE, SENSORS.USER_T,\nSILAGES.ID AS SilageID, SILAGES.NO AS TBS_name\nFROM LAVALIERS, SENSORS, SILAGES\nWHERE (LAVALIERS.ID = SENSORS.TSB_ID AND LAVALIERS.SILAGE_ID = SILAGES.ID)\nORDER BY SENSORS.TSB_ID ASC`;\n\nmsg.topic = Select;\n\nreturn msg;\n//","outputs":1,"noerr":0,"x":296.0000305175781,"y":805.0000610351562,"wires":[["5c75c78a.72cda8"]]},{"id":"314347fd.659248","type":"function","z":"2683001c.e8587","name":"Group DEV","func":"//допомыжны функцыъ\nfunction silageName(numberSilos){\n    if(numberSilos >= 1 && numberSilos <=14) return '156 (1)'\n    else if(numberSilos >= 15 && numberSilos <= 28) return '165 (2)'\n    else if(numberSilos >= 29 && numberSilos <= 42) return '157 (3)'\n    else if(numberSilos >= 43 && numberSilos <= 56) return '166 (4)'\n    else if(numberSilos >= 57 && numberSilos <= 70) return '158 (5)'\n    else if(numberSilos >= 71 && numberSilos <= 84) return '167 (6)'\n    else if(numberSilos >= 85 && numberSilos <= 98) return '159 (7)'\n    else if(numberSilos >= 99 && numberSilos <= 112) return '168 (8)'\n    else if(numberSilos >= 113 && numberSilos <= 126) return '160 (9)'\n    else if(numberSilos >= 127 && numberSilos <= 140) return '169 (10)'\n    else if(numberSilos >= 141 && numberSilos <= 154) return '161 (11)'\n    else if(numberSilos >= 155 && numberSilos <= 168) return '170 (12)'\n    else if(numberSilos >= 169 && numberSilos <= 182) return '162 (13)'\n    else if(numberSilos >= 183 && numberSilos <= 196) return '171 (14)'\n    else if(numberSilos >= 197 && numberSilos <= 210) return '163 (15)'\n    else if(numberSilos >= 211 && numberSilos <= 224) return '172 (16)'\n    else if(numberSilos >= 225 && numberSilos <= 238) return '164 (17)'\n    else if(numberSilos >= 239 && numberSilos <= 252) return '173 (18)'\n    else if(numberSilos >= 301 && numberSilos <= 318) return '10/2'\n    else if(numberSilos >= 319 && numberSilos <= 334) return '10/1'\n    else return numberSilos\n}\n\n\nfunction silageName2(tbs_number){\n    let numberTBS = Number(tbs_number)\n    if(tbs_number >= 10000 && tbs_number <=19999) return '1'\n    else if(tbs_number >= 20000 && tbs_number <= 29999) return '2'\n    else if(tbs_number >= 30000 && tbs_number <= 39999) return '3'\n    else if(tbs_number >= 40000 && tbs_number <= 49999) return '4'\n    else if(tbs_number >= 50000 && tbs_number <= 59999) return '5'\n    else return tbs_number\n}\n\n\n\n// function renameSerialNumber(number){\n//     if(number > 300){\n//         return Number(number.toString().replace(\"3\",''));\n//     }\n//     return number;\n// }\n\n\nfunction sortFunction(a,b){\n    return parseInt(a.LEVEL) - parseInt(b.LEVEL);\n}\n\n\n//ыныцыализацыя\n\nvar inData = msg.payload;\nvar IdArray = [];\nvar GroupIdOut = [];\n\n//групування по ID\nfor(let i = 0; i < inData.length; i++){\n    IdArray.push(inData[i].TSB_ID);\n}\n\n\n\nfor(let i = 0; i < inData.length; i++){\n    let ArrayID = [];\n    for(let j = 0; j < IdArray.length; j++){\n        if(inData[i].TSB_ID == IdArray[j]){\n            ArrayID.push(inData[j]);\n        }\n    }\n    ArrayID.sort(sortFunction);\n    GroupIdOut[inData[i].TSB_ID] = ArrayID;\n}\nGroupIdOut.splice(0,1);\nmsg.GroupIdOut = GroupIdOut;\n// \n//формування ответа\n\nvar GroupSensor = [];\n\n for(let i = 0; i < GroupIdOut.length; i++){\n    let group = {\n        GroupBob:[]\n    };\n    for(let j = 0; j < GroupIdOut[i].length; j++){\n        group.silos = silageName2(GroupIdOut[i][j].TBS_name);\n        let jsonGroup =\n            {\n              name: GroupIdOut[i][j].SILAGE_ID + '_' + GroupIdOut[i][j].LEVEL,\n              name_r:(j < 10) ? `Датчик0${j}` : `Датчик${j}`,\n              name_l:`Рiвень ${j}`,\n            };\n        group.GroupBob.push(jsonGroup);\n        group.SerialNumber = GroupIdOut[i][j].SILAGE_ID;\n        group.Name = GroupIdOut[i][j].TBS_name;  \n         \n    }\n    GroupSensor.push(group);\n }\n\n\n// //присвоэння выдповыды\n\n// msg.payload = {\n//     GroupSensor: GroupSensor\n// };\n\nmsg.GroupSensor = GroupSensor;\nreturn msg;","outputs":1,"noerr":0,"x":648.0000305175781,"y":806.0000610351562,"wires":[["969b7571.1ba958"]]},{"id":"969b7571.1ba958","type":"debug","z":"2683001c.e8587","name":"","active":true,"console":"false","complete":"true","x":794,"y":800.0000305175781,"wires":[]},{"id":"53a98aeb.8dcba4","type":"inject","z":"2683001c.e8587","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":133,"y":897.0000381469727,"wires":[["b786bccb.0ff58"]]},{"id":"b786bccb.0ff58","type":"function","z":"2683001c.e8587","name":"Query to DB TLMAX","func":"//var id = Number(msg.req.query.id)\nvar id = 2000\n\n\nvar Select = `\nSELECT * FROM TLMAX\nWHERE LOG_RECNO = ${id}\nORDER BY DATETIME DESC`\n\n\n\nmsg.topic = Select;\n\nreturn msg;","outputs":1,"noerr":0,"x":318.0000305175781,"y":899.0000610351562,"wires":[["37b8d1a7.f7729e"]]},{"id":"37b8d1a7.f7729e","type":"mysql","z":"2683001c.e8587","mydb":"30d3b88a.5d85c8","name":"","x":510.0000305175781,"y":904.0000610351562,"wires":[["a1e8315.373e4d","bf1d13b8.0af77"]]},{"id":"a1e8315.373e4d","type":"function","z":"2683001c.e8587","name":"","func":"var inputDate = msg.payload;\nvar id = msg.payload[0].LOG_RECNO;\nvar Zam_date = msg.payload[0].DATETIME\nvar sensorArray = [];\nvar out_temp = ''\nvar out_name = ''\n\nfor(let i = 0; i < inputDate.length; i++){\n    sensorArray[i] = {\n        'name': inputDate[i].SILAGE_ID + '_' + inputDate[i].LEVEL,\n        'temp': inputDate[i].USER_VALUE\n    }\n}\n\nconst idx_out = sensorArray.findIndex((element, index) => {\n    if(element.name === \"305_0\"){\n        return true\n    }\n});\nout_temp = sensorArray[idx_out].temp\nout_name = sensorArray[idx_out].name\nsensorArray.splice(idx_out, 1);\n\n//var ary = sensorArray.slice(70,80);\n\n\n\n\nmsg.payload = {\n    DTLINECREATE: Zam_date,\n    id: id,\n    out_temp,\n    out_name,\n    sensors: sensorArray\n}\nreturn msg;","outputs":1,"noerr":0,"x":666.0000305175781,"y":902.0000610351562,"wires":[["8f74ff66.15f1"]]},{"id":"8f74ff66.15f1","type":"debug","z":"2683001c.e8587","name":"","active":true,"console":"false","complete":"false","x":815.0000305175781,"y":897.0000610351562,"wires":[]},{"id":"bf1d13b8.0af77","type":"debug","z":"2683001c.e8587","name":"","active":true,"console":"false","complete":"false","x":664.0000305175781,"y":953.0000610351562,"wires":[]},{"id":"580ff168.7f78d","type":"function","z":"2683001c.e8587","name":"Group","func":"//допомыжны функцыъ\nfunction silageName(numberSilos){\n    if(numberSilos >= 1 && numberSilos <=14) return '156 (1)'\n    else if(numberSilos >= 15 && numberSilos <= 28) return '165 (2)'\n    else if(numberSilos >= 29 && numberSilos <= 42) return '157 (3)'\n    else if(numberSilos >= 43 && numberSilos <= 56) return '166 (4)'\n    else if(numberSilos >= 57 && numberSilos <= 70) return '158 (5)'\n    else if(numberSilos >= 71 && numberSilos <= 84) return '167 (6)'\n    else if(numberSilos >= 85 && numberSilos <= 98) return '159 (7)'\n    else if(numberSilos >= 99 && numberSilos <= 112) return '168 (8)'\n    else if(numberSilos >= 113 && numberSilos <= 126) return '160 (9)'\n    else if(numberSilos >= 127 && numberSilos <= 140) return '169 (10)'\n    else if(numberSilos >= 141 && numberSilos <= 154) return '161 (11)'\n    else if(numberSilos >= 155 && numberSilos <= 168) return '170 (12)'\n    else if(numberSilos >= 169 && numberSilos <= 182) return '162 (13)'\n    else if(numberSilos >= 183 && numberSilos <= 196) return '171 (14)'\n    else if(numberSilos >= 197 && numberSilos <= 210) return '163 (15)'\n    else if(numberSilos >= 211 && numberSilos <= 224) return '172 (16)'\n    else if(numberSilos >= 225 && numberSilos <= 238) return '164 (17)'\n    else if(numberSilos >= 239 && numberSilos <= 252) return '173 (18)'\n    else if(numberSilos >= 301 && numberSilos <= 318) return '10/2'\n    else if(numberSilos >= 319 && numberSilos <= 334) return '10/1'\n    else return numberSilos\n}\n\n\nfunction silageName2(numberSilos){\n    if(numberSilos >= 1 && numberSilos <=14) return '1'\n    else if(numberSilos >= 15 && numberSilos <= 28) return '2'\n    else if(numberSilos >= 29 && numberSilos <= 42) return '3'\n    else if(numberSilos >= 43 && numberSilos <= 56) return '4'\n    else return numberSilos\n}\n\n\n\n\n\nfunction serialid(serial){\n    if(serial >= 1 && serial <=14) return 1\n    else if(serial >= 15 && serial <= 28) return 2\n    else if(serial >= 29 && serial <= 42) return 3\n    else if(serial >= 43 && serial <= 56) return 4\n    else if(serial >= 57 && serial <= 70) return 5\n    else if(serial >= 71 && serial <= 84) return 6\n    else if(serial >= 85 && serial <= 98) return 7\n    else if(serial >= 99 && serial <= 112) return 8\n    else if(serial >= 113 && serial <= 126) return 9\n    else if(serial >= 127 && serial <= 140) return 10\n    else if(serial >= 141 && serial <= 154) return 11\n    else if(serial >= 155 && serial <= 168) return 12\n    else if(serial >= 169 && serial <= 182) return 13\n    else if(serial >= 183 && serial <= 196) return 14\n    else if(serial >= 197 && serial <= 210) return 15\n    else if(serial >= 211 && serial <= 224) return 16\n    else if(serial >= 225 && serial <= 238) return 17\n    else if(serial >= 239 && serial <= 252) return 18\n    else if(serial >= 301 && serial <= 311) return 19\n    else if(serial >= 312 && serial <= 322) return 20\n    else if(serial >= 323 && serial <= 334) return 21\n    else return serial\n}\n\nfunction renameSerialNumber(number){\n    if(number > 300){\n        return Number(number.toString().replace(\"3\",''))\n    }\n    return number\n}\n\n\n\n\n\nfunction sortFunction(a,b){\n    return parseInt(a.LEVEL) - parseInt(b.LEVEL)\n}\n\n\n//ыныцыализацыя\n\nvar inData = msg.payload;\nvar IdArray = [];\nvar GroupIdOut = [];\n\n//групування по ID\nfor(let i = 0; i < inData.length; i++){\n    IdArray.push(inData[i].TSB_ID)\n}\n\nfor(let i = 0; i < inData.length; i++){\n    let ArrayID = []\n    for(let j = 0; j < IdArray.length; j++){\n        if(inData[i].TSB_ID == IdArray[j]){\n            ArrayID.push(inData[j])\n        }\n    }\n    ArrayID.sort(sortFunction)\n    GroupIdOut[inData[i].TSB_ID] = ArrayID\n\n}\nGroupIdOut.splice(0,1);\n//формування ответа\n\nvar GroupSensor = []\n\n for(let i = 0; i < GroupIdOut.length; i++){\n    let group = {\n        GroupBob:[]\n    }\n    for(let j = 0; j < GroupIdOut[i].length; j++){\n        group.silos = silageName(GroupIdOut[i][j].NO);\n        let jsonGroup =\n            {\n              name: GroupIdOut[i][j].SILAGE_ID + '_' + GroupIdOut[i][j].LEVEL,\n              name_r:(j < 10) ? `Датчик0${j}` : `Датчик${j}`,\n              name_l:`Рiвень ${j}`,\n            }\n        group.GroupBob.push(jsonGroup)    \n        group.SerialNumber = GroupIdOut[i][j].SILAGE_ID\n        group.Name = renameSerialNumber(GroupIdOut[i][j].NO)   \n         \n    }\n    GroupSensor.push(group) \n }\n\n\n//присвоэння выдповыды\n\nmsg.payload = {\n    GroupSensor: GroupSensor\n};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":599,"y":552,"wires":[[]]},{"id":"9ec32a51.70b8f8","type":"inject","z":"2683001c.e8587","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":106.89582824707031,"y":596.888916015625,"wires":[["13663135.8cacff"]]},{"id":"13663135.8cacff","type":"function","z":"2683001c.e8587","name":"query DB SENSORS","func":"var Select = `\nSELECT *\nFROM SENSORS`\n\nmsg.topic = Select;\n\nreturn msg;\n//","outputs":1,"noerr":0,"x":307.8958282470703,"y":596.888916015625,"wires":[["94f0ca9.0c10038"]]},{"id":"fa9780ee.6b233","type":"http in","z":"2683001c.e8587","name":"","url":"/SENSORS","method":"get","swaggerDoc":"","x":152.8958282470703,"y":642.888916015625,"wires":[["13663135.8cacff"]]},{"id":"41f29d85.74a424","type":"debug","z":"2683001c.e8587","name":"","active":true,"console":"false","complete":"false","x":638.895824432373,"y":765.2222566604614,"wires":[]},{"id":"77fa47c.501b9b8","type":"function","z":"2683001c.e8587","name":"","func":"//допомыжны функцыъ\nfunction silageName(numberSilos){\n    if(numberSilos >= 1 && numberSilos <=14) return '156 (1)'\n    else if(numberSilos >= 15 && numberSilos <= 28) return '165 (2)'\n    else if(numberSilos >= 29 && numberSilos <= 42) return '157 (3)'\n    else if(numberSilos >= 43 && numberSilos <= 56) return '166 (4)'\n    else if(numberSilos >= 57 && numberSilos <= 70) return '158 (5)'\n    else if(numberSilos >= 71 && numberSilos <= 84) return '167 (6)'\n    else if(numberSilos >= 85 && numberSilos <= 98) return '159 (7)'\n    else if(numberSilos >= 99 && numberSilos <= 112) return '168 (8)'\n    else if(numberSilos >= 113 && numberSilos <= 126) return '160 (9)'\n    else if(numberSilos >= 127 && numberSilos <= 140) return '169 (10)'\n    else if(numberSilos >= 141 && numberSilos <= 154) return '161 (11)'\n    else if(numberSilos >= 155 && numberSilos <= 168) return '170 (12)'\n    else if(numberSilos >= 169 && numberSilos <= 182) return '162 (13)'\n    else if(numberSilos >= 183 && numberSilos <= 196) return '171 (14)'\n    else if(numberSilos >= 197 && numberSilos <= 210) return '163 (15)'\n    else if(numberSilos >= 211 && numberSilos <= 224) return '172 (16)'\n    else if(numberSilos >= 225 && numberSilos <= 238) return '164 (17)'\n    else if(numberSilos >= 239 && numberSilos <= 252) return '173 (18)'\n    else if(numberSilos >= 301 && numberSilos <= 318) return '10/2'\n    else if(numberSilos >= 319 && numberSilos <= 334) return '10/1'\n    else return numberSilos\n}\n\nfunction serialid(serial){\n    if(serial >= 1 && serial <=14) return 1\n    else if(serial >= 15 && serial <= 28) return 2\n    else if(serial >= 29 && serial <= 42) return 3\n    else if(serial >= 43 && serial <= 56) return 4\n    else if(serial >= 57 && serial <= 70) return 5\n    else if(serial >= 71 && serial <= 84) return 6\n    else if(serial >= 85 && serial <= 98) return 7\n    else if(serial >= 99 && serial <= 112) return 8\n    else if(serial >= 113 && serial <= 126) return 9\n    else if(serial >= 127 && serial <= 140) return 10\n    else if(serial >= 141 && serial <= 154) return 11\n    else if(serial >= 155 && serial <= 168) return 12\n    else if(serial >= 169 && serial <= 182) return 13\n    else if(serial >= 183 && serial <= 196) return 14\n    else if(serial >= 197 && serial <= 210) return 15\n    else if(serial >= 211 && serial <= 224) return 16\n    else if(serial >= 225 && serial <= 238) return 17\n    else if(serial >= 239 && serial <= 252) return 18\n    else if(serial >= 301 && serial <= 311) return 19\n    else if(serial >= 312 && serial <= 322) return 20\n    else if(serial >= 323 && serial <= 334) return 21\n    else return serial\n}\n\nfunction renameSerialNumber(number){\n    if(number > 300){\n        return Number(number.toString().replace(\"3\",''))\n    }\n    return number\n}\n\n\n\n\n\nfunction sortFunction(a,b){\n    return parseInt(a.LEVEL) - parseInt(b.LEVEL)\n}\n\n\n//ыныцыализацыя\n\nvar inData = msg.payload;\nvar IdArray = [];\nvar GroupIdOut = [];\n\n//групування по ID\nfor(let i = 0; i < inData.length; i++){\n    IdArray.push(inData[i].TSB_ID)\n}\n\nfor(let i = 0; i < inData.length; i++){\n    let ArrayID = []\n    for(let j = 0; j < IdArray.length; j++){\n        if(inData[i].TSB_ID == IdArray[j]){\n            ArrayID.push(inData[j])\n        }\n    }\n    ArrayID.sort(sortFunction)\n    GroupIdOut[inData[i].TSB_ID] = ArrayID\n\n}\nGroupIdOut.splice(0,1);\n//формування ответа\n\nvar GroupSensor = []\n\n for(let i = 0; i < GroupIdOut.length; i++){\n    let group = {\n        GroupBob:[]\n    }\n    for(let j = 0; j < GroupIdOut[i].length; j++){\n        group.silos = silageName(GroupIdOut[i][j].NO);\n        let jsonGroup =\n            {\n              name: GroupIdOut[i][j].SILAGE_ID + '_' + GroupIdOut[i][j].LEVEL,\n              name_r:(j < 10) ? `Датчик0${j}` : `Датчик${j}`,\n              name_l:`Рiвень ${j}`,\n            }\n        group.GroupBob.push(jsonGroup)    \n        group.SerialNumber = GroupIdOut[i][j].SILAGE_ID\n        group.Name = renameSerialNumber(GroupIdOut[i][j].NO)   \n         \n    }\n    GroupSensor.push(group) \n }\n\n\n//присвоэння выдповыды\n\nmsg.payload = {\n    GroupSensor: GroupSensor\n};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":641.8958129882812,"y":844.3333129882812,"wires":[[]]},{"id":"779151e6.f434f","type":"http in","z":"ff01d09f.6d81a","name":"","url":"/get/podves/termiks_test","method":"get","swaggerDoc":"","x":180,"y":60,"wires":[["ab11ad54.b0035","2857bfc5.c3c0d"]]},{"id":"ab11ad54.b0035","type":"function","z":"ff01d09f.6d81a","name":"query DB Group","func":"var Select = `\nSELECT  \nLAVALIERS.ID, LAVALIERS.NO, LAVALIERS.SILAGE_ID, LAVALIERS.LevelCount, LAVALIERS.LevelOffs, LAVALIERS.LoadLevels, LAVALIERS.DeviceAddr,\nSENSORS.TSB_ID, SENSORS.LEVEL, SENSORS.ONLINE, SENSORS.USER_T,\nSILAGES.ID AS SilageID, SILAGES.NO AS TBS_name\nFROM LAVALIERS, SENSORS, SILAGES\nWHERE (LAVALIERS.ID = SENSORS.TSB_ID AND LAVALIERS.SILAGE_ID = SILAGES.ID)\nORDER BY SENSORS.TSB_ID ASC`;\n\nmsg.topic = Select;\n\nreturn msg;\n//","outputs":1,"noerr":0,"x":280,"y":160,"wires":[["70caa9ba.fc8af8"]]},{"id":"70caa9ba.fc8af8","type":"mysql","z":"ff01d09f.6d81a","mydb":"30d3b88a.5d85c8","name":"","x":410,"y":100,"wires":[["1191db95.83d334","718981ac.a1dc7","e7c5c19f.2bf49"]]},{"id":"1191db95.83d334","type":"function","z":"ff01d09f.6d81a","name":"Group DEV","func":"//допомыжны функцыъ\n\nfunction silageName2(tbs_number){\n    let numberTBS = Number(tbs_number)\n    if(tbs_number >= 10000 && tbs_number <=19999) return '1'\n    else if(tbs_number >= 20000 && tbs_number <= 29999) return '2'\n    else if(tbs_number >= 30000 && tbs_number <= 39999) return '3'\n    else if(tbs_number >= 40000 && tbs_number <= 49999) return '4'\n    else if(tbs_number >= 50000 && tbs_number <= 59999) return '5'\n    else return tbs_number\n}\n\n\n\n// function renameSerialNumber(number){\n//     if(number > 300){\n//         return Number(number.toString().replace(\"3\",''));\n//     }\n//     return number;\n// }\n\n\nfunction sortFunction(a,b){\n    return parseInt(a.LEVEL) - parseInt(b.LEVEL);\n}\n\n\n//ыныцыализацыя\n\nvar inData = msg.payload;\nvar IdArray = [];\nvar GroupIdOut = [];\n\n//групування по ID\nfor(let i = 0; i < inData.length; i++){\n    IdArray.push(inData[i].TSB_ID);\n}\n\n\n\nfor(let i = 0; i < inData.length; i++){\n    let ArrayID = [];\n    for(let j = 0; j < IdArray.length; j++){\n        if(inData[i].TSB_ID == IdArray[j]){\n            ArrayID.push(inData[j]);\n        }\n    }\n    ArrayID.sort(sortFunction);\n    GroupIdOut[inData[i].TSB_ID] = ArrayID;\n}\nGroupIdOut.splice(0,1);\nmsg.GroupIdOut = GroupIdOut;\n// \n//формування ответа\n\nvar GroupSensor = [];\n\n for(let i = 0; i < GroupIdOut.length; i++){\n    let group = {\n        GroupBob:[]\n    };\n    for(let j = 0; j < GroupIdOut[i].length; j++){\n        group.silos = silageName2(GroupIdOut[i][j].TBS_name);\n        let jsonGroup =\n            {\n              name: GroupIdOut[i][j].SILAGE_ID + '_' + GroupIdOut[i][j].LEVEL,\n              name_r:(j < 10) ? `Датчик0${j}` : `Датчик${j}`,\n              name_l:`Рiвень ${j}`,\n            };\n        group.GroupBob.push(jsonGroup);\n        group.SerialNumber = GroupIdOut[i][j].SILAGE_ID;\n        group.Name = GroupIdOut[i][j].TBS_name;  \n         \n    }\n    GroupSensor.push(group);\n }\n\n\n// //присвоэння выдповыды\n\nmsg.payload = {\n    GroupSensor: GroupSensor\n};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":630,"y":100,"wires":[["fa0ca94e.0d09b8","eba7bd99.e59d4"]]},{"id":"fa0ca94e.0d09b8","type":"http response","z":"ff01d09f.6d81a","name":"","x":830,"y":100,"wires":[]},{"id":"6b6ac2df.67732c","type":"comment","z":"ff01d09f.6d81a","name":"Structura Podves and Silos","info":"","x":150,"y":20,"wires":[]},{"id":"9c1ff5ac.a2b288","type":"function","z":"ff01d09f.6d81a","name":"Query to DB","func":"var id = Number(msg.req.query.id)\n//var id = 200\n\n\nvar Select = `\nSELECT * FROM TLMAX\nWHERE LOG_RECNO = ${id}\nORDER BY DATETIME DESC`\n\n\n\nmsg.topic = Select;\n\nreturn msg;","outputs":1,"noerr":0,"x":372.8959045410156,"y":379.88892459869385,"wires":[["49f8f5ef.fdf23c"]]},{"id":"49f8f5ef.fdf23c","type":"mysql","z":"ff01d09f.6d81a","mydb":"30d3b88a.5d85c8","name":"","x":532.8958549499512,"y":378.8888940811157,"wires":[["e0afc06a.b0a5d","4e2c797c.ceb0a8"]]},{"id":"e0afc06a.b0a5d","type":"function","z":"ff01d09f.6d81a","name":"","func":"var inputDate = msg.payload;\nvar id = msg.payload[0].LOG_RECNO;\nvar Zam_date = msg.payload[0].DATETIME\nvar sensorArray = [];\nvar out_temp = ''\nvar out_name = ''\n\nfor(let i = 0; i < inputDate.length; i++){\n    sensorArray[i] = {\n        'name': inputDate[i].SILAGE_ID + '_' + inputDate[i].LEVEL,\n        'temp': inputDate[i].USER_VALUE\n    }\n}\n\n// const idx_out = sensorArray.findIndex((element, index) => {\n//     if(element.name === \"305_0\"){\n//         return true\n//     }\n// });\n//out_temp = sensorArray[idx_out].temp\n//out_name = sensorArray[idx_out].name\n//sensorArray.splice(idx_out, 1);\n\n//var ary = sensorArray.slice(70,80);\n\n\n\n\nmsg.payload = {\n    DTLINECREATE: Zam_date,\n    id: id,\n    //out_temp,\n    //out_name,\n    sensors: sensorArray\n}\nreturn msg;","outputs":1,"noerr":0,"x":674.8957824707031,"y":376.8888969421387,"wires":[["aa08081a.e42828","aad5fc3f.06a1f"]]},{"id":"aa08081a.e42828","type":"http response","z":"ff01d09f.6d81a","name":"","x":798.8958282470703,"y":379.8889207839966,"wires":[]},{"id":"ea733dd6.2cf86","type":"http in","z":"ff01d09f.6d81a","name":"","url":"/get/getSensor_test","method":"get","swaggerDoc":"","x":164.8958282470703,"y":380.8888931274414,"wires":[["9c1ff5ac.a2b288","7e8bdda6.feaf84"]]},{"id":"6a8cfc73.11db04","type":"inject","z":"2683001c.e8587","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":103.89582824707031,"y":116.88888549804688,"wires":[["fbb9b623.dc81f8"]]},{"id":"fbb9b623.dc81f8","type":"function","z":"2683001c.e8587","name":"SHOW LAST ID","func":"var Select = `\nSELECT * FROM TLMAX \nORDER BY LOG_RECNO DESC LIMIT 4320;`\n\n\n\nmsg.topic = Select;\n\nreturn msg;\n//","outputs":1,"noerr":0,"x":303.8958282470703,"y":116.88888549804688,"wires":[["94f0ca9.0c10038"]]},{"id":"6f8461f2.3ea3b","type":"comment","z":"ff01d09f.6d81a","name":"Get sensor and value by ID","info":"LOG_RECNO: 2818\nDATETIME: \"2022-10-15T12:20:48.000Z\"","x":175.82640075683594,"y":329.263916015625,"wires":[]},{"id":"eaa6709b.b7fe8","type":"function","z":"ff01d09f.6d81a","name":"","func":"msg.payload = {\n    message:\"not data found\"\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":553.8958320617676,"y":491.8888854980469,"wires":[["1079f430.272afc"]]},{"id":"1079f430.272afc","type":"http response","z":"ff01d09f.6d81a","name":"","x":685.895824432373,"y":493.88888359069824,"wires":[]},{"id":"4e2c797c.ceb0a8","type":"function","z":"ff01d09f.6d81a","name":"reset","func":"msg.reset = true\nreturn msg;","outputs":1,"noerr":0,"x":406.8959312438965,"y":439.88892364501953,"wires":[["7e8bdda6.feaf84"]]},{"id":"7e8bdda6.feaf84","type":"trigger","z":"ff01d09f.6d81a","op1":"","op2":"{}","op1type":"nul","op2type":"json","duration":"4","extend":false,"units":"s","reset":"","name":"","x":405.89588928222656,"y":494.8889865875244,"wires":[["eaa6709b.b7fe8"]]},{"id":"2857bfc5.c3c0d","type":"debug","z":"ff01d09f.6d81a","name":"","active":false,"console":"false","complete":"false","x":410,"y":20,"wires":[]},{"id":"eba7bd99.e59d4","type":"debug","z":"ff01d09f.6d81a","name":"","active":true,"console":"false","complete":"false","x":870,"y":20,"wires":[]},{"id":"718981ac.a1dc7","type":"debug","z":"ff01d09f.6d81a","name":"","active":true,"console":"false","complete":"false","x":630,"y":20,"wires":[]},{"id":"aad5fc3f.06a1f","type":"debug","z":"ff01d09f.6d81a","name":"","active":true,"console":"false","complete":"false","x":797.8403472900391,"y":306.9548645019531,"wires":[]},{"id":"635f03a4.0eed5c","type":"inject","z":"1001a228.b10a4e","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":234.89583587646484,"y":128.88889503479004,"wires":[["c865a1ba.7e43a"]]},{"id":"7619fc04.a9fcf4","type":"http request","z":"1001a228.b10a4e","name":"","method":"GET","ret":"txt","url":"","tls":"1756cec1.daced1","x":542.8958282470703,"y":218.88888549804688,"wires":[["3e44d9c8.692686"]]},{"id":"c865a1ba.7e43a","type":"function","z":"1001a228.b10a4e","name":"","func":"msg.url = \"https://10.107.21.152:8443/ords/termo/iot_cli/silo_sensor?id=2813\";\n\nflow.set(\"res\", msg.res)\nflow.set(\"req\", msg.req)\nreturn msg;","outputs":1,"noerr":0,"x":369.8958282470703,"y":217.88888549804688,"wires":[["7619fc04.a9fcf4"]]},{"id":"5f04c5c3.928a1c","type":"debug","z":"1001a228.b10a4e","name":"","active":true,"console":"false","complete":"false","x":856.8957939147949,"y":215.88888359069824,"wires":[]},{"id":"4ed8b642.8d56f8","type":"http in","z":"1001a228.b10a4e","name":"","url":"/ords/termo/iot_cli/","method":"post","swaggerDoc":"","x":194.83682250976562,"y":283.322940826416,"wires":[["c865a1ba.7e43a","4152a247.fd821c"]]},{"id":"3e44d9c8.692686","type":"function","z":"1001a228.b10a4e","name":"","func":"msg.res = flow.get(\"res\");\nmsg.req = flow.get(\"req\");\nreturn msg;","outputs":1,"noerr":0,"x":697.8402519226074,"y":215.7569637298584,"wires":[["5f04c5c3.928a1c"]]},{"id":"4152a247.fd821c","type":"debug","z":"1001a228.b10a4e","name":"","active":true,"console":"false","complete":"true","x":427.8403091430664,"y":283.5139217376709,"wires":[]},{"id":"7dba952b.36dbac","type":"inject","z":"ff01d09f.6d81a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":100,"y":160,"wires":[["ab11ad54.b0035"]]},{"id":"6b375322.f1f4bc","type":"function","z":"ff01d09f.6d81a","name":"query DB Group","func":"var Select = `\nSELECT  \nLAVALIERS.ID as LAVALIERS_ID, LAVALIERS.NO as LAVALIERS_NO, LAVALIERS.SILAGE_ID as LAVALIERS_SILAGE_ID, LAVALIERS.LevelCount, LAVALIERS.LevelOffs, LAVALIERS.LoadLevels, LAVALIERS.DeviceAddr,\nSENSORS.TSB_ID as SENSORS_TSB_ID, SENSORS.LEVEL as SENSORS_LEVEL, SENSORS.ONLINE, SENSORS.USER_T,\nSILAGES.ID AS SilageID, SILAGES.NO AS TBS_name\nFROM LAVALIERS, SENSORS, SILAGES\nWHERE (LAVALIERS.ID = SENSORS.TSB_ID AND LAVALIERS.SILAGE_ID = SILAGES.ID)\nORDER BY SENSORS.TSB_ID ASC`;\n\nmsg.topic = Select;\n\nreturn msg;\n//","outputs":1,"noerr":0,"x":280,"y":200,"wires":[["70caa9ba.fc8af8"]]},{"id":"d02e49ee.5417e8","type":"inject","z":"ff01d09f.6d81a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":100,"y":200,"wires":[["6b375322.f1f4bc"]]},{"id":"e7c5c19f.2bf49","type":"function","z":"ff01d09f.6d81a","name":"Group DEV","func":"//допомыжны функцыъ\n\nfunction silageName2(tbs_number){\n    let numberTBS = Number(tbs_number)\n    if(tbs_number >= 10000 && tbs_number <=19999) return '1'\n    else if(tbs_number >= 20000 && tbs_number <= 29999) return '2'\n    else if(tbs_number >= 30000 && tbs_number <= 39999) return '3'\n    else if(tbs_number >= 40000 && tbs_number <= 49999) return '4'\n    else if(tbs_number >= 50000 && tbs_number <= 59999) return '5'\n    else return tbs_number\n}\n\n\n\n// function renameSerialNumber(number){\n//     if(number > 300){\n//         return Number(number.toString().replace(\"3\",''));\n//     }\n//     return number;\n// }\n\n\nfunction sortFunction(a,b){\n    return parseInt(a.LEVEL) - parseInt(b.LEVEL);\n}\n\n\n//ыныцыализацыя\n\nvar inData = msg.payload;\nvar IdArray = []; //id termoPodves\nvar GroupIdOut = [];\n\n//групування по ID\nfor(let i = 0; i < inData.length; i++){\n    IdArray.push(inData[i].SENSORS_TSB_ID);\n}\n\n\n\nfor(let i = 0; i < inData.length; i++){\n    let ArrayID = [];\n    for(let j = 0; j < IdArray.length; j++){\n        if(inData[i].SENSORS_TSB_ID == IdArray[j]){\n            ArrayID.push(inData[j]);\n        }\n    }\n    ArrayID.sort(sortFunction);\n    GroupIdOut[inData[i].SENSORS_TSB_ID] = ArrayID;\n}\nGroupIdOut.splice(0,1);\nmsg.GroupIdOut = GroupIdOut;\n// \n//формування ответа\n\nvar GroupSensor = [];\n\n for(let i = 0; i < GroupIdOut.length; i++){\n    let group = {\n        GroupBob:[]\n    };\n    for(let j = 0; j < GroupIdOut[i].length; j++){\n        group.silos = GroupIdOut[i][j].TBS_name;\n        let jsonGroup =\n            {\n              name: GroupIdOut[i][j].LAVALIERS_NO + '_' + GroupIdOut[i][j].SENSORS_LEVEL,\n              name_r:(j < 10) ? `Датчик0${j}` : `Датчик${j}`,\n              name_l:`Рiвень ${j}`,\n            };\n        group.GroupBob.push(jsonGroup);\n        group.SerialNumber = GroupIdOut[i][j].LAVALIERS_SILAGE_ID;\n        group.Name = GroupIdOut[i][j].TBS_name;  \n         \n    }\n    GroupSensor.push(group);\n }\n\n\n// //присвоэння выдповыды\n\nmsg.payload = {\n    GroupSensor: GroupSensor\n};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":630,"y":140,"wires":[["a704bf6b.45141"]]},{"id":"a704bf6b.45141","type":"debug","z":"ff01d09f.6d81a","name":"","active":true,"console":"false","complete":"false","x":850,"y":140,"wires":[]},{"id":"15d7ea53.341f66","type":"inject","z":"2683001c.e8587","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":140,"y":1060,"wires":[["6c6156da.050168"]]},{"id":"6c6156da.050168","type":"function","z":"2683001c.e8587","name":"query DB Group","func":"var Select = `\nSELECT  \nLAVALIERS.ID as LAVALIERS_ID, \nLAVALIERS.NO as LAVALIERS_NO, \nLAVALIERS.SILAGE_ID as LAVALIERS_SILAGE_ID, \nLAVALIERS.LevelCount as LAVALIERS_LevelCount, \nLAVALIERS.LevelOffs as LAVALIERS_LevelOffs, \nLAVALIERS.LoadLevels as LAVALIERS_LoadLevels, \nLAVALIERS.DeviceAddr as LAVALIERS_DeviceAddr,\nSENSORS.TSB_ID as SENSORS_TSB_ID, \nSENSORS.LEVEL as SENSORS_LEVEL, \nSENSORS.ONLINE, \nSENSORS.USER_T,\nSILAGES.ID AS SILAGES_ID, \nSILAGES.NO AS SILAGES_NO\nFROM LAVALIERS, SENSORS, SILAGES\nWHERE (LAVALIERS.ID = SENSORS.TSB_ID AND LAVALIERS.SILAGE_ID = SILAGES.ID)\nORDER BY SENSORS.TSB_ID ASC`;\n\nmsg.topic = Select;\n\nreturn msg;\n//","outputs":1,"noerr":0,"x":160,"y":1100,"wires":[["38a83283.04bd5e"]]},{"id":"38a83283.04bd5e","type":"mysql","z":"2683001c.e8587","mydb":"30d3b88a.5d85c8","name":"","x":370,"y":1100,"wires":[["8b7e47bf.e294c8","9b82b6d1.400cb8"]]},{"id":"8b7e47bf.e294c8","type":"function","z":"2683001c.e8587","name":"Group DEV","func":"function sortFunction(a,b){\n    return parseInt(a.LEVEL) - parseInt(b.LEVEL);\n}\n\n\n//ыныцыализацыя\n\nvar inData = msg.payload;\nvar IdArray = []; //id termoPodves\nvar GroupIdOut = [];\n\n//групування по ID podveska\nfor(let i = 0; i < inData.length; i++){\n    IdArray.push(inData[i].SENSORS_TSB_ID);\n}\n\n\n\nfor(let i = 0; i < inData.length; i++){\n    let ArrayID = [];\n    for(let j = 0; j < IdArray.length; j++){\n        if(inData[i].SENSORS_TSB_ID == IdArray[j]){\n            ArrayID.push(inData[j]);\n        }\n    }\n    ArrayID.sort(sortFunction);\n    GroupIdOut[inData[i].SENSORS_TSB_ID] = ArrayID;\n}\nGroupIdOut.splice(0,1);\nmsg.GroupIdOut = GroupIdOut;\n// \n//формування ответа\n\nvar GroupSensor = [];\n\n for(let i = 0; i < GroupIdOut.length; i++){\n    let group = {\n        GroupBob:[]\n    };\n    for(let j = 0; j < GroupIdOut[i].length; j++){\n        group.silos = GroupIdOut[i][j].SILAGES_NO;\n        let jsonGroup =\n            {\n              name: GroupIdOut[i][j].LAVALIERS_NO + '_' + GroupIdOut[i][j].SENSORS_LEVEL,\n              name_r:(j < 10) ? `0${j}` : `${j}`,\n              name_l:`${j}`,\n            };\n        group.GroupBob.push(jsonGroup);\n        group.SerialNumber = GroupIdOut[i][j].LAVALIERS_NO;\n        group.Name = GroupIdOut[i][j].LAVALIERS_NO;  \n         \n    }\n    GroupSensor.push(group);\n }\n\n\n// //присвоэння выдповыды\n\nmsg.payload = {\n    GroupSensor: GroupSensor\n};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":1100,"wires":[["82c76262.9fd5c"]]},{"id":"82c76262.9fd5c","type":"debug","z":"2683001c.e8587","name":"","active":true,"console":"false","complete":"false","x":710,"y":1100,"wires":[]},{"id":"1e9e822f.30a78e","type":"comment","z":"2683001c.e8587","name":"Structura Podves and Silos","info":"5: object\n    name: \"2_5\"\n    name_r: \"Датчик05\"\n    name_l: \"Рiвень 5\"\nsilos: \"1\"\nSerialNumber: 2 // id leveris\nName: \"10103\"   // name leveris","x":430,"y":1060,"wires":[]},{"id":"a2578a7c.79f0a8","type":"function","z":"2683001c.e8587","name":"Query to DB","func":"//var id = Number(msg.req.query.id)\nvar id = 2000\n\n\nvar Select = `\nSELECT \nTLMAX.LOG_RECNO,\nTLMAX.DATETIME,\nTLMAX.SILAGE_ID,\nTLMAX.LEVEL,\nTLMAX.SENSOR_ONLINE,\nTLMAX.SENSOR_STATE,\nTLMAX.SENSOR_VALUE,\nTLMAX.USER_VALUE ,\nSILAGES.NO as SILAGES_NO,\nSILAGES.ORDER as SILAGES_ORDER,\nLAVALIERS.ID as LAVALIERS_ID,\nLAVALIERS.NO as LAVALIERS_NO\nFROM TLMAX, SILAGES , LAVALIERS\nWHERE (LOG_RECNO = ${id} AND TLMAX.SILAGE_ID = SILAGES.ID AND LAVALIERS.SILAGE_ID = SILAGES.ID)\nORDER BY DATETIME DESC`\n\n\nmsg.topic = Select;\n\nreturn msg;","outputs":1,"noerr":0,"x":290,"y":1240,"wires":[["430f2966.536938"]]},{"id":"5393e7df.61cf98","type":"function","z":"2683001c.e8587","name":"","func":"var inputDate = msg.payload;\nvar id = msg.payload[0].LOG_RECNO;\nvar Zam_date = msg.payload[0].DATETIME\nvar sensorArray = [];\nvar out_temp = ''\nvar out_name = ''\n\nfor(let i = 0; i < inputDate.length; i++){\n    sensorArray[i] = {\n        'name': inputDate[i].LAVALIERS_NO + '_' + inputDate[i].LEVEL,\n        'temp': inputDate[i].USER_VALUE\n    }\n}\n\n// const idx_out = sensorArray.findIndex((element, index) => {\n//     if(element.name === \"305_0\"){\n//         return true\n//     }\n// });\n//out_temp = sensorArray[idx_out].temp\n//out_name = sensorArray[idx_out].name\n//sensorArray.splice(idx_out, 1);\n\n//var ary = sensorArray.slice(70,80);\n\n\n\n\nmsg.payload = {\n    DTLINECREATE: Zam_date,\n    id: id,\n    //out_temp,\n    //out_name,\n    sensors: sensorArray\n}\nreturn msg;","outputs":1,"noerr":0,"x":591.9998779296875,"y":1236.9999723434448,"wires":[["cda8d87b.bd4be8"]]},{"id":"430f2966.536938","type":"mysql","z":"2683001c.e8587","mydb":"30d3b88a.5d85c8","name":"","x":449.99995040893555,"y":1238.9999694824219,"wires":[["5393e7df.61cf98","bcd24d54.f705a"]]},{"id":"bcf4d759.132e98","type":"comment","z":"2683001c.e8587","name":"Get sensor and value by ID","info":"LOG_RECNO: 2818\nDATETIME: \"2022-10-15T12:20:48.000Z\"","x":430,"y":1180,"wires":[]},{"id":"4c990d67.788004","type":"inject","z":"2683001c.e8587","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":140,"y":1240,"wires":[["a2578a7c.79f0a8"]]},{"id":"cda8d87b.bd4be8","type":"debug","z":"2683001c.e8587","name":"","active":true,"console":"false","complete":"false","x":730,"y":1240,"wires":[]},{"id":"74f4debe.2560f","type":"function","z":"2683001c.e8587","name":"Query to DB","func":"//var id = Number(msg.req.query.id)\nvar id = 2000\n\n\nvar Select = `\nSELECT * FROM TLMAX\nWHERE (LOG_RECNO = ${id} AND LAVALIERS.SILAGE_ID = SILAGES.ID)\nORDER BY DATETIME DESC`\n\n\n\nmsg.topic = Select;\n\nreturn msg;","outputs":1,"noerr":0,"x":230,"y":1180,"wires":[[]]},{"id":"bcd24d54.f705a","type":"debug","z":"2683001c.e8587","name":"","active":true,"console":"false","complete":"false","x":620,"y":1180,"wires":[]},{"id":"9b82b6d1.400cb8","type":"debug","z":"2683001c.e8587","name":"","active":false,"console":"false","complete":"false","x":550,"y":1020,"wires":[]},{"id":"14af44dd.d6da7b","type":"function","z":"2683001c.e8587","name":"Group DEV","func":"//допомыжны функцыъ\n\nfunction silageName2(tbs_number){\n    let numberTBS = Number(tbs_number)\n    if(tbs_number >= 10000 && tbs_number <=19999) return '1'\n    else if(tbs_number >= 20000 && tbs_number <= 29999) return '2'\n    else if(tbs_number >= 30000 && tbs_number <= 39999) return '3'\n    else if(tbs_number >= 40000 && tbs_number <= 49999) return '4'\n    else if(tbs_number >= 50000 && tbs_number <= 59999) return '5'\n    else return tbs_number\n}\n\n\n\n// function renameSerialNumber(number){\n//     if(number > 300){\n//         return Number(number.toString().replace(\"3\",''));\n//     }\n//     return number;\n// }\n\n\nfunction sortFunction(a,b){\n    return parseInt(a.LEVEL) - parseInt(b.LEVEL);\n}\n\n\n//ыныцыализацыя\n\nvar inData = msg.payload;\nvar IdArray = []; //id termoPodves\nvar GroupIdOut = [];\n\n//групування по ID\nfor(let i = 0; i < inData.length; i++){\n    IdArray.push(inData[i].SENSORS_TSB_ID);\n}\n\n\n\nfor(let i = 0; i < inData.length; i++){\n    let ArrayID = [];\n    for(let j = 0; j < IdArray.length; j++){\n        if(inData[i].SENSORS_TSB_ID == IdArray[j]){\n            ArrayID.push(inData[j]);\n        }\n    }\n    ArrayID.sort(sortFunction);\n    GroupIdOut[inData[i].SENSORS_TSB_ID] = ArrayID;\n}\nGroupIdOut.splice(0,1);\nmsg.GroupIdOut = GroupIdOut;\n// \n//формування ответа\n\nvar GroupSensor = [];\n\n for(let i = 0; i < GroupIdOut.length; i++){\n    let group = {\n        GroupBob:[]\n    };\n    for(let j = 0; j < GroupIdOut[i].length; j++){\n        group.silos = GroupIdOut[i][j].TBS_name;\n        let jsonGroup =\n            {\n              name: GroupIdOut[i][j].LAVALIERS_NO + '_' + GroupIdOut[i][j].SENSORS_LEVEL,\n              name_r:(j < 10) ? `Датчик0${j}` : `Датчик${j}`,\n              name_l:`Рiвень ${j}`,\n            };\n        group.GroupBob.push(jsonGroup);\n        group.SerialNumber = GroupIdOut[i][j].LAVALIERS_SILAGE_ID;\n        group.Name = GroupIdOut[i][j].TBS_name;  \n         \n    }\n    GroupSensor.push(group);\n }\n\n\n// //присвоэння выдповыды\n\nmsg.payload = {\n    GroupSensor: GroupSensor\n};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":730,"y":1000,"wires":[[]]},{"id":"efe49f9d.9c1ec","type":"http in","z":"ff01d09f.6d81a","name":"","url":"/get/podves/termiks","method":"get","swaggerDoc":"","x":180,"y":660,"wires":[["eb1e2c0f.9ef5c","a51547a6.3f6c78"]]},{"id":"fef872b0.33d45","type":"http response","z":"ff01d09f.6d81a","name":"","x":710,"y":720,"wires":[]},{"id":"3fb6aff4.64881","type":"comment","z":"ff01d09f.6d81a","name":"Structura Podves and Silos","info":"","x":170,"y":620,"wires":[]},{"id":"2c47abda.e5e4b4","type":"function","z":"ff01d09f.6d81a","name":"Query to DB","func":"var id = Number(msg.req.query.id)\n//var id = 200\n\n\n\nvar Select = `\nSELECT \nTLMAX.LOG_RECNO,\nTLMAX.DATETIME,\nTLMAX.SILAGE_ID,\nTLMAX.LEVEL,\nTLMAX.SENSOR_ONLINE,\nTLMAX.SENSOR_STATE,\nTLMAX.SENSOR_VALUE,\nTLMAX.USER_VALUE ,\nSILAGES.NO as SILAGES_NO,\nSILAGES.ORDER as SILAGES_ORDER,\nLAVALIERS.ID as LAVALIERS_ID,\nLAVALIERS.NO as LAVALIERS_NO\nFROM TLMAX, SILAGES , LAVALIERS\nWHERE (LOG_RECNO = ${id} AND TLMAX.SILAGE_ID = SILAGES.ID AND LAVALIERS.SILAGE_ID = SILAGES.ID)\nORDER BY DATETIME DESC`\n\n\nmsg.topic = Select;\n\nreturn msg;","outputs":1,"noerr":0,"x":392.8959045410156,"y":979.8889245986938,"wires":[["acda077e.a93b38"]]},{"id":"acda077e.a93b38","type":"mysql","z":"ff01d09f.6d81a","mydb":"30d3b88a.5d85c8","name":"","x":552.8958549499512,"y":978.8888940811157,"wires":[["ed8180da.4b56b","f98288bc.991098"]]},{"id":"ed8180da.4b56b","type":"function","z":"ff01d09f.6d81a","name":"","func":"var inputDate = msg.payload;\nvar id = msg.payload[0].LOG_RECNO;\nvar Zam_date = msg.payload[0].DATETIME\nvar sensorArray = [];\nvar out_temp = ''\nvar out_name = ''\n\nfor(let i = 0; i < inputDate.length; i++){\n    sensorArray[i] = {\n        'name': inputDate[i].LAVALIERS_NO + '_' + inputDate[i].LEVEL,\n        'temp': inputDate[i].USER_VALUE\n    }\n}\n\n// const idx_out = sensorArray.findIndex((element, index) => {\n//     if(element.name === \"305_0\"){\n//         return true\n//     }\n// });\n//out_temp = sensorArray[idx_out].temp\n//out_name = sensorArray[idx_out].name\n//sensorArray.splice(idx_out, 1);\n\n//var ary = sensorArray.slice(70,80);\n\n\n\n\nmsg.payload = {\n    DTLINECREATE: Zam_date,\n    id: id,\n    //out_temp,\n    //out_name,\n    sensors: sensorArray\n}\nreturn msg;","outputs":1,"noerr":0,"x":694.8957824707031,"y":976.8888969421387,"wires":[["f3cae8b3.c66d08","f78387cf.398ff8"]]},{"id":"f3cae8b3.c66d08","type":"http response","z":"ff01d09f.6d81a","name":"","x":818.8958282470703,"y":979.8889207839966,"wires":[]},{"id":"1408d117.1ba7ef","type":"http in","z":"ff01d09f.6d81a","name":"","url":"/get/getSensor","method":"get","swaggerDoc":"","x":174.8958282470703,"y":980.8888931274414,"wires":[["2c47abda.e5e4b4","1559db24.8ab405"]]},{"id":"2fc80390.e4cb9c","type":"comment","z":"ff01d09f.6d81a","name":"Get sensor and value by ID","info":"LOG_RECNO: 2818\nDATETIME: \"2022-10-15T12:20:48.000Z\"","x":195.82640075683594,"y":929.263916015625,"wires":[]},{"id":"dac085c2.25d4c8","type":"function","z":"ff01d09f.6d81a","name":"","func":"msg.payload = {\n    message:\"not data found\"\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":573.8958320617676,"y":1091.8888854980469,"wires":[["7d0b1710.8accc8"]]},{"id":"7d0b1710.8accc8","type":"http response","z":"ff01d09f.6d81a","name":"","x":705.895824432373,"y":1093.8888835906982,"wires":[]},{"id":"f98288bc.991098","type":"function","z":"ff01d09f.6d81a","name":"reset","func":"msg.reset = true\nreturn msg;","outputs":1,"noerr":0,"x":426.8959312438965,"y":1039.8889236450195,"wires":[["1559db24.8ab405"]]},{"id":"1559db24.8ab405","type":"trigger","z":"ff01d09f.6d81a","op1":"","op2":"{}","op1type":"nul","op2type":"json","duration":"4","extend":false,"units":"s","reset":"","name":"","x":425.89588928222656,"y":1094.8889865875244,"wires":[["dac085c2.25d4c8"]]},{"id":"eb1e2c0f.9ef5c","type":"debug","z":"ff01d09f.6d81a","name":"","active":true,"console":"false","complete":"false","x":430,"y":620,"wires":[]},{"id":"f78387cf.398ff8","type":"debug","z":"ff01d09f.6d81a","name":"","active":true,"console":"false","complete":"false","x":817.8403472900391,"y":906.9548645019531,"wires":[]},{"id":"4a59e781.501058","type":"debug","z":"ff01d09f.6d81a","name":"","active":true,"console":"false","complete":"true","x":590,"y":660,"wires":[]},{"id":"a51547a6.3f6c78","type":"function","z":"ff01d09f.6d81a","name":"query DB Group","func":"var Select = `\nSELECT  \nLAVALIERS.ID as LAVALIERS_ID, \nLAVALIERS.NO as LAVALIERS_NO, \nLAVALIERS.SILAGE_ID as LAVALIERS_SILAGE_ID, \nLAVALIERS.LevelCount as LAVALIERS_LevelCount, \nLAVALIERS.LevelOffs as LAVALIERS_LevelOffs, \nLAVALIERS.LoadLevels as LAVALIERS_LoadLevels, \nLAVALIERS.DeviceAddr as LAVALIERS_DeviceAddr,\nSENSORS.TSB_ID as SENSORS_TSB_ID, \nSENSORS.LEVEL as SENSORS_LEVEL, \nSENSORS.ONLINE, \nSENSORS.USER_T,\nSILAGES.ID AS SILAGES_ID, \nSILAGES.NO AS SILAGES_NO\nFROM LAVALIERS, SENSORS, SILAGES\nWHERE (LAVALIERS.ID = SENSORS.TSB_ID AND LAVALIERS.SILAGE_ID = SILAGES.ID)\nORDER BY SENSORS.TSB_ID ASC`;\n\nmsg.topic = Select;\n\nreturn msg;\n//","outputs":1,"noerr":0,"x":140,"y":720,"wires":[["2ff692cc.a9ad6e"]]},{"id":"2ff692cc.a9ad6e","type":"mysql","z":"ff01d09f.6d81a","mydb":"30d3b88a.5d85c8","name":"","x":330,"y":720,"wires":[["5d0795b0.6b03dc"]]},{"id":"5d0795b0.6b03dc","type":"function","z":"ff01d09f.6d81a","name":"Group DEV","func":"function sortFunction(a,b){\n    return parseInt(a.SENSORS_LEVEL) - parseInt(b.SENSORS_LEVEL);\n}\n\n\n//ыныцыализацыя\n\nvar inData = msg.payload;\nvar IdArray = []; //id termoPodves\nvar GroupIdOut = [];\n\n//групування по ID podveska\nfor(let i = 0; i < inData.length; i++){\n    IdArray.push(inData[i].SENSORS_TSB_ID);\n}\n\n\n\nfor(let i = 0; i < inData.length; i++){\n    let ArrayID = [];\n    for(let j = 0; j < IdArray.length; j++){\n        if(inData[i].SENSORS_TSB_ID == IdArray[j]){\n            ArrayID.push(inData[j]);\n        }\n    }\n    ArrayID.sort(sortFunction);\n    GroupIdOut[inData[i].SENSORS_TSB_ID] = ArrayID;\n}\nGroupIdOut.splice(0,1);\nmsg.GroupIdOut = GroupIdOut;\n// \n//формування ответа\n\nvar GroupSensor = [];\n\n for(let i = 0; i < GroupIdOut.length; i++){\n    let group = {\n        GroupBob:[]\n    };\n    for(let j = 0; j < GroupIdOut[i].length; j++){\n        group.silos = GroupIdOut[i][j].SILAGES_NO;\n        let jsonGroup =\n            {\n              name: GroupIdOut[i][j].LAVALIERS_NO + '_' + GroupIdOut[i][j].SENSORS_LEVEL,\n              name_r:(j < 10) ? `0${j}` : `${j}`,\n              name_l:`${j}`,\n            };\n        group.GroupBob.push(jsonGroup);\n        group.SerialNumber = GroupIdOut[i][j].LAVALIERS_NO;\n        group.Name = GroupIdOut[i][j].LAVALIERS_NO;  \n         \n    }\n    GroupSensor.push(group);\n }\n\n\n// //присвоэння выдповыды\n\nmsg.payload = {\n    GroupSensor: GroupSensor\n};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":720,"wires":[["fef872b0.33d45","4a59e781.501058"]]},{"id":"17580cd3.3acee3","type":"inject","z":"ff01d09f.6d81a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":120,"y":540,"wires":[["a51547a6.3f6c78"]]},{"id":"258311d4.2bf9fe","type":"inject","z":"ff01d09f.6d81a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":120,"y":820,"wires":[["a51547a6.3f6c78"]]}]
