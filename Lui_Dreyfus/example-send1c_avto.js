[{"id":"3d007ef4.e60402","type":"tab","label":"Avto_1 processing_scale1","disabled":false},{"id":"a6a1b4e1.beb968","type":"file","z":"3d007ef4.e60402","name":"deivce_config","filename":"deivce_config.json","appendNewline":true,"createDir":false,"overwriteFile":"true","x":480,"y":160,"wires":[[]]},{"id":"f32802ee.637f6","type":"exec","z":"3d007ef4.e60402","command":"cat /proc/cpuinfo","addpay":true,"append":"| grep Serial","useSpawn":"","timer":"5","name":"","x":367.0000228881836,"y":38,"wires":[["538df836.6e3ce8","aadaebd7.76ba98"],[],[]]},{"id":"f7f8df44.ea8e8","type":"function","z":"3d007ef4.e60402","name":"main config","func":"flow.set('prevWeight',null);\nflow.set('transaction',null);\nflow.set('transactionData',[]);\nflow.set('transactionMaxWeight',null);\nflow.set('transactionHasMinWeight',null);\nflow.set('transactionHasMaxWeight',null);\nflow.set('transactionHasMaxDuration',null);\nflow.set('lasttimedata', new Date());\nflow.set('checkHealth',null);\nflow.set('transactionWaybill',null);\nflow.set('transactionAccWeight', null);\nflow.set('transactionHasOverLoad', null);\nflow.set('transactionOperationName', null);\n\nreturn msg;\n","outputs":1,"noerr":0,"x":469,"y":257,"wires":[[]]},{"id":"eb73abdf.5b7498","type":"inject","z":"3d007ef4.e60402","name":"","repeat":"","crontab":"","once":true,"topic":"","payload":"","payloadType":"str","x":96.85713958740234,"y":220.28570556640625,"wires":[["5baac065.e7118","140c0dfd.4f6db2"]]},{"id":"8278013e.647fb","type":"http in","z":"3d007ef4.e60402","name":"","url":"/firmware","method":"post","swaggerDoc":"","x":160,"y":160,"wires":[["a6a1b4e1.beb968"]]},{"id":"5baac065.e7118","type":"file in","z":"3d007ef4.e60402","name":"deivce_config","filename":"deivce_config.json","format":"utf8","x":479,"y":217,"wires":[["e3f90c68.b4591"]]},{"id":"12c7f997.17e066","type":"http in","z":"3d007ef4.e60402","name":"","url":"/serial","method":"get","swaggerDoc":"","x":136,"y":34.000000953674316,"wires":[["f32802ee.637f6"]]},{"id":"538df836.6e3ce8","type":"http response","z":"3d007ef4.e60402","name":"","x":595,"y":20,"wires":[]},{"id":"aadaebd7.76ba98","type":"function","z":"3d007ef4.e60402","name":"","func":"msg.payload = msg.payload.split(':')[1].replace('\\n','').replace(' ','');\nreturn msg;","outputs":1,"noerr":0,"x":601,"y":56,"wires":[[]]},{"id":"331a7992.9dbb76","type":"inject","z":"3d007ef4.e60402","name":"DEMO","repeat":"10800","crontab":"","once":true,"topic":"","payload":"","payloadType":"str","x":116,"y":112.57142639160156,"wires":[["e4af370d.574678"]]},{"id":"e4af370d.574678","type":"function","z":"3d007ef4.e60402","name":"DEMO Data","func":"var device_config = {\n    'event_move_in_id':'80096D9ABE7F68F3E0533300000A6C0D',\n    'event_move_in_minus_id':'8DB9B239DF5252F0E055000000000001',\n    'event_move_out_id':'80096D9ABE8068F3E0533300000A6C0D',\n    'event_max_weight_id':'85A255F950F9BEF4E0533300000AC45D',\n    'event_on_id': '85A2CC45702A2DD1E0533300000A0C94',\n    'event_off_id':'85A2CC4570292DD1E0533300000A0C94',\n    'event_max_duration':'8642EE858DE89BAAE0533300000AFCC7',\n    'event_fake_traffic':'80096EF60C186574E0533300000ADBA5',\n    'event_get_weight_acc':'800970AC1FDC683CE0533300000AF1B0',\n    'event_min_weight':'875C3EB5C9DD092DE055000000000001',\n    'event_driver_in':'8E68D8D8B2977181E055000000000001',\n    'event_over_load':'B3EB5F800EFD2620E0530101007F8A05',\n    'snapshot_events':['80096D9ABE7F68F3E0533300000A6C0D','85A255F950F9BEF4E0533300000AC45D','8642EE858DE89BAAE0533300000AFCC7','800970AC1FDC683CE0533300000AF1B0', \"8E68D8D8B2977181E055000000000001\",\"B3EB5F800EFD2620E0530101007F8A05\"],\n    'main_host':'https://10.107.5.200:8443/ords/ettn',\n    'event_url':'/iot_cli/events/log',\n    'state_url':'/iot_cli/device',\n    'snapshot_url':'/iot_cli/events/snapshot',\n    'maxWeight':60000,\n    'maxDuration':600000,\n    'minWeight':-40,\n    'checkHealthTimeout':3000,\n    'minTriggerWeight':40,\n    'driverWeight':80,\n    'overLoadWeight': 200\n}\nmsg.payload = device_config;\n// flow.set('scale_id','80096CB0EFD83B63E0533300000A4334');\n// flow.set('event_move_in_id','80096D9ABE7F68F3E0533300000A6C0D');\n// flow.set('event_move_out_id','80096D9ABE8068F3E0533300000A6C0D');\n// flow.set('event_max_weight_id','85A255F950F9BEF4E0533300000AC45D');\n// flow.set('event_off_id','85A2CC4570292DD1E0533300000A0C94');\n// flow.set('event_on_id', '85A2CC45702A2DD1E0533300000A0C94');\n// flow.set('event_max_duration','8642EE858DE89BAAE0533300000AFCC7');\n// flow.set('main_host','http://prod.apex.rest/ords/ettn');\n// flow.set('event_url','/iot_cli/events/log');\n// flow.set('state_url','/v1/device');\n// flow.set('maxWeight',40000);\n// flow.set('maxDuration',20000);\n// flow.set('checkHealthTimeout',3000);\nreturn msg;","outputs":1,"noerr":0,"x":295.0000228881836,"y":113.00000190734863,"wires":[["a6a1b4e1.beb968"]]},{"id":"e3f90c68.b4591","type":"function","z":"3d007ef4.e60402","name":"device config","func":"var device_config = JSON.parse(msg.payload);\n\nflow.set('scale_id',device_config.scale_id);\nflow.set('event_move_in_id',device_config.event_move_in_id);\nflow.set('event_move_in_minus_id',device_config.event_move_in_minus_id);\nflow.set('event_move_out_id',device_config.event_move_out_id);\nflow.set('event_max_weight_id',device_config.event_max_weight_id);\nflow.set('event_off_id',device_config.event_off_id);\nflow.set('event_on_id', device_config.event_on_id);\nflow.set('event_max_duration',device_config.event_max_duration);\nflow.set('event_fake_traffic',device_config.event_fake_traffic);\nflow.set('event_driver_in', device_config.event_driver_in);\nflow.set('event_over_load',device_config.event_over_load);\nflow.set('main_host',device_config.main_host);\nflow.set('event_url',device_config.event_url);\nflow.set('state_url',device_config.state_url);\nflow.set('maxWeight',device_config.maxWeight);\nflow.set('minWeight',device_config.minWeight);\nflow.set('maxDuration',device_config.maxDuration);\nflow.set('checkHealthTimeout',device_config.checkHealthTimeout);\nflow.set('event_get_weight_acc',device_config.event_get_weight_acc);\nflow.set('event_min_weight',device_config.event_min_weight);\nflow.set('minTriggerWeight',device_config.minTriggerWeight);\nflow.set('snapshot_url',device_config.snapshot_url);\nflow.set('snapshot_events',device_config.snapshot_events);\nflow.set('driverWeight',device_config.driverWeight);\nflow.set('overLoadWeight', device_config.overLoadWeight);\n\nmsg.payload = {\n\tscale_id: flow.get('scale_id'),\n\tevent_move_in_id: flow.get('event_move_in_id'),\n\tevent_move_in_minus_id: flow.get('event_move_in_minus_id'),\n\tevent_move_out_id: flow.get('event_move_out_id'),\n\tevent_max_weight_id: flow.get('event_max_weight_id'),\n\tevent_off_id: flow.get('event_off_id'),\n\tevent_on_id: flow.get('event_on_id'),\n\tevent_max_duration: flow.get('event_max_duration'),\n\tevent_fake_traffic: flow.get('event_fake_traffic'),\n\tevent_driver_in: flow.get('event_driver_in'),\n\tevent_over_load: flow.get('event_over_load'),\n\tmain_host: flow.get('main_host'),\n\tevent_url: flow.get('event_url'),\n\tstate_url: flow.get('state_url'),\n\tmaxWeight: flow.get('maxWeight'),\n\tminWeight: flow.get('minWeight'),\n\tmaxDuration: flow.get('maxDuration'),\n\tcheckHealthTimeout: flow.get('checkHealthTimeout'),\n\tevent_get_weight_acc: flow.get('event_get_weight_acc'),\n\tevent_min_weight: flow.get('event_min_weight'),\n\tminTriggerWeight: flow.get('minTriggerWeight'),\n\tsnapshot_url: flow.get('snapshot_url'),\n\tsnapshot_events: flow.get('snapshot_events'),\n\tdriverWeight: flow.get('driverWeight'),\n\toverLoadWeight: flow.get('overLoadWeight')\n};\n\nreturn msg;\n","outputs":1,"noerr":0,"x":670,"y":220,"wires":[["95f3f725.b5aba8"]]},{"id":"95f3f725.b5aba8","type":"json","z":"3d007ef4.e60402","name":"","x":830,"y":220,"wires":[["e939033e.7e4da"]]},{"id":"e939033e.7e4da","type":"debug","z":"3d007ef4.e60402","name":"IN device config","active":false,"console":"false","complete":"true","x":1000,"y":220,"wires":[]},{"id":"ad9137a3.0a6a88","type":"function","z":"3d007ef4.e60402","name":"transactionHasMaxWeight","func":"msg.event_id = flow.get('event_max_weight_id');\nmsg.description = 'Перевищена максимально-допустима вага, кг: ' + msg.metadata.weight;\n\n\nreturn msg;","outputs":1,"noerr":0,"x":662.6666259765625,"y":564.6666374206543,"wires":[["67ebed51.1caaf4"]]},{"id":"6238f64d.bf8858","type":"switch","z":"3d007ef4.e60402","name":"switch max weight","property":"transactionHasMaxWeight","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":422.6666259765625,"y":564.6666374206543,"wires":[["ad9137a3.0a6a88"]]},{"id":"67ebed51.1caaf4","type":"function","z":"3d007ef4.e60402","name":"events payload","func":"var event_id = msg.event_id;\nvar scale_id = global.get('scale_id_in');\nvar snapshot_events = flow.get('snapshot_events');\nvar snapshot = false;\n\nif (snapshot_events.indexOf(event_id)>=0){\n    snapshot = true;\n}\n\nmsg.payload = {\n    'event':{\n        'id':msg.event_id\n    },\n    'devices':[{'id':scale_id}],\n    'data':msg.metadata,\n    'description':msg.description\n}\n\nmsg.headers = {\n    \"content-type\":\"application/json\"\n}\n\nmsg.url = flow.get('main_host')+flow.get('event_url');\nmsg.main_host = flow.get('main_host');\nmsg.event_url = flow.get('event_url');\nmsg.snapshot = snapshot;\nreturn msg;","outputs":1,"noerr":0,"x":989.6666870117188,"y":528.0951538085938,"wires":[["a3674345.1e5f2","72f267b3.c72018"]]},{"id":"72b134ef.51a8cc","type":"function","z":"3d007ef4.e60402","name":"main module","func":"var prevWeight = flow.get('prevWeight');\nvar transaction = flow.get('transaction');\nvar transactionData = flow.get('transactionData');\nvar transactionMaxWeight = flow.get('transactionMaxWeight');\nvar transactionHasMaxWeight = flow.get('transactionHasMaxWeight');\nvar transactionHasMinWeight = flow.get('transactionHasMinWeight');\nvar transactionHasMaxDuration = flow.get('transactionHasMaxDuration');\nvar transactionOperationName = flow.get('transactionOperationName');\n\nvar waybill = flow.get('transactionWaybill');\nvar weight = msg.payload;\nvar stableSize = 5;\nvar duration = 0;\nvar operation_name_income = \"Приход (авто)\";\nvar maxWeight = flow.get('maxWeight');\nvar maxDuration = flow.get('maxDuration');\nvar prevTransaction = transaction;\nvar minWeight = flow.get('minWeight');\nvar minTriggerWeight = flow.get('minTriggerWeight');\nvar is_minus = false;\nvar transactionAccWeight = flow.get('transactionAccWeight');//облікова вага\nvar overLoadWeight = flow.get('overLoadWeight');\n\n//transaction\nif (prevWeight === null){\n    prevWeight = msg.payload;    \n}else{\n    if((prevWeight <= 0) && (weight > 0) && (weight > minTriggerWeight)){\n        //start of transaction\n        transaction = Date.now();\n        msg.on = true;\n        flow.set('transaction',transaction);\n    }else if((prevWeight > 0) && (weight <=0) && (transaction)){\n        //transaction = 0;\n        msg.on = false;\n        transactionData = [];\n        flow.set('transaction',0);\n        flow.set('transactionMaxWeight',null);\n        flow.set('transactionHasMaxWeight',null);\n        flow.set('transactionHasMinWeight',null);\n        flow.set('transactionHasMaxDuration',null);\n        flow.set('transactionHasOverLoad',null);\n        flow.set('transactionOperationName',null);\n        flow.set('transactionWaybill',null);\n        flow.set('transactionMetadata',null);\n        flow.set('transactionAccWeight', null);//облікова вага\n    }else if((transaction === null) && (weight>0) && (weight > minTriggerWeight)){\n        transaction = Date.now();\n        flow.set('transaction',transaction);\n    }\n    if((prevWeight < 0) && ((weight-prevWeight) > minTriggerWeight)){\n        //start of transaction\n        is_minus = true;\n        msg.prevWeight = prevWeight;\n    }\n}\n\nif (transaction > 0){\n    transactionData.push(weight);    \n\n    //stable\n    if(transactionData.length > stableSize+1){\n        var stabletmp = true;\n        for (var i = transactionData.length-1; i > transactionData.length-1-stableSize; i--){\n            if (transactionData[i] !== transactionData[i-1]){\n                stabletmp = false;\n                msg.stable = stabletmp;\n                break;\n            }\n            msg.stable = stabletmp;\n        }\n    }else{\n        msg.stable = false;\n    }\n\n    //duration & transactionMaxWeight\n    duration = (Number(Date.now()) - Number(transaction));\n    if( (weight>transactionMaxWeight) || (transactionMaxWeight === null)){\n        transactionMaxWeight = weight;\n        flow.set(\"transactionMaxWeight\",transactionMaxWeight);\n    }\n    \n    if(!transactionHasMaxWeight && weight > maxWeight){\n        msg.transactionHasMaxWeight = true;\n        flow.set('transactionHasMaxWeight',true);\n    }\n    \n    if(!transactionHasMinWeight && weight < minWeight){\n        msg.transactionHasMinWeight = true;\n        flow.set('transactionHasMinWeight',true);\n    }\n    \n    //max duartion\n    if(!transactionHasMaxDuration && duration > maxDuration){\n        msg.transactionHasMaxDuration = true;\n        flow.set('transactionHasMaxDuration',true);\n    }\n}\n\n//result\nmsg.metadata = {\n    'weight':weight,\n    'prevWeight':prevWeight,\n    'prevTransaction':prevTransaction,\n    'transaction':transaction,\n    'on':msg.on,\n    'transactionDataCount':transactionData.length,\n    'stable':msg.stable,\n    'duration':Math.round(duration/1000),\n    'transactionMaxWeight':transactionMaxWeight,\n    'transactionAccWeight':transactionAccWeight,\n    'waybill':waybill,\n    'perimetr':true,\n    'weight1':msg.weight1,\n    'weight2':msg.weight2,\n    'weight_center':msg.weight_center,\n    'driverInCar':false,\n    'transactionOperationName':transactionOperationName\n}\nflow.set('transactionData',transactionData);\nflow.set('prevWeight',weight);\nflow.set('transactionMetadata',msg.metadata);\nflow.set('lasttimedata', new Date());\nmsg.is_minus = is_minus;\n\nif(transactionAccWeight && transactionOperationName!==operation_name_income){\n    \n   flow.set('transactionHasOverLoad',(weight-transactionAccWeight)>overLoadWeight);\n   \n}\n\nreturn msg;","outputs":1,"noerr":0,"x":170,"y":540,"wires":[["e5542ed2.9e6f5","6238f64d.bf8858","f7491b3d.962198","a9abc32.046714","ec900222.9b278","efc8ce48.7ccb4","6e378d4a.59f804"]]},{"id":"14f89004.2f8d8","type":"function","z":"3d007ef4.e60402","name":"get weight from accounting system","func":"var transactionMetadata = flow.get('transactionMetadata');\nvar transactionMaxWeight = flow.get('transactionMaxWeight');\nvar driverWeight = flow.get('driverWeight');\nvar buisness_data = msg.req.query;\n\nmsg.metadata = Object.assign(transactionMetadata,buisness_data);\n\n//check driver in a car\nvar driver_in = false;\nmsg.driverWeight = driverWeight;\nif((transactionMaxWeight - msg.metadata.weight) < driverWeight){\n    driver_in = true;\n}\n\nmsg.event_id = flow.get('event_get_weight_acc');\ntransactionWaybill = flow.get('transactionWaybill');\nif (!transactionWaybill){\n    flow.set('transactionWaybill',msg.req.query.reader);\n}\nmsg.description = ' '+buisness_data.operation_name+'. '+buisness_data.operation_type+'. Зважили в 1С. Поточна вага: ' + msg.metadata.weight+\" Номер авто: \"+buisness_data.truck1+\" \"+buisness_data.truck2+\" \"+buisness_data.item_name + \", ТТН: \" + buisness_data.waybill;\nmsg.transactionMetadata = transactionMetadata;\nmsg.driver_in = driver_in;\n\nflow.set('transactionAccWeight',  msg.metadata.weight);//облікова вага\nflow.set('transactionOperationName',  msg.metadata.operation_name);//вид операції\n\nreturn msg;","outputs":1,"noerr":0,"x":520,"y":920,"wires":[["7f829d33.911d94","67ebed51.1caaf4"]]},{"id":"90fd8df.838e47","type":"http request","z":"3d007ef4.e60402","name":"EVENTS","method":"POST","ret":"txt","url":"","tls":"e8a6e3c7.a7a1b","x":1266.0000076293945,"y":560.2221832275391,"wires":[["c0020365.338ea"]]},{"id":"808782c.f67398","type":"switch","z":"3d007ef4.e60402","name":"take snapshot","property":"snapshot","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":1300,"y":680,"wires":[["9f973f1a.b21d"]]},{"id":"a3674345.1e5f2","type":"json","z":"3d007ef4.e60402","name":"","x":1170,"y":480,"wires":[["98032e3a.c614e"]]},{"id":"72f267b3.c72018","type":"debug","z":"3d007ef4.e60402","name":"Avto 1 IN event","active":false,"console":"false","complete":"true","x":1176.6666259765625,"y":418.6666259765625,"wires":[]},{"id":"bff8e2dd.1b651","type":"function","z":"3d007ef4.e60402","name":"move in","func":"msg.event_id = flow.get('event_move_in_id');\nmsg.description = 'Заїзд на ваги. Поточна вага: ' + msg.metadata.weight;\n\nreturn msg;","outputs":1,"noerr":0,"x":612.6666259765625,"y":484.6666374206543,"wires":[["67ebed51.1caaf4"]]},{"id":"c105ba.3a374a48","type":"function","z":"3d007ef4.e60402","name":"off","func":"msg.event_id = flow.get('event_off_id');\nmsg.description = 'Прилад відключено';\nmsg.metadata = {\n    'state':msg.checkHealth\n}\nreturn msg;","outputs":1,"noerr":0,"x":560.6666259765625,"y":777.6666259765625,"wires":[["36a6820a.d997de"]]},{"id":"7e485d59.c501a4","type":"function","z":"3d007ef4.e60402","name":"on","func":"msg.event_id = flow.get('event_on_id');\nmsg.description = 'Прилад підключено';\nmsg.metadata = {\n    'state':msg.checkHealth\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":558.6666259765625,"y":736.6666259765625,"wires":[["3335d3ff.f9ca4c"]]},{"id":"89a4dbee.d1d3c8","type":"function","z":"3d007ef4.e60402","name":"move out","func":"msg.event_id = flow.get('event_move_out_id');\nmsg.description = 'Зїзд з ваг. Максимальна вага: ' + msg.metadata.transactionMaxWeight;\n\nreturn msg;","outputs":1,"noerr":0,"x":612.6666259765625,"y":524.6666374206543,"wires":[["67ebed51.1caaf4"]]},{"id":"30d2e78f.4b62e8","type":"function","z":"3d007ef4.e60402","name":"transaction has max duration","func":"msg.event_id = flow.get('event_max_duration');\nmsg.description = 'Перевищено максимальний час находження на вагах, сек: ' + msg.metadata.duration;\n\nreturn msg;","outputs":1,"noerr":0,"x":672.6666259765625,"y":604.6666374206543,"wires":[["67ebed51.1caaf4"]]},{"id":"124bef57.68d311","type":"function","z":"3d007ef4.e60402","name":"empty waybill","func":"msg.event_id = flow.get('event_fake_traffic');\nmsg.description = 'Холостий проїзд по вагам. Тривалість проїзду ' + Math.round(msg.metadata.duration/60)+ 'хв.' + \" Максимальна вага: \" + msg.metadata.transactionMaxWeight + \" кг.\";\n\nreturn msg;","outputs":1,"noerr":0,"x":772.6666259765625,"y":444.6666374206543,"wires":[["67ebed51.1caaf4"]]},{"id":"aac49511.105468","type":"function","z":"3d007ef4.e60402","name":"transactionHasMinWeight","func":"msg.event_id = flow.get('event_min_weight');\nmsg.description = 'Перевищена мінімально-допустима вага, кг: ' + msg.metadata.weight;\n\nreturn msg;","outputs":1,"noerr":0,"x":662.6666259765625,"y":644.6666374206543,"wires":[["67ebed51.1caaf4"]]},{"id":"ce3d71.8168729","type":"function","z":"3d007ef4.e60402","name":"move in minus","func":"msg.event_id = flow.get('event_move_in_minus_id');\nmsg.description = 'Заїзд із мінусом. ' + msg.prevWeight +' кг.';\n\nreturn msg;","outputs":1,"noerr":0,"x":620,"y":400,"wires":[["67ebed51.1caaf4"]]},{"id":"8cdbb44e.15b698","type":"link in","z":"3d007ef4.e60402","name":"s4","links":["fb6589c2.69fdd8"],"x":37.6666259765625,"y":544.6666259765625,"wires":[["9dee987c.4bd1c8","7a8cd7a6.bb68f8","72b134ef.51a8cc"]]},{"id":"e5542ed2.9e6f5","type":"switch","z":"3d007ef4.e60402","name":"switch move","property":"on","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":404.6666259765625,"y":527.6666259765625,"wires":[["bff8e2dd.1b651"],["89a4dbee.d1d3c8","842c07a0.222098","42e619b7.2938d8"]]},{"id":"f7491b3d.962198","type":"switch","z":"3d007ef4.e60402","name":"max duration","property":"transactionHasMaxDuration","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":402.6666259765625,"y":604.6666374206543,"wires":[["30d2e78f.4b62e8"]]},{"id":"a9abc32.046714","type":"switch","z":"3d007ef4.e60402","name":"switch min weight","property":"transactionHasMinWeight","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":422.6666259765625,"y":644.6666374206543,"wires":[["aac49511.105468"]]},{"id":"ec900222.9b278","type":"switch","z":"3d007ef4.e60402","name":"switch minus in","property":"is_minus","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":400,"y":400,"wires":[["ce3d71.8168729"]]},{"id":"7f829d33.911d94","type":"switch","z":"3d007ef4.e60402","name":"","property":"driver_in","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":824.6666259765625,"y":905.6666259765625,"wires":[["57dffe8b.04f53"]]},{"id":"df96f3e.c97a01","type":"http in","z":"3d007ef4.e60402","name":"","url":"/getWeight","method":"get","upload":false,"swaggerDoc":"","x":160,"y":920,"wires":[["be8af966.9cd558","14f89004.2f8d8"]]},{"id":"c0020365.338ea","type":"function","z":"3d007ef4.e60402","name":"parser","func":"var str = {\n    payload: msg.payload,\n    event_id: msg.event_id,\n    metadata: msg.metadata,\n    driverWeight: msg.driverWeight,\n    description: msg.description,\n    url: msg.url,\n    main_host: msg.main_host,\n    event_url: msg.event_url,\n    statusCode: msg.statusCode,\n    responseUrl: msg.responseUrl\n    \n};\nmsg.payload = JSON.stringify(str);\nreturn msg;","outputs":1,"noerr":0,"x":1454.8095626831055,"y":560.3809089660645,"wires":[["af561503.7b03b8"]]},{"id":"57dffe8b.04f53","type":"function","z":"3d007ef4.e60402","name":"driver_in event","func":"msg.event_id = flow.get('event_driver_in');\nmsg.description = 'При зважуванні водій в кабіні. Вага: ' + msg.metadata.weight+\"кг. Номер авто: \"+msg.metadata.truck1+\" \"+msg.metadata.truck2+\" \"+msg.metadata.item_name;\n\nreturn msg;","outputs":1,"noerr":0,"x":1024.6825561523438,"y":686.8730583190918,"wires":[["67ebed51.1caaf4"]]},{"id":"98032e3a.c614e","type":"debug","z":"3d007ef4.e60402","name":"Avto 1 IN event","active":false,"console":"true","complete":"payload","x":1330,"y":480,"wires":[]},{"id":"d3fc2a38.6d3e58","type":"switch","z":"3d007ef4.e60402","name":"","property":"checkHealth","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":410,"y":760,"wires":[["7e485d59.c501a4"],["c105ba.3a374a48"]]},{"id":"842c07a0.222098","type":"switch","z":"3d007ef4.e60402","name":"waybill","property":"metadata.waybill","propertyType":"msg","rules":[{"t":"null"}],"checkall":"true","outputs":1,"x":612.6666259765625,"y":444.6666374206543,"wires":[["124bef57.68d311"]]},{"id":"efc8ce48.7ccb4","type":"debug","z":"3d007ef4.e60402","name":"Avto 1 weight","active":false,"tosidebar":true,"console":true,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":180,"y":440,"wires":[]},{"id":"9dee987c.4bd1c8","type":"ui_text","z":"3d007ef4.e60402","group":"5106c661.4daa28","order":0,"width":0,"height":0,"name":"","label":"Поточна вага:","format":"{{msg.payload}}","layout":"row-spread","x":179,"y":654.0000114440918,"wires":[]},{"id":"be8af966.9cd558","type":"function","z":"3d007ef4.e60402","name":"response","func":"msg.payload = flow.get('transactionMetadata');\nmsg.payload.driverInCar = false;\ntransactionWaybill = flow.get('transactionWaybill');\nmsg.payload.transactionWaybill = transactionWaybill;\nif(transactionWaybill && transactionWaybill !== msg.req.query.reader){\n    msg.payload.status = false;    \n}else {\n    msg.payload.status = true;    \n}\n\n\n//\n//var queryInfo = msg.req.query\nmsg.payload.info = msg.req.query;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":440,"y":980,"wires":[["6efa7355.33335c","f23a2260.d4131"]]},{"id":"af561503.7b03b8","type":"debug","z":"3d007ef4.e60402","name":"Avto 1 IN response event","active":true,"console":"true","complete":"payload","x":1660,"y":560,"wires":[]},{"id":"6bfd12f4.d7ef8c","type":"function","z":"3d007ef4.e60402","name":"check scale health","func":"var lastcheckHealth = flow.get('checkHealth');\nvar checkHealth = null;\nvar lasttimedata = flow.get('lasttimedata');\n\nvar currenttimedata = new Date();\n\nif ((currenttimedata - lasttimedata) > 3000){\n    checkHealth = false;\n} else {\n    checkHealth = true;\n}\n\nflow.set(\"checkHealth\",checkHealth);\n\nif (lastcheckHealth != checkHealth){\n    msg.checkHealth = checkHealth;\n}else{\n    msg.checkHealth = null;\n}\nmsg.payload = checkHealth;\n\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":820,"wires":[["d3fc2a38.6d3e58"]]},{"id":"6efa7355.33335c","type":"http response","z":"3d007ef4.e60402","name":"","x":630,"y":980,"wires":[]},{"id":"edeb83d1.ebd65","type":"inject","z":"3d007ef4.e60402","name":"","repeat":"6","crontab":"","once":false,"topic":"","payload":"","payloadType":"date","x":110,"y":760,"wires":[["6bfd12f4.d7ef8c"]]},{"id":"fc8abaff.398cd8","type":"http in","z":"3d007ef4.e60402","name":"","url":"/getSimpleWeight","method":"get","swaggerDoc":"","x":140,"y":1100,"wires":[["d4e1e58b.2cc668"]]},{"id":"d4e1e58b.2cc668","type":"function","z":"3d007ef4.e60402","name":"response","func":"msg.payload = flow.get('transactionMetadata').weight;\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":1100,"wires":[["ae1c350d.40e0b8","f23a2260.d4131"]]},{"id":"ae1c350d.40e0b8","type":"http response","z":"3d007ef4.e60402","name":"","x":550,"y":1100,"wires":[]},{"id":"561ddd1d.ac4e14","type":"function","z":"3d007ef4.e60402","name":"snapshot payload","func":"var event_id = msg.event_id;\nvar scale_id = global.get('scale_id_in');\nvar tbase64   = msg.payload.toString('base64');\nmsg.payload = {\n    'event':{\n        'id':msg.event_id\n    },\n    'device':{\n        'id':scale_id\n        \n    },\n    'snapshot':tbase64,\n    'ext':'jpeg'\n}\n\nmsg.headers = {\n    \"content-type\":\"application/json\"\n}\n\nmsg.url = flow.get('main_host')+flow.get('snapshot_url');\n//msg.url = \"http://172.16.1.4:8080/ords/ettn/iot_cli/events/snapshot\";\n\nmsg.main_host = flow.get('main_host');\nmsg.snapshot_url = flow.get('snapshot_url');\n\nreturn msg;","outputs":1,"noerr":0,"x":1710,"y":680,"wires":[["3b42473f.054f18","7114427c.7abfbc"]]},{"id":"3b42473f.054f18","type":"http request","z":"3d007ef4.e60402","name":"send a snapshot","method":"POST","ret":"txt","url":"","tls":"b3906ca0.bb0d9","x":1920,"y":680,"wires":[["b3beb9be.0e6bb8"]]},{"id":"b3beb9be.0e6bb8","type":"debug","z":"3d007ef4.e60402","name":"response snapshot","active":true,"console":"true","complete":"payload","x":2271.714111328125,"y":669.5714721679688,"wires":[]},{"id":"b2f33ac7.5ad5a8","type":"http in","z":"3d007ef4.e60402","name":"Serialgel_Weight","url":"/scale/1ceface0-038d-4de1-8cc0-a1d93217b198/getWeight","method":"get","swaggerDoc":"","x":120,"y":980,"wires":[["be8af966.9cd558","14f89004.2f8d8"]]},{"id":"7a8cd7a6.bb68f8","type":"ui_chart","z":"3d007ef4.e60402","name":"","group":"10494db9.404c42","order":0,"width":"6","height":"6","label":"chart","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","ymin":"-20","ymax":"70000","removeOlder":"10","removeOlderPoints":"","removeOlderUnit":"60","cutout":0,"outputs":2,"x":149.3333740234375,"y":690.3333740234375,"wires":[[],[]]},{"id":"33c84a0c.c7e9a6","type":"comment","z":"3d007ef4.e60402","name":"Зробити фото","info":"https://10.107.5.200/ords/ettn/v1/events/snapshot","x":1299,"y":622,"wires":[]},{"id":"f49d28d.0b8d3d8","type":"comment","z":"3d007ef4.e60402","name":"Зважити у Апекс","info":"","x":120,"y":880,"wires":[]},{"id":"140c0dfd.4f6db2","type":"trigger","z":"3d007ef4.e60402","name":"","op1":"1","op2":"0","op1type":"str","op2type":"str","duration":"0","extend":false,"units":"ms","reset":"","outputs":1,"x":262.85714285714283,"y":261.4285714285714,"wires":[["f7f8df44.ea8e8"]]},{"id":"42e619b7.2938d8","type":"switch","z":"3d007ef4.e60402","name":"","property":"transactionHasOverLoad","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":590,"y":340,"wires":[["cc3862a4.823f8"]]},{"id":"cc3862a4.823f8","type":"function","z":"3d007ef4.e60402","name":"over_load","func":"msg.event_id = flow.get('event_over_load');\nmsg.description = 'Можливий досип після зважування. Максимальная вага: ' + msg.metadata.transactionMaxWeight + \"кг. Облікова вага: \" + msg.metadata.transactionAccWeight + \"кг.\";\n\nreturn msg;","outputs":1,"noerr":0,"x":720,"y":340,"wires":[["67ebed51.1caaf4"]]},{"id":"3335d3ff.f9ca4c","type":"delay","z":"3d007ef4.e60402","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"3","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":761,"y":737,"wires":[["67ebed51.1caaf4"]]},{"id":"36a6820a.d997de","type":"delay","z":"3d007ef4.e60402","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"3","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":760,"y":779,"wires":[["67ebed51.1caaf4"]]},{"id":"2eb99861.c03c78","type":"http request","z":"3d007ef4.e60402","name":"","method":"GET","ret":"bin","url":"https://a2goos.com/info/wp-content/uploads/2020/03/40.jpg","tls":"","x":1510,"y":680,"wires":[[]]},{"id":"7114427c.7abfbc","type":"debug","z":"3d007ef4.e60402","name":"","active":true,"console":"true","complete":"true","x":1890,"y":640,"wires":[]},{"id":"2612e4e9.5d21dc","type":"inject","z":"3d007ef4.e60402","name":"","repeat":"","crontab":"","once":false,"topic":"","payload":"","payloadType":"date","x":1280,"y":740,"wires":[["9f973f1a.b21d"]]},{"id":"9f973f1a.b21d","type":"file in","z":"3d007ef4.e60402","name":"","filename":"/distr/data/img2.jpg","format":"","x":1502.8299255371094,"y":739.8334169387817,"wires":[["561ddd1d.ac4e14"]]},{"id":"d78607d2.1d3a78","type":"http in","z":"3d007ef4.e60402","name":"","url":"/getSimple2","method":"get","upload":false,"swaggerDoc":"","x":120,"y":1160,"wires":[["ae2d754d.bb8d68"]]},{"id":"ae2d754d.bb8d68","type":"function","z":"3d007ef4.e60402","name":"response","func":"msg.payload = flow.get('transactionMetadata');\nmsg.payload.driverInCar = false;\ntransactionWaybill = flow.get('transactionWaybill');\nmsg.payload.transactionWaybill = transactionWaybill;\nif(transactionWaybill && transactionWaybill !== msg.req.query.reader){\n    msg.payload.status = false;    \n}else {\n    msg.payload.status = true;    \n}\n\nvar queryInfo = msg.req.query\nmsg.payload.info = queryInfo;\n\n\nflow.set('queryInfo', queryInfo);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":380,"y":1160,"wires":[["d0048553.8f91d8","fd5cf217.16fb3","6a27683c.8bb8d8"]]},{"id":"d0048553.8f91d8","type":"http response","z":"3d007ef4.e60402","name":"","x":830,"y":1160,"wires":[]},{"id":"fd5cf217.16fb3","type":"debug","z":"3d007ef4.e60402","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":550,"y":1180,"wires":[]},{"id":"f23a2260.d4131","type":"debug","z":"3d007ef4.e60402","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":610,"y":1040,"wires":[]},{"id":"6a27683c.8bb8d8","type":"function","z":"3d007ef4.e60402","name":"","func":"flow.set(\"count_1\", 0);\nflow.set(\"start_timer\", true);\nflow.set(\"arrayCompare\",[])\n\n\nvar queryInfo = msg.req.query\nflow.set('queryInfo', queryInfo);\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":880,"y":1020,"wires":[["9309c9cf.24ee08"]]},{"id":"9309c9cf.24ee08","type":"debug","z":"3d007ef4.e60402","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1010,"y":1100,"wires":[]},{"id":"15a6ffee.98b1c","type":"inject","z":"3d007ef4.e60402","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":150,"y":1200,"wires":[[]]},{"id":"27028606.99616a","type":"function","z":"3d007ef4.e60402","name":"","func":"var count = flow.get(\"count_1\");\ncount++;\nif(count == 10){\n    flow.set(\"count_1\", 0);\n    msg.push1C = true;\n    flow.set(\"start_timer\", false);\n} else {\n    msg.payload = count;\n    flow.set(\"count_1\", count);\n    msg.push1C = false;\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":460,"y":1220,"wires":[[]]},{"id":"abcf5d8c.fee57","type":"debug","z":"3d007ef4.e60402","name":"false","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":650,"y":1320,"wires":[]},{"id":"6e378d4a.59f804","type":"switch","z":"3d007ef4.e60402","name":"","property":"start_timer","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":310,"y":1320,"wires":[["34fed7b9.484968"]]},{"id":"1877ea51.b877c6","type":"comment","z":"3d007ef4.e60402","name":"push 1c","info":"","x":850,"y":980,"wires":[]},{"id":"cef69fe3.bf5b6","type":"comment","z":"3d007ef4.e60402","name":"Timer","info":"","x":330,"y":1200,"wires":[]},{"id":"e840735a.117c3","type":"debug","z":"3d007ef4.e60402","name":"true","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":810,"y":1400,"wires":[]},{"id":"34fed7b9.484968","type":"function","z":"3d007ef4.e60402","name":"","func":"var arrayCompare = flow.get(\"arrayCompare\");\nvar count = flow.get(\"count_1\");\nconst delta = 200;\nvar weight = msg.metadata.weight;\nvar prevWeight = msg.metadata.prevWeight;\nvar subWePr = weight - prevWeight;\n//\nvar send1C = true;\n\n\n\nif(arrayCompare.length == 10){\n    arrayCompare.forEach((element) => {\n        if(element === false){\n            send1C = false        \n        }        \n    })\n    msg.send1C = send1C;\n    \n    \n    flow.set(\"arrayCompare\", []);\n    flow.set(\"start_timer\", false);\n}else {\n    if(subWePr >= 0){\n        if(subWePr <= delta){\n            arrayCompare.push(true);    \n        }else {\n            arrayCompare.push(false);       \n        }\n    }else if(subWePr < 0){\n        if(subWePr >= -delta){\n            arrayCompare.push(true);    \n        }else {\n            arrayCompare.push(false);       \n        }    \n    }\n}\n\n\nmsg.subWePr = subWePr;\nflow.set(\"arrayCompare\", arrayCompare);\nmsg.payload = arrayCompare; \nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":480,"y":1320,"wires":[["abcf5d8c.fee57","bf84f2f6.28018"]]},{"id":"746aefac.dc841","type":"inject","z":"3d007ef4.e60402","name":"","props":[{"p":"payload"},{"p":"topic","v":"0","vt":"num"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"100","payloadType":"num","x":90,"y":1500,"wires":[["72b134ef.51a8cc"]]},{"id":"188ffa76.25af16","type":"inject","z":"3d007ef4.e60402","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"0","payloadType":"num","x":90,"y":1380,"wires":[["72b134ef.51a8cc"]]},{"id":"4bc02d94.e8df84","type":"inject","z":"3d007ef4.e60402","name":"","props":[{"p":"payload"},{"p":"topic","v":"0","vt":"num"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"500","payloadType":"num","x":90,"y":1540,"wires":[["72b134ef.51a8cc"]]},{"id":"6d69bec8.bde86","type":"inject","z":"3d007ef4.e60402","name":"","props":[{"p":"payload"},{"p":"topic","v":"0","vt":"num"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1000","payloadType":"num","x":90,"y":1580,"wires":[["72b134ef.51a8cc"]]},{"id":"990779f1.4509f8","type":"inject","z":"3d007ef4.e60402","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"transactionMetadata","payloadType":"flow","x":150,"y":1620,"wires":[["99a80fd4.a41c8"]]},{"id":"99a80fd4.a41c8","type":"debug","z":"3d007ef4.e60402","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":370,"y":1620,"wires":[]},{"id":"48169e41.968d3","type":"inject","z":"3d007ef4.e60402","name":"","props":[{"p":"payload"},{"p":"topic","v":"0","vt":"num"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1100","payloadType":"num","x":270,"y":1500,"wires":[["72b134ef.51a8cc"]]},{"id":"e97d468e.0d5d58","type":"inject","z":"3d007ef4.e60402","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"600","payloadType":"num","x":270,"y":1460,"wires":[["72b134ef.51a8cc"]]},{"id":"e12d4c80.ac5c3","type":"inject","z":"3d007ef4.e60402","name":"","props":[{"p":"payload"},{"p":"topic","v":"0","vt":"num"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1200","payloadType":"num","x":270,"y":1540,"wires":[["72b134ef.51a8cc"]]},{"id":"a1ddc953.79b0c8","type":"inject","z":"3d007ef4.e60402","name":"","props":[{"p":"payload"},{"p":"topic","v":"0","vt":"num"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1500","payloadType":"num","x":270,"y":1580,"wires":[["72b134ef.51a8cc"]]},{"id":"bf84f2f6.28018","type":"switch","z":"3d007ef4.e60402","name":"","property":"send1C","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":650,"y":1360,"wires":[["e840735a.117c3","abb1722a.59f73"]]},{"id":"75032696.ae48f8","type":"debug","z":"3d007ef4.e60402","name":"true","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":970,"y":1360,"wires":[]},{"id":"abb1722a.59f73","type":"function","z":"3d007ef4.e60402","name":"response","func":"msg.payload = flow.get('transactionMetadata');\nmsg.payload.driverInCar = false;\ntransactionWaybill = flow.get('transactionWaybill');\nmsg.payload.transactionWaybill = transactionWaybill;\nif(transactionWaybill && transactionWaybill !== msg.req.query.reader){\n    msg.payload.status = false;    \n}else {\n    msg.payload.status = true;    \n}\n\n\nmsg.payload.info = flow.get('queryInfo')\ndelete msg.metadata;\ndelete msg.is_minus;\ndelete msg.send1C;\ndelete msg.subWePr;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":820,"y":1360,"wires":[["75032696.ae48f8"]]},{"id":"b395c49c.fcd648","type":"inject","z":"3d007ef4.e60402","name":"","props":[{"p":"payload"},{"p":"topic","v":"0","vt":"num"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"100","payloadType":"num","x":90,"y":1460,"wires":[[]]},{"id":"e8a6e3c7.a7a1b","type":"tls-config","name":"","cert":"","key":"","ca":"","verifyservercert":false},{"id":"5106c661.4daa28","type":"ui_group","name":"Поточна вага","tab":"1e680ebf.30e371","order":1,"disp":true,"width":"6"},{"id":"b3906ca0.bb0d9","type":"tls-config","name":"","cert":"","key":"","ca":"","verifyservercert":false},{"id":"10494db9.404c42","type":"ui_group","name":"Графік ваги","tab":"1e680ebf.30e371","order":2,"disp":true,"width":"6"},{"id":"1e680ebf.30e371","type":"ui_tab","name":"Smart Scales","icon":"dashboard"}]
