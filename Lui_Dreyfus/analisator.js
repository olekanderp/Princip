[{"id":"6754df2.8b2bd2","type":"tab","label":"Infratek Lab inside"},{"id":"deae5a0f.76b048","type":"tcp in","z":"6754df2.8b2bd2","name":"","server":"server","host":"","port":"4003","datamode":"stream","datatype":"utf8","newline":"","topic":"","base64":false,"x":100,"y":80,"wires":[["dfeb2bf6.7c4268","bc1fa565.efbd78","8e2616c6.2be0c8","ffb4774e.d3bf38"]]},{"id":"dfeb2bf6.7c4268","type":"function","z":"6754df2.8b2bd2","name":"set last Analys","func":"flow.set('lastAnalys',msg.payload);\nflow.set('barcode',\"\");\nglobal.set('device_id_infratec_2',\"2286efc3-5417-f735-7050-384c1f019000\");\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":80,"wires":[["96ebdc5a.a9085"]]},{"id":"4e8c36a0.4403a8","type":"http in","z":"6754df2.8b2bd2","name":"","url":"/getQuality","method":"get","swaggerDoc":"","x":140,"y":380,"wires":[["3afcbeb.ecbcf42"]]},{"id":"b85bb052.c16f8","type":"http response","z":"6754df2.8b2bd2","name":"","x":610,"y":380,"wires":[]},{"id":"3afcbeb.ecbcf42","type":"function","z":"6754df2.8b2bd2","name":"create response","func":"var load = flow.get('load');\nif (load){\n    msg.payload = flow.get('parseQA');    \n    msg.load = true;\n}else{\n    msg.payload = {};\n    msg.load = false;\n}\nmsg.payload.barcode = flow.get('barcode');\nflow.set(\"load\",false);\n\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":380,"wires":[["b85bb052.c16f8","9d37e774.6be218","ee492291.2df8"]]},{"id":"96ebdc5a.a9085","type":"function","z":"6754df2.8b2bd2","name":"parse quality","func":"var result = {\n    localdate:new Date()\n};\n\nvar sdata = msg.payload;\nvar arr_sdata = sdata.split('\\n');\n\nresult.length = arr_sdata.length;\n\n//Ambient Temperature\nvar ambietTemperature = arr_sdata[7];\nvar arr_ambietTemperature = ambietTemperature.split(\":\");\nresult.ambietTemperature = arr_ambietTemperature[1];\n\n//Analysis Counter\nvar analysisCounter = arr_sdata[8];\nvar arr_analysisCounter = analysisCounter.split(\":\");\nresult.analysisCounter = arr_analysisCounter[1];\n\n//Sub sample\nvar subSample = arr_sdata[11];\nvar arr_subSample = subSample.split(\":\");\nvar arr_subSample_1 = arr_subSample[0].split(\"     \");\n\nresult.subsample = {\n   id : arr_subSample[0].replace(\"NrOFSubSamples\",\"\"),\n   NrOFSubSamples : arr_subSample[1]\n}\n\n//Sample hash\nvar sampleHash = arr_sdata[13];\nresult.sampleHash = sampleHash;\n\n//read quailities \nvar startQ  = 14;\nvar qLength = 7;\nvar endStr  = \"#\";\n\nvar qualities = [];\n\nfor( var i = startQ; i <= arr_sdata.length-qLength; ){\n    \n    var q = {\n        id:arr_sdata[i],\n        value:arr_sdata[i+1].split(String.fromCharCode(20)),\n        minmax:arr_sdata[i+4].split(String.fromCharCode(20))\n    }\n    qualities.push(q);   \n    i = i+qLength;\n    \n}\n\nresult.qualities = qualities;\nresult.datahash  = JSON.stringify(result);\n// msg.payload = arr_sdata;\nmsg.payload = result;\nflow.set('parseQA',result);\n\nreturn msg;","outputs":1,"noerr":0,"x":450,"y":80,"wires":[["65d4b2fd.2b336c","575ef478.89a1dc","ec2a4e39.82309"]]},{"id":"1d6a2711.3f8a19","type":"inject","z":"6754df2.8b2bd2","name":"","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":true,"x":90,"y":540,"wires":[["1f0a1929.f84527"]]},{"id":"1f0a1929.f84527","type":"function","z":"6754df2.8b2bd2","name":"init config","func":"flow.set('load',false);\nreturn msg;","outputs":1,"noerr":0,"x":220,"y":540,"wires":[[]]},{"id":"496220e.e7a3de","type":"function","z":"6754df2.8b2bd2","name":"read barcode","func":"flow.set(\"barcode\",msg.payload.replace(\"\\r\",\"\"));\nflow.set('load',true);\nmsg.payload = {\n    \"barcode\":msg.payload.replace(\"\\r\",\"\")\n}\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":640,"wires":[["ec048485.e33448","8e9a8899.772418"]]},{"id":"65d4b2fd.2b336c","type":"link out","z":"6754df2.8b2bd2","name":"get quality throw tcp Lab inside","links":["b62567f3.246808"],"x":735,"y":80,"wires":[]},{"id":"cb37fd55.1f823","type":"link out","z":"6754df2.8b2bd2","name":"1c request Lab inside","links":["50621407.1ba6ac"],"x":715,"y":420,"wires":[]},{"id":"ec048485.e33448","type":"link out","z":"6754df2.8b2bd2","name":"read barcode Lab inside","links":["36eb63cd.84468c"],"x":475,"y":600,"wires":[]},{"id":"9d37e774.6be218","type":"switch","z":"6754df2.8b2bd2","name":"","property":"load","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":610,"y":420,"wires":[["cb37fd55.1f823"]]},{"id":"f199a501.6462e8","type":"debug","z":"6754df2.8b2bd2","name":"Analysis","active":false,"console":"true","complete":"payload","x":810,"y":40,"wires":[]},{"id":"575ef478.89a1dc","type":"json","z":"6754df2.8b2bd2","name":"","x":590,"y":80,"wires":[["f199a501.6462e8"]]},{"id":"ee492291.2df8","type":"json","z":"6754df2.8b2bd2","name":"","x":610,"y":460,"wires":[["1218db57.0c8925"]]},{"id":"1218db57.0c8925","type":"debug","z":"6754df2.8b2bd2","name":"getQuality","active":false,"console":"true","complete":"payload","x":750,"y":460,"wires":[]},{"id":"1cd297c1.e94db8","type":"debug","z":"6754df2.8b2bd2","name":"Analysis wihout parse","active":false,"console":"true","complete":"payload","x":550,"y":120,"wires":[]},{"id":"bc1fa565.efbd78","type":"function","z":"6754df2.8b2bd2","name":"","func":"msg.payload = {\n    msg:\"\" + msg.payload\n};\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":120,"wires":[["7e0793be.17db0c"]]},{"id":"7e0793be.17db0c","type":"json","z":"6754df2.8b2bd2","name":"","x":370,"y":120,"wires":[["1cd297c1.e94db8"]]},{"id":"8e9a8899.772418","type":"debug","z":"6754df2.8b2bd2","name":"","active":true,"console":"false","complete":"false","x":530,"y":640,"wires":[]},{"id":"ec2a4e39.82309","type":"debug","z":"6754df2.8b2bd2","name":"","active":false,"console":"false","complete":"false","x":610,"y":40,"wires":[]},{"id":"12c5fce1.d75043","type":"inject","z":"6754df2.8b2bd2","name":"","topic":"","payload":"parseQA","payloadType":"flow","repeat":"","crontab":"","once":false,"x":150,"y":680,"wires":[["9678bed1.986e3","3b9b3d7f.10df22"]]},{"id":"9678bed1.986e3","type":"debug","z":"6754df2.8b2bd2","name":"","active":true,"console":"false","complete":"false","x":530,"y":680,"wires":[]},{"id":"3b9b3d7f.10df22","type":"json","z":"6754df2.8b2bd2","name":"","x":330,"y":720,"wires":[["9678bed1.986e3"]]},{"id":"f85ae8ab.7a2108","type":"http in","z":"6754df2.8b2bd2","name":"","url":"/gettest","method":"get","swaggerDoc":"","x":170,"y":780,"wires":[["e1c61e99.21513"]]},{"id":"551d2b2e.642114","type":"http response","z":"6754df2.8b2bd2","name":"","x":570,"y":780,"wires":[]},{"id":"e1c61e99.21513","type":"function","z":"6754df2.8b2bd2","name":"create response","func":"msg.payload = flow.get('parseQA');    \n  \nreturn msg;","outputs":1,"noerr":0,"x":400,"y":780,"wires":[["551d2b2e.642114"]]},{"id":"8e2616c6.2be0c8","type":"debug","z":"6754df2.8b2bd2","name":"","active":true,"console":"false","complete":"false","x":270,"y":40,"wires":[]},{"id":"ffb4774e.d3bf38","type":"function","z":"6754df2.8b2bd2","name":"Body message","func":"let send1C = {\n    truck_id: \"\",\n    device_id: global.get('device_id_infratec_2'),\n    message: msg.payload\n};\n\n msg.payload = send1C;\n msg.url = global.get(\"send_1c_url_quality\");\nreturn msg;","outputs":1,"noerr":0,"x":400,"y":260,"wires":[["8fb3460d.7dd668","16b1fb29.68b905","3d371068.ab45d"]]},{"id":"66332715.86b638","type":"inject","z":"6754df2.8b2bd2","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":120,"y":260,"wires":[["ef06e167.6c2af"]]},{"id":"ef06e167.6c2af","type":"function","z":"6754df2.8b2bd2","name":"","func":"msg.payload = `21-06-01     16:17\nCO261107     Corn\n\n~04180414~ ~043E043104400430043704460430~           130C33EA130C33EA\n~04180414~ ~043A043B04380435043D04420430~           130C33EA\n\n                          \n    Oil (DM)   3.8        \nProtein (DM)   9.2        \n    Moisture  12.6        \n Starch (DM)  73.6        `;\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":260,"wires":[["ffb4774e.d3bf38"]]},{"id":"8fb3460d.7dd668","type":"debug","z":"6754df2.8b2bd2","name":"","active":true,"console":"true","complete":"true","x":770,"y":260,"wires":[]},{"id":"3d371068.ab45d","type":"http request","z":"6754df2.8b2bd2","name":"Send","method":"POST","ret":"txt","url":"","tls":"f436a52.4d81958","x":610,"y":240,"wires":[["8fb3460d.7dd668"]]},{"id":"16b1fb29.68b905","type":"json","z":"6754df2.8b2bd2","name":"","x":610,"y":280,"wires":[["8fb3460d.7dd668"]]},{"id":"d8711c9f.7ad2f","type":"comment","z":"6754df2.8b2bd2","name":"Відправка в 1С","info":"","x":100,"y":220,"wires":[]},{"id":"81776839.e21738","type":"comment","z":"6754df2.8b2bd2","name":"Відправка шрих коду","info":"","x":320,"y":600,"wires":[]},{"id":"d9505979.aed6b8","type":"comment","z":"6754df2.8b2bd2","name":"Ініціалізація","info":"","x":110,"y":500,"wires":[]},{"id":"f436a52.4d81958","type":"tls-config","z":"","name":"","cert":"","key":"","ca":"","verifyservercert":false}]
