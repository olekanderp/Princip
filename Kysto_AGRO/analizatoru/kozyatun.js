[{"id":"a3fb5650.3f6df","type":"tab","label":"Infratek"},{"id":"1ef83c50.08690c","type":"tab","label":"processing_sсelya"},{"id":"946315dd.5308","type":"serial-port","z":"","serialport":"/dev/ttyACM0","serialbaud":"115200","databits":"8","parity":"none","stopbits":"1","newline":"\\r","bin":"false","out":"char","addchar":false},{"id":"7765899e.99e92","type":"tls-config","z":"","name":"","cert":"","key":"","ca":"","verifyservercert":false},{"id":"eda829f6.fc4a2","type":"tls-config","z":"","name":"","cert":"","key":"","ca":"","verifyservercert":false},{"id":"587728f6.6ecff8","type":"tcp in","z":"a3fb5650.3f6df","name":"","server":"server","host":"","port":"4011","datamode":"stream","datatype":"utf8","newline":"","topic":"","base64":false,"x":80,"y":60,"wires":[["dd5fb943.db36f8","e6c7cf44.8127b"]]},{"id":"dd5fb943.db36f8","type":"function","z":"a3fb5650.3f6df","name":"set last Analys","func":"flow.set('lastAnalys',msg.payload);\nflow.set('barcode',\"\");\nglobal.set('device_id','4b437ca6-971b-dc99-bc30-c2bc1f019000');\nreturn msg;","outputs":1,"noerr":0,"x":260,"y":60,"wires":[["be996ac1.b571b8"]]},{"id":"ff36c4ae.708698","type":"http in","z":"a3fb5650.3f6df","name":"","url":"/getQuality","method":"get","swaggerDoc":"","x":136,"y":145,"wires":[["2b5a3f44.efe138"]]},{"id":"8021e31b.d28478","type":"http response","z":"a3fb5650.3f6df","name":"","x":612,"y":161,"wires":[]},{"id":"2b5a3f44.efe138","type":"function","z":"a3fb5650.3f6df","name":"create response","func":"var load = flow.get('load');\nif (load){\n    msg.payload = flow.get('parseQA');    \n    msg.load = true;\n}else{\n    msg.payload = {};\n    msg.load = false;\n}\nmsg.payload.barcode = flow.get('barcode');\nflow.set(\"load\",false);\n\nreturn msg;","outputs":1,"noerr":0,"x":407,"y":153,"wires":[["8021e31b.d28478","6ac01dd8.e1dc0c","91810c35.9eacd"]]},{"id":"be996ac1.b571b8","type":"function","z":"a3fb5650.3f6df","name":"parse quality","func":"var result = {\n    localdate:new Date()\n};\n\nvar sdata = msg.payload;\nvar arr_sdata = sdata.split('\\n');\n\nresult.length = arr_sdata.length;\n\n//Ambient Temperature\nvar ambietTemperature = arr_sdata[7];\nvar arr_ambietTemperature = ambietTemperature.split(\":\");\nresult.ambietTemperature = arr_ambietTemperature[1];\n\n//Analysis Counter\nvar analysisCounter = arr_sdata[8];\nvar arr_analysisCounter = analysisCounter.split(\":\");\nresult.analysisCounter = arr_analysisCounter[1];\n\n//Sub sample\nvar subSample = arr_sdata[11];\nvar arr_subSample = subSample.split(\":\");\nvar arr_subSample_1 = arr_subSample[0].split(\"     \");\n\nresult.subsample = {\n   id : arr_subSample[0].replace(\"NrOFSubSamples\",\"\"),\n   NrOFSubSamples : arr_subSample[1]\n}\n\n//Sample hash\nvar sampleHash = arr_sdata[13];\nresult.sampleHash = sampleHash;\n\n//read quailities \nvar startQ  = 14;\nvar qLength = 7;\nvar endStr  = \"#\";\n\nvar qualities = [];\n\nfor( var i = startQ; i <= arr_sdata.length-qLength; ){\n    \n    var q = {\n        id:arr_sdata[i],\n        value:arr_sdata[i+1].split(String.fromCharCode(20)),\n        minmax:arr_sdata[i+4].split(String.fromCharCode(20))\n    }\n    qualities.push(q);   \n    i = i+qLength;\n    \n}\n\nresult.qualities = qualities;\nresult.datahash  = JSON.stringify(result);\n// msg.payload = arr_sdata;\nmsg.payload = result;\nflow.set('parseQA',result);\n\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":60,"wires":[["142dcb0f.068765","fe1386df.552098","c435b03f.52d0d8"]]},{"id":"63ded1d5.361ac8","type":"serial in","z":"a3fb5650.3f6df","name":"","serial":"946315dd.5308","x":110,"y":200,"wires":[["51830b97.0f0f44"]]},{"id":"460ce1a1.360268","type":"inject","z":"a3fb5650.3f6df","name":"","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":true,"x":90,"y":280,"wires":[["cafa36c6.8bb42"]]},{"id":"cafa36c6.8bb42","type":"function","z":"a3fb5650.3f6df","name":"init config","func":"flow.set('load',false);\nreturn msg;","outputs":1,"noerr":0,"x":236,"y":305,"wires":[[]]},{"id":"51830b97.0f0f44","type":"function","z":"a3fb5650.3f6df","name":"read barcode","func":"flow.set(\"barcode\",msg.payload.replace(\"\\r\",\"\"));\nflow.set('load',true);\nmsg.payload = {\n    \"barcode\":msg.payload.replace(\"\\r\",\"\")\n}\nreturn msg;","outputs":1,"noerr":0,"x":306,"y":225,"wires":[["3465f520.54f422","5758c5a0.6f233c"]]},{"id":"eab0be69.2dc038","type":"link in","z":"1ef83c50.08690c","name":"quality","links":["142dcb0f.068765"],"x":35,"y":300,"wires":[["38242e5d.fbf312"]]},{"id":"4623f175.4833","type":"http request","z":"1ef83c50.08690c","name":"EVENTS","method":"POST","ret":"txt","url":"","tls":"7765899e.99e92","x":942,"y":299,"wires":[["5ada9568.26047c"]]},{"id":"afb189c2.b3c398","type":"function","z":"1ef83c50.08690c","name":"events payload","func":"var event_id = msg.event_id;\nvar device_id = global.get('device_id');\n\n\nmsg.payload = {\n    'event':{\n        'id':msg.event_id\n    },\n    'devices':[{'id':device_id}],\n    'data':msg.metadata,\n    'description':msg.description\n}\n\nmsg.headers = {\n    \"content-type\":\"application/json\"\n}\n\nmsg.url = flow.get('main_host')+flow.get('event_url');\nmsg.main_host = flow.get('main_host');\nmsg.event_url = flow.get('event_url');\n\nreturn msg;","outputs":1,"noerr":0,"x":760,"y":300,"wires":[["4623f175.4833","3cb0dec7.a793f2"]]},{"id":"60da3186.3f4958","type":"inject","z":"1ef83c50.08690c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":80,"y":460,"wires":[["941211ea.533568"]]},{"id":"941211ea.533568","type":"function","z":"1ef83c50.08690c","name":"check scale health","func":"var lastcheckHealth = flow.get('checkHealth');\nvar checkHealth = null;\nvar lasttimedata = flow.get('lasttimedata');\n\nvar currenttimedata = new Date();\n\nif ((currenttimedata - lasttimedata) > 3000){\n    checkHealth = false;\n} else {\n    checkHealth = true;\n}\n\nflow.set(\"checkHealth\",checkHealth);\n\nif (lastcheckHealth != checkHealth){\n    msg.checkHealth = checkHealth;\n}else{\n    msg.checkHealth = null;\n}\nmsg.payload = checkHealth;\n\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":460,"wires":[["40f7aed6.3813a"]]},{"id":"77670012.f36138","type":"function","z":"1ef83c50.08690c","name":"main config","func":"flow.set('checkHealth',null);\n\nreturn msg;\n","outputs":1,"noerr":0,"x":370,"y":240,"wires":[[]]},{"id":"5ad50d2a.07766c","type":"inject","z":"1ef83c50.08690c","name":"","topic":"","payload":"","payloadType":"str","repeat":"10800","crontab":"","once":true,"x":90,"y":220,"wires":[["a4fa81d2.bb1be8","77670012.f36138"]]},{"id":"efc54588.dede78","type":"http request","z":"1ef83c50.08690c","name":"STATE","method":"POST","ret":"txt","url":"","tls":"eda829f6.fc4a2","x":610,"y":460,"wires":[["87a61e64.9df1e"]]},{"id":"40f7aed6.3813a","type":"function","z":"1ef83c50.08690c","name":"device state","func":"msg.payload = {\n    \"state\":msg.payload\n}\nmsg.headers = {\n    \"content-type\":\"application/json\"\n}\nmsg.url = flow.get('main_host')+flow.get('state_url')+\"?id=\"+global.get(\"scale_id\");\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":460,"wires":[["efc54588.dede78"]]},{"id":"8db7031d.caf9","type":"function","z":"1ef83c50.08690c","name":"device config","func":"var device_config = JSON.parse(msg.payload);\n\nflow.set('event_make_quality_id',device_config.event_make_quality_id);\nflow.set('event_read_barcode_id',device_config.event_read_barcode_id);\nflow.set('event_send_to_accsystem_id',device_config.event_send_to_accsystem_id);\nflow.set('event_no_conditional',device_config.event_no_conditional);\nflow.set('main_host',device_config.main_host);\nflow.set('event_url',device_config.event_url);\nflow.set('state_url',device_config.state_url);\nflow.set('snapshot_url',device_config.snapshot_url);\n\nreturn msg;\n","outputs":1,"noerr":0,"x":570,"y":200,"wires":[["e1ecff7e.a3b52"]]},{"id":"d87ca5b9.e61be","type":"http in","z":"1ef83c50.08690c","name":"","url":"/firmware","method":"post","swaggerDoc":"","x":140,"y":160,"wires":[["9d00f897.fd29d"]]},{"id":"9d00f897.fd29d","type":"file","z":"1ef83c50.08690c","name":"deivce_config","filename":"deivce_config.json","appendNewline":true,"createDir":false,"overwriteFile":"true","x":380,"y":160,"wires":[]},{"id":"a4fa81d2.bb1be8","type":"file in","z":"1ef83c50.08690c","name":"deivce_config","filename":"deivce_config.json","format":"utf8","x":380,"y":200,"wires":[["8db7031d.caf9"]]},{"id":"52c40cf1.e2e6bc","type":"http in","z":"1ef83c50.08690c","name":"","url":"/serial","method":"get","swaggerDoc":"","x":120,"y":40,"wires":[["77d20dc1.593bc4"]]},{"id":"77d20dc1.593bc4","type":"exec","z":"1ef83c50.08690c","command":"cat /proc/cpuinfo","addpay":true,"append":"| grep Serial","useSpawn":"","timer":"5","name":"","x":350,"y":40,"wires":[["9f67e9fe.a1ba28","6a0b42e.0122d3c"],[],[]]},{"id":"9f67e9fe.a1ba28","type":"http response","z":"1ef83c50.08690c","name":"","x":550,"y":20,"wires":[]},{"id":"6a0b42e.0122d3c","type":"function","z":"1ef83c50.08690c","name":"","func":"msg.payload = msg.payload.split(':')[1].replace('\\n','').replace(' ','');\nreturn msg;","outputs":1,"noerr":0,"x":540,"y":100,"wires":[["687a6dba.90f3dc"]]},{"id":"687a6dba.90f3dc","type":"debug","z":"1ef83c50.08690c","name":"","active":false,"console":"false","complete":"false","x":680,"y":100,"wires":[]},{"id":"7c6c7391.fa1e1c","type":"inject","z":"1ef83c50.08690c","name":"DEMO","topic":"","payload":"","payloadType":"str","repeat":"10800","crontab":"","once":false,"x":100,"y":100,"wires":[["33ebc5af.de5ab2"]]},{"id":"33ebc5af.de5ab2","type":"function","z":"1ef83c50.08690c","name":"DEMO Data","func":"var device_config = {\n    'event_make_quality_id':'8B9482814EDB2FC9E055000000000001',\n    'event_read_barcode_id':'8B9482814EDC2FC9E055000000000001',\n    'event_send_to_accsystem_id':'8B9482814EDD2FC9E055000000000001',\n    'event_no_conditional':'8C4D78A0466C7B36E055000000000001',\n    'main_host':'https://156.67.53.93:8443/ords/ettn',\n    'event_url':'/iot_cli/events/log',\n    'state_url':'/iot_cli/device',\n    'snapshot_url':'/iot_cli/events/snapshot'\n}\nmsg.payload = device_config;\n// flow.set('scale_id','80096CB0EFD83B63E0533300000A4334');\n// flow.set('event_move_in_id','80096D9ABE7F68F3E0533300000A6C0D');\n// flow.set('event_move_out_id','80096D9ABE8068F3E0533300000A6C0D');\n// flow.set('event_max_weight_id','85A255F950F9BEF4E0533300000AC45D');\n// flow.set('event_off_id','85A2CC4570292DD1E0533300000A0C94');\n// flow.set('event_on_id', '85A2CC45702A2DD1E0533300000A0C94');\n// flow.set('event_max_duration','8642EE858DE89BAAE0533300000AFCC7');\n// flow.set('main_host','http://prod.apex.rest/ords/ettn');\n// flow.set('event_url','/iot_cli/events/log');\n// flow.set('state_url','/v1/device');\n// flow.set('maxWeight',40000);\n// flow.set('maxDuration',20000);\n// flow.set('checkHealthTimeout',3000);\nreturn msg;\n//http://156.67.53.93:8888/ords/ettn\n//http://skelya.prncp.org/ords/ettn","outputs":1,"noerr":0,"x":249,"y":100,"wires":[["9d00f897.fd29d"]]},{"id":"e38f317f.ebf26","type":"function","z":"1ef83c50.08690c","name":"send quality","func":"msg.event_id = flow.get('event_make_quality_id');\nmsg.description = 'Отримали якість із аналізатору. Номер аналізу: ' + msg.payload.analysisCounter+\". Калібровка \"+msg.payload.subsample_id;\nmsg.metadata = msg.payload;\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":300,"wires":[["afb189c2.b3c398"]]},{"id":"87a61e64.9df1e","type":"debug","z":"1ef83c50.08690c","name":"","active":false,"console":"false","complete":"false","x":748,"y":490,"wires":[]},{"id":"e1ecff7e.a3b52","type":"debug","z":"1ef83c50.08690c","name":"","active":false,"console":"false","complete":"payload","x":750,"y":200,"wires":[]},{"id":"1d19d0c3.cce32f","type":"link in","z":"1ef83c50.08690c","name":"barcode","links":["3465f520.54f422"],"x":35,"y":340,"wires":[["fa97b378.d6c7b"]]},{"id":"fa97b378.d6c7b","type":"function","z":"1ef83c50.08690c","name":"read barcode","func":"msg.event_id = flow.get('event_read_barcode_id');\nmsg.description = 'Зчитування штрих-коду: ' + msg.payload.barcode;\nmsg.metadata = msg.payload;\n\nreturn msg;","outputs":1,"noerr":0,"x":150,"y":340,"wires":[["afb189c2.b3c398"]]},{"id":"7da8f746.870b","type":"function","z":"1ef83c50.08690c","name":"send to 1c","func":"msg.event_id = flow.get('event_send_to_accsystem_id');\nmsg.description = 'Отримання аналізу в 1С: ' + msg.payload.barcode;\nmsg.metadata = {\n    'barcode':msg.payload.barcode\n}\nreturn msg;","outputs":1,"noerr":0,"x":150,"y":380,"wires":[["afb189c2.b3c398"]]},{"id":"bc8ec231.38fe2","type":"link in","z":"1ef83c50.08690c","name":"1c","links":["f0835531.2e1bf"],"x":35,"y":380,"wires":[["7da8f746.870b"]]},{"id":"142dcb0f.068765","type":"link out","z":"a3fb5650.3f6df","name":"get quality throw tcp","links":["eab0be69.2dc038"],"x":775,"y":60,"wires":[]},{"id":"f0835531.2e1bf","type":"link out","z":"a3fb5650.3f6df","name":"1c request","links":["bc8ec231.38fe2"],"x":735,"y":160,"wires":[]},{"id":"3465f520.54f422","type":"link out","z":"a3fb5650.3f6df","name":"read barcode","links":["1d19d0c3.cce32f"],"x":435,"y":200,"wires":[]},{"id":"2d6cb735.f9989","type":"switch","z":"1ef83c50.08690c","name":"","property":"isNotConditional","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":410,"y":400,"wires":[["65203d09.37674c"]]},{"id":"65203d09.37674c","type":"function","z":"1ef83c50.08690c","name":"send quality","func":"msg.event_id = flow.get('event_no_conditional');\nmsg.description = 'Некодинційня якість. Номер аналізу ' + msg.payload.analysisCounter;\n\nvar payload = {};\nfor (var i = 0; i < msg.notcondition.length; i++){\n    payload = msg.notcondition[i];  \n}\nmsg.metadata = payload;\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":400,"wires":[["afb189c2.b3c398","e028d820.f352e8"]]},{"id":"e028d820.f352e8","type":"debug","z":"1ef83c50.08690c","name":"","active":false,"console":"false","complete":"true","x":730,"y":403,"wires":[]},{"id":"38242e5d.fbf312","type":"function","z":"1ef83c50.08690c","name":"parse result","func":"var p = msg.payload;\n\nvar result = {\n    \"ambietTemperature\":p.ambietTemperature,\n    \"analysisCounter\":p.analysisCounter,\n    \"subsample_id\":p.subsample.id,\n    \"subsample_NrOFSubSamples\":p.subsample.NrOFSubSamples,\n    \"sampleHash\":p.sampleHash\n};\nvar notcondition = [];\nvar isNotConditional = false;\n\nfor (var i = 0; i < p.qualities.length; i++){\n    \n    var valueid = p.qualities[i].id.replace(\" \",\"\"); \n    var temp_value_name = p.qualities[i].value[0].match(/[a-zA-Z]+/g)[0];\n    var temp_value = parseFloat(p.qualities[i].value[0].match(/\\d+.\\d+/g));\n    result[temp_value_name] = temp_value;\n    \n    var temp_value_min_name = p.qualities[i].minmax[0].match(/[a-zA-Z]+/g)[0];\n    var temp_value_min = parseFloat(p.qualities[i].minmax[0].match(/\\d+.\\d+/g)[0]);\n    // result[temp_value_name+\"_\"+temp_value_min_name] = temp_value_min;\n    \n    var temp_value_max_name = p.qualities[i].minmax[0].match(/[a-zA-Z]+/g)[1];\n    var temp_value_max = parseFloat(p.qualities[i].minmax[0].match(/\\d+.\\d+/g)[1]);\n    // result[temp_value_name+\"_\"+temp_value_max_name] = temp_value_max;\n    \n    if ((temp_value>temp_value_max) || (temp_value<temp_value_min)){\n        notcondition.push({\n            [temp_value_name]:temp_value,\n            [temp_value_min_name]:temp_value_min,\n            [temp_value_max_name]:temp_value_max\n        });\n        isNotConditional = true;\n    }\n}\nmsg.payload = result;\nmsg.notcondition = notcondition;\nmsg.isNotConditional = isNotConditional;\n\nreturn msg;","outputs":1,"noerr":0,"x":150,"y":300,"wires":[["e38f317f.ebf26","2d6cb735.f9989"]]},{"id":"6ac01dd8.e1dc0c","type":"switch","z":"a3fb5650.3f6df","name":"","property":"load","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":601,"y":197,"wires":[["f0835531.2e1bf"]]},{"id":"ae6a88c7.30c188","type":"debug","z":"a3fb5650.3f6df","name":"Analysis","active":true,"console":"true","complete":"payload","x":766,"y":91,"wires":[]},{"id":"fe1386df.552098","type":"json","z":"a3fb5650.3f6df","name":"","x":613,"y":89,"wires":[["ae6a88c7.30c188"]]},{"id":"91810c35.9eacd","type":"json","z":"a3fb5650.3f6df","name":"","x":600,"y":232,"wires":[["d111c2c3.cdea6"]]},{"id":"d111c2c3.cdea6","type":"debug","z":"a3fb5650.3f6df","name":"getQuality","active":false,"console":"true","complete":"payload","x":753,"y":234,"wires":[]},{"id":"3cb0dec7.a793f2","type":"json","z":"1ef83c50.08690c","name":"","x":915,"y":228,"wires":[["48650d9c.db99c4"]]},{"id":"48650d9c.db99c4","type":"debug","z":"1ef83c50.08690c","name":"event","active":true,"console":"true","complete":"payload","x":1058,"y":229,"wires":[]},{"id":"7d338831.540c48","type":"debug","z":"a3fb5650.3f6df","name":"Analysis wihout parse","active":true,"console":"true","complete":"payload","x":412,"y":108,"wires":[]},{"id":"e6c7cf44.8127b","type":"function","z":"a3fb5650.3f6df","name":"","func":"msg.payload = {\n    msg:\"\" + msg.payload\n};\nreturn msg;","outputs":1,"noerr":0,"x":101,"y":110,"wires":[["29b7abfd.ae601c"]]},{"id":"29b7abfd.ae601c","type":"json","z":"a3fb5650.3f6df","name":"","x":224,"y":108,"wires":[["7d338831.540c48"]]},{"id":"5758c5a0.6f233c","type":"debug","z":"a3fb5650.3f6df","name":"","active":true,"console":"false","complete":"false","x":362,"y":274,"wires":[]},{"id":"c435b03f.52d0d8","type":"debug","z":"a3fb5650.3f6df","name":"","active":true,"console":"false","complete":"false","x":543,"y":21,"wires":[]},{"id":"5ada9568.26047c","type":"debug","z":"1ef83c50.08690c","name":"event","active":true,"console":"true","complete":"payload","x":1091,"y":301,"wires":[]},{"id":"1da89bce.d089bc","type":"inject","z":"a3fb5650.3f6df","name":"","topic":"","payload":"parseQA","payloadType":"flow","repeat":"","crontab":"","once":false,"x":136,"y":408,"wires":[["cff62f2d.738cb8","ac0a71a7.9959c8"]]},{"id":"cff62f2d.738cb8","type":"debug","z":"a3fb5650.3f6df","name":"","active":true,"console":"false","complete":"false","x":515,"y":403,"wires":[]},{"id":"ac0a71a7.9959c8","type":"json","z":"a3fb5650.3f6df","name":"","x":314,"y":449,"wires":[["cff62f2d.738cb8"]]},{"id":"56886d8e.852624","type":"http in","z":"a3fb5650.3f6df","name":"","url":"/gettest","method":"get","swaggerDoc":"","x":179,"y":509,"wires":[["18c105b4.96901a"]]},{"id":"a6280986.df57c8","type":"http response","z":"a3fb5650.3f6df","name":"","x":571,"y":511,"wires":[]},{"id":"18c105b4.96901a","type":"function","z":"a3fb5650.3f6df","name":"create response","func":"msg.payload = flow.get('parseQA');    \n  \nreturn msg;","outputs":1,"noerr":0,"x":413,"y":515,"wires":[["a6280986.df57c8"]]}]
