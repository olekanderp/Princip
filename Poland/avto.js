[{"id":"52049de1.4fda5c","type":"tab","label":"Dashboard"},{"id":"abbadffc.010998","type":"tab","label":"scale 1"},{"id":"ff28ef7c.bc9d7","type":"tab","label":"processing_scale1"},{"id":"4405ba9d.eb37b4","type":"tab","label":"Flow 1"},{"id":"e000942c.4e9718","type":"tab","label":"JD"},{"id":"bdf26ad7.fc049","type":"tab","label":"processing_scale1"},{"id":"92d60b25.5643a","type":"subflow","name":"ETTN","info":"","in":[],"out":[]},{"id":"314bbb74.33c2fc","type":"subflow","name":"Subflow 1","info":"","in":[],"out":[]},{"id":"e71538f6.a8deb","type":"ui_tab","z":"","name":"Smart Scales","icon":"dashboard"},{"id":"fb69cbf4.cc7ca","type":"ui_base","name":"Scale dasboard","theme":"theme-light"},{"id":"9277d5e4.5a8b7","type":"ui_group","z":"","name":"Scale and identity","tab":"e71538f6.a8deb","order":5,"disp":true,"width":"6"},{"id":"9885241c.570b28","type":"ui_group","z":"","name":"Additional properties","tab":"e71538f6.a8deb","disp":true,"width":"6"},{"id":"cf88991a.a5d898","type":"modbus-client","z":"","name":"","clienttype":"tcp","bufferCommands":true,"stateLogEnabled":false,"tcpHost":"10.10.15.203","tcpPort":"502","tcpType":"DEFAULT","serialPort":"/dev/ttyUSB","serialType":"RTU-BUFFERD","serialBaudrate":"9600","serialDatabits":"8","serialStopbits":"1","serialParity":"none","serialConnectionDelay":"100","unit_id":"1","commandDelay":"1","clientTimeout":"1000","reconnectTimeout":"2000"},{"id":"9f8ffb9b.fd4b","type":"modbus-client","z":"","name":"","clienttype":"tcp","bufferCommands":true,"stateLogEnabled":false,"tcpHost":"10.10.15.202","tcpPort":"1702","tcpType":"DEFAULT","serialPort":"/dev/ttyUSB","serialType":"RTU-BUFFERD","serialBaudrate":"9600","serialDatabits":"8","serialStopbits":"1","serialParity":"none","serialConnectionDelay":"100","unit_id":"1","commandDelay":"1","clientTimeout":"1000","reconnectTimeout":"2000"},{"id":"5d976ff4.1f4cb8","type":"function","z":"abbadffc.010998","name":"GET WEIGHT","func":"msg.payload = flow.get('parser')(msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":388,"y":219,"wires":[["4889c15e.2c4b6","bdd00c6c.199ba"]]},{"id":"10169553.f52c43","type":"comment","z":"abbadffc.010998","name":"Device level","info":"","x":90,"y":140,"wires":[]},{"id":"9ba04c32.f6295","type":"inject","z":"abbadffc.010998","name":"init","topic":"","payload":"init","payloadType":"str","repeat":"","crontab":"","once":true,"x":90,"y":80,"wires":[["c2863382.4306e"]]},{"id":"a512369d.4c27b","type":"comment","z":"abbadffc.010998","name":"INITIALIZING","info":"","x":90,"y":20,"wires":[]},{"id":"21f00895.e76f38","type":"link in","z":"ff28ef7c.bc9d7","name":"weight","links":["20edce7e.5b51e2","a952ade4.1021c","4889c15e.2c4b6"],"x":35,"y":380,"wires":[["b232375d.adbac8","9f2d9db8.20b56","45a775ed.a31c0c"]]},{"id":"b232375d.adbac8","type":"function","z":"ff28ef7c.bc9d7","name":"main module","func":"var prevWeight = flow.get('prevWeight');\nvar transaction = flow.get('transaction');\nvar transactionData = flow.get('transactionData');\nvar transactionMaxWeight = flow.get('transactionMaxWeight');\nvar transactionHasMaxWeight = flow.get('transactionHasMaxWeight');\nvar transactionHasMinWeight = flow.get('transactionHasMinWeight');\nvar transactionHasMaxDuration = flow.get('transactionHasMaxDuration');\nvar waybill = flow.get('transactionWaybill');\nvar weight = msg.payload;\nvar stableSize = 5;\nvar duration = 0;\nvar maxWeight = flow.get('maxWeight');\nvar maxDuration = flow.get('maxDuration');\nvar prevTransaction = transaction;\nvar minWeight = flow.get('minWeight');\nvar minTriggerWeight = flow.get('minTriggerWeight');\n\n//transaction\nif (prevWeight === null){\n    prevWeight = msg.payload;    \n}else{\n    if((prevWeight <= 0) && (weight > 0) && (weight > minTriggerWeight)){\n        //start of transaction\n        transaction = Date.now();\n        msg.on = true;\n        flow.set('transaction',transaction);\n    }else if((prevWeight > 0) && (weight <=0) && (transaction)){\n        transaction = 0;\n        msg.on = false;\n        transactionData = [];\n        flow.set('transaction',transaction);\n        flow.set('transactionMaxWeight',null);\n        flow.set('transactionHasMaxWeight',null);\n        flow.set('transactionHasMinWeight',null);\n        flow.set('transactionHasMaxDuration',null);\n        flow.set('transactionWaybill',null);\n        flow.set('transactionMetadata',null);\n    }else if((transaction === null) && (weight>0) && (weight > minTriggerWeight)){\n        transaction = Date.now();\n        flow.set('transaction',transaction);\n    }\n}\n\nif (transaction > 0){\n    transactionData.push(weight);    \n\n    //stable\n    if(transactionData.length > stableSize+1){\n        var stabletmp = true;\n        for (var i = transactionData.length-1; i > transactionData.length-1-stableSize; i--){\n            if (transactionData[i] !== transactionData[i-1]){\n                stabletmp = false;\n                msg.stable = stabletmp;\n                break;\n            }\n            msg.stable = stabletmp;\n        }\n    }else{\n        msg.stable = false;\n    }\n\n    //duration & transactionMaxWeight\n    duration = (Number(Date.now()) - Number(transaction));\n    if( (weight>transactionMaxWeight) || (transactionMaxWeight === null)){\n        transactionMaxWeight = weight;\n        flow.set(\"transactionMaxWeight\",transactionMaxWeight);\n    }\n    \n    if(!transactionHasMaxWeight && weight > maxWeight){\n        msg.transactionHasMaxWeight = true;\n        flow.set('transactionHasMaxWeight',true);\n    }\n    \n    if(!transactionHasMinWeight && weight < minWeight){\n        msg.transactionHasMinWeight = true;\n        flow.set('transactionHasMinWeight',true);\n    }\n    \n    //max duartion\n    if(!transactionHasMaxDuration && duration > maxDuration){\n        msg.transactionHasMaxDuration = true;\n        flow.set('transactionHasMaxDuration',true);\n    }\n}\n\n//result\nmsg.metadata = {\n    'weight':weight,\n    'prevWeight':prevWeight,\n    'prevTransaction':prevTransaction,\n    'transaction':transaction,\n    'on':msg.on,\n    'transactionDataCount':transactionData.length,\n    'stable':msg.stable,\n    'duration':duration,\n    'transactionMaxWeight':transactionMaxWeight,\n    'waybill':waybill\n}\nflow.set('transactionData',transactionData);\nflow.set('prevWeight',weight);\nflow.set('transactionMetadata',msg.metadata);\nflow.set('lasttimedata', new Date());\nreturn msg;","outputs":1,"noerr":0,"x":170,"y":400,"wires":[["8a0ccafb.bb71c8","a13d0687.71e8d8","342d4a2e.6d0cc6","e65becf2.6f36b8","c16187c0.c5f"]]},{"id":"c8a22dea.1e164","type":"function","z":"ff28ef7c.bc9d7","name":"get weight from accounting system","func":"var transactionMetada = flow.get('transactionMetadata');\nvar buisness_data = msg.req.query;\nmsg.metadata = Object.assign(transactionMetada,buisness_data);\nmsg.event_id = flow.get('event_get_weight_acc');\nflow.set('transactionWaybill',msg.req.query.waybill);\nmsg.description = 'Зважили в 1С. Поточна вага: ' + msg.metadata.weight+\" Номер авто: \"+buisness_data.truck_id+\" \"+buisness_data.truck2_id;\nreturn msg;","outputs":1,"noerr":0,"x":440,"y":700,"wires":[["afc0cdb8.a726f"]]},{"id":"8a0ccafb.bb71c8","type":"switch","z":"ff28ef7c.bc9d7","name":"switch move","property":"on","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":390,"y":360,"wires":[["36cc9850.51a698"],["3bb4c54c.8d14ca","cb8b227f.3e8dd8"]]},{"id":"b4e1888d.abfc78","type":"http request","z":"ff28ef7c.bc9d7","name":"EVENTS","method":"POST","ret":"txt","url":"","tls":"","x":1140,"y":440,"wires":[["6c553406.f86b74"]]},{"id":"afc0cdb8.a726f","type":"function","z":"ff28ef7c.bc9d7","name":"events payload","func":"var event_id = msg.event_id;\nvar scale_id = flow.get('scale_id');\nmsg.payload = {\n    'event':{\n        'id':msg.event_id\n    },\n    'devices':[{'id':scale_id}],\n    'data':msg.metadata,\n    'description':msg.description\n}\n\nmsg.headers = {\n    \"content-type\":\"application/json\"\n}\n\nmsg.url = flow.get('main_host')+flow.get('event_url');\nmsg.main_host = flow.get('main_host');\nmsg.event_url = flow.get('event_url');\n\nreturn msg;","outputs":1,"noerr":0,"x":940,"y":440,"wires":[["bfae188f.61d91","2f33c250.ddae8e"]]},{"id":"36cc9850.51a698","type":"function","z":"ff28ef7c.bc9d7","name":"move in","func":"msg.event_id = flow.get('event_move_in_id');\nmsg.description = 'Заїзд на ваги. Поточна вага: ' + msg.metadata.weight;\n\nreturn msg;","outputs":1,"noerr":0,"x":580,"y":320,"wires":[["afc0cdb8.a726f"]]},{"id":"a13d0687.71e8d8","type":"switch","z":"ff28ef7c.bc9d7","name":"switch max weight","property":"transactionHasMaxWeight","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":390,"y":400,"wires":[["30454f9.6f53cb"]]},{"id":"30454f9.6f53cb","type":"function","z":"ff28ef7c.bc9d7","name":"transactionHasMaxWeight","func":"msg.event_id = flow.get('event_max_weight_id');\nmsg.description = 'Перевищена максимально-допустима вага: ' + msg.metadata.weight;\nmsg.needSnapshot = true;\n\nreturn msg;","outputs":1,"noerr":0,"x":630,"y":400,"wires":[["afc0cdb8.a726f"]]},{"id":"28f92c3d.4f0364","type":"inject","z":"ff28ef7c.bc9d7","name":"","topic":"","payload":"","payloadType":"date","repeat":"1","crontab":"","once":false,"x":110,"y":620,"wires":[["b82a2848.8a6078"]]},{"id":"b82a2848.8a6078","type":"function","z":"ff28ef7c.bc9d7","name":"check scale health","func":"var lastcheckHealth = flow.get('checkHealth');\nvar checkHealth = null;\nvar lasttimedata = flow.get('lasttimedata');\n\nvar currenttimedata = new Date();\n\nif ((currenttimedata - lasttimedata) > 3000){\n    checkHealth = false;\n} else {\n    checkHealth = true;\n}\n\nflow.set(\"checkHealth\",checkHealth);\n\nif (lastcheckHealth != checkHealth){\n    msg.checkHealth = checkHealth;\n}else{\n    msg.checkHealth = null;\n}\nmsg.payload = checkHealth;\n\nreturn msg;","outputs":1,"noerr":0,"x":290,"y":620,"wires":[["a3738e37.ae7f88","9e4676ce.86a42"]]},{"id":"a3738e37.ae7f88","type":"switch","z":"ff28ef7c.bc9d7","name":"","property":"checkHealth","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":470,"y":580,"wires":[["8ff9c378.2ad6c8"],["10f1eb37.17002d"]]},{"id":"10f1eb37.17002d","type":"function","z":"ff28ef7c.bc9d7","name":"off","func":"msg.event_id = flow.get('event_off_id');\nmsg.description = 'Прилад відключено';\nmsg.metadata = {\n    'state':msg.checkHealth\n}\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":560,"wires":[["afc0cdb8.a726f"]]},{"id":"8ff9c378.2ad6c8","type":"function","z":"ff28ef7c.bc9d7","name":"on","func":"msg.event_id = flow.get('event_on_id');\nmsg.description = 'Прилад підключено';\nmsg.metadata = {\n    'state':msg.checkHealth\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":520,"wires":[["afc0cdb8.a726f"]]},{"id":"23fef191.72fb8e","type":"function","z":"ff28ef7c.bc9d7","name":"main config","func":"flow.set('prevWeight',null);\nflow.set('transaction',null);\nflow.set('transactionData',[]);\nflow.set('transactionMaxWeight',null);\nflow.set('transactionHasMinWeight',null);\nflow.set('transactionHasMaxWeight',null);\nflow.set('transactionHasMaxDuration',null);\nflow.set('lasttimedata', new Date());\nflow.set('checkHealth',null);\nflow.set('transactionWaybill',null);\n\nreturn msg;\n","outputs":1,"noerr":0,"x":370,"y":240,"wires":[[]]},{"id":"52015096.f6bc","type":"inject","z":"ff28ef7c.bc9d7","name":"","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":true,"x":90,"y":220,"wires":[["1c88c517.d1200b","23fef191.72fb8e"]]},{"id":"c5b5abb1.7253f","type":"http request","z":"ff28ef7c.bc9d7","name":"STATE","method":"POST","ret":"txt","url":"","tls":"","x":1130,"y":580,"wires":[["f31ea76d.88682"]]},{"id":"9e4676ce.86a42","type":"function","z":"ff28ef7c.bc9d7","name":"device state","func":"msg.payload = {\n    \"state\":msg.payload\n}\nmsg.headers = {\n    \"content-type\":\"application/json\"\n}\nmsg.url = flow.get('main_host')+flow.get('state_url')+\"?id=\"+flow.get(\"scale_id\");\nreturn msg;","outputs":1,"noerr":0,"x":950,"y":580,"wires":[[]]},{"id":"c2863382.4306e","type":"function","z":"abbadffc.010998","name":"Модель весов","func":"flow.set('inputString',\"CMD\");\nflow.set('parser',function(v){\n       v = v;\n       return Number(v);\n    }\n  );\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":80,"wires":[[]]},{"id":"4cffb066.e84f88","type":"function","z":"ff28ef7c.bc9d7","name":"device config","func":"var device_config = JSON.parse(msg.payload);\n\nflow.set('scale_id',device_config.scale_id);\nflow.set('event_move_in_id',device_config.event_move_in_id);\nflow.set('event_move_out_id',device_config.event_move_out_id);\nflow.set('event_max_weight_id',device_config.event_max_weight_id);\nflow.set('event_off_id',device_config.event_off_id);\nflow.set('event_on_id', device_config.event_on_id);\nflow.set('event_max_duration',device_config.event_max_duration);\nflow.set('event_fake_traffic',device_config.event_fake_traffic);\nflow.set('main_host',device_config.main_host);\nflow.set('event_url',device_config.event_url);\nflow.set('state_url',device_config.state_url);\nflow.set('maxWeight',device_config.maxWeight);\nflow.set('minWeight',device_config.minWeight);\nflow.set('maxDuration',device_config.maxDuration);\nflow.set('checkHealthTimeout',device_config.checkHealthTimeout);\nflow.set('event_get_weight_acc',device_config.event_get_weight_acc);\nflow.set('event_min_weight',device_config.event_min_weight);\nflow.set('minTriggerWeight',device_config.minTriggerWeight);\nflow.set('snapshot_url',device_config.minTriggerWeight);\nflow.set('camera_url',device_config.camera_url);\n\n\n\n// flow.set('scale_id','80096CB0EFD83B63E0533300000A4334');\n// flow.set('event_move_in_id','80096D9ABE7F68F3E0533300000A6C0D');\n// flow.set('event_move_out_id','80096D9ABE8068F3E0533300000A6C0D');\n// flow.set('event_max_weight_id','85A255F950F9BEF4E0533300000AC45D');\n// flow.set('event_off_id','85A2CC4570292DD1E0533300000A0C94');\n// flow.set('event_on_id', '85A2CC45702A2DD1E0533300000A0C94');\n// flow.set('event_max_duration','8642EE858DE89BAAE0533300000AFCC7');\n// flow.set('main_host','http://prod.apex.rest/ords/ettn');\n// flow.set('event_url','/iot_cli/events/log');\n// flow.set('state_url','/v1/device');\n// flow.set('maxWeight',40000);\n// flow.set('maxDuration',20000);\n// flow.set('checkHealthTimeout',3000);\n\nreturn msg;\n","outputs":1,"noerr":0,"x":570,"y":200,"wires":[[]]},{"id":"3bb4c54c.8d14ca","type":"function","z":"ff28ef7c.bc9d7","name":"move out","func":"msg.event_id = flow.get('event_move_out_id');\nmsg.description = 'Зїзд з ваг. Поточна вага: ' + msg.metadata.weight;\n\nreturn msg;","outputs":1,"noerr":0,"x":580,"y":360,"wires":[["afc0cdb8.a726f"]]},{"id":"342d4a2e.6d0cc6","type":"switch","z":"ff28ef7c.bc9d7","name":"max duration","property":"transactionHasMaxDuration","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":370,"y":440,"wires":[["5d214a39.dacb5c"]]},{"id":"5d214a39.dacb5c","type":"function","z":"ff28ef7c.bc9d7","name":"transaction has max duration","func":"msg.event_id = flow.get('event_max_duration');\nmsg.description = 'Перевищено максимальний час находження на вагах: ' + msg.metadata.duration/1000;\n\nreturn msg;","outputs":1,"noerr":0,"x":640,"y":440,"wires":[["afc0cdb8.a726f"]]},{"id":"abe1cb4.62170b8","type":"http in","z":"ff28ef7c.bc9d7","name":"","url":"/firmware","method":"post","swaggerDoc":"","x":140,"y":160,"wires":[["ca36a90e.ab6a98"]]},{"id":"ca36a90e.ab6a98","type":"file","z":"ff28ef7c.bc9d7","name":"deivce_config","filename":"deivce_config.json","appendNewline":true,"createDir":false,"overwriteFile":"true","x":380,"y":160,"wires":[]},{"id":"1c88c517.d1200b","type":"file in","z":"ff28ef7c.bc9d7","name":"deivce_config","filename":"deivce_config.json","format":"utf8","x":380,"y":200,"wires":[["4cffb066.e84f88"]]},{"id":"cae1cde7.412af8","type":"http in","z":"ff28ef7c.bc9d7","name":"","url":"/serial","method":"get","swaggerDoc":"","x":120,"y":40,"wires":[["3177252b.3e15a2"]]},{"id":"3177252b.3e15a2","type":"exec","z":"ff28ef7c.bc9d7","command":"cat /proc/cpuinfo","addpay":true,"append":"| grep Serial","useSpawn":"","timer":"5","name":"","x":350,"y":40,"wires":[["52704729.d357e8","b7936fe7.d40408"],[],[]]},{"id":"52704729.d357e8","type":"http response","z":"ff28ef7c.bc9d7","name":"","x":550,"y":20,"wires":[]},{"id":"b7936fe7.d40408","type":"function","z":"ff28ef7c.bc9d7","name":"","func":"msg.payload = msg.payload.split(':')[1].replace('\\n','').replace(' ','');\nreturn msg;","outputs":1,"noerr":0,"x":540,"y":100,"wires":[["f085c9a9.58c888"]]},{"id":"f085c9a9.58c888","type":"debug","z":"ff28ef7c.bc9d7","name":"","active":false,"console":"false","complete":"false","x":705,"y":98,"wires":[]},{"id":"2468ca8c.8cc956","type":"inject","z":"ff28ef7c.bc9d7","name":"DEMO","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":true,"x":90,"y":100,"wires":[["8901221.bc003e"]]},{"id":"8901221.bc003e","type":"function","z":"ff28ef7c.bc9d7","name":"DEMO Data","func":"var device_config = {\n    'scale_id':'889DEB1AA0C57FC8E055000000000001',\n    'event_move_in_id':'80096D9ABE7F68F3E0533300000A6C0D',\n    'event_move_out_id':'80096D9ABE8068F3E0533300000A6C0D',\n    'event_max_weight_id':'85A255F950F9BEF4E0533300000AC45D',\n    'event_off_id':'85A2CC4570292DD1E0533300000A0C94',\n    'event_max_duration':'8642EE858DE89BAAE0533300000AFCC7',\n    'event_fake_traffic':'80096EF60C186574E0533300000ADBA5',\n    'event_get_weight_acc':'800970AC1FDC683CE0533300000AF1B0',\n    'event_min_weight':'875C3EB5C9DD092DE055000000000001',\n    'main_host':'http://ettn.apex.rest/ords/ettn',\n    'camera_url':'http://infoindustria.com.ua/wp-content/uploads/2016/08/zerno-mashina-300x225.jpg',\n    'event_url':'/iot_cli/events/log',\n    'state_url':'/iot_cli/device',\n    'snapshot_url':'/iot_cli/events/snapshot',\n    'maxWeight':40000,\n    'maxDuration':20000,\n    'minWeight':0,\n    'checkHealthTimeout':3000,\n    'minTriggerWeight':200\n}\nmsg.payload = device_config;\n// flow.set('scale_id','80096CB0EFD83B63E0533300000A4334');\n// flow.set('event_move_in_id','80096D9ABE7F68F3E0533300000A6C0D');\n// flow.set('event_move_out_id','80096D9ABE8068F3E0533300000A6C0D');\n// flow.set('event_max_weight_id','85A255F950F9BEF4E0533300000AC45D');\n// flow.set('event_off_id','85A2CC4570292DD1E0533300000A0C94');\n// flow.set('event_on_id', '85A2CC45702A2DD1E0533300000A0C94');\n// flow.set('event_max_duration','8642EE858DE89BAAE0533300000AFCC7');\n// flow.set('main_host','http://prod.apex.rest/ords/ettn');\n// flow.set('event_url','/iot_cli/events/log');\n// flow.set('state_url','/v1/device');\n// flow.set('maxWeight',40000);\n// flow.set('maxDuration',20000);\n// flow.set('checkHealthTimeout',3000);\nreturn msg;","outputs":1,"noerr":0,"x":299.9999694824219,"y":99.99999237060547,"wires":[["ca36a90e.ab6a98"]]},{"id":"9f2d9db8.20b56","type":"debug","z":"ff28ef7c.bc9d7","name":"","active":false,"console":"false","complete":"false","x":100,"y":320,"wires":[]},{"id":"4889c15e.2c4b6","type":"link out","z":"abbadffc.010998","name":"","links":["21f00895.e76f38"],"x":521,"y":219,"wires":[]},{"id":"cb8b227f.3e8dd8","type":"switch","z":"ff28ef7c.bc9d7","name":"waybill","property":"metadata.waybill","propertyType":"msg","rules":[{"t":"null"}],"checkall":"true","outputs":1,"x":580,"y":280,"wires":[["5385e689.81d99"]]},{"id":"5385e689.81d99","type":"function","z":"ff28ef7c.bc9d7","name":"move in","func":"msg.event_id = flow.get('event_fake_traffic');\nmsg.description = 'Холостий проїзд по вагам. Транзакція ' + msg.metadata.prevTransaction;\n\nreturn msg;","outputs":1,"noerr":0,"x":720,"y":280,"wires":[["afc0cdb8.a726f","ca11f7fd.d70f7"]]},{"id":"ca11f7fd.d70f7","type":"debug","z":"ff28ef7c.bc9d7","name":"","active":false,"console":"false","complete":"false","x":930,"y":280,"wires":[]},{"id":"c1d9c1c7.504fb8","type":"http in","z":"ff28ef7c.bc9d7","name":"","url":"/getWeight","method":"get","swaggerDoc":"","x":140,"y":740,"wires":[["c8a22dea.1e164","93c30d44.612558"]]},{"id":"f9755cd4.c5c5f","type":"http response","z":"ff28ef7c.bc9d7","name":"","x":530,"y":740,"wires":[]},{"id":"93c30d44.612558","type":"function","z":"ff28ef7c.bc9d7","name":"response","func":"msg.payload = flow.get('transactionMetadata');\nmsg.payload.sub_weight = flow.get('sub_weight_2');\nreturn msg;","outputs":1,"noerr":0,"x":360,"y":780,"wires":[["f9755cd4.c5c5f","470e544a.345874"]]},{"id":"470e544a.345874","type":"debug","z":"ff28ef7c.bc9d7","name":"","active":false,"console":"false","complete":"false","x":550,"y":780,"wires":[]},{"id":"11982baa.6bc00c","type":"link in","z":"52049de1.4fda5c","name":"dashboard","links":["e65becf2.6f36b8","30939ebe.d49e0a","9bb81a14.cf3438"],"x":80,"y":100,"wires":[["e6a5513d.b7ce2","78458bde.c97444","653bcdcb.4a7dcc","e515831b.2e09f","65da81d3.4e5348","ee5e13bf.273ae8"]]},{"id":"e65becf2.6f36b8","type":"link out","z":"ff28ef7c.bc9d7","name":"processing","links":["11982baa.6bc00c"],"x":340,"y":300,"wires":[]},{"id":"e6a5513d.b7ce2","type":"ui_gauge","z":"52049de1.4fda5c","name":"","group":"9277d5e4.5a8b7","order":0,"width":0,"height":0,"gtype":"gage","title":"Weight","label":"kg","format":"{{value}} kg","min":0,"max":"60000","colors":["#00b500","#e6e600","#ca3838"],"x":210,"y":20,"wires":[]},{"id":"78458bde.c97444","type":"ui_chart","z":"52049de1.4fda5c","name":"","group":"9277d5e4.5a8b7","order":0,"width":0,"height":0,"label":"History","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","ymin":"0","ymax":"60000","removeOlder":"10","removeOlderPoints":"","removeOlderUnit":"60","cutout":0,"x":210,"y":60,"wires":[[],[]]},{"id":"eef8169e.88e64","type":"ui_gauge","z":"52049de1.4fda5c","name":"","group":"9885241c.570b28","order":0,"width":0,"height":0,"gtype":"wave","title":"Time on scale","label":"units","format":"{{value}} seconds","min":0,"max":"30000","colors":["#00b500","#e6e600","#ca3838"],"x":350,"y":100,"wires":[]},{"id":"653bcdcb.4a7dcc","type":"ui_text","z":"52049de1.4fda5c","group":"9885241c.570b28","order":0,"width":0,"height":0,"name":"","label":"Stable","format":"{{msg.metadata.stable}}","layout":"row-spread","x":210,"y":140,"wires":[]},{"id":"e515831b.2e09f","type":"ui_text","z":"52049de1.4fda5c","group":"9885241c.570b28","order":0,"width":0,"height":0,"name":"","label":"on / off truck on scale","format":"{{msg.metadata.on}}","layout":"row-spread","x":260,"y":180,"wires":[]},{"id":"65da81d3.4e5348","type":"ui_text","z":"52049de1.4fda5c","group":"9885241c.570b28","order":0,"width":0,"height":0,"name":"","label":"Max weight","format":"{{msg.metadata.transactionMaxWeight}}","layout":"row-spread","x":230,"y":220,"wires":[]},{"id":"ee5e13bf.273ae8","type":"function","z":"52049de1.4fda5c","name":"duration","func":"msg.payload = msg.metadata.duration;\nreturn msg;","outputs":1,"noerr":0,"x":220,"y":100,"wires":[["eef8169e.88e64"]]},{"id":"bfae188f.61d91","type":"link out","z":"ff28ef7c.bc9d7","name":"processing event","links":["f0da2d7d.e5e8c"],"x":1120,"y":340,"wires":[]},{"id":"f31ea76d.88682","type":"debug","z":"ff28ef7c.bc9d7","name":"","active":false,"console":"false","complete":"false","x":1270,"y":580,"wires":[]},{"id":"6c553406.f86b74","type":"debug","z":"ff28ef7c.bc9d7","name":"","active":false,"console":"false","complete":"false","x":1290,"y":440,"wires":[]},{"id":"2f33c250.ddae8e","type":"debug","z":"ff28ef7c.bc9d7","name":"","active":false,"console":"false","complete":"false","x":1140,"y":280,"wires":[]},{"id":"c16187c0.c5f","type":"switch","z":"ff28ef7c.bc9d7","name":"switch min weight","property":"transactionHasMinWeight","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":390,"y":480,"wires":[["ea626fa9.b12728"]]},{"id":"ea626fa9.b12728","type":"function","z":"ff28ef7c.bc9d7","name":"transactionHasMinWeight","func":"msg.event_id = flow.get('event_min_weight');\nmsg.description = 'Перевищена мінімально-допустима вага: ' + msg.metadata.weight;\n\nreturn msg;","outputs":1,"noerr":0,"x":630,"y":480,"wires":[["afc0cdb8.a726f"]]},{"id":"47af1e0a.b48f5","type":"switch","z":"ff28ef7c.bc9d7","name":"take snapshot","property":"needSnapshot","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":1290,"y":500,"wires":[["d84afe69.cf6978"]]},{"id":"3c7283d9.878bec","type":"http request","z":"ff28ef7c.bc9d7","name":"get a snapshot","method":"GET","ret":"txt","url":"","tls":"","x":1640,"y":500,"wires":[["ef9d0575.68eab8"]]},{"id":"d84afe69.cf6978","type":"function","z":"ff28ef7c.bc9d7","name":"get camera url","func":"msg.url = flow.get('camera_url');\nreturn msg;","outputs":1,"noerr":0,"x":1460,"y":500,"wires":[["3c7283d9.878bec","494cbc0a.2136d4"]]},{"id":"ef9d0575.68eab8","type":"function","z":"ff28ef7c.bc9d7","name":"snapshot payload","func":"var event_id = msg.event_id;\nvar scale_id = flow.get('scale_id');\nmsg.payload = {\n    'event':{\n        'id':msg.event_id\n    },\n    'devices':[{'id':scale_id}],\n    'snapshot':msg.payload,\n    'ext':'jpeg'\n}\n\nmsg.headers = {\n    \"content-type\":\"application/json\"\n}\n\nmsg.url = flow.get('main_host')+flow.get('snapshot_url');\nmsg.main_host = flow.get('main_host');\nmsg.snapshot_url = flow.get('snapshot_url');\n\nreturn msg;","outputs":1,"noerr":0,"x":1830,"y":500,"wires":[["66a7a25.3c5595c"]]},{"id":"66a7a25.3c5595c","type":"http request","z":"ff28ef7c.bc9d7","name":"","method":"POST","ret":"txt","url":"send a snapshot","tls":"","x":2030,"y":500,"wires":[["5e543a44.6a05d4"]]},{"id":"5e543a44.6a05d4","type":"debug","z":"ff28ef7c.bc9d7","name":"","active":true,"console":"false","complete":"false","x":2220,"y":500,"wires":[]},{"id":"494cbc0a.2136d4","type":"debug","z":"ff28ef7c.bc9d7","name":"","active":true,"console":"false","complete":"true","x":1500,"y":360,"wires":[]},{"id":"4a31ba00.8bb858","type":"debug","z":"abbadffc.010998","name":"","active":false,"console":"false","complete":"false","x":377,"y":256,"wires":[]},{"id":"bdd00c6c.199ba","type":"debug","z":"abbadffc.010998","name":"","active":true,"console":"false","complete":"false","x":454,"y":180,"wires":[]},{"id":"7297e0e7.7e5f8","type":"function","z":"abbadffc.010998","name":"parser","func":"var weight_with_reg = msg.payload[0];\nvar clear_tail = 0b00000000000000001111111111111111;\nvar LE = weight_with_reg << 8;\nvar BE = weight_with_reg >> 8;\nvar str = (LE | BE) & clear_tail;\n\n    if(str >= 50000){\n         var LE_1 = weight_with_reg & 0b0000000011111111;\n         var BE_1 = weight_with_reg >> 8;\n        \n         var buf2 = Buffer.from([BE,LE]);\n         var out = buf2.readInt16LE(0);\n        \n        msg.payload = out;\n    }else {\n        msg.payload = str;\n    }\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":180,"wires":[["5d976ff4.1f4cb8","4a31ba00.8bb858"]]},{"id":"595dd2.e0bf723","type":"http in","z":"ff28ef7c.bc9d7","name":"","url":"/getSimpleWeight","method":"get","swaggerDoc":"","x":160,"y":860,"wires":[["17ed49ec.1d10e6"]]},{"id":"17ed49ec.1d10e6","type":"function","z":"ff28ef7c.bc9d7","name":"response","func":"msg.payload = flow.get('transactionMetadata').weight;\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":840,"wires":[["fdbb7372.e69238"]]},{"id":"fdbb7372.e69238","type":"http response","z":"ff28ef7c.bc9d7","name":"","x":528,"y":871,"wires":[]},{"id":"f486b686.b5c9d","type":"debug","z":"abbadffc.010998","name":"","active":true,"console":"false","complete":"false","x":270,"y":320,"wires":[]},{"id":"83f27256.b60e98","type":"comment","z":"abbadffc.010998","name":"Device modbus","info":"","x":94,"y":202,"wires":[]},{"id":"ba52371d.1ffa5","type":"modbus-read","z":"abbadffc.010998","name":"","showStatusActivities":false,"showErrors":false,"unitid":"","dataType":"HoldingRegister","adr":"0","quantity":"1","rate":"1","rateUnit":"s","server":"cf88991a.a5d898","x":96,"y":251,"wires":[["7297e0e7.7e5f8","f486b686.b5c9d"],[]]},{"id":"ac2caaf8.5901a8","type":"inject","z":"4405ba9d.eb37b4","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":105.5,"y":147,"wires":[["45267066.bd645"]]},{"id":"f3379710.b544b","type":"http request","z":"4405ba9d.eb37b4","name":"","method":"GET","ret":"obj","url":"10.10.190.180/api/slot/0/io/di","tls":"","x":403.5,"y":140,"wires":[["d18856d7.449b88"]]},{"id":"d18856d7.449b88","type":"debug","z":"4405ba9d.eb37b4","name":"","active":true,"console":"false","complete":"true","x":556.5,"y":137,"wires":[]},{"id":"45267066.bd645","type":"function","z":"4405ba9d.eb37b4","name":"DI_Status","func":"msg.headers = {\n    \"Content-Type\": 'application/json',\n    \"Accept\": 'vdn.dac.v1'\n}\nreturn msg;","outputs":1,"noerr":0,"x":256.5,"y":146,"wires":[["f3379710.b544b"]]},{"id":"506fcafa.310474","type":"inject","z":"4405ba9d.eb37b4","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":103,"y":206,"wires":[["c79a730.9d24c9"]]},{"id":"5178ce31.ed398","type":"http request","z":"4405ba9d.eb37b4","name":"","method":"GET","ret":"obj","url":"10.10.190.180/api/slot/0/io/do","tls":"","x":426,"y":205,"wires":[["86c4f76b.d90c28"]]},{"id":"86c4f76b.d90c28","type":"debug","z":"4405ba9d.eb37b4","name":"","active":true,"console":"false","complete":"true","x":585,"y":200,"wires":[]},{"id":"c79a730.9d24c9","type":"function","z":"4405ba9d.eb37b4","name":"DO_Status","func":"msg.headers = {\n    \"Content-Type\": 'application/json',\n    \"Accept\": 'vdn.dac.v1'\n}\nreturn msg;","outputs":1,"noerr":0,"x":264,"y":205,"wires":[["5178ce31.ed398"]]},{"id":"310975a8.15aaca","type":"http in","z":"4405ba9d.eb37b4","name":"","url":"/getDiStatus","method":"get","swaggerDoc":"","x":141.6666717529297,"y":267.77777099609375,"wires":[["8611c3fd.107e68"]]},{"id":"34006e17.750dfa","type":"http response","z":"4405ba9d.eb37b4","name":"","x":556.111083984375,"y":264.4444580078125,"wires":[]},{"id":"8611c3fd.107e68","type":"function","z":"4405ba9d.eb37b4","name":"","func":"msg.payload = flow.get('di');\nreturn msg;","outputs":1,"noerr":0,"x":403.3333740234375,"y":272.2221984863281,"wires":[["34006e17.750dfa"]]},{"id":"f2c7ebcf.c7345","type":"http in","z":"4405ba9d.eb37b4","name":"","url":"/getDoStatus","method":"get","swaggerDoc":"","x":144.2857666015625,"y":321.5872802734375,"wires":[["75ec60e2.3916c"]]},{"id":"16e37357.3005ed","type":"http response","z":"4405ba9d.eb37b4","name":"","x":594.2857360839844,"y":318.25396728515625,"wires":[]},{"id":"75ec60e2.3916c","type":"function","z":"4405ba9d.eb37b4","name":"","func":"msg.payload = flow.get('do');\nreturn msg;","outputs":1,"noerr":0,"x":451.5080261230469,"y":316.03173828125,"wires":[["16e37357.3005ed"]]},{"id":"1aec7f0a.469af1","type":"http in","z":"4405ba9d.eb37b4","name":"","url":"/gettest","method":"get","swaggerDoc":"","x":133.96829223632812,"y":373.8094787597656,"wires":[["bdc9e801.86e508"]]},{"id":"bdc9e801.86e508","type":"function","z":"4405ba9d.eb37b4","name":"","func":"msg.payload = {\n    \"48\": flow.get('48'),\n    \"36\": flow.get('36'),\n    \"68\": flow.get('68'),\n    \"52\": flow.get('52'),\n    \"32\": flow.get('32'),\n    \"16_C\": flow.get('16')\n}\nreturn msg;","outputs":1,"noerr":0,"x":451.1905517578125,"y":368.2539367675781,"wires":[["1f5bb152.e2e71f"]]},{"id":"1f5bb152.e2e71f","type":"http response","z":"4405ba9d.eb37b4","name":"","x":593.96826171875,"y":370.4761657714844,"wires":[]},{"id":"9867690a.6ef58","type":"function","z":"ff28ef7c.bc9d7","name":"fix avto config","func":"flow.set('prevWeight_2',null);\nflow.set('sub_weight_2',0);\nflow.set('minTriggerWeight_2',80);\nreturn msg;\n","outputs":1,"noerr":0,"x":914.9996948242188,"y":893.3331298828125,"wires":[[]]},{"id":"45a775ed.a31c0c","type":"function","z":"ff28ef7c.bc9d7","name":"detec avto","func":"var prevWeight = flow.get('prevWeight_2');\nvar weight = msg.payload;\nvar minTriggerWeight = flow.get('minTriggerWeight_2');\n\nvar is_minus = false;\n\n//transaction\nif (prevWeight === null){\n    prevWeight = msg.payload;    \n}else{\n    if((prevWeight <= 80) && (weight > 80) && (weight > minTriggerWeight)){\n        //start of transaction\n        transaction = Date.now();\n        msg.on = true;\n        flow.set('transaction_2',transaction);\n    }else if((prevWeight > 80) && (weight <=80)){\n        //transaction = 0;\n        msg.on = false;\n        transactionData = [];\n    }\n    if((prevWeight < 0) && ((weight-prevWeight) > minTriggerWeight)){\n        //start of transaction\n        is_minus = true;\n        msg.prevWeight = prevWeight;\n    }\n}\n\n//result\nmsg.metadata = {\n    'weight':weight,\n    'prevWeight':prevWeight,\n    'on':msg.on,\n    'stable':msg.stable\n\n}\nflow.set('prevWeight_2',weight);\nflow.set('transactionMetadata_2',msg.metadata);\n\nreturn msg;","outputs":1,"noerr":0,"x":778.333251953125,"y":966.6666259765625,"wires":[["8d98bcb8.8bca78","3e04c69a.6503da"]]},{"id":"30dff359.d6647c","type":"function","z":"ff28ef7c.bc9d7","name":"move in","func":"msg.description = 'Заїзд на ваги. Поточна вага: ' + msg.metadata.weight;\n\n//add prewweight\n\nflow.set('sub_weight_2',msg.metadata.prevWeight);\nreturn msg;","outputs":1,"noerr":0,"x":1088.333251953125,"y":946.6666259765625,"wires":[["823e2c09.9af848","412bf1fa.6e873"]]},{"id":"d30dea74.658e3","type":"function","z":"ff28ef7c.bc9d7","name":"move out","func":"msg.description = 'Зїзд з ваг. Поточна вага: ' + msg.metadata.weight;\nflow.set('sub_weight_2',0);\nreturn msg;","outputs":1,"noerr":0,"x":1088.333251953125,"y":986.6666259765625,"wires":[["8fffd7ae.1d7de"]]},{"id":"8d98bcb8.8bca78","type":"switch","z":"ff28ef7c.bc9d7","name":"switch move","property":"on","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":938.333251953125,"y":966.6666259765625,"wires":[["30dff359.d6647c"],["d30dea74.658e3"]]},{"id":"823e2c09.9af848","type":"debug","z":"ff28ef7c.bc9d7","name":"move in","active":true,"console":false,"complete":"true","x":1248.333251953125,"y":946.6666259765625,"wires":[]},{"id":"8fffd7ae.1d7de","type":"debug","z":"ff28ef7c.bc9d7","name":"move out","active":true,"console":false,"complete":"true","x":1248.333251953125,"y":986.6666259765625,"wires":[]},{"id":"481a726b.e8bf3c","type":"inject","z":"ff28ef7c.bc9d7","name":"","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":true,"x":764.9999389648438,"y":896.6666564941406,"wires":[["9867690a.6ef58"]]},{"id":"412bf1fa.6e873","type":"function","z":"ff28ef7c.bc9d7","name":"","func":"var detecWeightIn = flow.get('sub_weight_2');\nmsg.payload = detecWeightIn + \", \\n\";\nreturn msg;","outputs":1,"noerr":0,"x":1090.833251953125,"y":890.0000305175781,"wires":[["81928961.c9cbf"]]},{"id":"81928961.c9cbf","type":"file","z":"ff28ef7c.bc9d7","name":"","filename":"detec.txt","appendNewline":true,"createDir":true,"overwriteFile":"false","x":1239.166748046875,"y":885.0000610351562,"wires":[]},{"id":"3e04c69a.6503da","type":"debug","z":"ff28ef7c.bc9d7","name":"","active":false,"console":"false","complete":"false","x":949.1665649414062,"y":1036.6665649414062,"wires":[]},{"id":"1b0ec212.b7ec36","type":"http response","z":"ff28ef7c.bc9d7","name":"","x":525.8333333333333,"y":1209.9999999999998,"wires":[]},{"id":"89e61135.8e628","type":"http in","z":"ff28ef7c.bc9d7","name":"","url":"/detecFile","method":"get","swaggerDoc":"","x":384.16668701171875,"y":1068.3333740234375,"wires":[["76438667.f36658"]]},{"id":"76438667.f36658","type":"file in","z":"ff28ef7c.bc9d7","name":"","filename":"detec.txt","format":"utf8","x":414.16666666666663,"y":1126.6666666666665,"wires":[["1b0ec212.b7ec36"]]},{"id":"63414c81.7fd254","type":"inject","z":"e000942c.4e9718","name":"","topic":"","payload":"","payloadType":"date","repeat":"2","crontab":"","once":false,"x":110,"y":280,"wires":[["2cb909b0.16f0c6"]]},{"id":"a640d678.88d208","type":"tcp request","z":"e000942c.4e9718","server":"10.10.15.208","port":"1702","out":"char","splitc":"\\n","name":"","x":420,"y":280,"wires":[["11d1ab02.dba8e5"]]},{"id":"2cb909b0.16f0c6","type":"function","z":"e000942c.4e9718","name":"","func":"msg.payload = \"S\" + String.fromCharCode(13) + String.fromCharCode(10);\nreturn msg;","outputs":1,"noerr":0,"x":230,"y":280,"wires":[["a640d678.88d208","e58122ad.b93348"]]},{"id":"11d1ab02.dba8e5","type":"function","z":"e000942c.4e9718","name":"","func":"msg.payload = msg.payload.toString();\nreturn msg;","outputs":1,"noerr":0,"x":590,"y":280,"wires":[["4fc8c0c6.a43648","b352930c.63cf5"]]},{"id":"e58122ad.b93348","type":"debug","z":"e000942c.4e9718","name":"","active":true,"console":"false","complete":"false","x":390,"y":240,"wires":[]},{"id":"7c8aeab2.010aec","type":"function","z":"e000942c.4e9718","name":"Модель весов","func":"flow.set('inputString',\"CMD\");\nflow.set('parser',function(v){\n       v = v.replace(\"S\",\"\");\n       v = v.replace(\"S\",\"\");\n       v = v.replace(\"kg\",\"\");\n       return Number(v);\n       //return v;\n    }\n  );\nreturn msg;","outputs":1,"noerr":0,"x":260,"y":100,"wires":[[]]},{"id":"4fc8c0c6.a43648","type":"function","z":"e000942c.4e9718","name":"GET WEIGHT","func":"msg.payload = flow.get('parser')(msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":280,"wires":[["7c8468d8.2be09","46346775.90589"]]},{"id":"7baba796.d87ce8","type":"comment","z":"e000942c.4e9718","name":"Device level","info":"","x":110,"y":220,"wires":[]},{"id":"89fc8764.22644","type":"inject","z":"e000942c.4e9718","name":"init","topic":"","payload":"init","payloadType":"str","repeat":"","crontab":"","once":true,"x":90,"y":100,"wires":[["7c8aeab2.010aec"]]},{"id":"58267ee3.cb196","type":"comment","z":"e000942c.4e9718","name":"INITIALIZING","info":"","x":110,"y":60,"wires":[]},{"id":"7c8468d8.2be09","type":"link out","z":"e000942c.4e9718","name":"","links":["20ede6e4.a1c78a"],"x":873,"y":280,"wires":[]},{"id":"b352930c.63cf5","type":"debug","z":"e000942c.4e9718","name":"","active":true,"console":"false","complete":"false","x":729,"y":317,"wires":[]},{"id":"46346775.90589","type":"debug","z":"e000942c.4e9718","name":"","active":true,"console":"false","complete":"false","x":870,"y":220,"wires":[]},{"id":"582b50f4.2514d","type":"debug","z":"e000942c.4e9718","name":"","active":true,"console":"false","complete":"false","x":490,"y":120,"wires":[]},{"id":"df8687f2.2f5fb","type":"file","z":"bdf26ad7.fc049","name":"deivce_config","filename":"deivce_config.json","appendNewline":true,"createDir":false,"overwriteFile":"true","x":400,"y":180,"wires":[]},{"id":"20ede6e4.a1c78a","type":"link in","z":"bdf26ad7.fc049","name":"weight Jd","links":["7c8468d8.2be09"],"x":55,"y":400,"wires":[["42f75551.5fe7cc","3b7ac41b.ecf2b4"]]},{"id":"42f75551.5fe7cc","type":"function","z":"bdf26ad7.fc049","name":"main module","func":"var prevWeight = flow.get('prevWeight');\nvar transaction = flow.get('transaction');\nvar transactionData = flow.get('transactionData');\nvar transactionMaxWeight = flow.get('transactionMaxWeight');\nvar transactionHasMaxWeight = flow.get('transactionHasMaxWeight');\nvar transactionHasMinWeight = flow.get('transactionHasMinWeight');\nvar transactionHasMaxDuration = flow.get('transactionHasMaxDuration');\nvar waybill = flow.get('transactionWaybill');\nvar weight = msg.payload;\nvar stableSize = 5;\nvar duration = 0;\nvar maxWeight = flow.get('maxWeight');\nvar maxDuration = flow.get('maxDuration');\nvar prevTransaction = transaction;\nvar minWeight = flow.get('minWeight');\nvar minTriggerWeight = flow.get('minTriggerWeight');\n\n//transaction\nif (prevWeight === null){\n    prevWeight = msg.payload;    \n}else{\n    if((prevWeight <= 0) && (weight > 0) && (weight > minTriggerWeight)){\n        //start of transaction\n        transaction = Date.now();\n        msg.on = true;\n        flow.set('transaction',transaction);\n    }else if((prevWeight > 0) && (weight <=0) && (transaction)){\n        transaction = 0;\n        msg.on = false;\n        transactionData = [];\n        flow.set('transaction',transaction);\n        flow.set('transactionMaxWeight',null);\n        flow.set('transactionHasMaxWeight',null);\n        flow.set('transactionHasMinWeight',null);\n        flow.set('transactionHasMaxDuration',null);\n        flow.set('transactionWaybill',null);\n        flow.set('transactionMetadata',null);\n    }else if((transaction === null) && (weight>0) && (weight > minTriggerWeight)){\n        transaction = Date.now();\n        flow.set('transaction',transaction);\n    }\n}\n\nif (transaction > 0){\n    transactionData.push(weight);    \n\n    //stable\n    if(transactionData.length > stableSize+1){\n        var stabletmp = true;\n        for (var i = transactionData.length-1; i > transactionData.length-1-stableSize; i--){\n            if (transactionData[i] !== transactionData[i-1]){\n                stabletmp = false;\n                msg.stable = stabletmp;\n                break;\n            }\n            msg.stable = stabletmp;\n        }\n    }else{\n        msg.stable = false;\n    }\n\n    //duration & transactionMaxWeight\n    duration = (Number(Date.now()) - Number(transaction));\n    if( (weight>transactionMaxWeight) || (transactionMaxWeight === null)){\n        transactionMaxWeight = weight;\n        flow.set(\"transactionMaxWeight\",transactionMaxWeight);\n    }\n    \n    if(!transactionHasMaxWeight && weight > maxWeight){\n        msg.transactionHasMaxWeight = true;\n        flow.set('transactionHasMaxWeight',true);\n    }\n    \n    if(!transactionHasMinWeight && weight < minWeight){\n        msg.transactionHasMinWeight = true;\n        flow.set('transactionHasMinWeight',true);\n    }\n    \n    //max duartion\n    if(!transactionHasMaxDuration && duration > maxDuration){\n        msg.transactionHasMaxDuration = true;\n        flow.set('transactionHasMaxDuration',true);\n    }\n}\n\n//result\nmsg.metadata = {\n    'weight':weight,\n    'prevWeight':prevWeight,\n    'prevTransaction':prevTransaction,\n    'transaction':transaction,\n    'on':msg.on,\n    'transactionDataCount':transactionData.length,\n    'stable':msg.stable,\n    'duration':duration,\n    'transactionMaxWeight':transactionMaxWeight,\n    'waybill':waybill\n}\nflow.set('transactionData',transactionData);\nflow.set('prevWeight',weight);\nflow.set('transactionMetadata',msg.metadata);\nflow.set('lasttimedata', new Date());\nreturn msg;","outputs":1,"noerr":0,"x":190,"y":400,"wires":[["abcaf54d.3e6428","f236b8f4.ba52e8","c03cd462.f4c2e","226fd3b.d5176ac"]]},{"id":"a75058d4.5fe6e8","type":"function","z":"bdf26ad7.fc049","name":"get weight from accounting system","func":"var transactionMetada = flow.get('transactionMetadata');\nvar buisness_data = msg.req.query;\nmsg.metadata = Object.assign(transactionMetada,buisness_data);\nmsg.event_id = flow.get('event_get_weight_acc');\nflow.set('transactionWaybill',msg.req.query.waybill);\nmsg.description = 'Зважили в 1С. Поточна вага: ' + msg.metadata.weight+\" Номер авто: \"+buisness_data.truck_id+\" \"+buisness_data.truck2_id;\nreturn msg;","outputs":1,"noerr":0,"x":460,"y":720,"wires":[["2635fad5.12921e"]]},{"id":"abcaf54d.3e6428","type":"switch","z":"bdf26ad7.fc049","name":"switch move","property":"on","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":410,"y":380,"wires":[["81c2e01f.bcf778"],["9405f89d.409ef8","3cf9305b.0b7ff"]]},{"id":"7c72e7b0.72dfc8","type":"http request","z":"bdf26ad7.fc049","name":"EVENTS","method":"POST","ret":"txt","url":"","tls":"","x":1160,"y":460,"wires":[["ff0d0781.777a6"]]},{"id":"2635fad5.12921e","type":"function","z":"bdf26ad7.fc049","name":"events payload","func":"var event_id = msg.event_id;\nvar scale_id = flow.get('scale_id');\nmsg.payload = {\n    'event':{\n        'id':msg.event_id\n    },\n    'devices':[{'id':scale_id}],\n    'data':msg.metadata,\n    'description':msg.description\n}\n\nmsg.headers = {\n    \"content-type\":\"application/json\"\n}\n\nmsg.url = flow.get('main_host')+flow.get('event_url');\nmsg.main_host = flow.get('main_host');\nmsg.event_url = flow.get('event_url');\n\nreturn msg;","outputs":1,"noerr":0,"x":960,"y":460,"wires":[["3f928702.d6b6"]]},{"id":"81c2e01f.bcf778","type":"function","z":"bdf26ad7.fc049","name":"move in","func":"msg.event_id = flow.get('event_move_in_id');\nmsg.description = 'Заїзд на ваги. Поточна вага: ' + msg.metadata.weight;\n\nreturn msg;","outputs":1,"noerr":0,"x":600,"y":340,"wires":[["2635fad5.12921e"]]},{"id":"f236b8f4.ba52e8","type":"switch","z":"bdf26ad7.fc049","name":"switch max weight","property":"transactionHasMaxWeight","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":410,"y":420,"wires":[["80cb2cb0.5c2598"]]},{"id":"80cb2cb0.5c2598","type":"function","z":"bdf26ad7.fc049","name":"transactionHasMaxWeight","func":"msg.event_id = flow.get('event_max_weight_id');\nmsg.description = 'Перевищена максимально-допустима вага: ' + msg.metadata.weight;\nmsg.needSnapshot = true;\n\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":420,"wires":[["2635fad5.12921e"]]},{"id":"1612db3e.3e6185","type":"inject","z":"bdf26ad7.fc049","name":"","topic":"","payload":"","payloadType":"date","repeat":"1","crontab":"","once":false,"x":130,"y":640,"wires":[["4da8b7bb.6f9f5"]]},{"id":"4da8b7bb.6f9f5","type":"function","z":"bdf26ad7.fc049","name":"check scale health","func":"var lastcheckHealth = flow.get('checkHealth');\nvar checkHealth = null;\nvar lasttimedata = flow.get('lasttimedata');\n\nvar currenttimedata = new Date();\n\nif ((currenttimedata - lasttimedata) > 3000){\n    checkHealth = false;\n} else {\n    checkHealth = true;\n}\n\nflow.set(\"checkHealth\",checkHealth);\n\nif (lastcheckHealth != checkHealth){\n    msg.checkHealth = checkHealth;\n}else{\n    msg.checkHealth = null;\n}\nmsg.payload = checkHealth;\n\nreturn msg;","outputs":1,"noerr":0,"x":310,"y":640,"wires":[["d77290b3.ebf058"]]},{"id":"d77290b3.ebf058","type":"switch","z":"bdf26ad7.fc049","name":"","property":"checkHealth","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":490,"y":600,"wires":[["ebabc522.ef17d8"],["5bab9093.cc8d6"]]},{"id":"5bab9093.cc8d6","type":"function","z":"bdf26ad7.fc049","name":"off","func":"msg.event_id = flow.get('event_off_id');\nmsg.description = 'Прилад відключено';\nmsg.metadata = {\n    'state':msg.checkHealth\n}\nreturn msg;","outputs":1,"noerr":0,"x":630,"y":580,"wires":[["2635fad5.12921e"]]},{"id":"ebabc522.ef17d8","type":"function","z":"bdf26ad7.fc049","name":"on","func":"msg.event_id = flow.get('event_on_id');\nmsg.description = 'Прилад підключено';\nmsg.metadata = {\n    'state':msg.checkHealth\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":630,"y":540,"wires":[["2635fad5.12921e"]]},{"id":"e7379902.c7aba","type":"function","z":"bdf26ad7.fc049","name":"main config","func":"flow.set('prevWeight',null);\nflow.set('transaction',null);\nflow.set('transactionData',[]);\nflow.set('transactionMaxWeight',null);\nflow.set('transactionHasMinWeight',null);\nflow.set('transactionHasMaxWeight',null);\nflow.set('transactionHasMaxDuration',null);\nflow.set('lasttimedata', new Date());\nflow.set('checkHealth',null);\nflow.set('transactionWaybill',null);\n\nreturn msg;\n","outputs":1,"noerr":0,"x":390,"y":260,"wires":[[]]},{"id":"aa6d8a11.ccd558","type":"inject","z":"bdf26ad7.fc049","name":"","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":true,"x":110,"y":240,"wires":[["e7379902.c7aba","8ca9840b.248c6"]]},{"id":"43fde46b.bddab4","type":"http request","z":"bdf26ad7.fc049","name":"STATE","method":"POST","ret":"txt","url":"","tls":"","x":1150,"y":600,"wires":[["d00ae1e5.225928"]]},{"id":"9b05916e.926bf8","type":"function","z":"bdf26ad7.fc049","name":"device config","func":"var device_config = JSON.parse(msg.payload);\n\nflow.set('scale_id',device_config.scale_id);\nflow.set('event_move_in_id',device_config.event_move_in_id);\nflow.set('event_move_out_id',device_config.event_move_out_id);\nflow.set('event_max_weight_id',device_config.event_max_weight_id);\nflow.set('event_off_id',device_config.event_off_id);\nflow.set('event_on_id', device_config.event_on_id);\nflow.set('event_max_duration',device_config.event_max_duration);\nflow.set('event_fake_traffic',device_config.event_fake_traffic);\nflow.set('main_host',device_config.main_host);\nflow.set('event_url',device_config.event_url);\nflow.set('state_url',device_config.state_url);\nflow.set('maxWeight',device_config.maxWeight);\nflow.set('minWeight',device_config.minWeight);\nflow.set('maxDuration',device_config.maxDuration);\nflow.set('checkHealthTimeout',device_config.checkHealthTimeout);\nflow.set('event_get_weight_acc',device_config.event_get_weight_acc);\nflow.set('event_min_weight',device_config.event_min_weight);\nflow.set('minTriggerWeight',device_config.minTriggerWeight);\nflow.set('snapshot_url',device_config.minTriggerWeight);\nflow.set('camera_url',device_config.camera_url);\n\n\n\n// flow.set('scale_id','80096CB0EFD83B63E0533300000A4334');\n// flow.set('event_move_in_id','80096D9ABE7F68F3E0533300000A6C0D');\n// flow.set('event_move_out_id','80096D9ABE8068F3E0533300000A6C0D');\n// flow.set('event_max_weight_id','85A255F950F9BEF4E0533300000AC45D');\n// flow.set('event_off_id','85A2CC4570292DD1E0533300000A0C94');\n// flow.set('event_on_id', '85A2CC45702A2DD1E0533300000A0C94');\n// flow.set('event_max_duration','8642EE858DE89BAAE0533300000AFCC7');\n// flow.set('main_host','http://prod.apex.rest/ords/ettn');\n// flow.set('event_url','/iot_cli/events/log');\n// flow.set('state_url','/v1/device');\n// flow.set('maxWeight',40000);\n// flow.set('maxDuration',20000);\n// flow.set('checkHealthTimeout',3000);\n\nreturn msg;\n","outputs":1,"noerr":0,"x":690,"y":220,"wires":[[]]},{"id":"9405f89d.409ef8","type":"function","z":"bdf26ad7.fc049","name":"move out","func":"msg.event_id = flow.get('event_move_out_id');\nmsg.description = 'Зїзд з ваг. Поточна вага: ' + msg.metadata.weight;\n\nreturn msg;","outputs":1,"noerr":0,"x":600,"y":380,"wires":[["2635fad5.12921e"]]},{"id":"c03cd462.f4c2e","type":"switch","z":"bdf26ad7.fc049","name":"max duration","property":"transactionHasMaxDuration","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":390,"y":460,"wires":[["5d37f1f5.74dcd8"]]},{"id":"5d37f1f5.74dcd8","type":"function","z":"bdf26ad7.fc049","name":"transaction has max duration","func":"msg.event_id = flow.get('event_max_duration');\nmsg.description = 'Перевищено максимальний час находження на вагах: ' + msg.metadata.duration/1000;\n\nreturn msg;","outputs":1,"noerr":0,"x":660,"y":460,"wires":[["2635fad5.12921e"]]},{"id":"a7849864.5ceb","type":"http in","z":"bdf26ad7.fc049","name":"","url":"/firmware","method":"post","swaggerDoc":"","x":160,"y":180,"wires":[["df8687f2.2f5fb"]]},{"id":"4b967d6d.2fa50c","type":"file in","z":"bdf26ad7.fc049","name":"deivce_config","filename":"deivce_config.json","format":"utf8","x":500,"y":220,"wires":[["9b05916e.926bf8"]]},{"id":"58e658a7.9450f8","type":"http in","z":"bdf26ad7.fc049","name":"","url":"/serial","method":"get","swaggerDoc":"","x":140,"y":60,"wires":[["4792ea1a.cc6ad4"]]},{"id":"4792ea1a.cc6ad4","type":"exec","z":"bdf26ad7.fc049","command":"cat /proc/cpuinfo","addpay":true,"append":"| grep Serial","useSpawn":"","timer":"5","name":"","x":370,"y":60,"wires":[["2646afe.a5da6d","afb0e2e2.001c38"],[],[]]},{"id":"2646afe.a5da6d","type":"http response","z":"bdf26ad7.fc049","name":"","x":570,"y":40,"wires":[]},{"id":"afb0e2e2.001c38","type":"function","z":"bdf26ad7.fc049","name":"","func":"msg.payload = msg.payload.split(':')[1].replace('\\n','').replace(' ','');\nreturn msg;","outputs":1,"noerr":0,"x":560,"y":120,"wires":[["53547164.7ca398"]]},{"id":"53547164.7ca398","type":"debug","z":"bdf26ad7.fc049","name":"","active":false,"console":"false","complete":"false","x":725,"y":118,"wires":[]},{"id":"f426f7b1.c1eff","type":"inject","z":"bdf26ad7.fc049","name":"DEMO","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":true,"x":110,"y":120,"wires":[["d53de64b.5fe2d"]]},{"id":"d53de64b.5fe2d","type":"function","z":"bdf26ad7.fc049","name":"DEMO Data","func":"var device_config = {\n    'scale_id':'889DEB1AA0C57FC8E055000000000001',\n    'event_move_in_id':'80096D9ABE7F68F3E0533300000A6C0D',\n    'event_move_out_id':'80096D9ABE8068F3E0533300000A6C0D',\n    'event_max_weight_id':'85A255F950F9BEF4E0533300000AC45D',\n    'event_off_id':'85A2CC4570292DD1E0533300000A0C94',\n    'event_max_duration':'8642EE858DE89BAAE0533300000AFCC7',\n    'event_fake_traffic':'80096EF60C186574E0533300000ADBA5',\n    'event_get_weight_acc':'800970AC1FDC683CE0533300000AF1B0',\n    'event_min_weight':'875C3EB5C9DD092DE055000000000001',\n    'main_host':'http://ettn.apex.rest/ords/ettn',\n    'camera_url':'http://infoindustria.com.ua/wp-content/uploads/2016/08/zerno-mashina-300x225.jpg',\n    'event_url':'/iot_cli/events/log',\n    'state_url':'/iot_cli/device',\n    'snapshot_url':'/iot_cli/events/snapshot',\n    'maxWeight':40000,\n    'maxDuration':20000,\n    'minWeight':0,\n    'checkHealthTimeout':3000,\n    'minTriggerWeight':200\n}\nmsg.payload = device_config;\n// flow.set('scale_id','80096CB0EFD83B63E0533300000A4334');\n// flow.set('event_move_in_id','80096D9ABE7F68F3E0533300000A6C0D');\n// flow.set('event_move_out_id','80096D9ABE8068F3E0533300000A6C0D');\n// flow.set('event_max_weight_id','85A255F950F9BEF4E0533300000AC45D');\n// flow.set('event_off_id','85A2CC4570292DD1E0533300000A0C94');\n// flow.set('event_on_id', '85A2CC45702A2DD1E0533300000A0C94');\n// flow.set('event_max_duration','8642EE858DE89BAAE0533300000AFCC7');\n// flow.set('main_host','http://prod.apex.rest/ords/ettn');\n// flow.set('event_url','/iot_cli/events/log');\n// flow.set('state_url','/v1/device');\n// flow.set('maxWeight',40000);\n// flow.set('maxDuration',20000);\n// flow.set('checkHealthTimeout',3000);\nreturn msg;","outputs":1,"noerr":0,"x":319.9999694824219,"y":119.99999237060547,"wires":[["df8687f2.2f5fb"]]},{"id":"3b7ac41b.ecf2b4","type":"debug","z":"bdf26ad7.fc049","name":"","active":false,"console":"false","complete":"false","x":190,"y":340,"wires":[]},{"id":"3cf9305b.0b7ff","type":"switch","z":"bdf26ad7.fc049","name":"waybill","property":"metadata.waybill","propertyType":"msg","rules":[{"t":"null"}],"checkall":"true","outputs":1,"x":600,"y":300,"wires":[["f2bb32cf.de545"]]},{"id":"f2bb32cf.de545","type":"function","z":"bdf26ad7.fc049","name":"move in","func":"msg.event_id = flow.get('event_fake_traffic');\nmsg.description = 'Холостий проїзд по вагам. Транзакція ' + msg.metadata.prevTransaction;\n\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":300,"wires":[["2635fad5.12921e","653338cc.fc9458"]]},{"id":"653338cc.fc9458","type":"debug","z":"bdf26ad7.fc049","name":"","active":false,"console":"false","complete":"false","x":950,"y":300,"wires":[]},{"id":"c9fb80b2.f12a08","type":"http in","z":"bdf26ad7.fc049","name":"","url":"/getWeightJd","method":"get","swaggerDoc":"","x":140,"y":720,"wires":[["a75058d4.5fe6e8","4d338038.59f998"]]},{"id":"cfa2d37a.0120f","type":"http response","z":"bdf26ad7.fc049","name":"","x":550,"y":760,"wires":[]},{"id":"4d338038.59f998","type":"function","z":"bdf26ad7.fc049","name":"response","func":"msg.payload = flow.get('transactionMetadata');\nmsg.payload.sub_weight = flow.get('sub_weight_2');\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":800,"wires":[["cfa2d37a.0120f","a3d90ed4.88d458"]]},{"id":"a3d90ed4.88d458","type":"debug","z":"bdf26ad7.fc049","name":"","active":false,"console":"false","complete":"false","x":570,"y":800,"wires":[]},{"id":"d00ae1e5.225928","type":"debug","z":"bdf26ad7.fc049","name":"","active":false,"console":"false","complete":"false","x":1290,"y":600,"wires":[]},{"id":"ff0d0781.777a6","type":"debug","z":"bdf26ad7.fc049","name":"","active":false,"console":"false","complete":"false","x":1310,"y":460,"wires":[]},{"id":"3f928702.d6b6","type":"debug","z":"bdf26ad7.fc049","name":"","active":false,"console":"false","complete":"false","x":1170,"y":420,"wires":[]},{"id":"226fd3b.d5176ac","type":"switch","z":"bdf26ad7.fc049","name":"switch min weight","property":"transactionHasMinWeight","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":410,"y":500,"wires":[["3d369ba9.32cacc"]]},{"id":"3d369ba9.32cacc","type":"function","z":"bdf26ad7.fc049","name":"transactionHasMinWeight","func":"msg.event_id = flow.get('event_min_weight');\nmsg.description = 'Перевищена мінімально-допустима вага: ' + msg.metadata.weight;\n\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":500,"wires":[["2635fad5.12921e"]]},{"id":"1d8f4b7f.848d25","type":"switch","z":"bdf26ad7.fc049","name":"take snapshot","property":"needSnapshot","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":1310,"y":520,"wires":[["25a00388.d688bc"]]},{"id":"4348cc2.7f50a34","type":"http request","z":"bdf26ad7.fc049","name":"get a snapshot","method":"GET","ret":"txt","url":"","tls":"","x":1660,"y":520,"wires":[["bfdaa5ed.d49e68"]]},{"id":"25a00388.d688bc","type":"function","z":"bdf26ad7.fc049","name":"get camera url","func":"msg.url = flow.get('camera_url');\nreturn msg;","outputs":1,"noerr":0,"x":1480,"y":520,"wires":[["4348cc2.7f50a34","c57084ef.eb24a"]]},{"id":"bfdaa5ed.d49e68","type":"function","z":"bdf26ad7.fc049","name":"snapshot payload","func":"var event_id = msg.event_id;\nvar scale_id = flow.get('scale_id');\nmsg.payload = {\n    'event':{\n        'id':msg.event_id\n    },\n    'devices':[{'id':scale_id}],\n    'snapshot':msg.payload,\n    'ext':'jpeg'\n}\n\nmsg.headers = {\n    \"content-type\":\"application/json\"\n}\n\nmsg.url = flow.get('main_host')+flow.get('snapshot_url');\nmsg.main_host = flow.get('main_host');\nmsg.snapshot_url = flow.get('snapshot_url');\n\nreturn msg;","outputs":1,"noerr":0,"x":1850,"y":520,"wires":[["552250e5.467f88"]]},{"id":"552250e5.467f88","type":"http request","z":"bdf26ad7.fc049","name":"","method":"POST","ret":"txt","url":"send a snapshot","tls":"","x":2050,"y":520,"wires":[["89042aba.91c4a"]]},{"id":"89042aba.91c4a","type":"debug","z":"bdf26ad7.fc049","name":"","active":true,"console":"false","complete":"false","x":2240,"y":520,"wires":[]},{"id":"c57084ef.eb24a","type":"debug","z":"bdf26ad7.fc049","name":"","active":true,"console":"false","complete":"true","x":1520,"y":380,"wires":[]},{"id":"58d7d326.cdab0c","type":"http in","z":"bdf26ad7.fc049","name":"","url":"/getSimpleWeightJd","method":"get","swaggerDoc":"","x":190,"y":880,"wires":[["6d0740cc.29cd68"]]},{"id":"6d0740cc.29cd68","type":"function","z":"bdf26ad7.fc049","name":"response","func":"msg.payload = flow.get('transactionMetadata').weight;\nreturn msg;","outputs":1,"noerr":0,"x":420,"y":880,"wires":[["a82db7e3.fdbfc"]]},{"id":"a82db7e3.fdbfc","type":"http response","z":"bdf26ad7.fc049","name":"","x":550,"y":880,"wires":[]},{"id":"8ca9840b.248c6","type":"delay","z":"bdf26ad7.fc049","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":320,"y":220,"wires":[["4b967d6d.2fa50c"]]}]
