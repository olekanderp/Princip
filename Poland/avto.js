[{"id":"ef92ef9b.e24fb8","type":"tab","label":"scale 1"},{"id":"4b89c5ac.2bf5bc","type":"tab","label":"processing_scale1"},{"id":"2e651678.048d0a","type":"tab","label":"Dashboard"},{"id":"94b47542.b6afd8","type":"subflow","name":"ETTN","info":"","in":[],"out":[]},{"id":"acea5347.d22ba8","type":"subflow","name":"Subflow 1","info":"","in":[],"out":[]},{"id":"380ef4f5.893954","type":"ui_tab","z":"","name":"Smart Scales","icon":"dashboard"},{"id":"6866c887.098658","type":"ui_base","name":"Scale dasboard","theme":"theme-light"},{"id":"7e2882c6.9639c4","type":"ui_group","z":"","name":"Scale and identity","tab":"380ef4f5.893954","order":5,"disp":true,"width":"6"},{"id":"e440ce48.bd6ec","type":"ui_group","z":"","name":"Additional properties","tab":"380ef4f5.893954","disp":true,"width":"6"},{"id":"135b6896.7293c7","type":"modbus-client","z":"","name":"","clienttype":"tcp","bufferCommands":true,"stateLogEnabled":false,"tcpHost":"10.10.15.203","tcpPort":"502","tcpType":"DEFAULT","serialPort":"/dev/ttyUSB","serialType":"RTU-BUFFERD","serialBaudrate":"9600","serialDatabits":"8","serialStopbits":"1","serialParity":"none","serialConnectionDelay":"100","unit_id":"1","commandDelay":"1","clientTimeout":"1000","reconnectTimeout":"2000"},{"id":"ba1441f9.19e79","type":"function","z":"ef92ef9b.e24fb8","name":"GET WEIGHT","func":"msg.payload = flow.get('parser')(msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":388,"y":219,"wires":[["cb05deab.d4a2c","c701477a.2bea5"]]},{"id":"a89da379.5c8d88","type":"comment","z":"ef92ef9b.e24fb8","name":"Device level","info":"","x":90,"y":140,"wires":[]},{"id":"eb651460.603bf8","type":"inject","z":"ef92ef9b.e24fb8","name":"init","topic":"","payload":"init","payloadType":"str","repeat":"","crontab":"","once":true,"x":90,"y":80,"wires":[["512f15e0.bb27dc"]]},{"id":"fb880dea.eaf168","type":"comment","z":"ef92ef9b.e24fb8","name":"INITIALIZING","info":"","x":90,"y":20,"wires":[]},{"id":"dfe6eb6b.1d156","type":"link in","z":"4b89c5ac.2bf5bc","name":"weight","links":["20edce7e.5b51e2","a952ade4.1021c","cb05deab.d4a2c"],"x":35,"y":380,"wires":[["f094871d.8688c","7ef75b7e.a3e3fc"]]},{"id":"f094871d.8688c","type":"function","z":"4b89c5ac.2bf5bc","name":"main module","func":"var prevWeight = flow.get('prevWeight');\nvar transaction = flow.get('transaction');\nvar transactionData = flow.get('transactionData');\nvar transactionMaxWeight = flow.get('transactionMaxWeight');\nvar transactionHasMaxWeight = flow.get('transactionHasMaxWeight');\nvar transactionHasMinWeight = flow.get('transactionHasMinWeight');\nvar transactionHasMaxDuration = flow.get('transactionHasMaxDuration');\nvar waybill = flow.get('transactionWaybill');\nvar weight = msg.payload;\nvar stableSize = 5;\nvar duration = 0;\nvar maxWeight = flow.get('maxWeight');\nvar maxDuration = flow.get('maxDuration');\nvar prevTransaction = transaction;\nvar minWeight = flow.get('minWeight');\nvar minTriggerWeight = flow.get('minTriggerWeight');\n\n//transaction\nif (prevWeight === null){\n    prevWeight = msg.payload;    \n}else{\n    if((prevWeight <= 0) && (weight > 0) && (weight > minTriggerWeight)){\n        //start of transaction\n        transaction = Date.now();\n        msg.on = true;\n        flow.set('transaction',transaction);\n    }else if((prevWeight > 0) && (weight <=0) && (transaction)){\n        transaction = 0;\n        msg.on = false;\n        transactionData = [];\n        flow.set('transaction',transaction);\n        flow.set('transactionMaxWeight',null);\n        flow.set('transactionHasMaxWeight',null);\n        flow.set('transactionHasMinWeight',null);\n        flow.set('transactionHasMaxDuration',null);\n        flow.set('transactionWaybill',null);\n        flow.set('transactionMetadata',null);\n    }else if((transaction === null) && (weight>0) && (weight > minTriggerWeight)){\n        transaction = Date.now();\n        flow.set('transaction',transaction);\n    }\n}\n\nif (transaction > 0){\n    transactionData.push(weight);    \n\n    //stable\n    if(transactionData.length > stableSize+1){\n        var stabletmp = true;\n        for (var i = transactionData.length-1; i > transactionData.length-1-stableSize; i--){\n            if (transactionData[i] !== transactionData[i-1]){\n                stabletmp = false;\n                msg.stable = stabletmp;\n                break;\n            }\n            msg.stable = stabletmp;\n        }\n    }else{\n        msg.stable = false;\n    }\n\n    //duration & transactionMaxWeight\n    duration = (Number(Date.now()) - Number(transaction));\n    if( (weight>transactionMaxWeight) || (transactionMaxWeight === null)){\n        transactionMaxWeight = weight;\n        flow.set(\"transactionMaxWeight\",transactionMaxWeight);\n    }\n    \n    if(!transactionHasMaxWeight && weight > maxWeight){\n        msg.transactionHasMaxWeight = true;\n        flow.set('transactionHasMaxWeight',true);\n    }\n    \n    if(!transactionHasMinWeight && weight < minWeight){\n        msg.transactionHasMinWeight = true;\n        flow.set('transactionHasMinWeight',true);\n    }\n    \n    //max duartion\n    if(!transactionHasMaxDuration && duration > maxDuration){\n        msg.transactionHasMaxDuration = true;\n        flow.set('transactionHasMaxDuration',true);\n    }\n}\n\n//result\nmsg.metadata = {\n    'weight':weight,\n    'prevWeight':prevWeight,\n    'prevTransaction':prevTransaction,\n    'transaction':transaction,\n    'on':msg.on,\n    'transactionDataCount':transactionData.length,\n    'stable':msg.stable,\n    'duration':duration,\n    'transactionMaxWeight':transactionMaxWeight,\n    'waybill':waybill\n}\nflow.set('transactionData',transactionData);\nflow.set('prevWeight',weight);\nflow.set('transactionMetadata',msg.metadata);\nflow.set('lasttimedata', new Date());\nreturn msg;","outputs":1,"noerr":0,"x":170,"y":400,"wires":[["bb7ae955.14af58","1f6dd091.1cf1b7","e8f75c71.8d585","5cf2a1bc.02e258","5e2b9421.1bbddc"]]},{"id":"3c8eac05.c4e9ec","type":"function","z":"4b89c5ac.2bf5bc","name":"get weight from accounting system","func":"var transactionMetada = flow.get('transactionMetadata');\nvar buisness_data = msg.req.query;\nmsg.metadata = Object.assign(transactionMetada,buisness_data);\nmsg.event_id = flow.get('event_get_weight_acc');\nflow.set('transactionWaybill',msg.req.query.waybill);\nmsg.description = 'Зважили в 1С. Поточна вага: ' + msg.metadata.weight+\" Номер авто: \"+buisness_data.truck_id+\" \"+buisness_data.truck2_id;\nreturn msg;","outputs":1,"noerr":0,"x":440,"y":700,"wires":[["2714619a.5ce7d6"]]},{"id":"bb7ae955.14af58","type":"switch","z":"4b89c5ac.2bf5bc","name":"switch move","property":"on","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":390,"y":360,"wires":[["73a8abf7.5708cc"],["9e840a34.e1a948","aabb872.3b3ff78"]]},{"id":"8359125a.3eaf08","type":"http request","z":"4b89c5ac.2bf5bc","name":"EVENTS","method":"POST","ret":"txt","url":"","tls":"","x":1140,"y":440,"wires":[["fcd9e183.b317c8"]]},{"id":"2714619a.5ce7d6","type":"function","z":"4b89c5ac.2bf5bc","name":"events payload","func":"var event_id = msg.event_id;\nvar scale_id = flow.get('scale_id');\nmsg.payload = {\n    'event':{\n        'id':msg.event_id\n    },\n    'devices':[{'id':scale_id}],\n    'data':msg.metadata,\n    'description':msg.description\n}\n\nmsg.headers = {\n    \"content-type\":\"application/json\"\n}\n\nmsg.url = flow.get('main_host')+flow.get('event_url');\nmsg.main_host = flow.get('main_host');\nmsg.event_url = flow.get('event_url');\n\nreturn msg;","outputs":1,"noerr":0,"x":940,"y":440,"wires":[["58660ee.9e338f","56d474c7.fd3534"]]},{"id":"73a8abf7.5708cc","type":"function","z":"4b89c5ac.2bf5bc","name":"move in","func":"msg.event_id = flow.get('event_move_in_id');\nmsg.description = 'Заїзд на ваги. Поточна вага: ' + msg.metadata.weight;\n\nreturn msg;","outputs":1,"noerr":0,"x":580,"y":320,"wires":[["2714619a.5ce7d6"]]},{"id":"1f6dd091.1cf1b7","type":"switch","z":"4b89c5ac.2bf5bc","name":"switch max weight","property":"transactionHasMaxWeight","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":390,"y":400,"wires":[["ba78da6c.093c9"]]},{"id":"ba78da6c.093c9","type":"function","z":"4b89c5ac.2bf5bc","name":"transactionHasMaxWeight","func":"msg.event_id = flow.get('event_max_weight_id');\nmsg.description = 'Перевищена максимально-допустима вага: ' + msg.metadata.weight;\nmsg.needSnapshot = true;\n\nreturn msg;","outputs":1,"noerr":0,"x":630,"y":400,"wires":[["2714619a.5ce7d6"]]},{"id":"e69c1eaa.abb7f8","type":"inject","z":"4b89c5ac.2bf5bc","name":"","topic":"","payload":"","payloadType":"date","repeat":"1","crontab":"","once":false,"x":110,"y":620,"wires":[["3719056e.ec0af2"]]},{"id":"3719056e.ec0af2","type":"function","z":"4b89c5ac.2bf5bc","name":"check scale health","func":"var lastcheckHealth = flow.get('checkHealth');\nvar checkHealth = null;\nvar lasttimedata = flow.get('lasttimedata');\n\nvar currenttimedata = new Date();\n\nif ((currenttimedata - lasttimedata) > 3000){\n    checkHealth = false;\n} else {\n    checkHealth = true;\n}\n\nflow.set(\"checkHealth\",checkHealth);\n\nif (lastcheckHealth != checkHealth){\n    msg.checkHealth = checkHealth;\n}else{\n    msg.checkHealth = null;\n}\nmsg.payload = checkHealth;\n\nreturn msg;","outputs":1,"noerr":0,"x":290,"y":620,"wires":[["9a2a7f9f.3cb1","3faf6d8.a5e0a12"]]},{"id":"9a2a7f9f.3cb1","type":"switch","z":"4b89c5ac.2bf5bc","name":"","property":"checkHealth","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":470,"y":580,"wires":[["1482604e.012108"],["7d27bbe6.009844"]]},{"id":"7d27bbe6.009844","type":"function","z":"4b89c5ac.2bf5bc","name":"off","func":"msg.event_id = flow.get('event_off_id');\nmsg.description = 'Прилад відключено';\nmsg.metadata = {\n    'state':msg.checkHealth\n}\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":560,"wires":[["2714619a.5ce7d6"]]},{"id":"1482604e.012108","type":"function","z":"4b89c5ac.2bf5bc","name":"on","func":"msg.event_id = flow.get('event_on_id');\nmsg.description = 'Прилад підключено';\nmsg.metadata = {\n    'state':msg.checkHealth\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":520,"wires":[["2714619a.5ce7d6"]]},{"id":"8b3dd266.3d1bc","type":"function","z":"4b89c5ac.2bf5bc","name":"main config","func":"flow.set('prevWeight',null);\nflow.set('transaction',null);\nflow.set('transactionData',[]);\nflow.set('transactionMaxWeight',null);\nflow.set('transactionHasMinWeight',null);\nflow.set('transactionHasMaxWeight',null);\nflow.set('transactionHasMaxDuration',null);\nflow.set('lasttimedata', new Date());\nflow.set('checkHealth',null);\nflow.set('transactionWaybill',null);\n\nreturn msg;\n","outputs":1,"noerr":0,"x":370,"y":240,"wires":[[]]},{"id":"ad1c52f7.8cd25","type":"inject","z":"4b89c5ac.2bf5bc","name":"","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":true,"x":90,"y":220,"wires":[["492ecb99.34e07c","8b3dd266.3d1bc"]]},{"id":"4e7eb736.da8508","type":"http request","z":"4b89c5ac.2bf5bc","name":"STATE","method":"POST","ret":"txt","url":"","tls":"","x":1130,"y":580,"wires":[["1553d37.5cb57ad"]]},{"id":"3faf6d8.a5e0a12","type":"function","z":"4b89c5ac.2bf5bc","name":"device state","func":"msg.payload = {\n    \"state\":msg.payload\n}\nmsg.headers = {\n    \"content-type\":\"application/json\"\n}\nmsg.url = flow.get('main_host')+flow.get('state_url')+\"?id=\"+flow.get(\"scale_id\");\nreturn msg;","outputs":1,"noerr":0,"x":950,"y":580,"wires":[[]]},{"id":"512f15e0.bb27dc","type":"function","z":"ef92ef9b.e24fb8","name":"Модель весов","func":"flow.set('inputString',\"CMD\");\nflow.set('parser',function(v){\n       v = v;\n       return Number(v);\n    }\n  );\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":80,"wires":[[]]},{"id":"a19e16a5.c82ea","type":"function","z":"4b89c5ac.2bf5bc","name":"device config","func":"var device_config = JSON.parse(msg.payload);\n\nflow.set('scale_id',device_config.scale_id);\nflow.set('event_move_in_id',device_config.event_move_in_id);\nflow.set('event_move_out_id',device_config.event_move_out_id);\nflow.set('event_max_weight_id',device_config.event_max_weight_id);\nflow.set('event_off_id',device_config.event_off_id);\nflow.set('event_on_id', device_config.event_on_id);\nflow.set('event_max_duration',device_config.event_max_duration);\nflow.set('event_fake_traffic',device_config.event_fake_traffic);\nflow.set('main_host',device_config.main_host);\nflow.set('event_url',device_config.event_url);\nflow.set('state_url',device_config.state_url);\nflow.set('maxWeight',device_config.maxWeight);\nflow.set('minWeight',device_config.minWeight);\nflow.set('maxDuration',device_config.maxDuration);\nflow.set('checkHealthTimeout',device_config.checkHealthTimeout);\nflow.set('event_get_weight_acc',device_config.event_get_weight_acc);\nflow.set('event_min_weight',device_config.event_min_weight);\nflow.set('minTriggerWeight',device_config.minTriggerWeight);\nflow.set('snapshot_url',device_config.minTriggerWeight);\nflow.set('camera_url',device_config.camera_url);\n\n\n\n// flow.set('scale_id','80096CB0EFD83B63E0533300000A4334');\n// flow.set('event_move_in_id','80096D9ABE7F68F3E0533300000A6C0D');\n// flow.set('event_move_out_id','80096D9ABE8068F3E0533300000A6C0D');\n// flow.set('event_max_weight_id','85A255F950F9BEF4E0533300000AC45D');\n// flow.set('event_off_id','85A2CC4570292DD1E0533300000A0C94');\n// flow.set('event_on_id', '85A2CC45702A2DD1E0533300000A0C94');\n// flow.set('event_max_duration','8642EE858DE89BAAE0533300000AFCC7');\n// flow.set('main_host','http://prod.apex.rest/ords/ettn');\n// flow.set('event_url','/iot_cli/events/log');\n// flow.set('state_url','/v1/device');\n// flow.set('maxWeight',40000);\n// flow.set('maxDuration',20000);\n// flow.set('checkHealthTimeout',3000);\n\nreturn msg;\n","outputs":1,"noerr":0,"x":570,"y":200,"wires":[[]]},{"id":"9e840a34.e1a948","type":"function","z":"4b89c5ac.2bf5bc","name":"move out","func":"msg.event_id = flow.get('event_move_out_id');\nmsg.description = 'Зїзд з ваг. Поточна вага: ' + msg.metadata.weight;\n\nreturn msg;","outputs":1,"noerr":0,"x":580,"y":360,"wires":[["2714619a.5ce7d6"]]},{"id":"e8f75c71.8d585","type":"switch","z":"4b89c5ac.2bf5bc","name":"max duration","property":"transactionHasMaxDuration","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":370,"y":440,"wires":[["66bfa276.3eda94"]]},{"id":"66bfa276.3eda94","type":"function","z":"4b89c5ac.2bf5bc","name":"transaction has max duration","func":"msg.event_id = flow.get('event_max_duration');\nmsg.description = 'Перевищено максимальний час находження на вагах: ' + msg.metadata.duration/1000;\n\nreturn msg;","outputs":1,"noerr":0,"x":640,"y":440,"wires":[["2714619a.5ce7d6"]]},{"id":"934ea2fc.8e31f8","type":"http in","z":"4b89c5ac.2bf5bc","name":"","url":"/firmware","method":"post","swaggerDoc":"","x":140,"y":160,"wires":[["6214813d.ebd04"]]},{"id":"6214813d.ebd04","type":"file","z":"4b89c5ac.2bf5bc","name":"deivce_config","filename":"deivce_config.json","appendNewline":true,"createDir":false,"overwriteFile":"true","x":380,"y":160,"wires":[]},{"id":"492ecb99.34e07c","type":"file in","z":"4b89c5ac.2bf5bc","name":"deivce_config","filename":"deivce_config.json","format":"utf8","x":380,"y":200,"wires":[["a19e16a5.c82ea"]]},{"id":"c7e4788c.7a06f8","type":"http in","z":"4b89c5ac.2bf5bc","name":"","url":"/serial","method":"get","swaggerDoc":"","x":120,"y":40,"wires":[["4314f79a.6ca9e"]]},{"id":"4314f79a.6ca9e","type":"exec","z":"4b89c5ac.2bf5bc","command":"cat /proc/cpuinfo","addpay":true,"append":"| grep Serial","useSpawn":"","timer":"5","name":"","x":350,"y":40,"wires":[["b74047b2.455ae8","40e04647.486078"],[],[]]},{"id":"b74047b2.455ae8","type":"http response","z":"4b89c5ac.2bf5bc","name":"","x":550,"y":20,"wires":[]},{"id":"40e04647.486078","type":"function","z":"4b89c5ac.2bf5bc","name":"","func":"msg.payload = msg.payload.split(':')[1].replace('\\n','').replace(' ','');\nreturn msg;","outputs":1,"noerr":0,"x":540,"y":100,"wires":[["3278be96.14afba"]]},{"id":"3278be96.14afba","type":"debug","z":"4b89c5ac.2bf5bc","name":"","active":false,"console":"false","complete":"false","x":705,"y":98,"wires":[]},{"id":"27322980.42b8e6","type":"inject","z":"4b89c5ac.2bf5bc","name":"DEMO","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":true,"x":90,"y":100,"wires":[["674d6699.b0142"]]},{"id":"674d6699.b0142","type":"function","z":"4b89c5ac.2bf5bc","name":"DEMO Data","func":"var device_config = {\n    'scale_id':'889DEB1AA0C57FC8E055000000000001',\n    'event_move_in_id':'80096D9ABE7F68F3E0533300000A6C0D',\n    'event_move_out_id':'80096D9ABE8068F3E0533300000A6C0D',\n    'event_max_weight_id':'85A255F950F9BEF4E0533300000AC45D',\n    'event_off_id':'85A2CC4570292DD1E0533300000A0C94',\n    'event_max_duration':'8642EE858DE89BAAE0533300000AFCC7',\n    'event_fake_traffic':'80096EF60C186574E0533300000ADBA5',\n    'event_get_weight_acc':'800970AC1FDC683CE0533300000AF1B0',\n    'event_min_weight':'875C3EB5C9DD092DE055000000000001',\n    'main_host':'http://ettn.apex.rest/ords/ettn',\n    'camera_url':'http://infoindustria.com.ua/wp-content/uploads/2016/08/zerno-mashina-300x225.jpg',\n    'event_url':'/iot_cli/events/log',\n    'state_url':'/iot_cli/device',\n    'snapshot_url':'/iot_cli/events/snapshot',\n    'maxWeight':40000,\n    'maxDuration':20000,\n    'minWeight':0,\n    'checkHealthTimeout':3000,\n    'minTriggerWeight':200\n}\nmsg.payload = device_config;\n// flow.set('scale_id','80096CB0EFD83B63E0533300000A4334');\n// flow.set('event_move_in_id','80096D9ABE7F68F3E0533300000A6C0D');\n// flow.set('event_move_out_id','80096D9ABE8068F3E0533300000A6C0D');\n// flow.set('event_max_weight_id','85A255F950F9BEF4E0533300000AC45D');\n// flow.set('event_off_id','85A2CC4570292DD1E0533300000A0C94');\n// flow.set('event_on_id', '85A2CC45702A2DD1E0533300000A0C94');\n// flow.set('event_max_duration','8642EE858DE89BAAE0533300000AFCC7');\n// flow.set('main_host','http://prod.apex.rest/ords/ettn');\n// flow.set('event_url','/iot_cli/events/log');\n// flow.set('state_url','/v1/device');\n// flow.set('maxWeight',40000);\n// flow.set('maxDuration',20000);\n// flow.set('checkHealthTimeout',3000);\nreturn msg;","outputs":1,"noerr":0,"x":230,"y":100,"wires":[["6214813d.ebd04"]]},{"id":"7ef75b7e.a3e3fc","type":"debug","z":"4b89c5ac.2bf5bc","name":"","active":false,"console":"false","complete":"false","x":100,"y":320,"wires":[]},{"id":"cb05deab.d4a2c","type":"link out","z":"ef92ef9b.e24fb8","name":"","links":["dfe6eb6b.1d156"],"x":521,"y":219,"wires":[]},{"id":"aabb872.3b3ff78","type":"switch","z":"4b89c5ac.2bf5bc","name":"waybill","property":"metadata.waybill","propertyType":"msg","rules":[{"t":"null"}],"checkall":"true","outputs":1,"x":580,"y":280,"wires":[["72edcc5.cc4acb4"]]},{"id":"72edcc5.cc4acb4","type":"function","z":"4b89c5ac.2bf5bc","name":"move in","func":"msg.event_id = flow.get('event_fake_traffic');\nmsg.description = 'Холостий проїзд по вагам. Транзакція ' + msg.metadata.prevTransaction;\n\nreturn msg;","outputs":1,"noerr":0,"x":720,"y":280,"wires":[["2714619a.5ce7d6","b520c9e1.a19ae8"]]},{"id":"b520c9e1.a19ae8","type":"debug","z":"4b89c5ac.2bf5bc","name":"","active":false,"console":"false","complete":"false","x":930,"y":280,"wires":[]},{"id":"4cfb403e.c5279","type":"http in","z":"4b89c5ac.2bf5bc","name":"","url":"/getWeight","method":"get","swaggerDoc":"","x":140,"y":740,"wires":[["3c8eac05.c4e9ec","faf5b5d7.f80888"]]},{"id":"a7ddfb13.fede98","type":"http response","z":"4b89c5ac.2bf5bc","name":"","x":530,"y":740,"wires":[]},{"id":"faf5b5d7.f80888","type":"function","z":"4b89c5ac.2bf5bc","name":"response","func":"msg.payload = flow.get('transactionMetadata');\nreturn msg;","outputs":1,"noerr":0,"x":360,"y":780,"wires":[["a7ddfb13.fede98","cf12b51b.81ab7"]]},{"id":"cf12b51b.81ab7","type":"debug","z":"4b89c5ac.2bf5bc","name":"","active":false,"console":"false","complete":"false","x":550,"y":780,"wires":[]},{"id":"c8127784.6e5cd","type":"link in","z":"2e651678.048d0a","name":"dashboard","links":["5cf2a1bc.02e258"],"x":80,"y":100,"wires":[["d8b0cf85.520458","5dad8b03.054cec","1893a6d5.37b239","244dc964.d66c96","612af299.190bdc","4c8e5a13.000d44"]]},{"id":"5cf2a1bc.02e258","type":"link out","z":"4b89c5ac.2bf5bc","name":"processing","links":["c8127784.6e5cd"],"x":340,"y":300,"wires":[]},{"id":"d8b0cf85.520458","type":"ui_gauge","z":"2e651678.048d0a","name":"","group":"7e2882c6.9639c4","order":0,"width":0,"height":0,"gtype":"gage","title":"Weight","label":"kg","format":"{{value}} kg","min":0,"max":"60000","colors":["#00b500","#e6e600","#ca3838"],"x":210,"y":20,"wires":[]},{"id":"5dad8b03.054cec","type":"ui_chart","z":"2e651678.048d0a","name":"","group":"7e2882c6.9639c4","order":0,"width":0,"height":0,"label":"History","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","ymin":"0","ymax":"60000","removeOlder":"10","removeOlderPoints":"","removeOlderUnit":"60","cutout":0,"x":210,"y":60,"wires":[[],[]]},{"id":"690ef697.55e4f8","type":"ui_gauge","z":"2e651678.048d0a","name":"","group":"e440ce48.bd6ec","order":0,"width":0,"height":0,"gtype":"wave","title":"Time on scale","label":"units","format":"{{value}} seconds","min":0,"max":"30000","colors":["#00b500","#e6e600","#ca3838"],"x":350,"y":100,"wires":[]},{"id":"1893a6d5.37b239","type":"ui_text","z":"2e651678.048d0a","group":"e440ce48.bd6ec","order":0,"width":0,"height":0,"name":"","label":"Stable","format":"{{msg.metadata.stable}}","layout":"row-spread","x":210,"y":140,"wires":[]},{"id":"244dc964.d66c96","type":"ui_text","z":"2e651678.048d0a","group":"e440ce48.bd6ec","order":0,"width":0,"height":0,"name":"","label":"on / off truck on scale","format":"{{msg.metadata.on}}","layout":"row-spread","x":260,"y":180,"wires":[]},{"id":"612af299.190bdc","type":"ui_text","z":"2e651678.048d0a","group":"e440ce48.bd6ec","order":0,"width":0,"height":0,"name":"","label":"Max weight","format":"{{msg.metadata.transactionMaxWeight}}","layout":"row-spread","x":230,"y":220,"wires":[]},{"id":"4c8e5a13.000d44","type":"function","z":"2e651678.048d0a","name":"duration","func":"msg.payload = msg.metadata.duration;\nreturn msg;","outputs":1,"noerr":0,"x":220,"y":100,"wires":[["690ef697.55e4f8"]]},{"id":"58660ee.9e338f","type":"link out","z":"4b89c5ac.2bf5bc","name":"processing event","links":["f0da2d7d.e5e8c"],"x":1120,"y":340,"wires":[]},{"id":"1553d37.5cb57ad","type":"debug","z":"4b89c5ac.2bf5bc","name":"","active":false,"console":"false","complete":"false","x":1270,"y":580,"wires":[]},{"id":"fcd9e183.b317c8","type":"debug","z":"4b89c5ac.2bf5bc","name":"","active":false,"console":"false","complete":"false","x":1290,"y":440,"wires":[]},{"id":"56d474c7.fd3534","type":"debug","z":"4b89c5ac.2bf5bc","name":"","active":false,"console":"false","complete":"false","x":1140,"y":280,"wires":[]},{"id":"5e2b9421.1bbddc","type":"switch","z":"4b89c5ac.2bf5bc","name":"switch min weight","property":"transactionHasMinWeight","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":390,"y":480,"wires":[["8278af12.1e7748"]]},{"id":"8278af12.1e7748","type":"function","z":"4b89c5ac.2bf5bc","name":"transactionHasMinWeight","func":"msg.event_id = flow.get('event_min_weight');\nmsg.description = 'Перевищена мінімально-допустима вага: ' + msg.metadata.weight;\n\nreturn msg;","outputs":1,"noerr":0,"x":630,"y":480,"wires":[["2714619a.5ce7d6"]]},{"id":"15379957.73ee47","type":"switch","z":"4b89c5ac.2bf5bc","name":"take snapshot","property":"needSnapshot","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":1290,"y":500,"wires":[["a5246089.54539"]]},{"id":"b871b93.36225c8","type":"http request","z":"4b89c5ac.2bf5bc","name":"get a snapshot","method":"GET","ret":"txt","url":"","tls":"","x":1640,"y":500,"wires":[["55b68dc6.489a4c"]]},{"id":"a5246089.54539","type":"function","z":"4b89c5ac.2bf5bc","name":"get camera url","func":"msg.url = flow.get('camera_url');\nreturn msg;","outputs":1,"noerr":0,"x":1460,"y":500,"wires":[["b871b93.36225c8","1b31ad3d.57631b"]]},{"id":"55b68dc6.489a4c","type":"function","z":"4b89c5ac.2bf5bc","name":"snapshot payload","func":"var event_id = msg.event_id;\nvar scale_id = flow.get('scale_id');\nmsg.payload = {\n    'event':{\n        'id':msg.event_id\n    },\n    'devices':[{'id':scale_id}],\n    'snapshot':msg.payload,\n    'ext':'jpeg'\n}\n\nmsg.headers = {\n    \"content-type\":\"application/json\"\n}\n\nmsg.url = flow.get('main_host')+flow.get('snapshot_url');\nmsg.main_host = flow.get('main_host');\nmsg.snapshot_url = flow.get('snapshot_url');\n\nreturn msg;","outputs":1,"noerr":0,"x":1830,"y":500,"wires":[["f43b36e1.333a18"]]},{"id":"f43b36e1.333a18","type":"http request","z":"4b89c5ac.2bf5bc","name":"","method":"POST","ret":"txt","url":"send a snapshot","tls":"","x":2030,"y":500,"wires":[["7f489ef2.b4533"]]},{"id":"7f489ef2.b4533","type":"debug","z":"4b89c5ac.2bf5bc","name":"","active":true,"console":"false","complete":"false","x":2220,"y":500,"wires":[]},{"id":"1b31ad3d.57631b","type":"debug","z":"4b89c5ac.2bf5bc","name":"","active":true,"console":"false","complete":"true","x":1500,"y":360,"wires":[]},{"id":"7ae6a37b.9e81bc","type":"modbus-read","z":"ef92ef9b.e24fb8","name":"","showStatusActivities":false,"showErrors":false,"unitid":"","dataType":"HoldingRegister","adr":"0","quantity":"1","rate":"1","rateUnit":"s","server":"135b6896.7293c7","x":87,"y":223,"wires":[["89da0bc7.29a88","a42d1655.595da8"],[]]},{"id":"1aa73c7.b535f44","type":"debug","z":"ef92ef9b.e24fb8","name":"","active":false,"console":"false","complete":"false","x":377,"y":256,"wires":[]},{"id":"c701477a.2bea5","type":"debug","z":"ef92ef9b.e24fb8","name":"","active":false,"console":"false","complete":"false","x":454,"y":180,"wires":[]},{"id":"89da0bc7.29a88","type":"function","z":"ef92ef9b.e24fb8","name":"parser","func":"var weight_with_reg = msg.payload[0];\nvar clear_tail = 0b00000000000000001111111111111111;\nvar LE = weight_with_reg << 8;\nvar BE = weight_with_reg >> 8;\nvar str = (LE | BE) & clear_tail;\n\n    if(str >= 50000){\n         var LE_1 = weight_with_reg & 0b0000000011111111;\n         var BE_1 = weight_with_reg >> 8;\n        \n         var buf2 = Buffer.from([BE,LE]);\n         var out = buf2.readInt16LE(0);\n        \n        msg.payload = out;\n    }else {\n        msg.payload = str;\n    }\nreturn msg;","outputs":1,"noerr":0,"x":230,"y":200,"wires":[["ba1441f9.19e79","1aa73c7.b535f44"]]},{"id":"4e71056a.7ea364","type":"http in","z":"4b89c5ac.2bf5bc","name":"","url":"/getSimpleWeight","method":"get","swaggerDoc":"","x":160,"y":860,"wires":[["ba09f049.f7908"]]},{"id":"ba09f049.f7908","type":"function","z":"4b89c5ac.2bf5bc","name":"response","func":"msg.payload = flow.get('transactionMetadata').weight;\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":840,"wires":[["dddad20f.39def8"]]},{"id":"dddad20f.39def8","type":"http response","z":"4b89c5ac.2bf5bc","name":"","x":528,"y":871,"wires":[]},{"id":"a42d1655.595da8","type":"debug","z":"ef92ef9b.e24fb8","name":"","active":false,"console":"false","complete":"false","x":270,"y":320,"wires":[]},{"id":"85924c6e.da2348","type":"modbus-read","z":"ef92ef9b.e24fb8","name":"","showStatusActivities":false,"showErrors":false,"unitid":"","dataType":"HoldingRegister","adr":"0","quantity":"2","rate":"2","rateUnit":"s","server":"135b6896.7293c7","x":140,"y":480,"wires":[["ce820c36.db6cc8"],[]]},{"id":"ce820c36.db6cc8","type":"debug","z":"ef92ef9b.e24fb8","name":"","active":false,"console":"false","complete":"false","x":310,"y":480,"wires":[]},{"id":"945570aa.c20ed8","type":"modbus-read","z":"ef92ef9b.e24fb8","name":"","showStatusActivities":false,"showErrors":false,"unitid":"","dataType":"HoldingRegister","adr":"3","quantity":"1","rate":"2","rateUnit":"s","server":"135b6896.7293c7","x":150,"y":560,"wires":[["eb34e81c.1897f"],[]]},{"id":"eb34e81c.1897f","type":"debug","z":"ef92ef9b.e24fb8","name":"","active":false,"console":"false","complete":"false","x":310,"y":560,"wires":[]}]
