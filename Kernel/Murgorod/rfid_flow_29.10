[{"id":"e8e22d87.0e8b","type":"tab","label":"RFID UHF"},{"id":"572f2797.a3f3d8","type":"tab","label":"currentTags"},{"id":"c1fe441.42301b8","type":"tab","label":"Postgres"},{"id":"8d33ca5.8ce5838","type":"princip-llrp-device","z":"","ipAddress":"10.3.5.214","port":"5084","log":false},{"id":"e0f875b6.4bc168","type":"princip-llrp-device","z":"","ipAddress":"10.3.5.212","port":"5084","log":false},{"id":"1fc45ae7.7d45e5","type":"princip-llrp-device","z":"","ipAddress":"10.3.5.210","port":"5084","log":false},{"id":"5f96c43d.c0d33c","type":"princip-llrp-device","z":"","ipAddress":"10.3.5.217","port":"5084","log":false},{"id":"30b2ef9d.91eea","type":"princip-llrp-device","z":"","ipAddress":"10.3.5.211","port":"5084","log":false},{"id":"ab747bd1.e885d8","type":"princip-llrp-device","z":"","ipAddress":"10.3.5.216","port":"5084","log":false},{"id":"397e437e.6d3c3c","type":"princip-llrp-device","z":"","ipAddress":"10.3.5.215","port":"5084","log":false},{"id":"657a8a2c.6715c4","type":"postgresdb","z":"","hostname":"10.3.5.253","port":"5432","db":"rfid_log","ssl":false},{"id":"857cb92b.3c3cc8","type":"http in","z":"e8e22d87.0e8b","name":"","url":"/setAccessTable","method":"post","swaggerDoc":"","x":140,"y":140,"wires":[["689bf884.f79ad8"]]},{"id":"689bf884.f79ad8","type":"function","z":"e8e22d87.0e8b","name":"set Access Table","func":"// var accessTable = [exampleAcess];\n// var exampleAcess = {\n//     \"pointID\":\"35235325325235\"\n//     \"ip\":\"10.3.5.210\",\n//     \"antennaID\":\"1\",\n//     \"direction\":0,\n//     \"tags\":[\"124124\",\"3525235\"],\n//     \"gpo\":['80','00'],\n//      \"marked\":false\n// }\n\nflow.set('accessTable',msg.payload);\nflow.set('accessTableUpdate',new Date());\nmsg.statusCode = 200;\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":140,"wires":[["627d50fa.89506","6e935800.f35df8"]]},{"id":"627d50fa.89506","type":"http response","z":"e8e22d87.0e8b","name":"","x":550,"y":140,"wires":[]},{"id":"d65893b9.f108d","type":"inject","z":"e8e22d87.0e8b","name":"init","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":true,"x":110,"y":40,"wires":[["ed5584e8.a66448"]]},{"id":"ed5584e8.a66448","type":"function","z":"e8e22d87.0e8b","name":"LLRP conf","func":"//040300000012000001dd0000db0007000280 - 02 GPO index, 80 or 00 - on/off\nflow.set('sendGPO','040300000012000001dd0000db000700');\nflow.set('accessTable',[]);\nflow.set('getReaderConfig','0402000000110000012e00000900000000');\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":40,"wires":[[]]},{"id":"61b8f366.9a985c","type":"function","z":"e8e22d87.0e8b","name":"get row from Access Table","func":"var aT = flow.get('accessTable');\nvar aTDate = flow.get('accessTableUpdate');\nvar nowDate = Date();\nvar diff = 2000;\n\nmsg.do = true;\n//if access table is not actual\nif (nowDate-aTDate > diff){\n    msg.do = false;\n}else{\nfor (var i = 0; i < aT.length; i++){\n    if ((aT[i].ip === msg.ip)&&Number(aT[i].antenna)===msg.tag.antennaID){\n        msg.accessTable = aT[i];\n        break;\n     }\n}\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":660,"y":240,"wires":[["5c3395f6.9a86cc","94d97c17.a7e2"]]},{"id":"618d1d9f.bd2c54","type":"function","z":"e8e22d87.0e8b","name":"get IP","func":"\nmsg.tagID = msg.payload.data.tagID;\nmsg.tag   = msg.payload.data;\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":240,"wires":[["61b8f366.9a985c","917a1c1c.0621e"]]},{"id":"e9a311b6.b4435","type":"function","z":"e8e22d87.0e8b","name":"send GPO if Access","func":"var sendGPOtemplate = flow.get('sendGPO');\n\nvar cmd = []; \nif (msg.accessTable){\n    var tags = msg.accessTable.tags;\n    \n    for (var i = 0; i < tags.length; i++){\n        if (tags[i] === msg.tagID){\n           \n            for(var j = 0; j < msg.accessTable.gpo.length; j++){\n                cmd.push({\n                    \"payload\":new Buffer(sendGPOtemplate+msg.accessTable.gpo[j],'hex'),\n                    \"ip\":msg.ip\n                    \n                });\n                \n            } \n            break;\n        } \n    }\n}\n\nreturn cmd;","outputs":"4","noerr":0,"x":1020,"y":240,"wires":[["7b60ba8f.e0d614","94d97c17.a7e2"],["7da6c93e.c393c8"],["4f6881b1.268b1"],["b6d11cbb.a0e84"]]},{"id":"b6ad2fb.bd338d","type":"princip-llrp-out","z":"e8e22d87.0e8b","name":"217","device":"5f96c43d.c0d33c","x":90,"y":260,"wires":[["c35acb35.ab6e18"]]},{"id":"88bd6749.caef68","type":"princip-llrp-in","z":"e8e22d87.0e8b","name":"217","device":"5f96c43d.c0d33c","x":1290,"y":20,"wires":[]},{"id":"67e57c54.2e0b54","type":"function","z":"e8e22d87.0e8b","name":"send getReaderConfig LLRP message","func":"msg.payload = new Buffer(flow.get('getReaderConfig'),'hex');\nmsg.ip = msg.req.query.rfidID;\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":600,"wires":[["4b4178e4.0e7c68","7b60ba8f.e0d614"]]},{"id":"71fa0528.1efe0c","type":"switch","z":"e8e22d87.0e8b","name":"","property":"payload.type","propertyType":"msg","rules":[{"t":"eq","v":"getAccessReport","vt":"str"},{"t":"eq","v":"getReaderConfig","vt":"str"}],"checkall":"true","outputs":2,"x":330,"y":260,"wires":[["618d1d9f.bd2c54"],["37a9e529.c81c4a"]]},{"id":"35842f6d.616ef","type":"http in","z":"e8e22d87.0e8b","name":"","url":"/getReaderConfig","method":"get","swaggerDoc":"","x":120,"y":600,"wires":[["67e57c54.2e0b54"]]},{"id":"b4fa97d2.07ac88","type":"function","z":"e8e22d87.0e8b","name":"Waiting for LLRP response","func":"msg.statusCode = 200;\nmsg.payload = flow.get(msg.ip);\nreturn msg;","outputs":1,"noerr":0,"x":880,"y":600,"wires":[["5a741b8d.0ce7f4","e22c509e.75425"]]},{"id":"5a741b8d.0ce7f4","type":"http response","z":"e8e22d87.0e8b","name":"","x":1070,"y":600,"wires":[]},{"id":"37a9e529.c81c4a","type":"function","z":"e8e22d87.0e8b","name":"get Reader config","func":"flow.set(msg.ip,msg.payload.data);\nreturn msg;","outputs":1,"noerr":0,"x":484,"y":308,"wires":[[]]},{"id":"4b4178e4.0e7c68","type":"delay","z":"e8e22d87.0e8b","name":"","pauseType":"delay","timeout":"500","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":670,"y":600,"wires":[["b4fa97d2.07ac88"]]},{"id":"223c801f.be283","type":"http in","z":"e8e22d87.0e8b","name":"","url":"/setDefaultTable","method":"post","swaggerDoc":"","x":140,"y":180,"wires":[["1ae4308f.a62f9f"]]},{"id":"1ae4308f.a62f9f","type":"function","z":"e8e22d87.0e8b","name":"set default Table","func":"// var accessTable = [];\n// var exampleAcess = {\n//     \"ip\":\"10.3.5.210\",\n//     \"port\":5084,\n//     \"gpo\":['0180','0200']\n// }\n\nflow.set('accessTable',msg.payload);\nmsg.statusCode = 200;\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":180,"wires":[["8c5fbf47.357a4"]]},{"id":"8c5fbf47.357a4","type":"http response","z":"e8e22d87.0e8b","name":"","x":550,"y":180,"wires":[]},{"id":"b2ff94ab.4c3c08","type":"link in","z":"572f2797.a3f3d8","name":"","links":["2b4ac59.f7acf3a","917a1c1c.0621e"],"x":35,"y":40,"wires":[["4ec110da.8058f"]]},{"id":"4ec110da.8058f","type":"function","z":"572f2797.a3f3d8","name":"","func":"var ip_name = msg.ip.replace(/\\./g,\"_\");\nvar rfidTags = flow.get(ip_name);\nvar allTags = flow.get('allTags');\n\nif (!allTags){\n    allTags = [];\n}\n\nif(!(rfidTags)){\n    rfidTags = [];\n}\n\nvar tag = {\n    \"ip_name\":ip_name,\n    \"ip\":msg.ip,\n    \"antennaID\":msg.tag.antennaID,\n    \"tagID\":msg.tag.tagID,\n    \"timestamp\":new Date(),\n    \"peakRSSI\":msg.tag.PeakRSSI\n}\n\nfindedAllTags = false;\nfor (var i = 0; i < allTags.length; i++){\n    if((allTags[i].tagID === tag.tagID) && ((allTags[i].antennaID === tag.antennaID))){\n         findedAllTags = true; \n         allTags[i] = tag;\n    }\n}\nif(!findedAllTags){\n    allTags.push(tag);\n}\n\nfinded = false;\nif (rfidTags){\n    for (var i = 0; i < rfidTags.length; i++){\n        if((rfidTags[i].tagID === tag.tagID) && ((rfidTags[i].antennaID === tag.antennaID))){\n         finded = true; \n         rfidTags[i] = tag;\n        }\n    }\n}\n\nif (!finded){\n    rfidTags.push(tag);   \n}\n\nflow.set(ip_name,rfidTags);\nflow.set(\"allTags\",allTags);\nmsg.payload = tag;\nmsg.ip_name = ip_name;\nreturn msg;","outputs":1,"noerr":0,"x":130,"y":40,"wires":[["c11eb2ff.a54ed"]]},{"id":"917a1c1c.0621e","type":"link out","z":"e8e22d87.0e8b","name":"","links":["b2ff94ab.4c3c08"],"x":595,"y":280,"wires":[]},{"id":"c35acb35.ab6e18","type":"function","z":"e8e22d87.0e8b","name":"set IP","func":"msg.ip = \"10.3.5.217\";\nreturn msg;","outputs":1,"noerr":0,"x":210,"y":260,"wires":[["71fa0528.1efe0c"]]},{"id":"7b60ba8f.e0d614","type":"switch","z":"e8e22d87.0e8b","name":"","property":"ip","propertyType":"msg","rules":[{"t":"eq","v":"10.3.5.217","vt":"str"},{"t":"eq","v":"10.3.5.216","vt":"str"},{"t":"eq","v":"10.3.5.215","vt":"str"},{"t":"eq","v":"10.3.5.214","vt":"str"},{"t":"eq","v":"10.3.5.212","vt":"str"},{"t":"eq","v":"10.3.5.211","vt":"str"},{"t":"eq","v":"10.3.5.210","vt":"str"}],"checkall":"true","outputs":7,"x":1150,"y":140,"wires":[["88bd6749.caef68"],["60ad2cdd.bbbe44"],["5cd8c020.6dbe3"],["c0fce58e.620978"],["4f170030.b72c7"],["67f416cd.fee1a8"],["651e274a.dc9708"]]},{"id":"39f4363.c0c70ca","type":"princip-llrp-out","z":"e8e22d87.0e8b","name":"216","device":"ab747bd1.e885d8","x":90,"y":300,"wires":[["36ae78ac.a2baf8"]]},{"id":"36ae78ac.a2baf8","type":"function","z":"e8e22d87.0e8b","name":"set IP","func":"msg.ip = \"10.3.5.216\";\nreturn msg;","outputs":1,"noerr":0,"x":210,"y":300,"wires":[["71fa0528.1efe0c"]]},{"id":"32e24c0c.6e1454","type":"princip-llrp-out","z":"e8e22d87.0e8b","name":"215","device":"397e437e.6d3c3c","x":90,"y":340,"wires":[["1498761b.5bc28a"]]},{"id":"1498761b.5bc28a","type":"function","z":"e8e22d87.0e8b","name":"set IP","func":"msg.ip = \"10.3.5.215\";\nreturn msg;","outputs":1,"noerr":0,"x":210,"y":340,"wires":[["71fa0528.1efe0c"]]},{"id":"1213d3ec.966d7c","type":"princip-llrp-out","z":"e8e22d87.0e8b","name":"214","device":"8d33ca5.8ce5838","x":90,"y":380,"wires":[["4fca49aa.900b68"]]},{"id":"4fca49aa.900b68","type":"function","z":"e8e22d87.0e8b","name":"set IP","func":"msg.ip = \"10.3.5.214\";\nreturn msg;","outputs":1,"noerr":0,"x":210,"y":380,"wires":[["71fa0528.1efe0c"]]},{"id":"77901fd9.cb89c","type":"princip-llrp-out","z":"e8e22d87.0e8b","name":"212","device":"e0f875b6.4bc168","x":90,"y":420,"wires":[["fd308bb4.5f6228"]]},{"id":"fd308bb4.5f6228","type":"function","z":"e8e22d87.0e8b","name":"set IP","func":"msg.ip = \"10.3.5.212\";\nreturn msg;","outputs":1,"noerr":0,"x":210,"y":420,"wires":[["71fa0528.1efe0c"]]},{"id":"1932a8d9.3c6487","type":"princip-llrp-out","z":"e8e22d87.0e8b","name":"211","device":"30b2ef9d.91eea","x":90,"y":460,"wires":[["df4ad982.e08608"]]},{"id":"df4ad982.e08608","type":"function","z":"e8e22d87.0e8b","name":"set IP","func":"msg.ip = \"10.3.5.211\";\nreturn msg;","outputs":1,"noerr":0,"x":210,"y":460,"wires":[["71fa0528.1efe0c"]]},{"id":"4485e8fb.a5dc78","type":"princip-llrp-out","z":"e8e22d87.0e8b","name":"210","device":"1fc45ae7.7d45e5","x":90,"y":500,"wires":[["36d5dd5b.089602"]]},{"id":"36d5dd5b.089602","type":"function","z":"e8e22d87.0e8b","name":"set IP","func":"msg.ip = \"10.3.5.210\";\nreturn msg;","outputs":1,"noerr":0,"x":210,"y":500,"wires":[["71fa0528.1efe0c"]]},{"id":"60ad2cdd.bbbe44","type":"princip-llrp-in","z":"e8e22d87.0e8b","name":"216","device":"ab747bd1.e885d8","x":1290,"y":60,"wires":[]},{"id":"5cd8c020.6dbe3","type":"princip-llrp-in","z":"e8e22d87.0e8b","name":"215","device":"397e437e.6d3c3c","x":1290,"y":100,"wires":[]},{"id":"c0fce58e.620978","type":"princip-llrp-in","z":"e8e22d87.0e8b","name":"214","device":"8d33ca5.8ce5838","x":1290,"y":140,"wires":[]},{"id":"4f170030.b72c7","type":"princip-llrp-in","z":"e8e22d87.0e8b","name":"212","device":"e0f875b6.4bc168","x":1290,"y":180,"wires":[]},{"id":"67f416cd.fee1a8","type":"princip-llrp-in","z":"e8e22d87.0e8b","name":"211","device":"30b2ef9d.91eea","x":1290,"y":220,"wires":[]},{"id":"651e274a.dc9708","type":"princip-llrp-in","z":"e8e22d87.0e8b","name":"210","device":"1fc45ae7.7d45e5","x":1290,"y":260,"wires":[]},{"id":"89c295ed.2372e8","type":"princip-llrp-in","z":"e8e22d87.0e8b","name":"217","device":"5f96c43d.c0d33c","x":1550,"y":20,"wires":[]},{"id":"7da6c93e.c393c8","type":"switch","z":"e8e22d87.0e8b","name":"","property":"ip","propertyType":"msg","rules":[{"t":"eq","v":"10.3.5.217","vt":"str"},{"t":"eq","v":"10.3.5.216","vt":"str"},{"t":"eq","v":"10.3.5.215","vt":"str"},{"t":"eq","v":"10.3.5.214","vt":"str"},{"t":"eq","v":"10.3.5.212","vt":"str"},{"t":"eq","v":"10.3.5.211","vt":"str"},{"t":"eq","v":"10.3.5.210","vt":"str"}],"checkall":"true","outputs":7,"x":1410,"y":140,"wires":[["89c295ed.2372e8"],["37848d87.bf5272"],["9b291e41.5ef93"],["9cc90273.9b73"],["17d3725e.dce2be"],["fe756909.f0b348"],["34c3736e.4a0dcc"]]},{"id":"37848d87.bf5272","type":"princip-llrp-in","z":"e8e22d87.0e8b","name":"216","device":"ab747bd1.e885d8","x":1550,"y":60,"wires":[]},{"id":"9b291e41.5ef93","type":"princip-llrp-in","z":"e8e22d87.0e8b","name":"215","device":"397e437e.6d3c3c","x":1550,"y":100,"wires":[]},{"id":"9cc90273.9b73","type":"princip-llrp-in","z":"e8e22d87.0e8b","name":"214","device":"8d33ca5.8ce5838","x":1550,"y":140,"wires":[]},{"id":"17d3725e.dce2be","type":"princip-llrp-in","z":"e8e22d87.0e8b","name":"212","device":"e0f875b6.4bc168","x":1550,"y":180,"wires":[]},{"id":"fe756909.f0b348","type":"princip-llrp-in","z":"e8e22d87.0e8b","name":"211","device":"30b2ef9d.91eea","x":1550,"y":220,"wires":[]},{"id":"34c3736e.4a0dcc","type":"princip-llrp-in","z":"e8e22d87.0e8b","name":"210","device":"1fc45ae7.7d45e5","x":1550,"y":260,"wires":[]},{"id":"25bae7e1.4c8768","type":"princip-llrp-in","z":"e8e22d87.0e8b","name":"217","device":"5f96c43d.c0d33c","x":1830,"y":20,"wires":[]},{"id":"4f6881b1.268b1","type":"switch","z":"e8e22d87.0e8b","name":"","property":"ip","propertyType":"msg","rules":[{"t":"eq","v":"10.3.5.217","vt":"str"},{"t":"eq","v":"10.3.5.216","vt":"str"},{"t":"eq","v":"10.3.5.215","vt":"str"},{"t":"eq","v":"10.3.5.214","vt":"str"},{"t":"eq","v":"10.3.5.212","vt":"str"},{"t":"eq","v":"10.3.5.211","vt":"str"},{"t":"eq","v":"10.3.5.210","vt":"str"}],"checkall":"true","outputs":7,"x":1690,"y":140,"wires":[["25bae7e1.4c8768"],["20382dd1.4220f2"],["4455a107.92fac"],["10f2440e.94584c"],["c4d271d5.e44a1"],["d5ec20c2.807f6"],["b05d87b9.14dd88"]]},{"id":"20382dd1.4220f2","type":"princip-llrp-in","z":"e8e22d87.0e8b","name":"216","device":"ab747bd1.e885d8","x":1830,"y":60,"wires":[]},{"id":"4455a107.92fac","type":"princip-llrp-in","z":"e8e22d87.0e8b","name":"215","device":"397e437e.6d3c3c","x":1830,"y":100,"wires":[]},{"id":"10f2440e.94584c","type":"princip-llrp-in","z":"e8e22d87.0e8b","name":"214","device":"8d33ca5.8ce5838","x":1830,"y":140,"wires":[]},{"id":"c4d271d5.e44a1","type":"princip-llrp-in","z":"e8e22d87.0e8b","name":"212","device":"e0f875b6.4bc168","x":1830,"y":180,"wires":[]},{"id":"d5ec20c2.807f6","type":"princip-llrp-in","z":"e8e22d87.0e8b","name":"211","device":"30b2ef9d.91eea","x":1830,"y":220,"wires":[]},{"id":"b05d87b9.14dd88","type":"princip-llrp-in","z":"e8e22d87.0e8b","name":"210","device":"1fc45ae7.7d45e5","x":1830,"y":260,"wires":[]},{"id":"4769e4a5.daf1ec","type":"princip-llrp-in","z":"e8e22d87.0e8b","name":"217","device":"5f96c43d.c0d33c","x":2090,"y":20,"wires":[]},{"id":"b6d11cbb.a0e84","type":"switch","z":"e8e22d87.0e8b","name":"","property":"ip","propertyType":"msg","rules":[{"t":"eq","v":"10.3.5.217","vt":"str"},{"t":"eq","v":"10.3.5.216","vt":"str"},{"t":"eq","v":"10.3.5.215","vt":"str"},{"t":"eq","v":"10.3.5.214","vt":"str"},{"t":"eq","v":"10.3.5.212","vt":"str"},{"t":"eq","v":"10.3.5.211","vt":"str"},{"t":"eq","v":"10.3.5.210","vt":"str"}],"checkall":"true","outputs":7,"x":1950,"y":140,"wires":[["4769e4a5.daf1ec"],["5aaa0c65.81aec4"],["8706f8bc.291b98"],["8082492d.1f43f8"],["37fd8183.10291e"],["5216f0b6.b2343"],["546fe25b.fad75c"]]},{"id":"5aaa0c65.81aec4","type":"princip-llrp-in","z":"e8e22d87.0e8b","name":"216","device":"ab747bd1.e885d8","x":2090,"y":60,"wires":[]},{"id":"8706f8bc.291b98","type":"princip-llrp-in","z":"e8e22d87.0e8b","name":"215","device":"397e437e.6d3c3c","x":2090,"y":100,"wires":[]},{"id":"8082492d.1f43f8","type":"princip-llrp-in","z":"e8e22d87.0e8b","name":"214","device":"8d33ca5.8ce5838","x":2090,"y":140,"wires":[]},{"id":"37fd8183.10291e","type":"princip-llrp-in","z":"e8e22d87.0e8b","name":"212","device":"e0f875b6.4bc168","x":2090,"y":180,"wires":[]},{"id":"5216f0b6.b2343","type":"princip-llrp-in","z":"e8e22d87.0e8b","name":"211","device":"30b2ef9d.91eea","x":2090,"y":220,"wires":[]},{"id":"546fe25b.fad75c","type":"princip-llrp-in","z":"e8e22d87.0e8b","name":"210","device":"1fc45ae7.7d45e5","x":2090,"y":260,"wires":[]},{"id":"f5df1fe1.66155","type":"http in","z":"572f2797.a3f3d8","name":"","url":"/getTag","method":"get","swaggerDoc":"","x":130,"y":80,"wires":[["145b1ae0.ba4755"]]},{"id":"145b1ae0.ba4755","type":"function","z":"572f2797.a3f3d8","name":"","func":"var rfidID    = msg.req.query.rfidID.replace(/\\./g,\"_\");\nvar antennaID = msg.req.query.antennaID;\n\nif(antennaID){\n    antennaID = Number(antennaID);\n}\n\nvar tags = [];\nvar rfidTags = flow.get(rfidID);\n\nvar currentDate = new Date();\nvar difference  = 4000;\n\nif(rfidTags){\nfor (var i = rfidTags.length-1; i >=0; i--){\n    \n   if((rfidTags[i].antennaID===antennaID)&&((currentDate - rfidTags[i].timestamp) <= difference)){\n        tags.push({\n            'tagID':rfidTags[i].tagID,\n            'PeakRSSI':rfidTags[i].PeakRSSI,\n            'tagLastSeen':rfidTags[i].timestamp,\n            'currentDate':currentDate,\n            'diff':currentDate-rfidTags[i].timestamp\n            \n        });\n        \n    }\n}\n}\nmsg.payload = tags;\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":80,"wires":[["5650b450.380b2c"]]},{"id":"5650b450.380b2c","type":"http response","z":"572f2797.a3f3d8","name":"","x":470,"y":80,"wires":[]},{"id":"c11eb2ff.a54ed","type":"debug","z":"572f2797.a3f3d8","name":"","active":true,"console":false,"complete":"payload","x":630,"y":40,"wires":[]},{"id":"536cfe56.c27e3","type":"http in","z":"e8e22d87.0e8b","name":"","url":"/setReaderConfig","method":"post","swaggerDoc":"","x":680,"y":40,"wires":[["7bfb67e7.619588","475c27be.d79b28"]]},{"id":"7bfb67e7.619588","type":"function","z":"e8e22d87.0e8b","name":"","func":"var gpo_cmd = msg.payload.cmd;\nvar sendGPO = flow.get('sendGPO');\nmsg.ip      = msg.req.query.rfidID;\nmsg.payload = new Buffer(sendGPO+gpo_cmd,'hex');\nreturn msg;","outputs":"1","noerr":0,"x":910,"y":40,"wires":[["3c958d18.8044a2","7b60ba8f.e0d614"]]},{"id":"475c27be.d79b28","type":"http response","z":"e8e22d87.0e8b","name":"","x":910,"y":100,"wires":[]},{"id":"b11effc7.31be4","type":"inject","z":"572f2797.a3f3d8","name":"","topic":"","payload":"10_3_5_210","payloadType":"flow","repeat":"","crontab":"","once":false,"x":120,"y":160,"wires":[["87107bc1.084148"]]},{"id":"87107bc1.084148","type":"debug","z":"572f2797.a3f3d8","name":"","active":false,"console":"false","complete":"false","x":290,"y":160,"wires":[]},{"id":"3c958d18.8044a2","type":"debug","z":"e8e22d87.0e8b","name":"","active":false,"console":"false","complete":"payload","x":1080,"y":40,"wires":[]},{"id":"e22c509e.75425","type":"debug","z":"e8e22d87.0e8b","name":"","active":false,"console":"false","complete":"false","x":1070,"y":660,"wires":[]},{"id":"abff0c04.dc07","type":"inject","z":"572f2797.a3f3d8","name":"","topic":"","payload":"allTags","payloadType":"flow","repeat":"","crontab":"","once":false,"x":110,"y":200,"wires":[["caec28ab.ec2038"]]},{"id":"caec28ab.ec2038","type":"debug","z":"572f2797.a3f3d8","name":"","active":false,"console":"false","complete":"false","x":290,"y":200,"wires":[]},{"id":"abfdf91d.5c5908","type":"inject","z":"572f2797.a3f3d8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":100,"y":240,"wires":[["243ad468.4bb19c"]]},{"id":"243ad468.4bb19c","type":"function","z":"572f2797.a3f3d8","name":"","func":"flow.set(\"allTags\",[]);\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":240,"wires":[[]]},{"id":"2d3c3866.fca278","type":"http in","z":"572f2797.a3f3d8","name":"","url":"/getAllTags","method":"get","swaggerDoc":"","x":140,"y":120,"wires":[["137877e8.2ff988"]]},{"id":"137877e8.2ff988","type":"function","z":"572f2797.a3f3d8","name":"","func":"var allTags = flow.get(\"allTags\");\nvar tags    = [];\nvar currentDate = new Date();\nvar difference  = 4000;\n\nif(allTags){\nfor (var i = allTags.length-1; i >=0; i--){\n    \n   if(((currentDate - allTags[i].timestamp) <= difference)){\n        tags.push({\n            \"ip\":allTags[i].ip,\n            \"antenna\":allTags[i].antennaID,\n            'tagID':allTags[i].tagID,\n            'PeakRSSI':allTags[i].PeakRSSI,\n            'tagLastSeen':allTags[i].timestamp,\n            'currentDate':currentDate,\n            'diff':currentDate-allTags[i].timestamp\n        });\n        \n    }\n}\n}\nmsg.payload = tags;\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":120,"wires":[["847490c0.9330a","74dee389.b1443c"]]},{"id":"847490c0.9330a","type":"http response","z":"572f2797.a3f3d8","name":"","x":470,"y":120,"wires":[]},{"id":"6e935800.f35df8","type":"debug","z":"e8e22d87.0e8b","name":"","active":false,"console":"false","complete":"false","x":650,"y":100,"wires":[]},{"id":"9a1cc0df.8b5b7","type":"inject","z":"e8e22d87.0e8b","name":"","topic":"","payload":"accessTable","payloadType":"flow","repeat":"","crontab":"","once":false,"x":120,"y":680,"wires":[["f57d31ea.35b67"]]},{"id":"f57d31ea.35b67","type":"debug","z":"e8e22d87.0e8b","name":"","active":true,"console":"false","complete":"false","x":320,"y":680,"wires":[]},{"id":"5c3395f6.9a86cc","type":"switch","z":"e8e22d87.0e8b","name":"","property":"do","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":850,"y":240,"wires":[["e9a311b6.b4435"]]},{"id":"94d97c17.a7e2","type":"debug","z":"e8e22d87.0e8b","name":"","active":false,"console":"false","complete":"false","x":1200,"y":380,"wires":[]},{"id":"74dee389.b1443c","type":"debug","z":"572f2797.a3f3d8","name":"","active":false,"console":"false","complete":"false","x":540,"y":200,"wires":[]},{"id":"d1d046e4.843528","type":"inject","z":"c1fe441.42301b8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":160,"y":80,"wires":[["c9d9d730.7cadd8"]]},{"id":"c9d9d730.7cadd8","type":"template","z":"c1fe441.42301b8","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"CREATE TABLE TagLogs (\n ip           varchar(15),\n    tagID          varchar(56) NOT NULL,\n    antenna        varchar(2),\n    lasttimeSeen   date,\n   diff           integer ,\n    peakRSSI      integer\n);","x":340,"y":80,"wires":[["e37dde1.8e8f42"]]},{"id":"e37dde1.8e8f42","type":"postgres","z":"c1fe441.42301b8","postgresdb":"657a8a2c.6715c4","name":"","output":false,"outputs":0,"x":480,"y":80,"wires":[]},{"id":"513e4de7.8bd294","type":"function","z":"572f2797.a3f3d8","name":"","func":"var tag = msg.payload;\nmsg = {\n  \"payload\":tag \n}\n\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":140,"wires":[["3b2cd7e.140bc28"]]},{"id":"3b2cd7e.140bc28","type":"template","z":"572f2797.a3f3d8","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO public.taglogs(ip, tagid, antenna, diff, peakrssi) VALUES ('{{payload.ip}}', '{{payload.tagID}}','{{payload.antennaID}}', 0,{{payload.peakRSSI}})","x":730,"y":140,"wires":[["24b42954.e0ca86"]]},{"id":"24b42954.e0ca86","type":"postgres","z":"572f2797.a3f3d8","postgresdb":"657a8a2c.6715c4","name":"","output":false,"outputs":0,"x":860,"y":140,"wires":[]}]
