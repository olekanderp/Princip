[{"id":"e01cb617.7ac1f8","type":"tab","label":"Main Flow","disabled":false,"info":""},{"id":"e8f79e27.cefb","type":"tab","label":"MS SQL table managment","disabled":false,"info":""},{"id":"6bbcd4b2.f1051c","type":"tab","label":"Legacy","disabled":true,"info":""},{"id":"a57b8bc.3d86878","type":"subflow","name":"Subflow 1","info":"","in":[],"out":[]},{"id":"2a869df7.efeb52","type":"MSSQL-CN","z":"","tdsVersion":"7_4","name":"mes-bmez-01","server":"10.0.15.145","port":"1433","encyption":true,"database":"WINCCSQL","useUTC":true,"connectTimeout":"15000","requestTimeout":"15000","cancelTimeout":"5000","pool":"5"},{"id":"75af26a6.f69f48","type":"serial-port","z":"","serialport":"/dev/ttyUSB0","serialbaud":"1200","databits":"7","parity":"none","stopbits":"1","newline":"\\n","bin":"false","out":"char","addchar":false,"responsetimeout":""},{"id":"97ba69e7.2461a8","type":"MSSQL","z":"e8f79e27.cefb","mssqlCN":"2a869df7.efeb52","name":"create","query":"CREATE TABLE device_telemetry (ID INT IDENTITY PRIMARY KEY, datetime datetime2(7), DEVICE VARCHAR(50), TELEMETRY_VALUE bigint, telemtry_datetime datetime2(7));\n","outField":"payload","x":230,"y":20,"wires":[["10caea1b.b46716"]]},{"id":"8a12140c.1d94a8","type":"inject","z":"e8f79e27.cefb","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":80,"y":20,"wires":[["97ba69e7.2461a8"]]},{"id":"10caea1b.b46716","type":"debug","z":"e8f79e27.cefb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":410,"y":20,"wires":[]},{"id":"7ac25859.a79268","type":"MSSQL","z":"e8f79e27.cefb","mssqlCN":"2a869df7.efeb52","name":"select table","query":"SELECT DISTINCT TOP 10 * FROM device_telemetry","outField":"payload","x":250,"y":60,"wires":[["d189d586.d93608"]]},{"id":"681edb58.a44864","type":"inject","z":"e8f79e27.cefb","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":80,"y":60,"wires":[["7ac25859.a79268"]]},{"id":"d189d586.d93608","type":"debug","z":"e8f79e27.cefb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":410,"y":60,"wires":[]},{"id":"56e5b5cc.47f66c","type":"serial in","z":"e01cb617.7ac1f8","name":"","serial":"75af26a6.f69f48","x":110,"y":100,"wires":[["24d5ca10.19bbd6","6f65c55f.4341ec"]]},{"id":"24d5ca10.19bbd6","type":"debug","z":"e01cb617.7ac1f8","name":"","active":true,"console":"false","complete":"false","x":230,"y":220,"wires":[]},{"id":"6eeaec3a.466ae4","type":"comment","z":"e01cb617.7ac1f8","name":"","info":"copy C:\\Data\\exchange.txt \\\\.\\COM1\nотправка числа \necho ^1> \\\\.\\com46","x":100,"y":20,"wires":[]},{"id":"19a1105e.478ea","type":"http in","z":"e01cb617.7ac1f8","name":"","url":"/getData/serial","method":"get","swaggerDoc":"","x":130,"y":600,"wires":[["3d04d2fb.80207e"]]},{"id":"3d04d2fb.80207e","type":"function","z":"e01cb617.7ac1f8","name":"","func":"msg.payload = flow.get('data');\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":600,"wires":[["83e2714f.0b60f"]]},{"id":"83e2714f.0b60f","type":"http response","z":"e01cb617.7ac1f8","name":"","x":552.2857055664062,"y":610.2857055664062,"wires":[]},{"id":"6a99c694.30a2f8","type":"http in","z":"e01cb617.7ac1f8","name":"","url":"/getDataFile/serial","method":"get","swaggerDoc":"","x":132.85714721679688,"y":646.2857055664062,"wires":[["9731f934.322118"]]},{"id":"644c915d.61c96","type":"http response","z":"e01cb617.7ac1f8","name":"","x":556.28564453125,"y":649.2857055664062,"wires":[]},{"id":"9731f934.322118","type":"file in","z":"e01cb617.7ac1f8","name":"","filename":"/home/pi/str_with_SCADA.txt","format":"utf8","sendError":true,"x":370.8571472167969,"y":648.2857055664062,"wires":[["644c915d.61c96"]]},{"id":"7d942d42.f48e04","type":"debug","z":"e8f79e27.cefb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":410,"y":100,"wires":[]},{"id":"7777cfa1.03db9","type":"MSSQL","z":"e8f79e27.cefb","mssqlCN":"2a869df7.efeb52","name":"drop","query":"DROP TABLE device_telemetry","outField":"payload","x":230,"y":140,"wires":[["7d942d42.f48e04"]]},{"id":"43c3af10.b8724","type":"MSSQL","z":"e01cb617.7ac1f8","mssqlCN":"2a869df7.efeb52","name":"insert_1","query":"DECLARE @DEVICE VARCHAR(50)\nDECLARE @TELEMETRY_VALUE bigint\nDECLARE @TELEMETRY_DATE datetime\n\n\nSET @DEVICE = '{{{payload.DEVICE}}}';\nSET @TELEMETRY_VALUE = {{{payload.TELEMETRY_VALUE}}};\nSET @TELEMETRY_DATE = '{{{payload.TELEMETRY_DATE}}}';\n\n\nINSERT INTO device_telemetry (datetime, DEVICE, TELEMETRY_VALUE, telemtry_datetime) \nVALUES (GETDATE(), @DEVICE, @TELEMETRY_VALUE, replace(@TELEMETRY_DATE,'.',':'))\n\n","outField":"payload","x":640,"y":100,"wires":[["e8406c55.bdb36"]]},{"id":"e8406c55.bdb36","type":"debug","z":"e01cb617.7ac1f8","name":"","active":false,"tosidebar":true,"console":false,"complete":"true","x":770,"y":100,"wires":[]},{"id":"9246e2fe.e1f51","type":"inject","z":"e8f79e27.cefb","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":80,"y":100,"wires":[["2a5b6242.92e05e"]]},{"id":"2a5b6242.92e05e","type":"MSSQL","z":"e8f79e27.cefb","mssqlCN":"2a869df7.efeb52","name":"ALTER","query":"ALTER TABLE device_telemetry\nALTER COLUMN telemtry_datetime DATETIME2;","outField":"payload","x":240,"y":100,"wires":[["7d942d42.f48e04"]]},{"id":"4b0ebb55.0ad104","type":"inject","z":"e8f79e27.cefb","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":80,"y":140,"wires":[["7777cfa1.03db9"]]},{"id":"ec07c7b1.a61e78","type":"comment","z":"e01cb617.7ac1f8","name":"API","info":"","x":90,"y":680,"wires":[]},{"id":"6f65c55f.4341ec","type":"function","z":"e01cb617.7ac1f8","name":"Convert String","func":"var strData  = msg.payload.split(';');\n\nvar devName  = strData[0];\nvar devValue = Number(strData[1]);\nvar devDate  = strData[2].replace('\\r\\n','')+\":00\";\n\nvar payload =  {\n    DEVICE:devName,\n    TELEMETRY_VALUE:devValue,\n    TELEMETRY_DATE:devDate\n}\n\nvar devices = flow.get('devices');\nvar log = true;\n\nfor (var i = 0; i < devices.length; i++){\n    if (devices[i].DEVICE === devName){\n        if ((devices[i].TELEMETRY_VALUE === devValue)&&(devices[i].TELEMETRY_DATE === devDate)){\n            log = false;\n            device[i] = payload;\n        }\n   } \n}\n\nmsg.log     = log;\nmsg.payload = payload;\n\nreturn msg;","outputs":1,"noerr":0,"x":320,"y":100,"wires":[["c575ea5b.266e58","680e2fc0.282c4"]]},{"id":"c575ea5b.266e58","type":"debug","z":"e01cb617.7ac1f8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":450,"y":220,"wires":[]},{"id":"e5546d56.036","type":"comment","z":"e01cb617.7ac1f8","name":"API","info":"","x":70,"y":560,"wires":[]},{"id":"c4637c95.52a0b","type":"function","z":"6bbcd4b2.f1051c","name":"set data to flow var","func":"flow.set('data', msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":130,"y":100,"wires":[[]]},{"id":"de59cce3.2e0c6","type":"file","z":"6bbcd4b2.f1051c","name":"","filename":"/home/pi/str_with_SCADA.txt","appendNewline":true,"createDir":false,"overwriteFile":"false","x":160,"y":140,"wires":[[]]},{"id":"635da2f3.6ae1ac","type":"debug","z":"6bbcd4b2.f1051c","name":"","active":true,"tosidebar":true,"console":false,"complete":"true","x":445.5714111328125,"y":292.1428527832031,"wires":[]},{"id":"ec5e4aa2.c89608","type":"function","z":"6bbcd4b2.f1051c","name":"Oil_count","func":"var str = msg.payload;\n//Обрезаем конец:\nmsg.str = msg.payload;\nvar from = str.search('Oil_count');\nmsg.payload = from;\n\nif(from >= 0){\nreturn msg;\n}","outputs":1,"noerr":0,"x":92.85714721679688,"y":291.71429443359375,"wires":[["ed83908a.71ec6"]]},{"id":"44f23998.9e3ab8","type":"debug","z":"6bbcd4b2.f1051c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":437.71435546875,"y":253.14288330078125,"wires":[]},{"id":"ed83908a.71ec6","type":"function","z":"6bbcd4b2.f1051c","name":"div_filter","func":"var str = msg.str;\nvar DEVICE =    str.substring(0,9);\n\nvar to = str.length;\nvar intermediate_str = str.substring(10,to);\nvar from = intermediate_str.search(';');\nvar numb = intermediate_str.substring(0,from);\nvar TELEMETRY_VALUE = Number(numb);\n\n\nvar to_1 = intermediate_str.length;\nvar TELEMETRY_DATE =  intermediate_str.substring(from + 1,to_1-4);\nTELEMETRY_DATE = TELEMETRY_DATE+\":00\";\n// TELEMETRY_DATE = TELEMETRY_DATE.replace('/.','-')+\":00\";\n\n var d = new Date();\n var de = (Date.parse(TELEMETRY_DATE));\n var date_2 = {\n     a:(d.toLocaleString()),\n     b:de\n }\n\nmsg.payload = {\n    DEVICE:DEVICE,\n    TELEMETRY_VALUE:TELEMETRY_VALUE,\n    TELEMETRY_DATE:TELEMETRY_DATE,\n    numb:numb,\n    date:TELEMETRY_DATE\n}\nreturn msg;\n","outputs":1,"noerr":0,"x":251,"y":292,"wires":[["635da2f3.6ae1ac"]]},{"id":"68370983.25b128","type":"function","z":"6bbcd4b2.f1051c","name":"BY3_count","func":"var str = msg.payload;\n//Обрезаем конец:\nmsg.str = msg.payload;\nvar from = str.search('BY3_count');\nmsg.payload = from;\n\nif(from >= 0){\n    return msg;\n}","outputs":1,"noerr":0,"x":106,"y":253,"wires":[["1dd54b31.a54ca5"]]},{"id":"1dd54b31.a54ca5","type":"function","z":"6bbcd4b2.f1051c","name":"div_filter","func":"var str = msg.str;\nvar DEVICE =    str.substring(0,9);\n\nvar to = str.length;\nvar intermediate_str = str.substring(10,to);\nvar from = intermediate_str.search(';');\nvar numb = intermediate_str.substring(0,from);\nvar TELEMETRY_VALUE = Number(numb);\n\n\nvar to_1 = intermediate_str.length;\nvar TELEMETRY_DATE =  intermediate_str.substring(from + 1,to_1-2);\n\nvar d = new Date();\nvar de = d.setTime(Date.parse(TELEMETRY_DATE));\nvar date_2 = {\n    a:(d.toLocaleString()),\n    b:de\n}\n\n\n\n\n\nmsg.payload = {\n    DEVICE:DEVICE,\n    TELEMETRY_VALUE:TELEMETRY_VALUE,\n    TELEMETRY_DATE:date_2.a,\n    numb:numb,\n    datetime:new Date()\n}\nreturn msg;\n","outputs":1,"noerr":0,"x":251.14285278320312,"y":254.28570556640625,"wires":[["44f23998.9e3ab8"]]},{"id":"1675a4c8.19435b","type":"function","z":"6bbcd4b2.f1051c","name":"BY1_count","func":"var str = msg.payload;\n//Обрезаем конец:\nmsg.str = msg.payload;\nvar from = str.search('BY1_count');\nmsg.payload = from;\n\nif(from >= 0){\n    return msg;\n}","outputs":1,"noerr":0,"x":106,"y":216,"wires":[["2be09a41.550026"]]},{"id":"2be09a41.550026","type":"function","z":"6bbcd4b2.f1051c","name":"div_filter","func":"var str = msg.str;\nvar DEVICE =    str.substring(0,9);\n\nvar to = str.length;\nvar intermediate_str = str.substring(10,to);\nvar from = intermediate_str.search(';');\nvar numb = intermediate_str.substring(0,from);\nvar TELEMETRY_VALUE = Number(numb);\n\n\nvar to_1 = intermediate_str.length;\nvar TELEMETRY_DATE =  intermediate_str.substring(from + 1,to_1-2);\n\nvar d = new Date();\nvar de = d.setTime(Date.parse(TELEMETRY_DATE));\nvar date_2 = {\n    a:(d.toLocaleString()),\n    b:de\n}\n\n\n\n\n\nmsg.payload = {\n    DEVICE:DEVICE,\n    TELEMETRY_VALUE:TELEMETRY_VALUE,\n    TELEMETRY_DATE:date_2.a,\n    numb:numb,\n    datetime:new Date()\n}\nreturn msg;\n","outputs":1,"noerr":0,"x":249.14285278320312,"y":215.28570556640625,"wires":[["32430e20.7a19a2"]]},{"id":"32430e20.7a19a2","type":"debug","z":"6bbcd4b2.f1051c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":376,"y":213,"wires":[]},{"id":"345ee29.4153e1e","type":"MSSQL","z":"e8f79e27.cefb","mssqlCN":"2a869df7.efeb52","name":"DELETE","query":"DELETE FROM device_telemetry","outField":"payload","x":240,"y":200,"wires":[["6fe1f238.bbca0c"]]},{"id":"6fe1f238.bbca0c","type":"debug","z":"e8f79e27.cefb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":410,"y":200,"wires":[]},{"id":"9d07544c.f72708","type":"inject","z":"e8f79e27.cefb","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":80,"y":200,"wires":[["345ee29.4153e1e"]]},{"id":"f0dcd55e.947aa8","type":"inject","z":"e01cb617.7ac1f8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":110,"y":60,"wires":[["f79ddd4e.7a21"]]},{"id":"f79ddd4e.7a21","type":"function","z":"e01cb617.7ac1f8","name":"","func":"flow.set('devices',[]);\nreturn msg;","outputs":1,"noerr":0,"x":290,"y":60,"wires":[[]]},{"id":"680e2fc0.282c4","type":"switch","z":"e01cb617.7ac1f8","name":"","property":"log","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":490,"y":100,"wires":[["43c3af10.b8724"],["1723e808.b236e8"]]},{"id":"1723e808.b236e8","type":"debug","z":"e01cb617.7ac1f8","name":"","active":false,"console":"false","complete":"false","x":650,"y":220,"wires":[]}]
