[{"id":"2c7328f4.660f48","type":"tab","label":"scale 1"},{"id":"3c9edf1e.a761e","type":"tab","label":"processing"},{"id":"20659f5c.eccf","type":"subflow","name":"ETTN","info":"","in":[],"out":[]},{"id":"105ecd06.7cad53","type":"subflow","name":"Subflow 1","info":"","in":[],"out":[]},{"id":"a6e3647f.ac4af8","type":"ui_tab","z":"","name":"3.0","icon":"dashboard"},{"id":"a2c1314d.9e6a1","type":"ui_tab","z":"","name":"Smart Scales","icon":"dashboard"},{"id":"baeca9a3.599088","type":"ui_base","name":"Node-RED Dashboard","theme":"theme-light"},{"id":"6e8d2175.cba58","type":"ui_tab","z":"","name":"ETTN","icon":"dashboard"},{"id":"68b9253b.d88e1c","type":"serial-port","z":"","serialport":"/dev/teleinfo_pv","serialbaud":"9600","databits":"8","parity":"none","stopbits":"1","newline":"\\n","bin":"false","out":"char","addchar":false},{"id":"aaaae18.356742","type":"serial-port","z":"","serialport":"/dev/teleinfo","serialbaud":"9600","databits":"8","parity":"none","stopbits":"1","newline":"\\n","bin":"false","out":"char","addchar":false},{"id":"a92616e1.130c18","type":"serial-port","z":"","serialport":"/dev/ttyUSB0","serialbaud":"19200","databits":"8","parity":"none","stopbits":"1","newline":"1000","bin":"bin","out":"time","addchar":false},{"id":"31c7fe97.346882","type":"ui_group","z":"","name":"Вагa і ІД карти","tab":"a2c1314d.9e6a1","order":5,"disp":true,"width":"6"},{"id":"e342ada6.d1b4f","type":"inject","z":"2c7328f4.660f48","name":"","topic":"","payload":"inputString","payloadType":"flow","repeat":"1","crontab":"","once":false,"x":120,"y":180,"wires":[["9cd5ade8.1b7a3"]]},{"id":"9cd5ade8.1b7a3","type":"serial out","z":"2c7328f4.660f48","name":"support","serial":"aaaae18.356742","x":300,"y":180,"wires":[]},{"id":"d3f83d59.0a0da","type":"serial in","z":"2c7328f4.660f48","name":"","serial":"aaaae18.356742","x":110,"y":240,"wires":[["3f8012e2.1bcbde","f955e532.326348"]]},{"id":"3f8012e2.1bcbde","type":"function","z":"2c7328f4.660f48","name":"GET WEIGHT","func":"msg.payload = flow.get('parser')(msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":300,"y":240,"wires":[[]]},{"id":"d10535af.6179c8","type":"comment","z":"2c7328f4.660f48","name":"Device level","info":"","x":90,"y":140,"wires":[]},{"id":"28d47be3.0a5a64","type":"inject","z":"2c7328f4.660f48","name":"init","topic":"","payload":"init","payloadType":"str","repeat":"","crontab":"","once":true,"x":90,"y":80,"wires":[["fd5e85db.baff28"]]},{"id":"815eb197.0240f","type":"comment","z":"2c7328f4.660f48","name":"INITIALIZING","info":"","x":90,"y":20,"wires":[]},{"id":"7745aee8.91d7","type":"http in","z":"2c7328f4.660f48","name":"","url":"/scale1/snapshot1","method":"get","swaggerDoc":"","x":157.24537658691406,"y":1218.2200050354004,"wires":[["c3fe085b.e82468"]]},{"id":"c3fe085b.e82468","type":"http request","z":"2c7328f4.660f48","name":"","method":"GET","ret":"bin","url":"https://vis.ua/wp-content/uploads/2018/02/2-4.jpg","tls":"","x":410.2477111816406,"y":1221.2084045410156,"wires":[["3aee151d.70e56a"]]},{"id":"3aee151d.70e56a","type":"http response","z":"2c7328f4.660f48","name":"","x":636.2499389648438,"y":1216.8311157226562,"wires":[]},{"id":"ed39f378.159b6","type":"serial in","z":"2c7328f4.660f48","name":"","serial":"68b9253b.d88e1c","x":121,"y":1361,"wires":[["36fe5e9c.4392e2","77c59bce.bb53c4"]]},{"id":"967ad8c1.637178","type":"serial out","z":"2c7328f4.660f48","name":"support","serial":"68b9253b.d88e1c","x":321,"y":1321,"wires":[]},{"id":"36fe5e9c.4392e2","type":"function","z":"2c7328f4.660f48","name":"Convert String","func":"var str = msg.payload\nvar devName = str.substring(0,5);\nvar devValue = str.substring(6,15);\n    devValue = Number(devValue);\n\nvar payload =  {\n    DEVICE:devName,\n    TELEMETRY_VALUE:devValue\n    }\n\nmsg.payload = payload;\nreturn msg;","outputs":1,"noerr":0,"x":320,"y":1360,"wires":[["8dbba65a.f124e8"]]},{"id":"8dbba65a.f124e8","type":"function","z":"2c7328f4.660f48","name":"","func":"msg.payload = {\n    \"event_id\":flow.get('config').scale+': '+new Date(),\n    \"device_event_id\":\"83D28F5E76A4CF19E0533300000AA9B3\",\n    \"device_id\":\"83D29107971188EDE0533300000A97C5\",\n    \"value\":{\n         \"sensor_id\":msg.payload.DEVICE,\n         \"temp\":msg.payload.TELEMETRY_VALUE}\n};\nreturn msg;","outputs":1,"noerr":0,"x":490,"y":1360,"wires":[[]]},{"id":"1d67f94d.275017","type":"inject","z":"2c7328f4.660f48","name":"","topic":"","payload":"inputString","payloadType":"flow","repeat":"1","crontab":"","once":false,"x":121,"y":1322.000002861023,"wires":[["967ad8c1.637178"]]},{"id":"77c59bce.bb53c4","type":"debug","z":"2c7328f4.660f48","name":"","active":false,"console":"false","complete":"false","x":273,"y":1415,"wires":[]},{"id":"25eff714.d20fc8","type":"function","z":"2c7328f4.660f48","name":"led green","func":"var buf = Buffer.from('AABB0600000007010204','hex');\nmsg.payload = buf;\nreturn msg;","outputs":1,"noerr":0,"x":508.3333053588867,"y":1653.3331966400146,"wires":[["f9798956.13d488"]]},{"id":"575bb0a1.78db3","type":"inject","z":"2c7328f4.660f48","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":103.99991226196289,"y":1701.666693687439,"wires":[["b68b52db.97b1b"]]},{"id":"d4bc534c.3b9f1","type":"function","z":"2c7328f4.660f48","name":"buz","func":"var buf = Buffer.from('AABB05000000060107','hex');\nmsg.payload = buf;\nreturn msg;","outputs":1,"noerr":0,"x":494.1667175292969,"y":1864.333080291748,"wires":[["f9798956.13d488","254dce6b.c96752"]]},{"id":"86c3540a.c328e8","type":"function","z":"2c7328f4.660f48","name":"rf_request (зчитуєм картку)","func":"var buf = Buffer.from('AABB0600000001022625','hex');\nmsg.payload = buf;\nreturn msg;","outputs":1,"noerr":0,"x":602.6667633056641,"y":1776.3334035873413,"wires":[["f9798956.13d488"]]},{"id":"f9798956.13d488","type":"serial out","z":"2c7328f4.660f48","name":"","serial":"a92616e1.130c18","x":902.9165191650391,"y":1738.9167728424072,"wires":[]},{"id":"cf1e6d61.7a014","type":"serial in","z":"2c7328f4.660f48","name":"","serial":"a92616e1.130c18","x":79.9999771118164,"y":1921.333381652832,"wires":[["1bbc6a52.7f55d6","29764a94.a5f806"]]},{"id":"fc6f9794.1461a8","type":"debug","z":"2c7328f4.660f48","name":"","active":false,"console":"false","complete":"false","x":672.6666564941406,"y":1931.3335704803467,"wires":[]},{"id":"1bbc6a52.7f55d6","type":"function","z":"2c7328f4.660f48","name":"фільтр відповіді","func":"var buffer_length_3 = 0x8;\n\nif(buffer_length_3 == msg.payload[2]){\nreturn msg;\n}","outputs":1,"noerr":0,"x":274.0591468811035,"y":1924.715292930603,"wires":[["c3c06848.640c58"]]},{"id":"c3c06848.640c58","type":"function","z":"2c7328f4.660f48","name":"make str","func":"var all_i = msg.payload;\n\nvar card_id = [all_i[4],all_i[5],all_i[6],all_i[7],all_i[8],all_i[9],all_i[10]];\nvar current_card = card_id.join(\"\");\nmsg.payload = current_card;\nflow.set(\"current_card\",current_card);\n\nreturn msg;\n","outputs":1,"noerr":0,"x":439.33335876464844,"y":1926.6667404174805,"wires":[["fc6f9794.1461a8","d4bc534c.3b9f1","fcf20c77.29fac"]]},{"id":"18ec4982.0762d6","type":"inject","z":"2c7328f4.660f48","name":"","topic":"","payload":"","payloadType":"date","repeat":"3","crontab":"","once":false,"x":100.66661834716797,"y":1776.3333625793457,"wires":[["86c3540a.c328e8"]]},{"id":"b68b52db.97b1b","type":"function","z":"2c7328f4.660f48","name":"led red","func":"var buf = Buffer.from('AABB0600000007010107','hex');\nmsg.payload = buf;\nreturn msg;","outputs":1,"noerr":0,"x":480.3333683013916,"y":1727.4443626403809,"wires":[["f9798956.13d488"]]},{"id":"a6b1ce12.0652d","type":"inject","z":"2c7328f4.660f48","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":108.99996566772461,"y":1660.0000247955322,"wires":[["25eff714.d20fc8"]]},{"id":"254dce6b.c96752","type":"debug","z":"2c7328f4.660f48","name":"","active":false,"console":"false","complete":"false","x":671.6667404174805,"y":1874.9998626708984,"wires":[]},{"id":"45dc038c.faa7fc","type":"comment","z":"2c7328f4.660f48","name":"Rfid reader","info":"","x":253.3333333333333,"y":1584.9999999999998,"wires":[]},{"id":"29764a94.a5f806","type":"debug","z":"2c7328f4.660f48","name":"","active":false,"console":"false","complete":"false","x":283.75000762939453,"y":1859.9999046325684,"wires":[]},{"id":"ee175305.8c413","type":"debug","z":"2c7328f4.660f48","name":"","active":false,"console":"false","complete":"false","x":411.25,"y":1993.75,"wires":[]},{"id":"fcf20c77.29fac","type":"ui_text","z":"2c7328f4.660f48","group":"31c7fe97.346882","order":0,"width":0,"height":0,"name":"","label":"ІД картки","format":"{{msg.payload}}","layout":"row-spread","x":637.5,"y":2017.5,"wires":[]},{"id":"bc99aa30.d18988","type":"link in","z":"3c9edf1e.a761e","name":"weight","links":["20edce7e.5b51e2","a952ade4.1021c","f955e532.326348"],"x":35,"y":380,"wires":[["2aebc76e.14ee98","b522170b.b92838"]]},{"id":"2aebc76e.14ee98","type":"function","z":"3c9edf1e.a761e","name":"main module","func":"var prevWeight = flow.get('prevWeight');\nvar transaction = flow.get('transaction');\nvar transactionData = flow.get('transactionData');\nvar transactionMaxWeight = flow.get('transactionMaxWeight');\nvar transactionHasMaxWeight = flow.get('transactionHasMaxWeight');\nvar transactionHasMaxDuration = flow.get('transactionHasMaxDuration');\nvar waybill = flow.get('transactionWaybill');\nvar weight = msg.payload;\nvar stableSize = 5;\nvar duration = 0;\nvar maxWeight = flow.get('maxWeight');\nvar maxDuration = flow.get('maxDuration');\n//transaction\nif (prevWeight === null){\n    prevWeight = msg.payload;    \n}else{\n    if((prevWeight <= 0) && (weight > 0)){\n        //start of transaction\n        transaction = Date.now();\n        msg.on = true;\n        flow.set('transaction',transaction);\n    }else if((prevWeight > 0) && (weight <=0)){\n        transaction = 0;\n        msg.on = false;\n        transactionData = [];\n        flow.set('transaction',transaction);\n        flow.set('transactionMaxWeight',null);\n        flow.set('transactionHasMaxWeight',null);\n        flow.set('transactionHasMaxDuration',null);\n        flow.set('transactionWaybill',null);\n        flow.set('transactionMetadata',null);\n    }else if((transaction === null) && (weight>0)){\n        transaction = Date.now();\n        flow.set('transaction',transaction);\n    }\n}\n\nif (transaction > 0){\n    transactionData.push(weight);    \n\n    //stable\n    if(transactionData.length > stableSize+1){\n        var stabletmp = true;\n        for (var i = transactionData.length-1; i > transactionData.length-1-stableSize; i--){\n            if (transactionData[i] !== transactionData[i-1]){\n                stabletmp = false;\n                msg.stable = stabletmp;\n                break;\n            }\n            msg.stable = stabletmp;\n        }\n    }else{\n        msg.stable = false;\n    }\n\n    //duration & transactionMaxWeight\n    duration = (Number(Date.now()) - Number(transaction));\n    if( (weight>transactionMaxWeight) || (transactionMaxWeight === null)){\n        transactionMaxWeight = weight;\n        flow.set(\"transactionMaxWeight\",transactionMaxWeight);\n    }\n    \n    if(!transactionHasMaxWeight && weight > maxWeight){\n        msg.transactionHasMaxWeight = true;\n        flow.set('transactionHasMaxWeight',true);\n    }\n    \n    //max duartion\n    if(!transactionHasMaxDuration && duration > maxDuration){\n        msg.transactionHasMaxDuration = true;\n        flow.set('transactionHasMaxDuration',true);\n    }\n}\n\n//result\nmsg.metadata = {\n    'weight':weight,\n    'prevWeight':prevWeight,\n    'transaction':transaction,\n    'on':msg.on,\n    'transactionDataCount':transactionData.length,\n    'stable':msg.stable,\n    'duration':duration,\n    'transactionMaxWeight':transactionMaxWeight,\n    'waybill':waybill\n}\nflow.set('transactionData',transactionData);\nflow.set('prevWeight',weight);\nflow.set('transactionMetadata',msg.metadata);\nflow.set('lasttimedata', new Date());\nreturn msg;","outputs":1,"noerr":0,"x":210,"y":380,"wires":[["5d08f202.b377ec","95b83073.dc702","195e3ed4.316f41"]]},{"id":"33642030.253a3","type":"function","z":"3c9edf1e.a761e","name":"get weight from accounting system","func":"var transactionMetada = flow.get('transactionMetadata');\nvar buisness_data = msg.req.query;\nmsg.metadata = Object.assign(transactionMetada,buisness_data);\nmsg.event_id = flow.get('event_get_weight_acc');\nflow.set('transactionWaybill','0103-12002');\nmsg.description = 'Зважили в 1С. Поточна вага: ' + msg.metadata.weight+\" Номер авто: \"+buisness_data.truck_id+\" \"+buisness_data.truck2_id;\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":600,"wires":[["2e02d295.0a6dde"]]},{"id":"6f64bc46.f02424","type":"link in","z":"3c9edf1e.a761e","name":"1c data","links":["5be7034d.fee01c"],"x":35,"y":600,"wires":[["33642030.253a3"]]},{"id":"5d08f202.b377ec","type":"switch","z":"3c9edf1e.a761e","name":"switch move","property":"on","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":390,"y":360,"wires":[["29656f04.de853"],["c71283fe.4d2a2","f7a2003d.10174"]]},{"id":"80c257.48350da8","type":"http request","z":"3c9edf1e.a761e","name":"EVENTS","method":"POST","ret":"txt","url":"","tls":"","x":1140,"y":440,"wires":[[]]},{"id":"2e02d295.0a6dde","type":"function","z":"3c9edf1e.a761e","name":"events payload","func":"var event_id = msg.event_id;\nmsg.payload = {\n    'event':{\n        'id':msg.event_id\n    },\n    'data':msg.metadata,\n    'description':msg.description\n}\n\nmsg.headers = {\n    \"content-type\":\"application/json\"\n}\n\nmsg.url = flow.get('main_host')+flow.get('event_url');\nmsg.main_host = flow.get('main_host');\nmsg.event_url = flow.get('event_url');\n\nreturn msg;","outputs":1,"noerr":0,"x":980,"y":440,"wires":[["80c257.48350da8"]]},{"id":"29656f04.de853","type":"function","z":"3c9edf1e.a761e","name":"move in","func":"msg.event_id = flow.get('event_move_in_id');\nmsg.description = 'Заїзд на ваги. Поточна вага: ' + msg.metadata.weight;\n\nreturn msg;","outputs":1,"noerr":0,"x":580,"y":320,"wires":[["2e02d295.0a6dde"]]},{"id":"95b83073.dc702","type":"switch","z":"3c9edf1e.a761e","name":"switch max weight","property":"transactionHasMaxWeight","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":390,"y":400,"wires":[["907296c.ab49768"]]},{"id":"907296c.ab49768","type":"function","z":"3c9edf1e.a761e","name":"transactionHasMaxWeight","func":"msg.event_id = flow.get('event_max_weight_id');\nmsg.description = 'Перевищена максимально-допустима вага: ' + msg.metadata.weight;\n\nreturn msg;","outputs":1,"noerr":0,"x":630,"y":400,"wires":[["2e02d295.0a6dde"]]},{"id":"2d842be1.0d2394","type":"inject","z":"3c9edf1e.a761e","name":"","topic":"","payload":"","payloadType":"date","repeat":"1","crontab":"","once":false,"x":90,"y":520,"wires":[["56e7932b.3139dc"]]},{"id":"56e7932b.3139dc","type":"function","z":"3c9edf1e.a761e","name":"check scale health","func":"var lastcheckHealth = flow.get('checkHealth');\nvar checkHealth = null;\nvar lasttimedata = flow.get('lasttimedata');\n\nvar currenttimedata = new Date();\n\nif ((currenttimedata - lasttimedata) > 3000){\n    checkHealth = false;\n} else {\n    checkHealth = true;\n}\n\nflow.set(\"checkHealth\",checkHealth);\n\nif (lastcheckHealth != checkHealth){\n    msg.checkHealth = checkHealth;\n}else{\n    msg.checkHealth = null;\n}\nmsg.payload = checkHealth;\n\nreturn msg;","outputs":1,"noerr":0,"x":290,"y":520,"wires":[["df805552.c8c2e8","fc8e98d8.c08298"]]},{"id":"df805552.c8c2e8","type":"switch","z":"3c9edf1e.a761e","name":"","property":"checkHealth","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":450,"y":480,"wires":[["16350e0a.7eaa82"],["cd7f3dde.95347"]]},{"id":"cd7f3dde.95347","type":"function","z":"3c9edf1e.a761e","name":"off","func":"msg.event_id = flow.get('event_off_id');\nmsg.description = 'Прилад відключено';\nmsg.metadata = {\n    'state':msg.checkHealth\n}\nreturn msg;","outputs":1,"noerr":0,"x":570,"y":520,"wires":[["2e02d295.0a6dde"]]},{"id":"16350e0a.7eaa82","type":"function","z":"3c9edf1e.a761e","name":"on","func":"msg.event_id = flow.get('event_on_id');\nmsg.description = 'Прилад підключено';\nmsg.metadata = {\n    'state':msg.checkHealth\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":570,"y":480,"wires":[["2e02d295.0a6dde"]]},{"id":"815a8aef.64fce8","type":"function","z":"3c9edf1e.a761e","name":"main config","func":"flow.set('prevWeight',null);\nflow.set('transaction',null);\nflow.set('transactionData',[]);\nflow.set('transactionMaxWeight',null);\nflow.set('transactionHasMaxWeight',null);\nflow.set('transactionHasMaxDuration',null);\nflow.set('lasttimedata', new Date());\nflow.set('checkHealth',null);\nflow.set('transactionWaybill',null);\n\nreturn msg;\n","outputs":1,"noerr":0,"x":370,"y":240,"wires":[[]]},{"id":"79185831.4353f8","type":"inject","z":"3c9edf1e.a761e","name":"","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":true,"x":90,"y":220,"wires":[["2fa99451.c04a9c","815a8aef.64fce8"]]},{"id":"e9c80023.2b958","type":"http request","z":"3c9edf1e.a761e","name":"STATE","method":"POST","ret":"txt","url":"","tls":"","x":1130,"y":580,"wires":[[]]},{"id":"fc8e98d8.c08298","type":"function","z":"3c9edf1e.a761e","name":"device state","func":"msg.payload = {\n    \"state\":msg.payload\n}\nmsg.headers = {\n    \"content-type\":\"application/json\"\n}\nmsg.url = flow.get('main_host')+flow.get('state_url')+\"?id=\"+flow.get(\"scale_id\");\nreturn msg;","outputs":1,"noerr":0,"x":990,"y":580,"wires":[["e9c80023.2b958"]]},{"id":"fd5e85db.baff28","type":"function","z":"2c7328f4.660f48","name":"Модель весов","func":"flow.set('inputString',\"CMD\");\nflow.set('parser',function(v){\n       v = v;\n       return Number(v);\n    }\n  );\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":80,"wires":[[]]},{"id":"5476bf9.a8cd04","type":"http request","z":"2c7328f4.660f48","name":"APEX","method":"POST","ret":"txt","url":"https://prod.apex.rest/ords/ettn/v1/events","tls":"","x":1590,"y":80,"wires":[["19adfb.8c43c205"]]},{"id":"e9d3886a.9c88b8","type":"function","z":"2c7328f4.660f48","name":"","func":"msg.payload = \n{\"event_id\":msg.event_id,\n\"camera_name\":flow.get('config').camera_front_name,\n'snapshot': Buffer.from(msg.payload).toString('base64'),\n'ext':'jpeg'\n};\n\nmsg.headers = {\n    \"content-type\":\"application/json\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":1492.6667098999023,"y":378.00000953674316,"wires":[["d58c89cb.3be818"]]},{"id":"d58c89cb.3be818","type":"http request","z":"2c7328f4.660f48","name":"APEX","method":"POST","ret":"txt","url":"https://prod.apex.rest/ords/ettn/v1/events/snapshot","tls":"","x":1626.6667137145996,"y":378.00000762939453,"wires":[[]]},{"id":"19adfb.8c43c205","type":"debug","z":"2c7328f4.660f48","name":"","active":false,"console":"false","complete":"statusCode ","x":1760,"y":80,"wires":[]},{"id":"bffdb6ff.1a3148","type":"debug","z":"2c7328f4.660f48","name":"","active":false,"console":"false","complete":"true","x":1500,"y":320,"wires":[]},{"id":"cfd8a595.e7c0e8","type":"http request","z":"2c7328f4.660f48","name":"nifi","method":"POST","ret":"txt","url":"http://134.209.249.184:5000","tls":"","x":1590,"y":140,"wires":[["c6b09630.605868"]]},{"id":"c6b09630.605868","type":"debug","z":"2c7328f4.660f48","name":"","active":false,"console":"false","complete":"false","x":1770,"y":140,"wires":[]},{"id":"d94765a0.855d98","type":"http request","z":"2c7328f4.660f48","name":"SKELYA","method":"POST","ret":"txt","url":"https://prod.apex.rest/ords/ettn/v1/events/log","tls":"","x":1600,"y":180,"wires":[["c7a9ad9b.32904"]]},{"id":"c7a9ad9b.32904","type":"debug","z":"2c7328f4.660f48","name":"","active":true,"console":"false","complete":"false","x":1770,"y":180,"wires":[]},{"id":"140b521e.29901e","type":"function","z":"3c9edf1e.a761e","name":"device config","func":"var device_config = JSON.parse(msg.payload);\n\nflow.set('scale_id',device_config.scale_id);\nflow.set('event_move_in_id',device_config.event_move_in_id);\nflow.set('event_move_out_id',device_config.event_move_out_id);\nflow.set('event_max_weight_id',device_config.event_max_weight_id);\nflow.set('event_off_id',device_config.event_off_id);\nflow.set('event_on_id', device_config.event_on_id);\nflow.set('event_max_duration',device_config.event_max_duration);\nflow.set('event_fake_traffic',device_config.event_fake_traffic);\nflow.set('main_host',device_config.main_host);\nflow.set('event_url',device_config.event_url);\nflow.set('state_url',device_config.state_url);\nflow.set('maxWeight',device_config.maxWeight);\nflow.set('maxDuration',device_config.maxDuration);\nflow.set('checkHealthTimeout',device_config.checkHealthTimeout);\nflow.set('event_get_weight_acc',device_config.event_get_weight_acc);\n\n\n// flow.set('scale_id','80096CB0EFD83B63E0533300000A4334');\n// flow.set('event_move_in_id','80096D9ABE7F68F3E0533300000A6C0D');\n// flow.set('event_move_out_id','80096D9ABE8068F3E0533300000A6C0D');\n// flow.set('event_max_weight_id','85A255F950F9BEF4E0533300000AC45D');\n// flow.set('event_off_id','85A2CC4570292DD1E0533300000A0C94');\n// flow.set('event_on_id', '85A2CC45702A2DD1E0533300000A0C94');\n// flow.set('event_max_duration','8642EE858DE89BAAE0533300000AFCC7');\n// flow.set('main_host','http://prod.apex.rest/ords/ettn');\n// flow.set('event_url','/iot_cli/events/log');\n// flow.set('state_url','/v1/device');\n// flow.set('maxWeight',40000);\n// flow.set('maxDuration',20000);\n// flow.set('checkHealthTimeout',3000);\n\nreturn msg;\n","outputs":1,"noerr":0,"x":570,"y":200,"wires":[[]]},{"id":"c71283fe.4d2a2","type":"function","z":"3c9edf1e.a761e","name":"move out","func":"msg.event_id = flow.get('event_move_out_id');\nmsg.description = 'Зїзд з ваг. Поточна вага: ' + msg.metadata.weight;\n\nreturn msg;","outputs":1,"noerr":0,"x":580,"y":360,"wires":[["2e02d295.0a6dde"]]},{"id":"195e3ed4.316f41","type":"switch","z":"3c9edf1e.a761e","name":"max duration","property":"transactionHasMaxDuration","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":370,"y":440,"wires":[["c8b0f8f0.358248"]]},{"id":"c8b0f8f0.358248","type":"function","z":"3c9edf1e.a761e","name":"transaction has max duration","func":"msg.event_id = flow.get('event_max_duration');\nmsg.description = 'Перевищено максимальний час находження на вагах: ' + msg.metadata.duration/1000;\n\nreturn msg;","outputs":1,"noerr":0,"x":640,"y":440,"wires":[["2e02d295.0a6dde"]]},{"id":"f7b9aeeb.8508b","type":"http in","z":"3c9edf1e.a761e","name":"","url":"/firmware","method":"post","swaggerDoc":"","x":140,"y":160,"wires":[["1d58f342.62cc6d"]]},{"id":"1d58f342.62cc6d","type":"file","z":"3c9edf1e.a761e","name":"deivce_config","filename":"deivce_config.json","appendNewline":true,"createDir":false,"overwriteFile":"true","x":380,"y":160,"wires":[]},{"id":"2fa99451.c04a9c","type":"file in","z":"3c9edf1e.a761e","name":"deivce_config","filename":"deivce_config.json","format":"utf8","x":380,"y":200,"wires":[["140b521e.29901e"]]},{"id":"8edc94a.6b5bf68","type":"http in","z":"3c9edf1e.a761e","name":"","url":"/serial","method":"get","swaggerDoc":"","x":120,"y":40,"wires":[["c80cf277.cab5f"]]},{"id":"c80cf277.cab5f","type":"exec","z":"3c9edf1e.a761e","command":"cat /proc/cpuinfo","addpay":true,"append":"| grep Serial","useSpawn":"","timer":"5","name":"","x":350,"y":40,"wires":[["dd407874.79fe88","d4c170d6.6c7a9"],[],[]]},{"id":"dd407874.79fe88","type":"http response","z":"3c9edf1e.a761e","name":"","x":550,"y":20,"wires":[]},{"id":"d4c170d6.6c7a9","type":"function","z":"3c9edf1e.a761e","name":"","func":"msg.payload = msg.payload.split(':')[1].replace('\\n','').replace(' ','');\nreturn msg;","outputs":1,"noerr":0,"x":540,"y":100,"wires":[["432db3b5.e5cc4c"]]},{"id":"432db3b5.e5cc4c","type":"debug","z":"3c9edf1e.a761e","name":"","active":false,"console":"false","complete":"false","x":680,"y":100,"wires":[]},{"id":"b747f211.38543","type":"inject","z":"3c9edf1e.a761e","name":"DEMO","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":true,"x":90,"y":120,"wires":[["382c00d0.d8771"]]},{"id":"382c00d0.d8771","type":"function","z":"3c9edf1e.a761e","name":"DEMO Data","func":"var device_config = {\n    'scale_id':'80096CB0EFD83B63E0533300000A4334',\n    'event_move_in_id':'80096D9ABE7F68F3E0533300000A6C0D',\n    'event_move_out_id':'80096D9ABE8068F3E0533300000A6C0D',\n    'event_max_weight_id':'85A255F950F9BEF4E0533300000AC45D',\n    'event_off_id':'85A2CC4570292DD1E0533300000A0C94',\n    'event_max_duration':'8642EE858DE89BAAE0533300000AFCC7',\n    'event_fake_traffic':'80096EF60C186574E0533300000ADBA5',\n    'event_get_weight_acc':'800970AC1FDC683CE0533300000AF1B0',\n    'main_host':'http://prod.apex.rest/ords/ettn',\n    'event_url':'/iot_cli/events/log',\n    'state_url':'/v1/device',\n    'maxWeight':40000,\n    'maxDuration':20000,\n    'checkHealthTimeout':3000\n}\nmsg.payload = device_config;\n// flow.set('scale_id','80096CB0EFD83B63E0533300000A4334');\n// flow.set('event_move_in_id','80096D9ABE7F68F3E0533300000A6C0D');\n// flow.set('event_move_out_id','80096D9ABE8068F3E0533300000A6C0D');\n// flow.set('event_max_weight_id','85A255F950F9BEF4E0533300000AC45D');\n// flow.set('event_off_id','85A2CC4570292DD1E0533300000A0C94');\n// flow.set('event_on_id', '85A2CC45702A2DD1E0533300000A0C94');\n// flow.set('event_max_duration','8642EE858DE89BAAE0533300000AFCC7');\n// flow.set('main_host','http://prod.apex.rest/ords/ettn');\n// flow.set('event_url','/iot_cli/events/log');\n// flow.set('state_url','/v1/device');\n// flow.set('maxWeight',40000);\n// flow.set('maxDuration',20000);\n// flow.set('checkHealthTimeout',3000);\nreturn msg;","outputs":1,"noerr":0,"x":260,"y":120,"wires":[["1d58f342.62cc6d"]]},{"id":"b522170b.b92838","type":"debug","z":"3c9edf1e.a761e","name":"","active":false,"console":"false","complete":"false","x":100,"y":320,"wires":[]},{"id":"f955e532.326348","type":"link out","z":"2c7328f4.660f48","name":"","links":["bc99aa30.d18988"],"x":235,"y":280,"wires":[]},{"id":"f7a2003d.10174","type":"switch","z":"3c9edf1e.a761e","name":"waybill","property":"metadata.waybill","propertyType":"msg","rules":[{"t":"null"}],"checkall":"true","outputs":1,"x":580,"y":280,"wires":[["83d4471f.f5a2d8"]]},{"id":"83d4471f.f5a2d8","type":"function","z":"3c9edf1e.a761e","name":"move in","func":"msg.event_id = flow.get('event_fake_traffic');\nmsg.description = 'Холостий проїзд по вагам. Транзакція' + msg.metadata.transaction;\n\nreturn msg;","outputs":1,"noerr":0,"x":720,"y":280,"wires":[["2e02d295.0a6dde","1132b86f.9f88c8"]]},{"id":"1132b86f.9f88c8","type":"debug","z":"3c9edf1e.a761e","name":"","active":false,"console":"false","complete":"false","x":840,"y":200,"wires":[]},{"id":"9ab23f30.d4b4","type":"http in","z":"3c9edf1e.a761e","name":"","url":"/getWeight","method":"get","swaggerDoc":"","x":140,"y":680,"wires":[["33642030.253a3","9c8bb626.4e1dd8"]]},{"id":"10ea7db7.2ca9a2","type":"http response","z":"3c9edf1e.a761e","name":"","x":550,"y":680,"wires":[]},{"id":"9c8bb626.4e1dd8","type":"function","z":"3c9edf1e.a761e","name":"response","func":"\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":680,"wires":[["10ea7db7.2ca9a2"]]}]
