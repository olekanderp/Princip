[{"id":"2c7328f4.660f48","type":"tab","label":"scale 1"},{"id":"3c9edf1e.a761e","type":"tab","label":"processing"},{"id":"ff5c1dc9.ace25","type":"tab","label":"Dashboard"},{"id":"c201b2e9.698bf","type":"tab","label":"Telegram informer"},{"id":"20659f5c.eccf","type":"subflow","name":"ETTN","info":"","in":[],"out":[]},{"id":"105ecd06.7cad53","type":"subflow","name":"Subflow 1","info":"","in":[],"out":[]},{"id":"a2c1314d.9e6a1","type":"ui_tab","z":"","name":"Smart Scales","icon":"dashboard"},{"id":"baeca9a3.599088","type":"ui_base","name":"Scale dasboard","theme":"theme-light"},{"id":"aaaae18.356742","type":"serial-port","z":"","serialport":"/dev/teleinfo","serialbaud":"9600","databits":"8","parity":"none","stopbits":"1","newline":"\\n","bin":"false","out":"char","addchar":false},{"id":"31c7fe97.346882","type":"ui_group","z":"","name":"Scale and identity","tab":"a2c1314d.9e6a1","order":5,"disp":true,"width":"6"},{"id":"81dd6331.a859b","type":"ui_group","z":"","name":"Additional properties","tab":"a2c1314d.9e6a1","disp":true,"width":"6"},{"id":"193741be.32290e","type":"telegram bot","z":"","botname":"Smart scales bot","usernames":"","chatids":"","baseapiurl":"","updatemode":"polling","pollinterval":"300","usesocks":false,"sockshost":"","socksport":"6667","socksusername":"anonymous","sockspassword":"","bothost":"","localbotport":"8443","publicbotport":"8443","privatekey":"","certificate":"","useselfsignedcertificate":false,"verboselogging":true},{"id":"c0784bc0.e06748","type":"telegram bot","z":"","botname":"HeinzBot","usernames":"Windhose","chatids":"","baseapiurl":"","updatemode":"polling","pollinterval":"300","usesocks":false,"sockshost":"","socksport":"6667","socksusername":"anonymous","sockspassword":"","bothost":"","localbotport":"8443","publicbotport":"8443","privatekey":"","certificate":"","useselfsignedcertificate":false,"verboselogging":false},{"id":"e342ada6.d1b4f","type":"inject","z":"2c7328f4.660f48","name":"","topic":"","payload":"inputString","payloadType":"flow","repeat":"1","crontab":"","once":false,"x":120,"y":180,"wires":[["9cd5ade8.1b7a3"]]},{"id":"9cd5ade8.1b7a3","type":"serial out","z":"2c7328f4.660f48","name":"support","serial":"aaaae18.356742","x":300,"y":180,"wires":[]},{"id":"d3f83d59.0a0da","type":"serial in","z":"2c7328f4.660f48","name":"","serial":"aaaae18.356742","x":110,"y":240,"wires":[["3f8012e2.1bcbde"]]},{"id":"3f8012e2.1bcbde","type":"function","z":"2c7328f4.660f48","name":"GET WEIGHT","func":"msg.payload = flow.get('parser')(msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":300,"y":240,"wires":[["f955e532.326348"]]},{"id":"d10535af.6179c8","type":"comment","z":"2c7328f4.660f48","name":"Device level","info":"","x":90,"y":140,"wires":[]},{"id":"28d47be3.0a5a64","type":"inject","z":"2c7328f4.660f48","name":"init","topic":"","payload":"init","payloadType":"str","repeat":"","crontab":"","once":true,"x":90,"y":80,"wires":[["fd5e85db.baff28"]]},{"id":"815eb197.0240f","type":"comment","z":"2c7328f4.660f48","name":"INITIALIZING","info":"","x":90,"y":20,"wires":[]},{"id":"bc99aa30.d18988","type":"link in","z":"3c9edf1e.a761e","name":"weight","links":["20edce7e.5b51e2","a952ade4.1021c","f955e532.326348"],"x":35,"y":380,"wires":[["2aebc76e.14ee98","b522170b.b92838"]]},{"id":"2aebc76e.14ee98","type":"function","z":"3c9edf1e.a761e","name":"main module","func":"var prevWeight = flow.get('prevWeight');\nvar transaction = flow.get('transaction');\nvar transactionData = flow.get('transactionData');\nvar transactionMaxWeight = flow.get('transactionMaxWeight');\nvar transactionHasMaxWeight = flow.get('transactionHasMaxWeight');\nvar transactionHasMaxDuration = flow.get('transactionHasMaxDuration');\nvar waybill = flow.get('transactionWaybill');\nvar weight = msg.payload;\nvar stableSize = 5;\nvar duration = 0;\nvar maxWeight = flow.get('maxWeight');\nvar maxDuration = flow.get('maxDuration');\nvar prevTransaction = transaction;\n//transaction\nif (prevWeight === null){\n    prevWeight = msg.payload;    \n}else{\n    if((prevWeight <= 0) && (weight > 0)){\n        //start of transaction\n        transaction = Date.now();\n        msg.on = true;\n        flow.set('transaction',transaction);\n    }else if((prevWeight > 0) && (weight <=0)){\n        transaction = 0;\n        msg.on = false;\n        transactionData = [];\n        flow.set('transaction',transaction);\n        flow.set('transactionMaxWeight',null);\n        flow.set('transactionHasMaxWeight',null);\n        flow.set('transactionHasMaxDuration',null);\n        flow.set('transactionWaybill',null);\n        flow.set('transactionMetadata',null);\n    }else if((transaction === null) && (weight>0)){\n        transaction = Date.now();\n        flow.set('transaction',transaction);\n    }\n}\n\nif (transaction > 0){\n    transactionData.push(weight);    \n\n    //stable\n    if(transactionData.length > stableSize+1){\n        var stabletmp = true;\n        for (var i = transactionData.length-1; i > transactionData.length-1-stableSize; i--){\n            if (transactionData[i] !== transactionData[i-1]){\n                stabletmp = false;\n                msg.stable = stabletmp;\n                break;\n            }\n            msg.stable = stabletmp;\n        }\n    }else{\n        msg.stable = false;\n    }\n\n    //duration & transactionMaxWeight\n    duration = (Number(Date.now()) - Number(transaction));\n    if( (weight>transactionMaxWeight) || (transactionMaxWeight === null)){\n        transactionMaxWeight = weight;\n        flow.set(\"transactionMaxWeight\",transactionMaxWeight);\n    }\n    \n    if(!transactionHasMaxWeight && weight > maxWeight){\n        msg.transactionHasMaxWeight = true;\n        flow.set('transactionHasMaxWeight',true);\n    }\n    \n    //max duartion\n    if(!transactionHasMaxDuration && duration > maxDuration){\n        msg.transactionHasMaxDuration = true;\n        flow.set('transactionHasMaxDuration',true);\n    }\n}\n\n//result\nmsg.metadata = {\n    'weight':weight,\n    'prevWeight':prevWeight,\n    'prevTransaction':prevTransaction,\n    'transaction':transaction,\n    'on':msg.on,\n    'transactionDataCount':transactionData.length,\n    'stable':msg.stable,\n    'duration':duration,\n    'transactionMaxWeight':transactionMaxWeight,\n    'waybill':waybill\n}\nflow.set('transactionData',transactionData);\nflow.set('prevWeight',weight);\nflow.set('transactionMetadata',msg.metadata);\nflow.set('lasttimedata', new Date());\nreturn msg;","outputs":1,"noerr":0,"x":210,"y":380,"wires":[["5d08f202.b377ec","95b83073.dc702","195e3ed4.316f41","d615a19c.98451"]]},{"id":"33642030.253a3","type":"function","z":"3c9edf1e.a761e","name":"get weight from accounting system","func":"var transactionMetada = flow.get('transactionMetadata');\nvar buisness_data = msg.req.query;\nmsg.metadata = Object.assign(transactionMetada,buisness_data);\nmsg.event_id = flow.get('event_get_weight_acc');\nflow.set('transactionWaybill','0103-12002');\nmsg.description = 'Зважили в 1С. Поточна вага: ' + msg.metadata.weight+\" Номер авто: \"+buisness_data.truck_id+\" \"+buisness_data.truck2_id;\nreturn msg;","outputs":1,"noerr":0,"x":450,"y":600,"wires":[["2e02d295.0a6dde"]]},{"id":"5d08f202.b377ec","type":"switch","z":"3c9edf1e.a761e","name":"switch move","property":"on","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":390,"y":360,"wires":[["29656f04.de853"],["c71283fe.4d2a2","f7a2003d.10174"]]},{"id":"80c257.48350da8","type":"http request","z":"3c9edf1e.a761e","name":"EVENTS","method":"POST","ret":"txt","url":"","tls":"","x":1140,"y":440,"wires":[[]]},{"id":"2e02d295.0a6dde","type":"function","z":"3c9edf1e.a761e","name":"events payload","func":"var event_id = msg.event_id;\nvar scale_id = flow.get('scale_id');\nmsg.payload = {\n    'event':{\n        'id':msg.event_id\n    },\n    'devices':[{'id':scale_id}],\n    'data':msg.metadata,\n    'description':msg.description\n}\n\nmsg.headers = {\n    \"content-type\":\"application/json\"\n}\n\nmsg.url = flow.get('main_host')+flow.get('event_url');\nmsg.main_host = flow.get('main_host');\nmsg.event_url = flow.get('event_url');\n\nreturn msg;","outputs":1,"noerr":0,"x":980,"y":440,"wires":[["80c257.48350da8","194ec441.d317cc"]]},{"id":"29656f04.de853","type":"function","z":"3c9edf1e.a761e","name":"move in","func":"msg.event_id = flow.get('event_move_in_id');\nmsg.description = 'Заїзд на ваги. Поточна вага: ' + msg.metadata.weight;\n\nreturn msg;","outputs":1,"noerr":0,"x":580,"y":320,"wires":[["2e02d295.0a6dde"]]},{"id":"95b83073.dc702","type":"switch","z":"3c9edf1e.a761e","name":"switch max weight","property":"transactionHasMaxWeight","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":390,"y":400,"wires":[["907296c.ab49768"]]},{"id":"907296c.ab49768","type":"function","z":"3c9edf1e.a761e","name":"transactionHasMaxWeight","func":"msg.event_id = flow.get('event_max_weight_id');\nmsg.description = 'Перевищена максимально-допустима вага: ' + msg.metadata.weight;\n\nreturn msg;","outputs":1,"noerr":0,"x":630,"y":400,"wires":[["2e02d295.0a6dde"]]},{"id":"2d842be1.0d2394","type":"inject","z":"3c9edf1e.a761e","name":"","topic":"","payload":"","payloadType":"date","repeat":"1","crontab":"","once":false,"x":90,"y":520,"wires":[["56e7932b.3139dc"]]},{"id":"56e7932b.3139dc","type":"function","z":"3c9edf1e.a761e","name":"check scale health","func":"var lastcheckHealth = flow.get('checkHealth');\nvar checkHealth = null;\nvar lasttimedata = flow.get('lasttimedata');\n\nvar currenttimedata = new Date();\n\nif ((currenttimedata - lasttimedata) > 3000){\n    checkHealth = false;\n} else {\n    checkHealth = true;\n}\n\nflow.set(\"checkHealth\",checkHealth);\n\nif (lastcheckHealth != checkHealth){\n    msg.checkHealth = checkHealth;\n}else{\n    msg.checkHealth = null;\n}\nmsg.payload = checkHealth;\n\nreturn msg;","outputs":1,"noerr":0,"x":290,"y":520,"wires":[["df805552.c8c2e8","fc8e98d8.c08298"]]},{"id":"df805552.c8c2e8","type":"switch","z":"3c9edf1e.a761e","name":"","property":"checkHealth","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":450,"y":480,"wires":[["16350e0a.7eaa82"],["cd7f3dde.95347"]]},{"id":"cd7f3dde.95347","type":"function","z":"3c9edf1e.a761e","name":"off","func":"msg.event_id = flow.get('event_off_id');\nmsg.description = 'Прилад відключено';\nmsg.metadata = {\n    'state':msg.checkHealth\n}\nreturn msg;","outputs":1,"noerr":0,"x":570,"y":520,"wires":[["2e02d295.0a6dde"]]},{"id":"16350e0a.7eaa82","type":"function","z":"3c9edf1e.a761e","name":"on","func":"msg.event_id = flow.get('event_on_id');\nmsg.description = 'Прилад підключено';\nmsg.metadata = {\n    'state':msg.checkHealth\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":570,"y":480,"wires":[["2e02d295.0a6dde"]]},{"id":"815a8aef.64fce8","type":"function","z":"3c9edf1e.a761e","name":"main config","func":"flow.set('prevWeight',null);\nflow.set('transaction',null);\nflow.set('transactionData',[]);\nflow.set('transactionMaxWeight',null);\nflow.set('transactionHasMaxWeight',null);\nflow.set('transactionHasMaxDuration',null);\nflow.set('lasttimedata', new Date());\nflow.set('checkHealth',null);\nflow.set('transactionWaybill',null);\n\nreturn msg;\n","outputs":1,"noerr":0,"x":370,"y":240,"wires":[[]]},{"id":"79185831.4353f8","type":"inject","z":"3c9edf1e.a761e","name":"","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":true,"x":90,"y":220,"wires":[["2fa99451.c04a9c","815a8aef.64fce8"]]},{"id":"e9c80023.2b958","type":"http request","z":"3c9edf1e.a761e","name":"STATE","method":"POST","ret":"txt","url":"","tls":"","x":1130,"y":580,"wires":[[]]},{"id":"fc8e98d8.c08298","type":"function","z":"3c9edf1e.a761e","name":"device state","func":"msg.payload = {\n    \"state\":msg.payload\n}\nmsg.headers = {\n    \"content-type\":\"application/json\"\n}\nmsg.url = flow.get('main_host')+flow.get('state_url')+\"?id=\"+flow.get(\"scale_id\");\nreturn msg;","outputs":1,"noerr":0,"x":990,"y":580,"wires":[["e9c80023.2b958"]]},{"id":"fd5e85db.baff28","type":"function","z":"2c7328f4.660f48","name":"Модель весов","func":"flow.set('inputString',\"CMD\");\nflow.set('parser',function(v){\n       v = v;\n       return Number(v);\n    }\n  );\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":80,"wires":[[]]},{"id":"140b521e.29901e","type":"function","z":"3c9edf1e.a761e","name":"device config","func":"var device_config = JSON.parse(msg.payload);\n\nflow.set('scale_id',device_config.scale_id);\nflow.set('event_move_in_id',device_config.event_move_in_id);\nflow.set('event_move_out_id',device_config.event_move_out_id);\nflow.set('event_max_weight_id',device_config.event_max_weight_id);\nflow.set('event_off_id',device_config.event_off_id);\nflow.set('event_on_id', device_config.event_on_id);\nflow.set('event_max_duration',device_config.event_max_duration);\nflow.set('event_fake_traffic',device_config.event_fake_traffic);\nflow.set('main_host',device_config.main_host);\nflow.set('event_url',device_config.event_url);\nflow.set('state_url',device_config.state_url);\nflow.set('maxWeight',device_config.maxWeight);\nflow.set('maxDuration',device_config.maxDuration);\nflow.set('checkHealthTimeout',device_config.checkHealthTimeout);\nflow.set('event_get_weight_acc',device_config.event_get_weight_acc);\n\n\n// flow.set('scale_id','80096CB0EFD83B63E0533300000A4334');\n// flow.set('event_move_in_id','80096D9ABE7F68F3E0533300000A6C0D');\n// flow.set('event_move_out_id','80096D9ABE8068F3E0533300000A6C0D');\n// flow.set('event_max_weight_id','85A255F950F9BEF4E0533300000AC45D');\n// flow.set('event_off_id','85A2CC4570292DD1E0533300000A0C94');\n// flow.set('event_on_id', '85A2CC45702A2DD1E0533300000A0C94');\n// flow.set('event_max_duration','8642EE858DE89BAAE0533300000AFCC7');\n// flow.set('main_host','http://prod.apex.rest/ords/ettn');\n// flow.set('event_url','/iot_cli/events/log');\n// flow.set('state_url','/v1/device');\n// flow.set('maxWeight',40000);\n// flow.set('maxDuration',20000);\n// flow.set('checkHealthTimeout',3000);\n\nreturn msg;\n","outputs":1,"noerr":0,"x":570,"y":200,"wires":[[]]},{"id":"c71283fe.4d2a2","type":"function","z":"3c9edf1e.a761e","name":"move out","func":"msg.event_id = flow.get('event_move_out_id');\nmsg.description = 'Зїзд з ваг. Поточна вага: ' + msg.metadata.weight;\n\nreturn msg;","outputs":1,"noerr":0,"x":580,"y":360,"wires":[["2e02d295.0a6dde"]]},{"id":"195e3ed4.316f41","type":"switch","z":"3c9edf1e.a761e","name":"max duration","property":"transactionHasMaxDuration","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":370,"y":440,"wires":[["c8b0f8f0.358248"]]},{"id":"c8b0f8f0.358248","type":"function","z":"3c9edf1e.a761e","name":"transaction has max duration","func":"msg.event_id = flow.get('event_max_duration');\nmsg.description = 'Перевищено максимальний час находження на вагах: ' + msg.metadata.duration/1000;\n\nreturn msg;","outputs":1,"noerr":0,"x":640,"y":440,"wires":[["2e02d295.0a6dde"]]},{"id":"f7b9aeeb.8508b","type":"http in","z":"3c9edf1e.a761e","name":"","url":"/firmware","method":"post","swaggerDoc":"","x":140,"y":160,"wires":[["1d58f342.62cc6d"]]},{"id":"1d58f342.62cc6d","type":"file","z":"3c9edf1e.a761e","name":"deivce_config","filename":"deivce_config.json","appendNewline":true,"createDir":false,"overwriteFile":"true","x":380,"y":160,"wires":[]},{"id":"2fa99451.c04a9c","type":"file in","z":"3c9edf1e.a761e","name":"deivce_config","filename":"deivce_config.json","format":"utf8","x":380,"y":200,"wires":[["140b521e.29901e"]]},{"id":"8edc94a.6b5bf68","type":"http in","z":"3c9edf1e.a761e","name":"","url":"/serial","method":"get","swaggerDoc":"","x":120,"y":40,"wires":[["c80cf277.cab5f"]]},{"id":"c80cf277.cab5f","type":"exec","z":"3c9edf1e.a761e","command":"cat /proc/cpuinfo","addpay":true,"append":"| grep Serial","useSpawn":"","timer":"5","name":"","x":350,"y":40,"wires":[["dd407874.79fe88","d4c170d6.6c7a9"],[],[]]},{"id":"dd407874.79fe88","type":"http response","z":"3c9edf1e.a761e","name":"","x":550,"y":20,"wires":[]},{"id":"d4c170d6.6c7a9","type":"function","z":"3c9edf1e.a761e","name":"","func":"msg.payload = msg.payload.split(':')[1].replace('\\n','').replace(' ','');\nreturn msg;","outputs":1,"noerr":0,"x":540,"y":100,"wires":[["432db3b5.e5cc4c"]]},{"id":"432db3b5.e5cc4c","type":"debug","z":"3c9edf1e.a761e","name":"","active":false,"console":"false","complete":"false","x":680,"y":100,"wires":[]},{"id":"b747f211.38543","type":"inject","z":"3c9edf1e.a761e","name":"DEMO","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":true,"x":90,"y":120,"wires":[["382c00d0.d8771"]]},{"id":"382c00d0.d8771","type":"function","z":"3c9edf1e.a761e","name":"DEMO Data","func":"var device_config = {\n    'scale_id':'80096CB0EFD83B63E0533300000A4334',\n    'event_move_in_id':'80096D9ABE7F68F3E0533300000A6C0D',\n    'event_move_out_id':'80096D9ABE8068F3E0533300000A6C0D',\n    'event_max_weight_id':'85A255F950F9BEF4E0533300000AC45D',\n    'event_off_id':'85A2CC4570292DD1E0533300000A0C94',\n    'event_max_duration':'8642EE858DE89BAAE0533300000AFCC7',\n    'event_fake_traffic':'80096EF60C186574E0533300000ADBA5',\n    'event_get_weight_acc':'800970AC1FDC683CE0533300000AF1B0',\n    'main_host':'http://prod.apex.rest/ords/ettn',\n    'event_url':'/iot_cli/events/log',\n    'state_url':'/v1/device',\n    'maxWeight':40000,\n    'maxDuration':20000,\n    'checkHealthTimeout':3000\n}\nmsg.payload = device_config;\n// flow.set('scale_id','80096CB0EFD83B63E0533300000A4334');\n// flow.set('event_move_in_id','80096D9ABE7F68F3E0533300000A6C0D');\n// flow.set('event_move_out_id','80096D9ABE8068F3E0533300000A6C0D');\n// flow.set('event_max_weight_id','85A255F950F9BEF4E0533300000AC45D');\n// flow.set('event_off_id','85A2CC4570292DD1E0533300000A0C94');\n// flow.set('event_on_id', '85A2CC45702A2DD1E0533300000A0C94');\n// flow.set('event_max_duration','8642EE858DE89BAAE0533300000AFCC7');\n// flow.set('main_host','http://prod.apex.rest/ords/ettn');\n// flow.set('event_url','/iot_cli/events/log');\n// flow.set('state_url','/v1/device');\n// flow.set('maxWeight',40000);\n// flow.set('maxDuration',20000);\n// flow.set('checkHealthTimeout',3000);\nreturn msg;","outputs":1,"noerr":0,"x":260,"y":120,"wires":[["1d58f342.62cc6d"]]},{"id":"b522170b.b92838","type":"debug","z":"3c9edf1e.a761e","name":"","active":false,"console":"false","complete":"false","x":100,"y":320,"wires":[]},{"id":"f955e532.326348","type":"link out","z":"2c7328f4.660f48","name":"","links":["bc99aa30.d18988"],"x":415,"y":240,"wires":[]},{"id":"f7a2003d.10174","type":"switch","z":"3c9edf1e.a761e","name":"waybill","property":"metadata.waybill","propertyType":"msg","rules":[{"t":"null"}],"checkall":"true","outputs":1,"x":580,"y":280,"wires":[["83d4471f.f5a2d8"]]},{"id":"83d4471f.f5a2d8","type":"function","z":"3c9edf1e.a761e","name":"move in","func":"msg.event_id = flow.get('event_fake_traffic');\nmsg.description = 'Холостий проїзд по вагам. Транзакція ' + msg.metadata.prevTransaction;\n\nreturn msg;","outputs":1,"noerr":0,"x":720,"y":280,"wires":[["2e02d295.0a6dde","1132b86f.9f88c8"]]},{"id":"1132b86f.9f88c8","type":"debug","z":"3c9edf1e.a761e","name":"","active":false,"console":"false","complete":"false","x":930,"y":280,"wires":[]},{"id":"9ab23f30.d4b4","type":"http in","z":"3c9edf1e.a761e","name":"","url":"/getWeight","method":"get","swaggerDoc":"","x":120,"y":600,"wires":[["33642030.253a3","9c8bb626.4e1dd8"]]},{"id":"10ea7db7.2ca9a2","type":"http response","z":"3c9edf1e.a761e","name":"","x":530,"y":660,"wires":[]},{"id":"9c8bb626.4e1dd8","type":"function","z":"3c9edf1e.a761e","name":"response","func":"msg.payload = flow.get('transactionMetadata');\nreturn msg;","outputs":1,"noerr":0,"x":360,"y":660,"wires":[["10ea7db7.2ca9a2","4fd41efd.1b047"]]},{"id":"4fd41efd.1b047","type":"debug","z":"3c9edf1e.a761e","name":"","active":true,"console":"false","complete":"false","x":550,"y":700,"wires":[]},{"id":"23ad0084.6b845","type":"link in","z":"ff5c1dc9.ace25","name":"dashboard","links":["d615a19c.98451"],"x":80,"y":100,"wires":[["6349cef5.e86e4","3e41f36b.968a9c","55fbbc9e.c413c4","1ce2c511.495bfb","4c77ae74.0fab1","8151f200.18e3f"]]},{"id":"d615a19c.98451","type":"link out","z":"3c9edf1e.a761e","name":"processing","links":["23ad0084.6b845"],"x":340,"y":300,"wires":[]},{"id":"6349cef5.e86e4","type":"ui_gauge","z":"ff5c1dc9.ace25","name":"","group":"31c7fe97.346882","order":0,"width":0,"height":0,"gtype":"gage","title":"Weight","label":"kg","format":"{{value}} kg","min":0,"max":"60000","colors":["#00b500","#e6e600","#ca3838"],"x":210,"y":20,"wires":[]},{"id":"3e41f36b.968a9c","type":"ui_chart","z":"ff5c1dc9.ace25","name":"","group":"31c7fe97.346882","order":0,"width":0,"height":0,"label":"History","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","ymin":"0","ymax":"60000","removeOlder":"10","removeOlderPoints":"","removeOlderUnit":"60","cutout":0,"x":210,"y":60,"wires":[[],[]]},{"id":"b92bc540.4eb878","type":"ui_gauge","z":"ff5c1dc9.ace25","name":"","group":"81dd6331.a859b","order":0,"width":0,"height":0,"gtype":"wave","title":"Time on scale","label":"units","format":"{{value}} seconds","min":0,"max":"30000","colors":["#00b500","#e6e600","#ca3838"],"x":350,"y":100,"wires":[]},{"id":"55fbbc9e.c413c4","type":"ui_text","z":"ff5c1dc9.ace25","group":"81dd6331.a859b","order":0,"width":0,"height":0,"name":"","label":"Stable","format":"{{msg.metadata.stable}}","layout":"row-spread","x":210,"y":140,"wires":[]},{"id":"1ce2c511.495bfb","type":"ui_text","z":"ff5c1dc9.ace25","group":"81dd6331.a859b","order":0,"width":0,"height":0,"name":"","label":"on / off truck on scale","format":"{{msg.metadata.on}}","layout":"row-spread","x":260,"y":180,"wires":[]},{"id":"4c77ae74.0fab1","type":"ui_text","z":"ff5c1dc9.ace25","group":"81dd6331.a859b","order":0,"width":0,"height":0,"name":"","label":"Max weight","format":"{{msg.metadata.transactionMaxWeight}}","layout":"row-spread","x":230,"y":220,"wires":[]},{"id":"8151f200.18e3f","type":"function","z":"ff5c1dc9.ace25","name":"duration","func":"msg.payload = msg.metadata.duration;\nreturn msg;","outputs":1,"noerr":0,"x":220,"y":100,"wires":[["b92bc540.4eb878"]]},{"id":"aa0be2e9.f4261","type":"telegram receiver","z":"c201b2e9.698bf","name":"","bot":"193741be.32290e","saveDataDir":"","x":100,"y":220,"wires":[["5ad6b411.f7a33c","cf7073f2.2c69e"],[]]},{"id":"5ad6b411.f7a33c","type":"function","z":"c201b2e9.698bf","name":"get text","func":"msg.text = msg.payload.content;\nmsg.chatId = msg.payload.chatId;\n\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":220,"wires":[["e7a7b675.0bf308","1f8c92e6.779c8d"]]},{"id":"99dbb116.15ba","type":"telegram sender","z":"c201b2e9.698bf","name":"","bot":"193741be.32290e","x":740,"y":200,"wires":[["d974d2fe.19523"]]},{"id":"b7fb5489.3fb7e8","type":"link in","z":"c201b2e9.698bf","name":"telegram","links":["194ec441.d317cc"],"x":15,"y":440,"wires":[["3dcb7363.1563dc"]]},{"id":"3dcb7363.1563dc","type":"function","z":"c201b2e9.698bf","name":"create payload","func":"var access_table = flow.get('access_table');\nmsg.payload = {\n    \"content\":msg.payload.description,\n    \"type\":\"message\",\n    \"chatId\":access_table.chatId\n}\nmsg.sendmsg = access_table.subscribe;\nreturn msg;","outputs":1,"noerr":0,"x":140,"y":440,"wires":[["1790eef5.a24221"]]},{"id":"d974d2fe.19523","type":"debug","z":"c201b2e9.698bf","name":"","active":false,"console":"false","complete":"false","x":950,"y":200,"wires":[]},{"id":"194ec441.d317cc","type":"link out","z":"3c9edf1e.a761e","name":"processing event","links":["b7fb5489.3fb7e8"],"x":1120,"y":340,"wires":[]},{"id":"e7a7b675.0bf308","type":"switch","z":"c201b2e9.698bf","name":"","property":"text","propertyType":"msg","rules":[{"t":"eq","v":"/start","vt":"str"},{"t":"eq","v":"Unsubscribe","vt":"str"},{"t":"eq","v":"Subscribe","vt":"str"}],"checkall":"true","outputs":3,"x":410,"y":320,"wires":[["191ceb86.e0dbf4"],["b8e71be2.0c7858","c71c9d7e.7816d"],["8bbc56de.170578"]]},{"id":"191ceb86.e0dbf4","type":"function","z":"c201b2e9.698bf","name":"send auth","func":"context.global.keyboard = { pending : true };\n\nmsg.payload = {\n    \"content\":'Select the action',\n    \"options\":{\n        \"reply_markup\":JSON.stringify({\n            \"keyboard\":[\n            [{\n                \"text\":'Authorization',\n                \"request_contact\":true\n                }]\n            ],\n        \"resize_keyboard\":true,\n        \"one_time_keyboard\":true\n        })\n    },\n    \"type\":\"message\",\n    \"chatId\":msg.chatId\n}\n    \nreturn msg;","outputs":1,"noerr":0,"x":560,"y":200,"wires":[["99dbb116.15ba"]]},{"id":"1f8c92e6.779c8d","type":"switch","z":"c201b2e9.698bf","name":"","property":"payload.type","propertyType":"msg","rules":[{"t":"eq","v":"contact","vt":"str"}],"checkall":"true","outputs":1,"x":410,"y":260,"wires":[["62534a0e.e497d4"]]},{"id":"1840e586.aa472a","type":"inject","z":"c201b2e9.698bf","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":80,"y":40,"wires":[["5c1463c0.a4586c"]]},{"id":"e81cf948.c17358","type":"file","z":"c201b2e9.698bf","name":"","filename":"telegram_auth","appendNewline":true,"createDir":false,"overwriteFile":"true","x":540,"y":40,"wires":[]},{"id":"5c1463c0.a4586c","type":"function","z":"c201b2e9.698bf","name":"set phone_numbers for auth","func":"msg.payload = ['+380971688870'];\nreturn msg;","outputs":1,"noerr":0,"x":300,"y":40,"wires":[["e81cf948.c17358"]]},{"id":"d571f435.ab4588","type":"inject","z":"c201b2e9.698bf","name":"","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":true,"x":70,"y":80,"wires":[["161a6147.c530af","836dea94.1243b8"]]},{"id":"161a6147.c530af","type":"file in","z":"c201b2e9.698bf","name":"","filename":"telegram_auth","format":"utf8","x":260,"y":80,"wires":[["41e5dede.c2d1e"]]},{"id":"41e5dede.c2d1e","type":"function","z":"c201b2e9.698bf","name":"parse to JSON","func":"var auth = JSON.parse(msg.payload);\nflow.set('auth',auth);\nmsg.payload = auth;\nreturn msg;","outputs":1,"noerr":0,"x":440,"y":80,"wires":[["5d533ceb.577964"]]},{"id":"62534a0e.e497d4","type":"function","z":"c201b2e9.698bf","name":"check auth","func":"var auth = flow.get('auth');\nvar phone_number = msg.payload.content.phone_number;\nvar auth_ok = false;\nfor (var i = 0; i < auth.length; i++){\n    if (auth[i] === phone_number){\n        auth_ok = true;\n        break;\n    }\n}\nmsg.auth_ok = auth_ok;\nmsg.phone_number = phone_number;\nmsg.chatId = msg.payload.chatId;\nreturn msg;","outputs":1,"noerr":0,"x":570,"y":260,"wires":[["b0b36a0.7499c98"]]},{"id":"b0b36a0.7499c98","type":"switch","z":"c201b2e9.698bf","name":"","property":"auth_ok","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":730,"y":260,"wires":[["c09d3100.a45ea"],["27d1fa92.c5d586"]]},{"id":"c09d3100.a45ea","type":"function","z":"c201b2e9.698bf","name":"send auth ok","func":"context.global.keyboard = { pending : true };\nmsg.payload = {\n    \"content\":'Your successful subscribe on events',\n    \"options\":{\n        \"reply_markup\":JSON.stringify({\n            \"keyboard\":[\n            [{\n                \"text\":'Unsubscribe'\n                }]\n            ],\n        \"resize_keyboard\":true,\n        \"one_time_keyboard\":true\n        })\n    },\n    \"type\":\"message\",\n    \"chatId\":msg.chatId\n}\nmsg.subscribe = true;\nreturn msg;","outputs":1,"noerr":0,"x":950,"y":260,"wires":[["99dbb116.15ba","27d523c9.4b21ac"]]},{"id":"27d1fa92.c5d586","type":"function","z":"c201b2e9.698bf","name":"send auth false","func":"context.global.keyboard = { pending : true };\nmsg.payload = {\n    \"content\":'Access denied. Please try more or contact the administrator',\n    \"options\":{\n        \"reply_markup\":JSON.stringify({\n            \"keyboard\":[\n            [{\n                \"text\":'Authorization',\n                \"request_contact\":true\n                }]\n            ],\n        \"resize_keyboard\":true,\n        \"one_time_keyboard\":true\n        })\n    },\n    \"type\":\"message\",\n    \"chatId\":msg.chatId\n}\n    \nreturn msg;","outputs":1,"noerr":0,"x":960,"y":320,"wires":[["99dbb116.15ba"]]},{"id":"b91b9ed8.bd7ed","type":"file","z":"c201b2e9.698bf","name":"","filename":"access_table","appendNewline":true,"createDir":false,"overwriteFile":"true","x":1110,"y":400,"wires":[]},{"id":"836dea94.1243b8","type":"file in","z":"c201b2e9.698bf","name":"","filename":"access_table","format":"utf8","x":250,"y":120,"wires":[["fdd094ed.625298"]]},{"id":"fdd094ed.625298","type":"function","z":"c201b2e9.698bf","name":"parse to JSON","func":"flow.set('access_table',JSON.parse(msg.payload));\nreturn msg;","outputs":1,"noerr":0,"x":440,"y":120,"wires":[["3be10023.68aea"]]},{"id":"5d533ceb.577964","type":"debug","z":"c201b2e9.698bf","name":"","active":true,"console":"false","complete":"false","x":610,"y":80,"wires":[]},{"id":"3be10023.68aea","type":"debug","z":"c201b2e9.698bf","name":"","active":true,"console":"false","complete":"false","x":610,"y":120,"wires":[]},{"id":"27d523c9.4b21ac","type":"function","z":"c201b2e9.698bf","name":"","func":"msg.payload = JSON.stringify({\n        'chatId':msg.payload.chatId,\n        'subscribe':msg.subscribe\n    }); \nreturn msg;","outputs":1,"noerr":0,"x":910,"y":380,"wires":[["b91b9ed8.bd7ed","57798dc.80a2b74","999d1ae6.d41058"]]},{"id":"b8e71be2.0c7858","type":"function","z":"c201b2e9.698bf","name":"","func":"msg.subscribe = false;\nreturn msg;","outputs":1,"noerr":0,"x":590,"y":380,"wires":[["27d523c9.4b21ac"]]},{"id":"57798dc.80a2b74","type":"delay","z":"c201b2e9.698bf","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1100,"y":360,"wires":[["836dea94.1243b8"]]},{"id":"1790eef5.a24221","type":"switch","z":"c201b2e9.698bf","name":"","property":"sendmsg","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":310,"y":440,"wires":[["99dbb116.15ba"]]},{"id":"999d1ae6.d41058","type":"debug","z":"c201b2e9.698bf","name":"","active":true,"console":"false","complete":"false","x":1110,"y":440,"wires":[]},{"id":"cf7073f2.2c69e","type":"debug","z":"c201b2e9.698bf","name":"","active":true,"console":"false","complete":"false","x":190,"y":380,"wires":[]},{"id":"8bbc56de.170578","type":"function","z":"c201b2e9.698bf","name":"check auth for subscribe","func":"var access_table = flow.get('access_table');\nif (msg.payload.chatId === access_table.chatId){\n    msg.auth_ok = true;    \n}else{\n    msg.auth_ok = false;\n}\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":480,"wires":[["c09d3100.a45ea"]]},{"id":"c71c9d7e.7816d","type":"function","z":"c201b2e9.698bf","name":"send subscribe","func":"context.global.keyboard = { pending : true };\nmsg.payload = {\n    \"content\":'You do not subscribe on any events. Please press Subscribe',\n    \"options\":{\n        \"reply_markup\":JSON.stringify({\n            \"keyboard\":[\n            [{\n                \"text\":'Subscribe'\n                }]\n            ],\n        \"resize_keyboard\":true,\n        \"one_time_keyboard\":true\n        })\n    },\n    \"type\":\"message\",\n    \"chatId\":msg.chatId\n}\nmsg.subscribe = true;\nreturn msg;","outputs":1,"noerr":0,"x":620,"y":340,"wires":[["99dbb116.15ba"]]}]
