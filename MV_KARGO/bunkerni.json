[{"id":"4361bc23.706984","type":"tab","label":"Flow 1"},{"id":"ed58abb5.459c08","type":"tab","label":"Flow 2"},{"id":"a629a5b6.1949b8","type":"serial-port","z":"","serialport":"/dev/ttyUSB0","serialbaud":"9600","databits":"8","parity":"none","stopbits":"1","newline":"\\n","bin":"false","out":"char","addchar":false},{"id":"abf3ef5e.0c973","type":"modbus-client","z":"","name":"","clienttype":"serial","bufferCommands":true,"stateLogEnabled":false,"tcpHost":"127.0.0.1","tcpPort":"502","tcpType":"DEFAULT","serialPort":"/dev/ttyUSB0","serialType":"RTU-BUFFERD","serialBaudrate":"9600","serialDatabits":"8","serialStopbits":"1","serialParity":"none","serialConnectionDelay":"100","unit_id":"1","commandDelay":"1","clientTimeout":"1000","reconnectTimeout":"2000"},{"id":"1dda3344.bdc2ed","type":"http in","z":"4361bc23.706984","name":"","url":"/getAllFile","method":"get","swaggerDoc":"","x":170,"y":620,"wires":[["c3c0cc63.40ff1"]]},{"id":"c3c0cc63.40ff1","type":"file in","z":"4361bc23.706984","name":"","filename":"/distr/data/portion.json","format":"utf8","x":420,"y":620,"wires":[["889d225f.c51f7"]]},{"id":"889d225f.c51f7","type":"http response","z":"4361bc23.706984","name":"","x":590,"y":620,"wires":[]},{"id":"4dcfa00d.7330c","type":"http in","z":"4361bc23.706984","name":"","url":"/removeFile","method":"get","swaggerDoc":"","x":180,"y":740,"wires":[["86a9b6ea.c0f758","d7996625.2564c8"]]},{"id":"7e54bbf8.1e8014","type":"http response","z":"4361bc23.706984","name":"","x":570,"y":740,"wires":[]},{"id":"86a9b6ea.c0f758","type":"file","z":"4361bc23.706984","name":"","filename":"/distr/data/portion.json","appendNewline":true,"createDir":false,"overwriteFile":"delete","x":480,"y":800,"wires":[]},{"id":"d7996625.2564c8","type":"function","z":"4361bc23.706984","name":"","func":"msg.payload = \"file remove\"\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":740,"wires":[["7e54bbf8.1e8014"]]},{"id":"282bcca9.76aba4","type":"http in","z":"4361bc23.706984","name":"","url":"/readLast/otves","method":"get","swaggerDoc":"","x":190,"y":680,"wires":[["befe6bbb.cb99d8"]]},{"id":"9576b4ac.ab3f28","type":"http response","z":"4361bc23.706984","name":"","x":570,"y":680,"wires":[]},{"id":"befe6bbb.cb99d8","type":"function","z":"4361bc23.706984","name":"","func":"msg.payload = flow.get('lastOtves');\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":680,"wires":[["9576b4ac.ab3f28"]]},{"id":"431f29d6.227508","type":"inject","z":"4361bc23.706984","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"x":110,"y":40,"wires":[["d96cfc99.8b838"]]},{"id":"d96cfc99.8b838","type":"function","z":"4361bc23.706984","name":"INIT","func":"flow.set('lastOtves', {}); // json  для файла\nflow.set('lastWeight', 0); // останный отвес \nflow.set(\"allWeight\", 0);  // сумарна вага\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":40,"wires":[[]]},{"id":"9560e8d0.ea2e48","type":"serial in","z":"4361bc23.706984","name":"","serial":"a629a5b6.1949b8","x":110,"y":120,"wires":[["b99ebc77.4c3f2","509331b.006d5d","6f23540d.2060bc"]]},{"id":"b99ebc77.4c3f2","type":"debug","z":"4361bc23.706984","name":"","active":true,"console":"false","complete":"false","x":310,"y":120,"wires":[]},{"id":"509331b.006d5d","type":"file","z":"4361bc23.706984","name":"","filename":"/distr/data/otvesu.json","appendNewline":true,"createDir":true,"overwriteFile":"false","x":340,"y":160,"wires":[]},{"id":"f5c536dc.73fcb8","type":"inject","z":"4361bc23.706984","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":100,"y":880,"wires":[["b0153c4a.7701a"]]},{"id":"b0153c4a.7701a","type":"file in","z":"4361bc23.706984","name":"","filename":"/distr/data/otvesu.json","format":"utf8","x":280,"y":880,"wires":[["2660f0c8.3b503"]]},{"id":"2660f0c8.3b503","type":"debug","z":"4361bc23.706984","name":"","active":true,"console":"false","complete":"false","x":490,"y":880,"wires":[]},{"id":"6401c592.2e863c","type":"debug","z":"4361bc23.706984","name":"","active":true,"console":"false","complete":"false","x":330,"y":220,"wires":[]},{"id":"6f23540d.2060bc","type":"function","z":"4361bc23.706984","name":"write to file","func":"var inStr = msg.payload;//16:14:15 GROSS  720  12110 kg\nvar NET =  inStr.indexOf('NET');\n\nif(NET >= 0) {\n\n    let arrayGross = inStr.split(' ');// для дати\n    \n    //let weight = Number(arrayGross[6]);\n    let weight = Number(inStr.substring(21, 38)); //вага\n    let count = Number(inStr.substring(14, 20)); //порцыъ \n    let allWeight = flow.get(\"allWeight\"); //сумування ваги\n    \n    allWeight += weight;\n    \n    let otves = {\n         name: \"NET WEIGHT\",\n         weight:weight,\n         count:count,\n         dateAll: flow.get(\"correctDate\"),\n         allWeight: allWeight\n    };\n    \n      \n    flow.set('lastWeight', weight); // остання вага\n    flow.set('count', otves.count); // остання порція\n    flow.set(\"allWeight\", allWeight); // вся вага просумована\n    flow.set(\"lastOtves\", otves);// весь отвес\n    \nmsg.payload = otves;\n// msg.payload = arrayGross\n \nreturn msg;    \n}\n\n // TOTAL WEIGHT     9734980 kg\nvar totalWeight =  inStr.indexOf('TOTAL');\nif(totalWeight >= 0){\n    let arrayTotal = inStr.split(' ');\n    let TotalWeight = Number(arrayTotal[6]);\n    let weight = flow.get('lastWeight');\n    let count = flow.get('count');\n    \n    let otves = {\n        name: 'TOTAL WEIGHT',\n        weight:weight,\n        count:count,\n        dateAll: flow.get(\"correctDate\"),\n        allWeight: TotalWeight,\n        allWeightSum:  flow.get(\"allWeight\")\n    };\n    \n    msg.payload = otves\n    flow.set(\"lastOtves\", otves);\n    \n    //обнулення коли завершився цикл\n    flow.set('lastWeight', 0); // остання вага\n    flow.set('count', 0); // остання порція\n    flow.set(\"allWeight\", 0); // вся вага просумована\n    \n    return msg;  \n}\n\n//TOTAL WEIGHT     9734980 kg\n","outputs":"1","noerr":0,"x":130,"y":240,"wires":[["6401c592.2e863c","2f9c6cd4.a5c374"]]},{"id":"d972d26f.09b8b","type":"debug","z":"4361bc23.706984","name":"","active":true,"console":"false","complete":"false","x":470,"y":380,"wires":[]},{"id":"72a2175e.b38498","type":"function","z":"4361bc23.706984","name":"time","func":"var d = new Date();\n\nvar utc = d.getTime() + (d.getTimezoneOffset() * 60000);\n\nvar offset = 3; // This is the offset for UTC+3, in your case (UTC+1) should be 1\n\nnewDate = new Date(utc + (3600000*offset));\n\nmsg.payload = newDate;\n//msg.payload = newDate.toLocaleString();\n\nflow.set('correctDate', newDate);\n\nreturn msg;\n","outputs":1,"noerr":0,"x":590,"y":40,"wires":[["97093316.14ec"]]},{"id":"c531bd1c.a75a4","type":"inject","z":"4361bc23.706984","name":"","topic":"","payload":"","payloadType":"date","repeat":"1","crontab":"","once":false,"x":450,"y":40,"wires":[["72a2175e.b38498"]]},{"id":"97093316.14ec","type":"debug","z":"4361bc23.706984","name":"","active":false,"console":"false","complete":"false","x":730,"y":40,"wires":[]},{"id":"2f9c6cd4.a5c374","type":"file","z":"4361bc23.706984","name":"","filename":"/distr/data/portion.json","appendNewline":true,"createDir":true,"overwriteFile":"false","x":360,"y":260,"wires":[]},{"id":"4cd25f24.c5ea5","type":"inject","z":"4361bc23.706984","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":100,"y":920,"wires":[["71e04d6b.96a2d4"]]},{"id":"71e04d6b.96a2d4","type":"file in","z":"4361bc23.706984","name":"","filename":"/distr/data/portion.json","format":"utf8","x":280,"y":920,"wires":[["25c06832.bf0988"]]},{"id":"25c06832.bf0988","type":"debug","z":"4361bc23.706984","name":"","active":true,"console":"false","complete":"false","x":490,"y":920,"wires":[]},{"id":"86f03fe8.1058","type":"http in","z":"4361bc23.706984","name":"","url":"/getAllFile2","method":"get","swaggerDoc":"","x":180,"y":560,"wires":[["382d2d42.70bb82"]]},{"id":"382d2d42.70bb82","type":"file in","z":"4361bc23.706984","name":"","filename":"/distr/data/otvesu.json","format":"utf8","x":420,"y":560,"wires":[["13b3f280.826afe"]]},{"id":"13b3f280.826afe","type":"http response","z":"4361bc23.706984","name":"","x":590,"y":560,"wires":[]},{"id":"67062915.d0e518","type":"inject","z":"4361bc23.706984","name":"TOTAL ","topic":"","payload":"TOTAL WEIGHT     9734980 kg","payloadType":"str","repeat":"","crontab":"","once":false,"x":110,"y":380,"wires":[[]]},{"id":"4a5a561c.cfe718","type":"inject","z":"4361bc23.706984","name":"NET WEIGHT 3","topic":"","payload":"NET WEIGHT      121            12970 kg","payloadType":"str","repeat":"","crontab":"","once":false,"x":140,"y":420,"wires":[["943244e.fb5dfb8"]]},{"id":"3e7aad10.dd3d62","type":"inject","z":"4361bc23.706984","name":"NET WEIGHT ","topic":"","payload":"NET WEIGHT        1            12150 kg","payloadType":"str","repeat":"","crontab":"","once":false,"x":130,"y":460,"wires":[["943244e.fb5dfb8"]]},{"id":"161fbd16.3d8cf3","type":"comment","z":"4361bc23.706984","name":"18:08:12 GROSS   15  12175 kg","info":"NET WEIGHT       93            12075 \nNET WEIGHT        1            12150 kg\nNET WEIGHT       88            12035 kg\nNET WEIGHT      121            12970 kg","x":610,"y":460,"wires":[]},{"id":"95309dd2.b155c","type":"inject","z":"4361bc23.706984","name":"NET WEIGHT 2","topic":"","payload":"NET WEIGHT       88            12035 kg","payloadType":"str","repeat":"","crontab":"","once":false,"x":140,"y":500,"wires":[["943244e.fb5dfb8"]]},{"id":"943244e.fb5dfb8","type":"function","z":"4361bc23.706984","name":"test","func":"var inStr = msg.payload;//16:14:15 GROSS  720  12110 kg\nvar NET =  inStr.indexOf('NET');\n\nif(NET >= 0) {\n\n    let arrayGross = inStr.split(' ');// для дати\n    \n    //let weight = Number(arrayGross[6]);\n    let weight = Number(inStr.substring(22, 37)); //вага\n    \n    let count = Number(inStr.substring(14, 20)); //порцыъ \n\n    let otves = {\n         weight:weight,\n         count:count,\n         dateAll: flow.get(\"correctDate\"),\n    };\n    \n      \n\n    \nmsg.payload = otves;\n// msg.payload = arrayGross\n \nreturn msg;    \n}\n","outputs":"1","noerr":0,"x":310,"y":400,"wires":[["d972d26f.09b8b"]]},{"id":"83ac0016.de245","type":"inject","z":"4361bc23.706984","name":"","topic":"","payload":"lastOtves","payloadType":"flow","repeat":"","crontab":"","once":false,"x":650,"y":140,"wires":[["c6e4add1.974e7"]]},{"id":"c6e4add1.974e7","type":"debug","z":"4361bc23.706984","name":"","active":true,"console":"false","complete":"false","x":900,"y":140,"wires":[]},{"id":"30745761.67a3f8","type":"inject","z":"4361bc23.706984","name":"","topic":"","payload":"lastWeight","payloadType":"flow","repeat":"","crontab":"","once":false,"x":660,"y":180,"wires":[["c6e4add1.974e7"]]},{"id":"52b4e807.7ab2e8","type":"inject","z":"4361bc23.706984","name":"","topic":"","payload":"allWeight","payloadType":"flow","repeat":"","crontab":"","once":false,"x":650,"y":220,"wires":[["c6e4add1.974e7"]]},{"id":"887a8448.409f18","type":"inject","z":"4361bc23.706984","name":"","topic":"","payload":"correctDate","payloadType":"flow","repeat":"","crontab":"","once":false,"x":660,"y":260,"wires":[["c6e4add1.974e7"]]}]
