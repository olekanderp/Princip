[{"id":"5cd2cf3d.a0638","type":"tab","label":"Infratek"},{"id":"2f536b98.d3eb54","type":"tab","label":"processing_skelya"},{"id":"84fa27ef.447e08","type":"tab","label":"Infratek 2"},{"id":"c8e75c1d.f83","type":"tab","label":"processing_skelya 2"},{"id":"a5e5afad.227fd","type":"serial-port","z":"","serialport":"/dev/sensor_0","serialbaud":"115200","databits":"8","parity":"none","stopbits":"1","newline":"200","bin":"false","out":"time","addchar":false},{"id":"c6163ae9.d3d2b8","type":"serial-port","z":"","serialport":"/dev/sensor_1","serialbaud":"115200","databits":"8","parity":"none","stopbits":"1","newline":"200","bin":"false","out":"time","addchar":false},{"id":"4f8eb207.d850dc","type":"serial-port","z":"","serialport":"/dev/ttyACM0","serialbaud":"115200","databits":"8","parity":"none","stopbits":"1","newline":"\\r","bin":"false","out":"char","addchar":false},{"id":"251a0f4.6922bf","type":"tcp in","z":"5cd2cf3d.a0638","name":"","server":"server","host":"","port":"4011","datamode":"stream","datatype":"utf8","newline":"","topic":"","base64":false,"x":74,"y":76,"wires":[["9919fce2.ab9ed","b39b0f5d.6ac4a"]]},{"id":"52175d1d.3c1f74","type":"function","z":"5cd2cf3d.a0638","name":"set last Analys","func":"flow.set('lastAnalys',msg.payload);\nflow.set('barcode',\"\");\nglobal.set('device_id','b523d8ec-002a-6fbd-d330-26001f019000');\nreturn msg;","outputs":1,"noerr":0,"x":560,"y":80,"wires":[["2df3305b.3919e"]]},{"id":"c27a2924.b77fc8","type":"http in","z":"5cd2cf3d.a0638","name":"","url":"/getQuality","method":"get","swaggerDoc":"","x":126,"y":293,"wires":[["a5d2786.6b9a988"]]},{"id":"a9d9136.d6bc7f","type":"http response","z":"5cd2cf3d.a0638","name":"","x":616,"y":293,"wires":[]},{"id":"a5d2786.6b9a988","type":"function","z":"5cd2cf3d.a0638","name":"create response","func":"var load = flow.get('load');\nif (load){\n    msg.payload = flow.get('parseQA');    \n    msg.load = true;\n}else{\n    msg.payload = {};\n    msg.load = false;\n}\nmsg.payload.barcode = flow.get('barcode');\nflow.set(\"load\",false);\n\nreturn msg;","outputs":1,"noerr":0,"x":406,"y":293,"wires":[["a9d9136.d6bc7f","a82af876.d652f8","ebd30430.617f38"]]},{"id":"2df3305b.3919e","type":"function","z":"5cd2cf3d.a0638","name":"parse quality","func":"var result = {\n    localdate:new Date()\n};\n\nvar sdata = msg.payload;\nvar arr_sdata = sdata.split('\\n');\n\nresult.length = arr_sdata.length;\n\n//Ambient Temperature\nvar ambietTemperature = arr_sdata[7];\nvar arr_ambietTemperature = ambietTemperature.split(\":\");\nresult.ambietTemperature = arr_ambietTemperature[1];\n\n//Analysis Counter\nvar analysisCounter = arr_sdata[8];\nvar arr_analysisCounter = analysisCounter.split(\":\");\nresult.analysisCounter = arr_analysisCounter[1];\n\n//Sub sample\nvar subSample = arr_sdata[11];\nvar arr_subSample = subSample.split(\":\");\nvar arr_subSample_1 = arr_subSample[0].split(\"     \");\n\nresult.subsample = {\n   id : arr_subSample[0].replace(\"NrOFSubSamples\",\"\"),\n   NrOFSubSamples : arr_subSample[1]\n}\n\n//Sample hash\nvar sampleHash = arr_sdata[13];\nresult.sampleHash = sampleHash;\n\n//read quailities \nvar startQ  = 14;\nvar qLength = 7;\nvar endStr  = \"#\";\n\nvar qualities = [];\n\nfor( var i = startQ; i <= arr_sdata.length-qLength; ){\n    \n    var q = {\n        id:arr_sdata[i],\n        value:arr_sdata[i+1].split(String.fromCharCode(20)),\n        minmax:arr_sdata[i+4].split(String.fromCharCode(20))\n    }\n    \n    if (q.value[0].search('This') > 0){\n        break;\n    }\n    \n    qualities.push(q);\n    i = i+qLength;\n    \n}\n\nresult.qualities = qualities;\nresult.datahash  = JSON.stringify(result);\n// msg.payload = arr_sdata;\nmsg.payload = result;\nflow.set('parseQA',result);\n\nreturn msg;","outputs":1,"noerr":0,"x":730,"y":80,"wires":[["1103acfc.b506d3","ab33fcfe.f6a6a","d6c5c32c.bfc32"]]},{"id":"2520e5e1.28a08a","type":"inject","z":"5cd2cf3d.a0638","name":"","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":true,"x":105,"y":345,"wires":[["f4631c53.792eb"]]},{"id":"f4631c53.792eb","type":"function","z":"5cd2cf3d.a0638","name":"init config","func":"flow.set('load',false);\nreturn msg;","outputs":1,"noerr":0,"x":255,"y":345,"wires":[[]]},{"id":"5646d10e.b4397","type":"function","z":"5cd2cf3d.a0638","name":"read barcode","func":"flow.set(\"barcode\",msg.payload.replace(\"\\r\",\"\"));\nflow.set('load',true);\nmsg.payload = {\n    \"barcode\":msg.payload.replace(\"\\r\",\"\")\n}\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":200,"wires":[["7da14405.9267bc"]]},{"id":"bf2f583a.565968","type":"link in","z":"2f536b98.d3eb54","name":"quality","links":["1103acfc.b506d3"],"x":35,"y":300,"wires":[["35621716.4420a8"]]},{"id":"78f77923.c41198","type":"http request","z":"2f536b98.d3eb54","name":"EVENTS","method":"POST","ret":"txt","url":"","tls":"","x":920,"y":300,"wires":[[]]},{"id":"30e9d7ef.324028","type":"function","z":"2f536b98.d3eb54","name":"events payload","func":"var event_id = msg.event_id;\nvar device_id = global.get('device_id');\n\n\nmsg.payload = {\n    'event':{\n        'id':msg.event_id\n    },\n    'devices':[{'id':device_id}],\n    'data':msg.metadata,\n    'description':msg.description\n}\n\nmsg.headers = {\n    \"content-type\":\"application/json\"\n}\n\nmsg.url = flow.get('main_host')+flow.get('event_url');\nmsg.main_host = flow.get('main_host');\nmsg.event_url = flow.get('event_url');\n\nreturn msg;","outputs":1,"noerr":0,"x":760,"y":300,"wires":[["78f77923.c41198"]]},{"id":"516e1233.8fc3dc","type":"inject","z":"2f536b98.d3eb54","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":80,"y":460,"wires":[["5f90b87c.cf0a28"]]},{"id":"5f90b87c.cf0a28","type":"function","z":"2f536b98.d3eb54","name":"check scale health","func":"var lastcheckHealth = flow.get('checkHealth');\nvar checkHealth = null;\nvar lasttimedata = flow.get('lasttimedata');\n\nvar currenttimedata = new Date();\n\nif ((currenttimedata - lasttimedata) > 3000){\n    checkHealth = false;\n} else {\n    checkHealth = true;\n}\n\nflow.set(\"checkHealth\",checkHealth);\n\nif (lastcheckHealth != checkHealth){\n    msg.checkHealth = checkHealth;\n}else{\n    msg.checkHealth = null;\n}\nmsg.payload = checkHealth;\n\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":460,"wires":[["500ed9f7.587858"]]},{"id":"1046e63e.604f4a","type":"function","z":"2f536b98.d3eb54","name":"main config","func":"flow.set('checkHealth',null);\n\nreturn msg;\n","outputs":1,"noerr":0,"x":370,"y":240,"wires":[[]]},{"id":"354889a.028dd76","type":"inject","z":"2f536b98.d3eb54","name":"","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":true,"x":90,"y":220,"wires":[["f4c97140.6c067","1046e63e.604f4a"]]},{"id":"a80e4776.903268","type":"http request","z":"2f536b98.d3eb54","name":"STATE","method":"POST","ret":"txt","url":"","tls":"","x":610,"y":460,"wires":[["e0b84417.c485d8"]]},{"id":"500ed9f7.587858","type":"function","z":"2f536b98.d3eb54","name":"device state","func":"msg.payload = {\n    \"state\":msg.payload\n}\nmsg.headers = {\n    \"content-type\":\"application/json\"\n}\nmsg.url = flow.get('main_host')+flow.get('state_url')+\"?id=\"+global.get(\"scale_id\");\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":460,"wires":[["a80e4776.903268"]]},{"id":"53e43f58.75d74","type":"function","z":"2f536b98.d3eb54","name":"device config","func":"var device_config = JSON.parse(msg.payload);\n\nflow.set('event_make_quality_id',device_config.event_make_quality_id);\nflow.set('event_read_barcode_id',device_config.event_read_barcode_id);\nflow.set('event_send_to_accsystem_id',device_config.event_send_to_accsystem_id);\nflow.set('event_no_conditional',device_config.event_no_conditional);\nflow.set('main_host',device_config.main_host);\nflow.set('event_url',device_config.event_url);\nflow.set('state_url',device_config.state_url);\nflow.set('snapshot_url',device_config.snapshot_url);\n\nreturn msg;\n","outputs":1,"noerr":0,"x":570,"y":200,"wires":[["a871040d.efd6f8"]]},{"id":"6569eecd.a0a92","type":"http in","z":"2f536b98.d3eb54","name":"","url":"/firmware","method":"post","swaggerDoc":"","x":140,"y":160,"wires":[["3190d20f.08a0be"]]},{"id":"3190d20f.08a0be","type":"file","z":"2f536b98.d3eb54","name":"deivce_config","filename":"deivce_config.json","appendNewline":true,"createDir":false,"overwriteFile":"true","x":380,"y":160,"wires":[]},{"id":"f4c97140.6c067","type":"file in","z":"2f536b98.d3eb54","name":"deivce_config","filename":"deivce_config.json","format":"utf8","x":380,"y":200,"wires":[["53e43f58.75d74"]]},{"id":"53eee72e.1a5ef8","type":"http in","z":"2f536b98.d3eb54","name":"","url":"/serial","method":"get","swaggerDoc":"","x":120,"y":40,"wires":[["e2a9e28b.39a4e"]]},{"id":"e2a9e28b.39a4e","type":"exec","z":"2f536b98.d3eb54","command":"cat /proc/cpuinfo","addpay":true,"append":"| grep Serial","useSpawn":"","timer":"5","name":"","x":350,"y":40,"wires":[["6067afa2.e17d8","649839cd.47d2f8"],[],[]]},{"id":"6067afa2.e17d8","type":"http response","z":"2f536b98.d3eb54","name":"","x":550,"y":20,"wires":[]},{"id":"649839cd.47d2f8","type":"function","z":"2f536b98.d3eb54","name":"","func":"msg.payload = msg.payload.split(':')[1].replace('\\n','').replace(' ','');\nreturn msg;","outputs":1,"noerr":0,"x":540,"y":100,"wires":[["1ee99635.0d1ada"]]},{"id":"1ee99635.0d1ada","type":"debug","z":"2f536b98.d3eb54","name":"","active":false,"console":"false","complete":"false","x":694,"y":100,"wires":[]},{"id":"57c6265c.17a308","type":"inject","z":"2f536b98.d3eb54","name":"DEMO","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"x":80,"y":100,"wires":[["a56f9dd8.daa2c"]]},{"id":"a56f9dd8.daa2c","type":"function","z":"2f536b98.d3eb54","name":"DEMO Data","func":"var device_config = {\n    'event_make_quality_id':'8B9482814EDB2FC9E055000000000001',\n    'event_read_barcode_id':'8B9482814EDC2FC9E055000000000001',\n    'event_send_to_accsystem_id':'8B9482814EDD2FC9E055000000000001',\n    'event_no_conditional':'8C4D78A0466C7B36E055000000000001',\n    'main_host':'http://skelya.prncp.org/ords/ettn',\n    'event_url':'/iot_cli/events/log',\n    'state_url':'/iot_cli/device',\n    'snapshot_url':'/iot_cli/events/snapshot'\n}\nmsg.payload = device_config;\n// flow.set('scale_id','80096CB0EFD83B63E0533300000A4334');\n// flow.set('event_move_in_id','80096D9ABE7F68F3E0533300000A6C0D');\n// flow.set('event_move_out_id','80096D9ABE8068F3E0533300000A6C0D');\n// flow.set('event_max_weight_id','85A255F950F9BEF4E0533300000AC45D');\n// flow.set('event_off_id','85A2CC4570292DD1E0533300000A0C94');\n// flow.set('event_on_id', '85A2CC45702A2DD1E0533300000A0C94');\n// flow.set('event_max_duration','8642EE858DE89BAAE0533300000AFCC7');\n// flow.set('main_host','http://prod.apex.rest/ords/ettn');\n// flow.set('event_url','/iot_cli/events/log');\n// flow.set('state_url','/v1/device');\n// flow.set('maxWeight',40000);\n// flow.set('maxDuration',20000);\n// flow.set('checkHealthTimeout',3000);\nreturn msg;","outputs":1,"noerr":0,"x":230,"y":100,"wires":[["3190d20f.08a0be"]]},{"id":"4e05337a.0bddcc","type":"function","z":"2f536b98.d3eb54","name":"send quality","func":"msg.event_id = flow.get('event_make_quality_id');\nmsg.description = 'Îòðèìàëè ÿê³ñòü ³ç àíàë³çàòîðó. Íîìåð àíàë³çó: ' + msg.payload.analysisCounter+\". Êàë³áðîâêà \"+msg.payload.subsample_id;\nmsg.metadata = msg.payload;\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":300,"wires":[["30e9d7ef.324028"]]},{"id":"e0b84417.c485d8","type":"debug","z":"2f536b98.d3eb54","name":"","active":false,"console":"false","complete":"false","x":750,"y":460,"wires":[]},{"id":"a871040d.efd6f8","type":"debug","z":"2f536b98.d3eb54","name":"","active":false,"console":"false","complete":"payload","x":750,"y":200,"wires":[]},{"id":"3a9faae5.72fdb6","type":"link in","z":"2f536b98.d3eb54","name":"barcode","links":["7da14405.9267bc"],"x":35,"y":340,"wires":[["b2181c42.3bdf8"]]},{"id":"b2181c42.3bdf8","type":"function","z":"2f536b98.d3eb54","name":"read barcode","func":"msg.event_id = flow.get('event_read_barcode_id');\nmsg.description = 'Ç÷èòóâàííÿ øòðèõ-êîäó: ' + msg.payload.barcode;\nmsg.metadata = msg.payload;\n\nreturn msg;","outputs":1,"noerr":0,"x":150,"y":340,"wires":[["30e9d7ef.324028"]]},{"id":"defef6ad.1309c8","type":"function","z":"2f536b98.d3eb54","name":"send to 1c","func":"msg.event_id = flow.get('event_send_to_accsystem_id');\nmsg.description = 'Îòðèìàííÿ àíàë³çó â 1Ñ: ' + msg.payload.barcode;\nmsg.metadata = {\n    'barcode':msg.payload.barcode\n}\nreturn msg;","outputs":1,"noerr":0,"x":150,"y":380,"wires":[["30e9d7ef.324028"]]},{"id":"8655ce9a.541d9","type":"link in","z":"2f536b98.d3eb54","name":"1c","links":["6e2ad3f3.8bc99c"],"x":35,"y":380,"wires":[["defef6ad.1309c8"]]},{"id":"1103acfc.b506d3","type":"link out","z":"5cd2cf3d.a0638","name":"get quality throw tcp","links":["bf2f583a.565968"],"x":775,"y":20,"wires":[]},{"id":"6e2ad3f3.8bc99c","type":"link out","z":"5cd2cf3d.a0638","name":"1c request","links":["8655ce9a.541d9"],"x":723,"y":301,"wires":[]},{"id":"7da14405.9267bc","type":"link out","z":"5cd2cf3d.a0638","name":"read barcode","links":["3a9faae5.72fdb6"],"x":415,"y":200,"wires":[]},{"id":"b2f0c343.43ca1","type":"switch","z":"2f536b98.d3eb54","name":"","property":"isNotConditional","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":410,"y":400,"wires":[["19a911ae.d839be"]]},{"id":"19a911ae.d839be","type":"function","z":"2f536b98.d3eb54","name":"send quality","func":"msg.event_id = flow.get('event_no_conditional');\nmsg.description = 'Íåêîäèíö³éíÿ ÿê³ñòü. Íîìåð àíàë³çó ' + msg.payload.analysisCounter;\n\nvar payload = {};\nfor (var i = 0; i < msg.notcondition.length; i++){\n    payload = msg.notcondition[i];  \n}\nmsg.metadata = payload;\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":400,"wires":[["30e9d7ef.324028","a677981a.b5c718"]]},{"id":"a677981a.b5c718","type":"debug","z":"2f536b98.d3eb54","name":"","active":false,"console":"false","complete":"true","x":760,"y":400,"wires":[]},{"id":"35621716.4420a8","type":"function","z":"2f536b98.d3eb54","name":"parse result","func":"var p = msg.payload;\n\nvar result = {\n    \"ambietTemperature\":p.ambietTemperature,\n    \"analysisCounter\":p.analysisCounter,\n    \"subsample_id\":p.subsample.id,\n    \"subsample_NrOFSubSamples\":p.subsample.NrOFSubSamples,\n    \"sampleHash\":p.sampleHash\n};\nvar notcondition = [];\nvar isNotConditional = false;\n\nfor (var i = 0; i < p.qualities.length; i++){\n    \n    var valueid = p.qualities[i].id.replace(\" \",\"\"); \n    var temp_value_name = p.qualities[i].value[0].match(/[a-zA-Z]+/g)[0];\n    var temp_value = parseFloat(p.qualities[i].value[0].match(/\\d+.\\d+/g));\n    result[temp_value_name] = temp_value;\n    \n    var temp_value_min_name = p.qualities[i].minmax[0].match(/[a-zA-Z]+/g)[0];\n    var temp_value_min = parseFloat(p.qualities[i].minmax[0].match(/\\d+.\\d+/g)[0]);\n    // result[temp_value_name+\"_\"+temp_value_min_name] = temp_value_min;\n    \n    var temp_value_max_name = p.qualities[i].minmax[0].match(/[a-zA-Z]+/g)[1];\n    var temp_value_max = parseFloat(p.qualities[i].minmax[0].match(/\\d+.\\d+/g)[1]);\n    // result[temp_value_name+\"_\"+temp_value_max_name] = temp_value_max;\n    \n    if ((temp_value>temp_value_max) || (temp_value<temp_value_min)){\n        notcondition.push({\n            [temp_value_name]:temp_value,\n            [temp_value_min_name]:temp_value_min,\n            [temp_value_max_name]:temp_value_max\n        });\n        isNotConditional = true;\n    }\n}\nmsg.payload = result;\nmsg.notcondition = notcondition;\nmsg.isNotConditional = isNotConditional;\n\nreturn msg;","outputs":1,"noerr":0,"x":150,"y":300,"wires":[["4e05337a.0bddcc","b2f0c343.43ca1"]]},{"id":"a82af876.d652f8","type":"switch","z":"5cd2cf3d.a0638","name":"","property":"load","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":616,"y":333,"wires":[["6e2ad3f3.8bc99c"]]},{"id":"c539df96.91a85","type":"debug","z":"5cd2cf3d.a0638","name":"Аналізатор 1","active":true,"console":"true","complete":"payload","x":580,"y":140,"wires":[]},{"id":"7cadfc06.e601d4","type":"debug","z":"5cd2cf3d.a0638","name":"barcode","active":true,"console":"true","complete":"payload","x":270,"y":240,"wires":[]},{"id":"2bf0f44e.246bac","type":"debug","z":"5cd2cf3d.a0638","name":"parser quality FOSS 1","active":false,"console":"true","complete":"payload","x":1250,"y":80,"wires":[]},{"id":"2f6ffee3.59e422","type":"function","z":"5cd2cf3d.a0638","name":"","func":"msg.payload = msg.payload.substring(0,2500);\nmsg.payload = {\n    msg:msg.payload\n};\n    \nreturn msg;","outputs":1,"noerr":0,"x":310,"y":140,"wires":[["34d47e6a.fc17f2"]]},{"id":"9919fce2.ab9ed","type":"delay","z":"5cd2cf3d.a0638","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"4","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":160,"y":140,"wires":[["2f6ffee3.59e422"]]},{"id":"ad3415e6.b982f8","type":"json","z":"5cd2cf3d.a0638","name":"","x":1050,"y":80,"wires":[["2bf0f44e.246bac"]]},{"id":"ab33fcfe.f6a6a","type":"delay","z":"5cd2cf3d.a0638","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"4","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":900,"y":80,"wires":[["ad3415e6.b982f8"]]},{"id":"34d47e6a.fc17f2","type":"json","z":"5cd2cf3d.a0638","name":"","x":430,"y":140,"wires":[["c539df96.91a85"]]},{"id":"1fb17070.c7c6","type":"serial in","z":"5cd2cf3d.a0638","name":"","serial":"c6163ae9.d3d2b8","x":90,"y":200,"wires":[["7cadfc06.e601d4","5646d10e.b4397"]]},{"id":"fcd2b0f7.7967e","type":"tcp in","z":"84fa27ef.447e08","name":"","server":"server","host":"","port":"4012","datamode":"stream","datatype":"utf8","newline":"","topic":"","base64":false,"x":100,"y":100,"wires":[["ebec991e.aa15a8","24a90b67.b349b4"]]},{"id":"649ee7b0.20daa8","type":"function","z":"84fa27ef.447e08","name":"set last Analys","func":"flow.set('lastAnalys',msg.payload);\nflow.set('barcode',\"\");\nglobal.set('device_id_2','10b2ba2e-addb-0b9b-bd33-95141f019000');\nreturn msg;","outputs":1,"noerr":0,"x":600,"y":100,"wires":[["1cc81f4.1d725e1","caea91b6.42919"]]},{"id":"6845ffe0.ab83","type":"http in","z":"84fa27ef.447e08","name":"","url":"/getQuality_2","method":"get","swaggerDoc":"","x":149,"y":213,"wires":[["3304d520.da951a"]]},{"id":"cb47b78f.6e0ba8","type":"http response","z":"84fa27ef.447e08","name":"","x":664,"y":243,"wires":[]},{"id":"3304d520.da951a","type":"function","z":"84fa27ef.447e08","name":"create response","func":"var load = flow.get('load');\nif (load){\n    msg.payload = flow.get('parseQA');    \n    msg.load = true;\n}else{\n    msg.payload = {};\n    msg.load = false;\n}\nmsg.payload.barcode = flow.get('barcode');\nflow.set(\"load\",false);\n\nreturn msg;","outputs":1,"noerr":0,"x":419,"y":213,"wires":[["cb47b78f.6e0ba8","e3bc7276.94248","4c4ad759.2c5668"]]},{"id":"1cc81f4.1d725e1","type":"function","z":"84fa27ef.447e08","name":"parse quality","func":"var result = {\n    localdate:new Date()\n};\n\nvar sdata = msg.payload;\nvar arr_sdata = sdata.split('\\n');\n\nresult.length = arr_sdata.length;\n\n//Ambient Temperature\nvar ambietTemperature = arr_sdata[7];\nvar arr_ambietTemperature = ambietTemperature.split(\":\");\nresult.ambietTemperature = arr_ambietTemperature[1];\n\n//Analysis Counter\nvar analysisCounter = arr_sdata[8];\nvar arr_analysisCounter = analysisCounter.split(\":\");\nresult.analysisCounter = arr_analysisCounter[1];\n\n//Sub sample\nvar subSample = arr_sdata[11];\nvar arr_subSample = subSample.split(\":\");\nvar arr_subSample_1 = arr_subSample[0].split(\"     \");\n\nresult.subsample = {\n   id : arr_subSample[0].replace(\"NrOFSubSamples\",\"\"),\n   NrOFSubSamples : arr_subSample[1]\n}\n\n//Sample hash\nvar sampleHash = arr_sdata[13];\nresult.sampleHash = sampleHash;\n\n//read quailities \nvar startQ  = 14;\nvar qLength = 7;\nvar endStr  = \"#\";\n\nvar qualities = [];\n\nfor( var i = startQ; i <= arr_sdata.length-qLength; ){\n    \n    var q = {\n        id:arr_sdata[i],\n        value:arr_sdata[i+1].split(String.fromCharCode(20)),\n        minmax:arr_sdata[i+4].split(String.fromCharCode(20))\n    }\n    \n    if (q.value[0].search('This') > 0){\n        break;\n    }\n    \n    qualities.push(q);\n    i = i+qLength;\n    \n}\n\nresult.qualities = qualities;\nresult.datahash  = JSON.stringify(result);\n// msg.payload = arr_sdata;\nmsg.payload = result;\nflow.set('parseQA',result);\n\nreturn msg;","outputs":1,"noerr":0,"x":806,"y":100,"wires":[["ee8562c9.545ae","32b6cd46.6d95c2","ae4d3bea.077828"]]},{"id":"d87e63d5.93de6","type":"inject","z":"84fa27ef.447e08","name":"","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":true,"x":89,"y":353,"wires":[["2ca501eb.02793e"]]},{"id":"2ca501eb.02793e","type":"function","z":"84fa27ef.447e08","name":"init config","func":"flow.set('load',false);\nreturn msg;","outputs":1,"noerr":0,"x":394,"y":353,"wires":[[]]},{"id":"5ad8cf5c.acd53","type":"function","z":"84fa27ef.447e08","name":"read barcode","func":"flow.set(\"barcode\",msg.payload.replace(\"\\r\",\"\"));\nflow.set('load',true);\nmsg.payload = {\n    \"barcode\":msg.payload.replace(\"\\r\",\"\")\n}\nreturn msg;","outputs":1,"noerr":0,"x":319.00000762939453,"y":274.2500057220459,"wires":[["37e9c1c2.23cb7e","39761443.9e1aac"]]},{"id":"937493ca.7f581","type":"link in","z":"c8e75c1d.f83","name":"quality 2","links":["ee8562c9.545ae"],"x":35,"y":300,"wires":[["cc67ec45.14862"]]},{"id":"f5220279.27523","type":"http request","z":"c8e75c1d.f83","name":"EVENTS","method":"POST","ret":"txt","url":"","tls":"","x":920,"y":300,"wires":[["f998e63f.975fb8"]]},{"id":"957ed7e6.bb6ba8","type":"function","z":"c8e75c1d.f83","name":"events payload","func":"var event_id = msg.event_id;\nvar device_id = global.get('device_id_2');\n\n\nmsg.payload = {\n    'event':{\n        'id':msg.event_id\n    },\n    'devices':[{'id':device_id}],\n    'data':msg.metadata,\n    'description':msg.description\n}\n\nmsg.headers = {\n    \"content-type\":\"application/json\"\n}\n\nmsg.url = flow.get('main_host')+flow.get('event_url');\nmsg.main_host = flow.get('main_host');\nmsg.event_url = flow.get('event_url');\n\nreturn msg;","outputs":1,"noerr":0,"x":760,"y":300,"wires":[["f5220279.27523"]]},{"id":"f772d52e.64ee98","type":"inject","z":"c8e75c1d.f83","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":80,"y":460,"wires":[["4c88d05d.bd3e8"]]},{"id":"4c88d05d.bd3e8","type":"function","z":"c8e75c1d.f83","name":"check scale health","func":"var lastcheckHealth = flow.get('checkHealth');\nvar checkHealth = null;\nvar lasttimedata = flow.get('lasttimedata');\n\nvar currenttimedata = new Date();\n\nif ((currenttimedata - lasttimedata) > 3000){\n    checkHealth = false;\n} else {\n    checkHealth = true;\n}\n\nflow.set(\"checkHealth\",checkHealth);\n\nif (lastcheckHealth != checkHealth){\n    msg.checkHealth = checkHealth;\n}else{\n    msg.checkHealth = null;\n}\nmsg.payload = checkHealth;\n\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":460,"wires":[["b23f8e73.d706b"]]},{"id":"d18276d5.1eda18","type":"function","z":"c8e75c1d.f83","name":"main config","func":"flow.set('checkHealth',null);\n\nreturn msg;\n","outputs":1,"noerr":0,"x":370,"y":240,"wires":[[]]},{"id":"225e53f.5bf41ac","type":"inject","z":"c8e75c1d.f83","name":"","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":true,"x":90,"y":220,"wires":[["bc2e7215.99516","d18276d5.1eda18"]]},{"id":"672ba8.813c0458","type":"http request","z":"c8e75c1d.f83","name":"STATE","method":"POST","ret":"txt","url":"","tls":"","x":610,"y":460,"wires":[["df303310.cbc33"]]},{"id":"b23f8e73.d706b","type":"function","z":"c8e75c1d.f83","name":"device state","func":"msg.payload = {\n    \"state\":msg.payload\n}\nmsg.headers = {\n    \"content-type\":\"application/json\"\n}\nmsg.url = flow.get('main_host')+flow.get('state_url')+\"?id=\"+global.get(\"scale_id\");\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":460,"wires":[["672ba8.813c0458"]]},{"id":"667b947f.555e9c","type":"function","z":"c8e75c1d.f83","name":"device config","func":"var device_config = JSON.parse(msg.payload);\n\nflow.set('event_make_quality_id',device_config.event_make_quality_id);\nflow.set('event_read_barcode_id',device_config.event_read_barcode_id);\nflow.set('event_send_to_accsystem_id',device_config.event_send_to_accsystem_id);\nflow.set('event_no_conditional',device_config.event_no_conditional);\nflow.set('main_host',device_config.main_host);\nflow.set('event_url',device_config.event_url);\nflow.set('state_url',device_config.state_url);\nflow.set('snapshot_url',device_config.snapshot_url);\n\nreturn msg;\n","outputs":1,"noerr":0,"x":570,"y":200,"wires":[["9bbb045f.38c868"]]},{"id":"471b8127.78c6a","type":"http in","z":"c8e75c1d.f83","name":"","url":"/firmware","method":"post","swaggerDoc":"","x":140,"y":160,"wires":[["f19f17a2.0c8598"]]},{"id":"f19f17a2.0c8598","type":"file","z":"c8e75c1d.f83","name":"deivce_config","filename":"deivce_config.json","appendNewline":true,"createDir":false,"overwriteFile":"true","x":380,"y":160,"wires":[]},{"id":"bc2e7215.99516","type":"file in","z":"c8e75c1d.f83","name":"deivce_config","filename":"deivce_config.json","format":"utf8","x":380,"y":200,"wires":[["667b947f.555e9c"]]},{"id":"775db076.6288b","type":"http in","z":"c8e75c1d.f83","name":"","url":"/serial","method":"get","swaggerDoc":"","x":120,"y":40,"wires":[["d20e6c33.29897"]]},{"id":"d20e6c33.29897","type":"exec","z":"c8e75c1d.f83","command":"cat /proc/cpuinfo","addpay":true,"append":"| grep Serial","useSpawn":"","timer":"5","name":"","x":350,"y":40,"wires":[["27ca0d06.0b3da2","59e06558.ef1c9c"],[],[]]},{"id":"27ca0d06.0b3da2","type":"http response","z":"c8e75c1d.f83","name":"","x":550,"y":20,"wires":[]},{"id":"59e06558.ef1c9c","type":"function","z":"c8e75c1d.f83","name":"","func":"msg.payload = msg.payload.split(':')[1].replace('\\n','').replace(' ','');\nreturn msg;","outputs":1,"noerr":0,"x":540,"y":100,"wires":[["ec263124.2ca6c"]]},{"id":"ec263124.2ca6c","type":"debug","z":"c8e75c1d.f83","name":"","active":false,"console":"false","complete":"false","x":694,"y":100,"wires":[]},{"id":"152f96a.289c969","type":"inject","z":"c8e75c1d.f83","name":"DEMO","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"x":80,"y":100,"wires":[["3c844da4.a56252"]]},{"id":"3c844da4.a56252","type":"function","z":"c8e75c1d.f83","name":"DEMO Data","func":"var device_config = {\n    'event_make_quality_id':'8B9482814EDB2FC9E055000000000001',\n    'event_read_barcode_id':'8B9482814EDC2FC9E055000000000001',\n    'event_send_to_accsystem_id':'8B9482814EDD2FC9E055000000000001',\n    'event_no_conditional':'8C4D78A0466C7B36E055000000000001',\n    'main_host':'http://skelya.prncp.org/ords/ettn',\n    'event_url':'/iot_cli/events/log',\n    'state_url':'/iot_cli/device',\n    'snapshot_url':'/iot_cli/events/snapshot'\n}\nmsg.payload = device_config;\n// flow.set('scale_id','80096CB0EFD83B63E0533300000A4334');\n// flow.set('event_move_in_id','80096D9ABE7F68F3E0533300000A6C0D');\n// flow.set('event_move_out_id','80096D9ABE8068F3E0533300000A6C0D');\n// flow.set('event_max_weight_id','85A255F950F9BEF4E0533300000AC45D');\n// flow.set('event_off_id','85A2CC4570292DD1E0533300000A0C94');\n// flow.set('event_on_id', '85A2CC45702A2DD1E0533300000A0C94');\n// flow.set('event_max_duration','8642EE858DE89BAAE0533300000AFCC7');\n// flow.set('main_host','http://prod.apex.rest/ords/ettn');\n// flow.set('event_url','/iot_cli/events/log');\n// flow.set('state_url','/v1/device');\n// flow.set('maxWeight',40000);\n// flow.set('maxDuration',20000);\n// flow.set('checkHealthTimeout',3000);\nreturn msg;","outputs":1,"noerr":0,"x":230,"y":100,"wires":[["f19f17a2.0c8598"]]},{"id":"6be12cad.032bd4","type":"function","z":"c8e75c1d.f83","name":"send quality","func":"msg.event_id = flow.get('event_make_quality_id');\nmsg.description = 'Îòðèìàëè ÿê³ñòü ³ç àíàë³çàòîðó. Íîìåð àíàë³çó: ' + msg.payload.analysisCounter+\". Êàë³áðîâêà \"+msg.payload.subsample_id;\nmsg.metadata = msg.payload;\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":300,"wires":[["957ed7e6.bb6ba8"]]},{"id":"df303310.cbc33","type":"debug","z":"c8e75c1d.f83","name":"","active":false,"console":"false","complete":"false","x":750,"y":460,"wires":[]},{"id":"9bbb045f.38c868","type":"debug","z":"c8e75c1d.f83","name":"","active":false,"console":"false","complete":"payload","x":750,"y":200,"wires":[]},{"id":"31acc6eb.1dfaba","type":"link in","z":"c8e75c1d.f83","name":"barcode 2","links":["37e9c1c2.23cb7e"],"x":35,"y":340,"wires":[["474231db.640aa"]]},{"id":"474231db.640aa","type":"function","z":"c8e75c1d.f83","name":"read barcode","func":"msg.event_id = flow.get('event_read_barcode_id');\nmsg.description = 'Ç÷èòóâàííÿ øòðèõ-êîäó: ' + msg.payload.barcode;\nmsg.metadata = msg.payload;\n\nreturn msg;","outputs":1,"noerr":0,"x":150,"y":340,"wires":[["957ed7e6.bb6ba8"]]},{"id":"5d466a57.f40594","type":"function","z":"c8e75c1d.f83","name":"send to 1c","func":"msg.event_id = flow.get('event_send_to_accsystem_id');\nmsg.description = 'Îòðèìàííÿ àíàë³çó â 1Ñ: ' + msg.payload.barcode;\nmsg.metadata = {\n    'barcode':msg.payload.barcode\n}\nreturn msg;","outputs":1,"noerr":0,"x":150,"y":380,"wires":[["957ed7e6.bb6ba8"]]},{"id":"d7623d9a.f573c","type":"link in","z":"c8e75c1d.f83","name":"1c 2","links":["39c11201.12e21e"],"x":35,"y":380,"wires":[["5d466a57.f40594"]]},{"id":"ee8562c9.545ae","type":"link out","z":"84fa27ef.447e08","name":"get quality throw tcp 2","links":["937493ca.7f581"],"x":1135,"y":100,"wires":[]},{"id":"39c11201.12e21e","type":"link out","z":"84fa27ef.447e08","name":"1c request 2","links":["d7623d9a.f573c"],"x":1094,"y":336,"wires":[]},{"id":"37e9c1c2.23cb7e","type":"link out","z":"84fa27ef.447e08","name":"read barcode","links":["31acc6eb.1dfaba"],"x":454,"y":275,"wires":[]},{"id":"f16a91fe.931fb","type":"switch","z":"c8e75c1d.f83","name":"","property":"isNotConditional","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":410,"y":400,"wires":[["faf7ee78.eec28"]]},{"id":"faf7ee78.eec28","type":"function","z":"c8e75c1d.f83","name":"send quality","func":"msg.event_id = flow.get('event_no_conditional');\nmsg.description = 'Íåêîäèíö³éíÿ ÿê³ñòü. Íîìåð àíàë³çó ' + msg.payload.analysisCounter;\n\nvar payload = {};\nfor (var i = 0; i < msg.notcondition.length; i++){\n    payload = msg.notcondition[i];  \n}\nmsg.metadata = payload;\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":400,"wires":[["957ed7e6.bb6ba8","14e0023f.e6108e"]]},{"id":"14e0023f.e6108e","type":"debug","z":"c8e75c1d.f83","name":"","active":false,"console":"false","complete":"true","x":760,"y":400,"wires":[]},{"id":"cc67ec45.14862","type":"function","z":"c8e75c1d.f83","name":"parse result","func":"var p = msg.payload;\n\nvar result = {\n    \"ambietTemperature\":p.ambietTemperature,\n    \"analysisCounter\":p.analysisCounter,\n    \"subsample_id\":p.subsample.id,\n    \"subsample_NrOFSubSamples\":p.subsample.NrOFSubSamples,\n    \"sampleHash\":p.sampleHash\n};\nvar notcondition = [];\nvar isNotConditional = false;\n\nfor (var i = 0; i < p.qualities.length; i++){\n    \n    var valueid = p.qualities[i].id.replace(\" \",\"\"); \n    var temp_value_name = p.qualities[i].value[0].match(/[a-zA-Z]+/g)[0];\n    var temp_value = parseFloat(p.qualities[i].value[0].match(/\\d+.\\d+/g));\n    result[temp_value_name] = temp_value;\n    \n    var temp_value_min_name = p.qualities[i].minmax[0].match(/[a-zA-Z]+/g)[0];\n    var temp_value_min = parseFloat(p.qualities[i].minmax[0].match(/\\d+.\\d+/g)[0]);\n    // result[temp_value_name+\"_\"+temp_value_min_name] = temp_value_min;\n    \n    var temp_value_max_name = p.qualities[i].minmax[0].match(/[a-zA-Z]+/g)[1];\n    var temp_value_max = parseFloat(p.qualities[i].minmax[0].match(/\\d+.\\d+/g)[1]);\n    // result[temp_value_name+\"_\"+temp_value_max_name] = temp_value_max;\n    \n    if ((temp_value>temp_value_max) || (temp_value<temp_value_min)){\n        notcondition.push({\n            [temp_value_name]:temp_value,\n            [temp_value_min_name]:temp_value_min,\n            [temp_value_max_name]:temp_value_max\n        });\n        isNotConditional = true;\n    }\n}\nmsg.payload = result;\nmsg.notcondition = notcondition;\nmsg.isNotConditional = isNotConditional;\n\nreturn msg;","outputs":1,"noerr":0,"x":150,"y":300,"wires":[["6be12cad.032bd4","f16a91fe.931fb"]]},{"id":"e3bc7276.94248","type":"switch","z":"84fa27ef.447e08","name":"","property":"load","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":707,"y":294,"wires":[["39c11201.12e21e"]]},{"id":"b4a73937.44ba68","type":"debug","z":"84fa27ef.447e08","name":"parser quality FOSS 2","active":false,"console":"true","complete":"payload","x":1279,"y":142,"wires":[]},{"id":"e060ff6f.16de1","type":"json","z":"84fa27ef.447e08","name":"","x":1080,"y":143,"wires":[["b4a73937.44ba68"]]},{"id":"70065c4a.135a34","type":"delay","z":"84fa27ef.447e08","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"5","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":600,"y":180,"wires":[["a3b629c2.697d08"]]},{"id":"32b6cd46.6d95c2","type":"delay","z":"84fa27ef.447e08","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"5","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":902,"y":144,"wires":[["e060ff6f.16de1"]]},{"id":"a3b629c2.697d08","type":"function","z":"84fa27ef.447e08","name":"","func":"msg.payload = msg.payload.substring(0,2500);\nmsg.payload = {\n    msg:msg.payload\n};\n    \nreturn msg;","outputs":1,"noerr":0,"x":759,"y":191,"wires":[["13ca9d06.8097b3"]]},{"id":"13ca9d06.8097b3","type":"json","z":"84fa27ef.447e08","name":"","x":895,"y":198,"wires":[["e536e8aa.aed1b8"]]},{"id":"e536e8aa.aed1b8","type":"debug","z":"84fa27ef.447e08","name":"Аналізатор 2","active":false,"console":"true","complete":"payload","x":1105,"y":194,"wires":[]},{"id":"bfa11c92.fa83d","type":"inject","z":"84fa27ef.447e08","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":919,"y":251,"wires":[["e536e8aa.aed1b8"]]},{"id":"ae4d3bea.077828","type":"debug","z":"84fa27ef.447e08","name":"","active":false,"console":"false","complete":"false","x":1260,"y":300,"wires":[]},{"id":"caea91b6.42919","type":"debug","z":"84fa27ef.447e08","name":"","active":false,"console":"false","complete":"false","x":950,"y":400,"wires":[]},{"id":"ebec991e.aa15a8","type":"function","z":"84fa27ef.447e08","name":"search foss","func":"var foss = 'Foss Tecator';\nvar sdata = msg.payload;\nvar arr_sdata = sdata.split('\\n');\n\nvar search = arr_sdata[2].search(foss);\n\nmsg.foss = search;\nmsg.arr  = arr_sdata;\n\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":100,"wires":[["dbc705a.67141f8"]]},{"id":"dbc705a.67141f8","type":"switch","z":"84fa27ef.447e08","name":"","property":"foss","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"}],"checkall":"true","outputs":1,"x":424,"y":100,"wires":[["649ee7b0.20daa8","70065c4a.135a34"]]},{"id":"f998e63f.975fb8","type":"debug","z":"c8e75c1d.f83","name":"","active":false,"console":"false","complete":"false","x":1120,"y":300,"wires":[]},{"id":"39761443.9e1aac","type":"debug","z":"84fa27ef.447e08","name":"infratek 2","active":true,"console":"false","complete":"payload","x":420,"y":318,"wires":[]},{"id":"24a90b67.b349b4","type":"debug","z":"84fa27ef.447e08","name":"infratek 2","active":true,"console":"false","complete":"payload","x":259,"y":164,"wires":[]},{"id":"8a10006f.08b67","type":"comment","z":"84fa27ef.447e08","name":"Аналізатор 2 інформація","info":"№2 в лабораторії\n10.142.10.47","x":152,"y":55,"wires":[]},{"id":"a262f7db.7e4f28","type":"comment","z":"5cd2cf3d.a0638","name":"Аналізатор 1  інформація","info":"№1 в лабораторії\n10.142.10.46","x":139,"y":32,"wires":[]},{"id":"c08a36ae.510638","type":"serial in","z":"84fa27ef.447e08","name":"","serial":"a5e5afad.227fd","x":94,"y":275.5,"wires":[["5ad8cf5c.acd53"]]},{"id":"4c4ad759.2c5668","type":"debug","z":"84fa27ef.447e08","name":"","active":true,"console":"false","complete":"false","x":648.7500076293945,"y":333.7500047683716,"wires":[]},{"id":"ebd30430.617f38","type":"debug","z":"5cd2cf3d.a0638","name":"","active":true,"console":"false","complete":"false","x":610,"y":380,"wires":[]},{"id":"d6c5c32c.bfc32","type":"debug","z":"5cd2cf3d.a0638","name":"","active":true,"console":"false","complete":"false","x":890,"y":140,"wires":[]},{"id":"b39b0f5d.6ac4a","type":"function","z":"5cd2cf3d.a0638","name":"search foss","func":"var foss = 'Foss Tecator';\nvar sdata = msg.payload;\nvar arr_sdata = sdata.split('\\n');\n\nvar search = arr_sdata[2].search(foss);\n\nmsg.foss = search;\nmsg.arr  = arr_sdata;\n\nreturn msg;","outputs":1,"noerr":0,"x":230,"y":80,"wires":[["6d71d714.bbb768"]]},{"id":"6d71d714.bbb768","type":"switch","z":"5cd2cf3d.a0638","name":"","property":"foss","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"}],"checkall":"true","outputs":1,"x":370,"y":80,"wires":[["52175d1d.3c1f74"]]}]
