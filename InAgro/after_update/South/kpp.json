[{"id":"78179ed1.3521c","type":"tab","label":"QR Print"},{"id":"1aa5e479.1c12dc","type":"tab","label":"processing_scale1"},{"id":"8159ee58.1d12f","type":"tab","label":"Дашборд Брутто"},{"id":"b73c3ad4.d39558","type":"tab","label":"Tablo"},{"id":"c30bf6c9.215ca8","type":"serial-port","z":"","serialport":"/dev/avto","serialbaud":"9600","databits":"8","parity":"none","stopbits":"1","newline":"500","bin":"false","out":"time","addchar":false},{"id":"a57a7a97.215ba8","type":"serial-port","z":"","serialport":"/dev/tablo","serialbaud":"9600","databits":"8","parity":"none","stopbits":"1","newline":"20","bin":"false","out":"time","addchar":false},{"id":"ecea570.b2643a8","type":"socket-io-event","z":"","addr":"getWeight"},{"id":"52b8e9c6.6aae18","type":"socket-io-server","z":"","port":"4001"},{"id":"370cd167.ca739e","type":"serial-port","z":"","serialport":"/dev/ttyACM0","serialbaud":"9600","databits":"8","parity":"none","stopbits":"1","newline":"50","bin":"false","out":"time","addchar":false},{"id":"8ab63c4c.df903","type":"ui_group","z":"","name":"Вага","tab":"e6809312.a3631","order":1,"disp":true,"width":"4"},{"id":"a69a5365.2a154","type":"ui_group","z":"","name":"Default","tab":"","disp":true,"width":"6"},{"id":"77758a63.fa9364","type":"ui_group","z":"","name":"Статус","tab":"e6809312.a3631","order":2,"disp":true,"width":"7"},{"id":"e6809312.a3631","type":"ui_tab","z":"","name":"Prod","icon":"dashboard","order":2},{"id":"a250ed12.2c4e5","type":"ui_group","z":"","name":"Данные","tab":"e6809312.a3631","order":4,"disp":true,"width":"8"},{"id":"1b1700c6.493b3f","type":"ui_group","z":"","name":"Таймер","tab":"e6809312.a3631","order":3,"disp":true,"width":"5"},{"id":"b54ed59.8177728","type":"ui_group","z":"","name":"Данные транспортного средства","tab":"e6809312.a3631","order":6,"disp":true,"width":"9"},{"id":"61212ad5.2d4534","type":"ui_group","z":"","name":"Текст","tab":"e6809312.a3631","order":5,"disp":true,"width":"9"},{"id":"3e243f43.ece68","type":"ui_group","z":"","name":"Інформація","tab":"456b62bf.5ff89c","disp":true,"width":"16"},{"id":"456b62bf.5ff89c","type":"ui_tab","z":"","name":"Prod","icon":"dashboard","order":1},{"id":"c9e1e69c.b11ed8","type":"inject","z":"8159ee58.1d12f","name":"","topic":"","payload":"Сканируйте пропуск","payloadType":"str","repeat":"2","crontab":"","once":false,"x":137,"y":67,"wires":[["f5a0d90a.d11e58"]]},{"id":"b1859dc9.fff1e","type":"function","z":"8159ee58.1d12f","name":"Counter","func":"var count = flow.get(\"delay\");\n\ncount = count - 1;\n\nmsg.payload = count;\nflow.set(\"delay\", count);\n\nif(count === 0){\nflow.set(\"delay\", 30); \nflow.set(\"triger_route\", false);\nflow.set(\"status_code\", 0);\n\n\n}\nreturn msg;","outputs":1,"noerr":0,"x":180,"y":620,"wires":[["ad6bf652.72b2f8"]]},{"id":"47f1928b.df6f5c","type":"inject","z":"8159ee58.1d12f","name":"","topic":"","payload":"","payloadType":"date","repeat":"1","crontab":"","once":false,"x":110,"y":540,"wires":[["b458bb3f.090d28"]]},{"id":"19d63ef4.236411","type":"function","z":"8159ee58.1d12f","name":"init","func":"flow.set(\"delay\", 30);\nflow.set(\"triger_route\", false);\nflow.set(\"status_code\", 0);\nreturn msg;","outputs":1,"noerr":0,"x":287,"y":26,"wires":[[]]},{"id":"785a3c92.b5d9c4","type":"inject","z":"8159ee58.1d12f","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"x":134,"y":27,"wires":[["19d63ef4.236411"]]},{"id":"c0c11542.8bb108","type":"function","z":"8159ee58.1d12f","name":"triger_route","func":"flow.set(\"triger_route\", true);//включив таймер\n\nif(msg.statusCode == 200){\n    msg.payload = JSON.parse(msg.payload);\n    let board_text= msg.payload.board_text;//зовнішнє табло\n    let disp_text= msg.payload.disp_text;//дашборд\n\n    msg.payload = {\n        disp_text:`<p class=\"disp_text\">${disp_text}</p>`,\n        board_text: board_text\n    };\n\n}else if(msg.statusCode != 200){\n    msg.payload = JSON.parse(msg.payload);\n    let errorTable = msg.payload.ТекстОшибкиТабло;\n    let shortErrorTable = msg.payload.КраткоеОписаниеОшибки;\n    let fullErrorTable = msg.payload.ПолноеОписаниеОшибки;\n    \n    msg.payload = {\n       disp_text:`<p class=\"fullerror_table\">${shortErrorTable}</p>`,\n       board_text: shortErrorTable\n    };\n} else {\n    msg.payload = {\n       disp_text: `<p class=\"default_error\">\"Ошибка сети, обратитесь к адмінистратору\"</p>`,\n       board_text: `Ошибка сети, обратитесь к адмінистратору`\n    };\n}\nreturn msg;\n/*\nРезультат.Вставить(\"ТекстОшибкиТабло\",\"\");\n  Результат.Вставить(\"КраткоеОписаниеОшибки\",\"\");\n  Результат.Вставить(\"ПолноеОписаниеОшибки\",\"\");\nякщо код 200: тоді така сама структура, як в sendOnBoard\n*/","outputs":1,"noerr":0,"x":150,"y":400,"wires":[["995607c9.2d02c8","6d0ef94e.b062d8","452638dc.949cd8"]]},{"id":"b458bb3f.090d28","type":"switch","z":"8159ee58.1d12f","name":"","property":"triger_route","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":150,"y":580,"wires":[["b1859dc9.fff1e"]]},{"id":"d3976c07.c3f67","type":"serial in","z":"1aa5e479.1c12dc","name":"Сканер весов 2","serial":"370cd167.ca739e","x":100,"y":160,"wires":[["73d3d258.a40bac","f52f19af.020d08"]]},{"id":"cec3d107.0177d","type":"http request","z":"1aa5e479.1c12dc","name":"","method":"POST","ret":"txt","url":"http://192.168.11.30/gppves/hs/PerimeterControl/api/SmartScales/GetWeigt","tls":"","x":870,"y":200,"wires":[["e02b86bc.d7cd98","457b19ab.4c1c68","9a918ab3.5e03f8","c878a9ca.792bd8"]]},{"id":"4ab69084.7f72b","type":"link in","z":"8159ee58.1d12f","name":"","links":["3c2a916b.d32bce","1b84a8ba.d42597"],"x":35,"y":420,"wires":[["c0c11542.8bb108"]]},{"id":"5152fdd6.56d0e4","type":"function","z":"8159ee58.1d12f","name":"check successful","func":"if(msg.statusCode == 200){\n    msg.payload = \"Данные успешно получены\";\n}\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":420,"wires":[["dd30f4a9.464318"]]},{"id":"d60beb52.819028","type":"function","z":"8159ee58.1d12f","name":"","func":"//msg.payload = \"Сканируйте пропуск\";\n\nvar triger_route = flow.get(\"triger_route\");\n\nif(triger_route === true){\n    msg.payload = \"_\";\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":40,"wires":[["b6356e88.b022c"]]},{"id":"c2eb02e5.de1ed","type":"link out","z":"8159ee58.1d12f","name":"блокування сканера","links":["8bc15d9.5d964a"],"x":995,"y":420,"wires":[]},{"id":"dd30f4a9.464318","type":"function","z":"8159ee58.1d12f","name":"block scaner","func":"if(msg.statusCode != 403){\n    msg.payload = 1;\n}\nreturn msg;\n","outputs":1,"noerr":0,"x":870,"y":420,"wires":[["c2eb02e5.de1ed"]]},{"id":"9031af86.4df7b","type":"http in","z":"1aa5e479.1c12dc","name":"","url":"/sendOnBoard","method":"post","swaggerDoc":"","x":154,"y":959,"wires":[["7dbeac47.7312c4","93aebec9.d3441","b8a9742.5339f88","785a9632.c18e98"]]},{"id":"7dbeac47.7312c4","type":"function","z":"1aa5e479.1c12dc","name":"","func":"flow.set(\"disp_text\", msg.payload.disp_text);\nflow.set(\"board_text\", msg.payload.board_text);\n//error message\nflow.set(\"ТекстОшибкиТабло\", msg.payload.ТекстОшибкиТабло);\nflow.set(\"КраткоеОписаниеОшибки\", msg.payload.КраткоеОписаниеОшибки);\nflow.set(\"ПолноеОписаниеОшибки\", msg.payload.ПолноеОписаниеОшибки);\nreturn msg;","outputs":1,"noerr":0,"x":490,"y":920,"wires":[["3c2a916b.d32bce"]]},{"id":"93aebec9.d3441","type":"http response","z":"1aa5e479.1c12dc","name":"","x":492,"y":881,"wires":[]},{"id":"3c2a916b.d32bce","type":"link out","z":"1aa5e479.1c12dc","name":"3 1c для табло","links":["4ab69084.7f72b"],"x":622,"y":919,"wires":[]},{"id":"c345e9d2.2fd5e8","type":"debug","z":"1aa5e479.1c12dc","name":"sendOnBoard","active":true,"console":"true","complete":"payload","x":658,"y":959,"wires":[]},{"id":"ad6bf652.72b2f8","type":"function","z":"8159ee58.1d12f","name":"Clear monitor","func":"if(msg.payload === 0){\n\nmsg.payload = {};\n    return msg;\n}\n\n","outputs":1,"noerr":0,"x":240,"y":660,"wires":[["7472e300.1c006c","ca222ed.e97cad"]]},{"id":"1b84a8ba.d42597","type":"link out","z":"1aa5e479.1c12dc","name":"ожидайте","links":["46360d9b.d64544","4ab69084.7f72b"],"x":1155,"y":200,"wires":[]},{"id":"46360d9b.d64544","type":"link in","z":"8159ee58.1d12f","name":"","links":["1b84a8ba.d42597"],"x":35,"y":120,"wires":[["8bd5bd3e.4e0d7"]]},{"id":"8bd5bd3e.4e0d7","type":"function","z":"8159ee58.1d12f","name":"ожидайте","func":"if(msg.statusCode == 200){\n    flow.set(\"status_code\", 2);\n    msg.payload = \"Очікуйте, виконується запит\";\n    flow.set(\"triger_route\", true);\n    msg.status_messege = \"Очікуйте, виконується запит\"\n    return msg;\n}\n","outputs":1,"noerr":0,"x":140,"y":120,"wires":[["a4a1bdf.b0d694"]]},{"id":"73d3d258.a40bac","type":"debug","z":"1aa5e479.1c12dc","name":"qr with scanner","active":true,"console":"true","complete":"payload","x":330,"y":160,"wires":[]},{"id":"f52f19af.020d08","type":"delay","z":"1aa5e479.1c12dc","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"5","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":200,"y":200,"wires":[["a4cacf26.1a6a8"]]},{"id":"f5a0d90a.d11e58","type":"switch","z":"8159ee58.1d12f","name":"","property":"status_code","propertyType":"flow","rules":[{"t":"eq","v":"0","vt":"num"},{"t":"neq","v":"0","vt":"num"}],"checkall":"true","outputs":2,"x":318,"y":67,"wires":[["d60beb52.819028"],["a4a1bdf.b0d694"]]},{"id":"a4a1bdf.b0d694","type":"function","z":"8159ee58.1d12f","name":"","func":"var code = msg.status_messege;\n\nmsg.payload = code;\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":80,"wires":[["ee762466.a90998"]]},{"id":"ba1a3bfd.103468","type":"debug","z":"8159ee58.1d12f","name":"","active":true,"console":"false","complete":"true","x":1170,"y":260,"wires":[]},{"id":"ee762466.a90998","type":"ui_template","z":"8159ee58.1d12f","group":"77758a63.fa9364","name":"","order":0,"width":"6","height":"2","format":"<style>\n   #help_s {\n    font-size:30px;\n    font-weight:bold;\n    color: red;  \n   }\n</style>\n\n\n\n<div id=\"help_s\" ng-bind-html=\"msg.payload\"></div>","storeOutMessages":false,"fwdInMessages":false,"x":806.5000076293945,"y":55.75000047683716,"wires":[[]]},{"id":"ee41091b.b62608","type":"link in","z":"1aa5e479.1c12dc","name":"очитска перемених","links":["7472e300.1c006c"],"x":55,"y":420,"wires":[["b2313fb2.e7678"]]},{"id":"e1fd0f71.2ed0d","type":"function","z":"1aa5e479.1c12dc","name":"clear r,t,q","func":"flow.set(\"route_id\", \"\");\nflow.set(\"tusk_number\", \"\");\nflow.set(\"qr_code\", \"\");\nflow.set(\"route_uat_guid\", \"\");\nflow.set(\"recipient_guid\", \"\");\nflow.set(\"nomenclature_guid\",\"\");\n\nflow.set(\"time_in\", \"\");\nflow.set(\"time_out\", \"\");\nflow.set(\"plant_id\", \"\");\n\n\n//нові змінні\n\nflow.set(\"disp_text\", \"\");\nflow.set(\"board_text\", \"\");\n//error message\nflow.set(\"ТекстОшибкиТабло\", \"\");\nflow.set(\"КраткоеОписаниеОшибки\", \"\");\nflow.set(\"ПолноеОписаниеОшибки\", \"\");\nflow.set(\"qr_code_2\",\"\");\nreturn msg;\n","outputs":1,"noerr":0,"x":620,"y":420,"wires":[[]]},{"id":"7472e300.1c006c","type":"link out","z":"8159ee58.1d12f","name":"","links":["ee41091b.b62608"],"x":515,"y":660,"wires":[]},{"id":"b2313fb2.e7678","type":"function","z":"1aa5e479.1c12dc","name":"send 1C","func":"var qr = flow.get(\"qr_code\");\nvar task_id = flow.get(\"tusk_number\");\nmsg.payload = {\n    truck_id:qr,\n    weight:0,\n    stable: true,\n    device_id:\"barcode3\",\n    route_id: 0,\n    task_id:0\n};\nmsg.replay = false;\nreturn msg;","outputs":1,"noerr":0,"x":220,"y":420,"wires":[["21db2c2f.78b7e4","e3dd8268.521a","118aa470.30c02c"]]},{"id":"21db2c2f.78b7e4","type":"delay","z":"1aa5e479.1c12dc","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":440,"y":420,"wires":[["e1fd0f71.2ed0d"]]},{"id":"a1da99bf.899408","type":"inject","z":"1aa5e479.1c12dc","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"x":110,"y":60,"wires":[["cbc0f7c0.6f8f38"]]},{"id":"cbc0f7c0.6f8f38","type":"function","z":"1aa5e479.1c12dc","name":"to_first","func":"flow.set(\"to_first\", false);\nreturn msg;","outputs":1,"noerr":0,"x":290,"y":60,"wires":[[]]},{"id":"e02b86bc.d7cd98","type":"function","z":"1aa5e479.1c12dc","name":"","func":"var replat = msg.replay;\nif(replat === true){\n\nreturn msg;\n}","outputs":1,"noerr":0,"x":1030,"y":200,"wires":[["1b84a8ba.d42597","f6bbbfa5.05687"]]},{"id":"f6bbbfa5.05687","type":"debug","z":"1aa5e479.1c12dc","name":"","active":false,"console":"false","complete":"true","x":1190,"y":240,"wires":[]},{"id":"a4cacf26.1a6a8","type":"function","z":"1aa5e479.1c12dc","name":"check last qr code","func":"var last_qr = flow.get(\"qr_code\");\nvar qr = msg.payload;\nvar len_qr = qr.length;\n\nqr = qr.substring(0,len_qr - 1);\n\nmsg.qr = qr;\n\nif ((last_qr) && (last_qr !== qr)){\n    msg.stop = true;\n}else{\n    msg.stop = false;\n}\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":200,"wires":[["5fe4a8ab.e1c0d8"]]},{"id":"5fe4a8ab.e1c0d8","type":"switch","z":"1aa5e479.1c12dc","name":"","property":"stop","propertyType":"msg","rules":[{"t":"false"}],"checkall":"true","outputs":1,"x":550,"y":200,"wires":[["c5fa97fc.e1a4f8"]]},{"id":"c5fa97fc.e1a4f8","type":"function","z":"1aa5e479.1c12dc","name":"send 1C","func":"msg.payload = {\n    truck_id:msg.qr,\n    device_id:\"barcode3\",\n    //device_id: msg.payload.device_id \n};\nmsg.replay = true;\nflow.set(\"qr_code\", msg.qr);\nreturn msg;","outputs":1,"noerr":0,"x":700,"y":200,"wires":[["cec3d107.0177d","eaa055e3.a72d68","495ed775.2f2158"]]},{"id":"3b990962.e09fb6","type":"debug","z":"1aa5e479.1c12dc","name":"send 1C","active":true,"console":"true","complete":"payload","x":970,"y":280,"wires":[]},{"id":"2fefe56d.6459aa","type":"inject","z":"1aa5e479.1c12dc","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"x":450,"y":380,"wires":[["e1fd0f71.2ed0d"]]},{"id":"2b4cbde.a552f42","type":"http in","z":"78179ed1.3521c","name":"","url":"/sendToPrinter","method":"post","swaggerDoc":"","x":203,"y":110.71430206298828,"wires":[["5305ffe8.360b4","4c84edfb.184554","29195877.20d508","1cd29974.367137"]]},{"id":"a75e8c5b.ad78d","type":"function","z":"78179ed1.3521c","name":"query params","func":"//var pdf = msg.payload.pdf;\n//msg.payload = new Buffer(pdf);\n//msg.payload = pdf;\nmsg.filename     = \"/distr/data/print\"+\".pdf\";\n\nreturn msg;","outputs":1,"noerr":0,"x":537.2857208251953,"y":112.28573036193848,"wires":[["6112ebb.0e43a14","227e176b.0c7568"]]},{"id":"6112ebb.0e43a14","type":"file","z":"78179ed1.3521c","name":"","filename":"","appendNewline":true,"createDir":false,"overwriteFile":"true","x":708.8571243286133,"y":114.14292526245117,"wires":[]},{"id":"5305ffe8.360b4","type":"debug","z":"78179ed1.3521c","name":"","active":false,"console":"false","complete":"true","x":499,"y":157.85712432861328,"wires":[]},{"id":"4c84edfb.184554","type":"http response","z":"78179ed1.3521c","name":"","x":503.1428527832031,"y":77,"wires":[]},{"id":"227e176b.0c7568","type":"debug","z":"78179ed1.3521c","name":"","active":false,"console":"false","complete":"true","x":692,"y":160.71430206298828,"wires":[]},{"id":"4e706d03.e24264","type":"inject","z":"78179ed1.3521c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":204,"y":294.7143020629883,"wires":[["48919b1b.2a3fb4"]]},{"id":"e31cd560.daebf8","type":"debug","z":"78179ed1.3521c","name":"","active":false,"console":"false","complete":"false","x":504,"y":281.7143020629883,"wires":[]},{"id":"48919b1b.2a3fb4","type":"exec","z":"78179ed1.3521c","command":"ls data","addpay":false,"append":"","useSpawn":"","timer":"","name":"","x":349,"y":304.2143020629883,"wires":[["e31cd560.daebf8"],[],[]]},{"id":"1cd29974.367137","type":"base64","z":"78179ed1.3521c","name":"","action":"","property":"payload","x":391,"y":202.71429443359375,"wires":[["fa858231.5bafb","a75e8c5b.ad78d"]]},{"id":"fa858231.5bafb","type":"debug","z":"78179ed1.3521c","name":"","active":false,"console":"false","complete":"true","x":545,"y":200.71429443359375,"wires":[]},{"id":"eaa055e3.a72d68","type":"json","z":"1aa5e479.1c12dc","name":"","x":830,"y":280,"wires":[["3b990962.e09fb6"]]},{"id":"5449fef4.cc2bc","type":"debug","z":"1aa5e479.1c12dc","name":"Обнулення","active":false,"console":"true","complete":"payload","x":500,"y":320,"wires":[]},{"id":"b8a9742.5339f88","type":"json","z":"1aa5e479.1c12dc","name":"","x":488,"y":959,"wires":[["c345e9d2.2fd5e8"]]},{"id":"e3dd8268.521a","type":"json","z":"1aa5e479.1c12dc","name":"","x":350,"y":320,"wires":[["5449fef4.cc2bc"]]},{"id":"cd12ec15.6ef2f","type":"debug","z":"78179ed1.3521c","name":"sendToPrinter","active":false,"console":"true","complete":"payload","x":522,"y":27,"wires":[]},{"id":"29195877.20d508","type":"function","z":"78179ed1.3521c","name":"get pdf","func":"msg.payload = \"get pdf\";\nreturn msg;","outputs":1,"noerr":0,"x":335,"y":25,"wires":[["cd12ec15.6ef2f"]]},{"id":"457b19ab.4c1c68","type":"function","z":"1aa5e479.1c12dc","name":"parse res","func":"var text = msg.payload;\n\nmsg.payload = {\n    textz: text,\n    qr:msg.qr,\n    statusCode:msg.statusCode,\n    \n};\n\n//delete msg.payload;\ndelete msg.qr;\ndelete msg.statusCode;\ndelete msg.headers;\ndelete msg.responseUrl;\ndelete msg._msgid;\n\nreturn msg;","outputs":1,"noerr":0,"x":1020,"y":80,"wires":[["dfcb2457.54e988"]]},{"id":"2e0ab0ba.a8ddc","type":"debug","z":"1aa5e479.1c12dc","name":"res 1C","active":false,"console":"true","complete":"payload","x":1288,"y":80,"wires":[]},{"id":"dfcb2457.54e988","type":"json","z":"1aa5e479.1c12dc","name":"","x":1156,"y":79,"wires":[["2e0ab0ba.a8ddc"]]},{"id":"9a918ab3.5e03f8","type":"debug","z":"1aa5e479.1c12dc","name":"","active":true,"console":"false","complete":"true","x":1030,"y":160,"wires":[]},{"id":"b6356e88.b022c","type":"trigger","z":"8159ee58.1d12f","op1":"","op2":"_","op1type":"pay","op2type":"str","duration":"1","extend":false,"units":"s","reset":"","name":"m","x":600,"y":45,"wires":[["ee762466.a90998"]]},{"id":"5700b22c.a7292c","type":"inject","z":"1aa5e479.1c12dc","name":"","topic":"","payload":"TT0002 ","payloadType":"str","repeat":"","crontab":"","once":false,"x":110,"y":260,"wires":[["f52f19af.020d08"]]},{"id":"785a9632.c18e98","type":"debug","z":"1aa5e479.1c12dc","name":"sendOnBoard","active":true,"console":"true","complete":"payload","x":518,"y":839,"wires":[]},{"id":"995607c9.2d02c8","type":"debug","z":"8159ee58.1d12f","name":"","active":true,"console":"false","complete":"true","x":350,"y":400,"wires":[]},{"id":"b56c8472.089538","type":"http in","z":"1aa5e479.1c12dc","name":"","url":"/rfid","method":"post","swaggerDoc":"","x":160,"y":640,"wires":[["1e9714ba.26e6fb","ea20d145.2d91b","e7ff97d4.f82198"]]},{"id":"f7590ee7.be8bd","type":"function","z":"1aa5e479.1c12dc","name":"приводиш до нормального формату","func":"msg.replay = true;\nflow.set(\"qr_code_2\", msg.payload.truck_id);\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":680,"wires":[["d721648.9db3698","cec3d107.0177d","495ed775.2f2158"]]},{"id":"1e9714ba.26e6fb","type":"function","z":"1aa5e479.1c12dc","name":"check last qr code","func":"var last_qr = flow.get(\"qr_code_2\");\n//парсю джейсон  \"{\"truck_id\":\"300833B2DDD9014000000000\",\"device_id\":\"192.168.16.70\"}\"\n//var inDate = JSON.parse(msg.payload);\nvar inDate = msg.payload;\nvar qr = inDate.truck_id;\nvar len_qr = qr.length;\n\n//qr = qr.substring(0,len_qr - 1);\n\nmsg.qr = qr;\n\nif ((last_qr) && (last_qr !== qr)){\n    msg.stop = true;\n}else{\n    msg.stop = false;\n}\nmsg.payload = inDate;\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":640,"wires":[["8c2c6ecc.37d47","fd97d0.5d49283"]]},{"id":"8c2c6ecc.37d47","type":"switch","z":"1aa5e479.1c12dc","name":"","property":"stop","propertyType":"msg","rules":[{"t":"false"}],"checkall":"true","outputs":1,"x":610,"y":640,"wires":[["f7590ee7.be8bd"]]},{"id":"c48742ac.b45c","type":"comment","z":"1aa5e479.1c12dc","name":"Віртуальний зчитувач з 1С","info":"","x":160,"y":540,"wires":[]},{"id":"ea20d145.2d91b","type":"debug","z":"1aa5e479.1c12dc","name":"","active":true,"console":"false","complete":"true","x":390,"y":600,"wires":[]},{"id":"d721648.9db3698","type":"debug","z":"1aa5e479.1c12dc","name":"","active":true,"console":"false","complete":"true","x":750,"y":680,"wires":[]},{"id":"fd97d0.5d49283","type":"debug","z":"1aa5e479.1c12dc","name":"","active":false,"console":"false","complete":"true","x":610,"y":600,"wires":[]},{"id":"e7ff97d4.f82198","type":"http response","z":"1aa5e479.1c12dc","name":"","x":390,"y":560,"wires":[]},{"id":"118aa470.30c02c","type":"function","z":"1aa5e479.1c12dc","name":"на 1С","func":"\nreturn msg;","outputs":1,"noerr":0,"x":590,"y":280,"wires":[[]]},{"id":"65b83360.6d0a1c","type":"function","z":"1aa5e479.1c12dc","name":"send 1C old","func":"var task_id = flow.get(\"tusk_number\");\nvar route_id = flow.get(\"route_id\");\nvar route_uat_guid = flow.get(\"route_uat_guid\");\nvar nomenclature_guid = flow.get(\"nomenclature_guid\");\nvar recipient_guid = flow.get(\"recipient_guid\");\nvar time_in = flow.get(\"time_in\");\nvar time_out = flow.get(\"time_out\");\nvar plant_id = flow.get(\"plant_id\");\n\n\nmsg.payload = {\n    truck_id:msg.qr,\n    weight:flow.get(\"weight_qr\"),\n    stable: true,\n    device_id:\"barcode3\",\n    route_id: route_id,\n    task_id:task_id,\n    route_uat_guid:route_uat_guid,\n    recipient_guid: recipient_guid,\n    nomenclature_guid:nomenclature_guid,\n    time_in: time_in,\n    time_out: time_out,\n    plant_id: plant_id\n};\nmsg.replay = true;\nflow.set(\"qr_code\", msg.qr);\nreturn msg;","outputs":1,"noerr":0,"x":710,"y":160,"wires":[[]]},{"id":"17188cff.f5a393","type":"function","z":"1aa5e479.1c12dc","name":"clear r,t,q old","func":"flow.set(\"route_id\", \"\");\nflow.set(\"tusk_number\", \"\");\nflow.set(\"qr_code\", \"\");\nflow.set(\"route_uat_guid\", \"\");\nflow.set(\"recipient_guid\", \"\");\nflow.set(\"nomenclature_guid\",\"\");\n\n\nflow.set(\"time_in\", \"\");\nflow.set(\"time_out\", \"\");\nflow.set(\"plant_id\", \"\");\nreturn msg;\n","outputs":1,"noerr":0,"x":630,"y":380,"wires":[[]]},{"id":"f41043a9.a102a","type":"function","z":"1aa5e479.1c12dc","name":"old","func":"flow.set(\"tusk_number\", msg.payload.task_id);\nflow.set(\"route_id\", msg.payload.route_id);\nflow.set(\"route_uat_guid\", msg.payload.route_uat_guid);\nflow.set(\"recipient_guid\", msg.payload.recipient_guid);\nflow.set(\"nomenclature_guid\", msg.payload.nomenclature_guid);\n\n\nflow.set(\"time_in\", msg.payload.time_in);\nflow.set(\"time_out\", msg.payload.time_out);\nflow.set(\"plant_id\", msg.payload.plant_id);\n\nreturn msg;","outputs":1,"noerr":0,"x":110,"y":920,"wires":[[]]},{"id":"f93b2288.c21d","type":"function","z":"8159ee58.1d12f","name":"triger_route old","func":"function formatDate(date) {\n    var d = new Date(date),\n        month = '' + (d.getMonth() + 1),\n        day = '' + d.getDate(),\n        year = d.getFullYear(),\n        hours = d.getHours(),\n        minutes= d.getMinutes();\n        \n\n    if (month.length < 2) \n        month = '0' + month;\n    if (day.length < 2) \n        day = '0' + day;\n    if (hours.length < 2) \n        hours = '0' + hours;\n    if (minutes.length < 2) \n        minutes = '0' + minutes;\n    \n\n    return [day,month,year].join('-')+\" \"+hours+\":0\"+minutes;\n}\n\nvar message_type = msg.payload.message_type;//1 коротке 2 довге\n\n    if(message_type == 1){\n        flow.set(\"triger_route\", true);\n        \n        var task_id = msg.payload.task_id;\n        var route_id = msg.payload.route_id;\n        var time_in  = new Date(msg.payload.time_in);\n        var time_out = new Date(msg.payload.time_out);\n        \n        var typeof_time_in = typeof(msg.payload.time_in);\n        var typeof_time_out = typeof(msg.payload.time_out);\n        \n        \n        if(typeof_time_in == \"string\"){\n           time_in =  msg.payload.time_in;\n        }else{\n           time_in = formatDate(time_in); \n        }\n        if(typeof_time_out == \"string\"){\n           time_out =  msg.payload.time_out;\n        }else{\n           time_out = formatDate(time_out) \n        }\n//            time_in:\"Время на поле: \" + formatDate(time_in),\n//\n        \n        var driver_1 = msg.payload.driver;\n        var driver_id_1 = msg.payload.driver_id;\n        var truck1_1 = msg.payload.truck1;\n        var truck2_1 = msg.payload.truck2;\n        var contractor_1 = msg.payload.contractor;\n        var text_1 = msg.payload.text;\n        //var upload_point = msg.payload.upload_point;\n        var route_name = msg.payload.route_name;\n        flow.set(\"route_id\", route_id);\n        flow.set(\"task_id\", task_id);\n        \n        msg.statusCode = 200;\n        \n        msg.payload = {\n            task_id:\"Номер задачі: \" + task_id,\n            route_id:\"Маршрут: \" + route_name,\n            time_in:\"Время на поле: \" + time_in,\n            time_out:\"Время с поля: \" + \"\"+time_out,\n            truck1:\"Автомобиль: \" + truck1_1,\n            truck2:\"Прицеп: \" + truck2_1,\n            driver:\"Водитель: \" + driver_1,\n            driver_id:\"Номер удостоверения: \" + driver_id_1,\n            contractor:\"Контрагент получатель груза: \" + contractor_1,\n            text: text_1\n        };\n        \n        delete msg.res;\n        delete msg.req;\n        //flow.set(\"delay\", 60);\n        return msg;\n    }else if(message_type == 2){\n        flow.set(\"triger_route\", true);\n        \n        var weight = msg.payload.weight;\n        var truck1 = msg.payload.truck1;\n        var truck2 = msg.payload.truck2;\n        var driver = msg.payload.driver;\n        var driver_id = msg.payload.driver_id;\n        var route = msg.payload.route;\n        var contractor = msg.payload.contractor;\n        var weight_delta = msg.payload.weight_delta;\n        var route_id_two = flow.get(\"route_id\");\n        var task_id_two = flow.get(\"task_id\");\n        var text = msg.payload.text;\n        msg.statusCode = 200;\n        \n        msg.payload = {\n        weight:\"Вес: \" + weight,\n        truck1:\"Автомобиль: \" + truck1,\n        truck2:\"Прицеп: \" + truck2,\n        driver:\"Водитель: \" + driver,\n        driver_id:\"Номер удостоверения: \" + driver_id,\n        route:\"Маршрут: \" + route,\n        contractor:\"Контрагент получатель груза: \" + contractor,\n        weight_delta:\"Отклонение: \" + weight_delta,\n        route_id:\"Номер маршрута: \" + route_id_two,\n        task_id: \"Номер задачі: \" + task_id_two,\n        text: msg.payload.text\n        };\n        \n        \n        delete msg.res;\n        delete msg.req;\n        return msg;\n    }else if(message_type == 3){\n        flow.set(\"triger_route\", true);\n        \n        var weight = msg.payload.weight;\n        var truck1 = msg.payload.truck1;\n        var truck2 = msg.payload.truck2;\n        var driver = msg.payload.driver;\n        var driver_id = msg.payload.driver_id;\n        var route = msg.payload.route;\n        var contractor = msg.payload.contractor;\n        var weight_delta = msg.payload.weight_delta;\n        var route_id_two = msg.payload.task_id;\n        var task_id_two = msg.payload.route_id;\n        var text = msg.payload.text;\n        msg.statusCode = 200;\n        \n        msg.payload = {\n        weight:\"Вес: \" + weight,\n        truck1:\"Автомобиль: \" + truck1,\n        truck2:\"Прицеп: \" + truck2,\n        driver:\"Водитель: \" + driver,\n        driver_id:\"Номер удостоверения: \" + driver_id,\n        route:\"Маршрут: \" + route,\n        contractor:\"Контрагент получатель груза: \" + contractor,\n        weight_delta:\"Отклонение: \" + weight_delta,\n        //route_id:\"Номер маршрута: \" + route_id_two,\n        //task_id: \"Номер задачі: \" + task_id_two,\n        text:text\n        }\n        \n        \n        delete msg.res;\n        delete msg.req;\n        return msg;\n    }else if(msg.statusCode != 200){\n        flow.set(\"triger_route\", true);\n        flow.set(\"respons_scan_send\", msg.payload);\n        \n        /*msg.payload.time_out = \"\";\n        msg.payload.truck_id = \"\";\n        msg.payload.route_id = \"\";\n        msg.payload.time_in = \"\";\n        msg.payload.weight=\"\";\n        msg.payload.truck1=\"\";\n        msg.payload.truck2=\"\" ;\n        msg.payload.driver=\"\";\n        msg.payload.driver_id=\"\";\n        msg.payload.route=\"\";\n        msg.payload.contractor=\"\";\n        msg.payload.weight_delta=\"\";\n        */\n        msg.statusCode = 403;\n        delete msg.res;\n        delete msg.req;\n        return msg;\n    }\n","outputs":1,"noerr":0,"x":160,"y":340,"wires":[[]]},{"id":"a83d69a7.3bd668","type":"inject","z":"8159ee58.1d12f","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"x":130,"y":180,"wires":[["623d4d1f.7423b4"]]},{"id":"623d4d1f.7423b4","type":"function","z":"8159ee58.1d12f","name":"Сканируйте пропуск","func":"msg.payload = {\n    disp_text: `<p class=\"blink\" align=\"center\">Сканируйте пропуск</p>`\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":180,"wires":[["c411007.d9069"]]},{"id":"6d0ef94e.b062d8","type":"function","z":"8159ee58.1d12f","name":"","func":"delete msg.replay;\ndelete msg.statusCode;\ndelete msg.headers;\ndelete msg.responseUrl;\ndelete msg.req;\ndelete msg.res;\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":300,"wires":[["c411007.d9069"]]},{"id":"c411007.d9069","type":"ui_template","z":"8159ee58.1d12f","group":"3e243f43.ece68","name":"","order":0,"width":"16","height":"9","format":"<style>\n   .blink {\n    animation: blink 2s infinite; /* Параметры анимации */\n    color: red;\n    font-size: 250%;\n   }\n   @keyframes blink {\n    from { opacity: 1; /* Непрозрачный текст */ }\n    to { opacity: 0; /* Прозрачный текст */ }\n   }\n   /* Нормальная інформация */\n   .disp_text {\n    font-size: 150%;    \n   }\n   /* Ошибка */\n   .fullerror_table {\n    color: red;\n    font-size: 150%;    \n   }\n   \n   \n</style>\n\n\n\n\n\n<div ng-bind-html=\"msg.payload.disp_text\"></div>","storeOutMessages":true,"fwdInMessages":true,"x":1000,"y":180,"wires":[[]]},{"id":"ca222ed.e97cad","type":"function","z":"8159ee58.1d12f","name":"cleade date ","func":"msg.payload = {\n        disp_text:`<p class=\"blink\" align=\"center\">Сканируйте пропуск</p>`,\n        board_text: \"\"\n    };\nreturn msg;","outputs":1,"noerr":0,"x":290,"y":700,"wires":[["c411007.d9069"]]},{"id":"4ac9763f.a5edb8","type":"inject","z":"b73c3ad4.d39558","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":140,"y":220,"wires":[["957973db.96a35"]]},{"id":"77cc655d.e2ff9c","type":"template","z":"b73c3ad4.d39558","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<?xml version=\"1.0\"?>\n<ledscreens>\n    <ledscreen num=\"1\" strcount=\"1\">\n       <textstring color=\"clRed\" fontname=\"Arial\" fontsize=\"10\">{{payload.board_text}}</textstring>\n    </ledscreen>\n</ledscreens>","x":422,"y":220,"wires":[["c39bc3fd.7a004","da23c1e8.822a5"]]},{"id":"c39bc3fd.7a004","type":"debug","z":"b73c3ad4.d39558","name":"","active":true,"console":"false","complete":"true","x":572,"y":181,"wires":[]},{"id":"bb74821e.8b88c","type":"debug","z":"b73c3ad4.d39558","name":"","active":true,"console":"false","complete":"true","x":802,"y":220,"wires":[]},{"id":"957973db.96a35","type":"function","z":"b73c3ad4.d39558","name":"","func":"msg.headers = {};\nmsg.headers['content-type'] = 'application/xml';\n\ndelete msg.qr;\ndelete msg.stop;\ndelete msg.replay;\n\ndelete msg.statusCode;\nreturn msg;","outputs":1,"noerr":0,"x":282,"y":220,"wires":[["77cc655d.e2ff9c"]]},{"id":"da23c1e8.822a5","type":"http request","z":"b73c3ad4.d39558","name":"","method":"POST","ret":"txt","url":"192.168.11.25:5505","tls":"","x":595,"y":218,"wires":[["bb74821e.8b88c"]]},{"id":"241f2ed7.6757c2","type":"link in","z":"b73c3ad4.d39558","name":"send on board IN","links":["e3323615.687838","452638dc.949cd8"],"x":71,"y":126,"wires":[["cd5e3e6.c611ac"]]},{"id":"cd5e3e6.c611ac","type":"debug","z":"b73c3ad4.d39558","name":"","active":true,"console":"false","complete":"false","x":256,"y":106,"wires":[]},{"id":"452638dc.949cd8","type":"link out","z":"8159ee58.1d12f","name":"","links":["241f2ed7.6757c2"],"x":255,"y":460,"wires":[]},{"id":"3b1a4725.dc1e78","type":"file","z":"1aa5e479.1c12dc","name":"","filename":"info_rfid.txt","appendNewline":true,"createDir":true,"overwriteFile":"false","x":1190,"y":40,"wires":[]},{"id":"c878a9ca.792bd8","type":"function","z":"1aa5e479.1c12dc","name":"log res ","func":"var res1C = JSON.parse(msg.payload);\nlet logs = \"\";\nif(msg.statusCode == 200){\n    msg.payload = JSON.parse(msg.payload);\n    let disp_text= msg.payload.disp_text;//дашборд\n\n    logs = disp_text + \"\";\n\n}else if(msg.statusCode != 200){\n    msg.payload = JSON.parse(msg.payload);\n    let shortErrorTable = msg.payload.КраткоеОписаниеОшибки;\n\n    logs = shortErrorTable + \"\";\n}\n\nmsg.payload = \"res ||   \" + logs + \"  ||  \" + new Date();\nreturn msg;","outputs":1,"noerr":0,"x":1010,"y":40,"wires":[["3b1a4725.dc1e78"]]},{"id":"495ed775.2f2158","type":"json","z":"1aa5e479.1c12dc","name":"","x":950,"y":360,"wires":[["2918f951.5475d6","ee93de4c.b478a"]]},{"id":"2918f951.5475d6","type":"function","z":"1aa5e479.1c12dc","name":"log req","func":"msg.payload = \"req ||\" + msg.payload + \"|| \" + new Date();\nreturn msg;","outputs":1,"noerr":0,"x":1090,"y":360,"wires":[["e1dac503.57db48"]]},{"id":"e1dac503.57db48","type":"file","z":"1aa5e479.1c12dc","name":"","filename":"info_rfid.txt","appendNewline":true,"createDir":true,"overwriteFile":"false","x":1250,"y":360,"wires":[]},{"id":"ee93de4c.b478a","type":"debug","z":"1aa5e479.1c12dc","name":"","active":false,"console":"false","complete":"true","x":1090,"y":440,"wires":[]},{"id":"31bb8e7e.b369c2","type":"inject","z":"1aa5e479.1c12dc","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":900,"y":920,"wires":[["bf7a70c0.e5246"]]},{"id":"bf7a70c0.e5246","type":"file in","z":"1aa5e479.1c12dc","name":"","filename":"info_rfid.txt","format":"utf8","x":1050,"y":920,"wires":[["d1f296be.946bf8"]]},{"id":"d1f296be.946bf8","type":"debug","z":"1aa5e479.1c12dc","name":"","active":true,"console":"false","complete":"false","x":1230,"y":920,"wires":[]},{"id":"f89f8a4f.478408","type":"comment","z":"1aa5e479.1c12dc","name":"Сканер QR","info":"","x":90,"y":120,"wires":[]},{"id":"59eecbb.84c4f34","type":"comment","z":"1aa5e479.1c12dc","name":"Відправка даних на табло і дашборд","info":"","x":170,"y":800,"wires":[]},{"id":"2b81b377.0841ec","type":"inject","z":"1aa5e479.1c12dc","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":542,"y":485,"wires":[["c46e02c1.55ee5"]]},{"id":"c46e02c1.55ee5","type":"function","z":"1aa5e479.1c12dc","name":"","func":"msg.payload = {\n   truck_id: \"E280110520007194F5F908C4\",\ndevice_id: \"192.168.11.195\" \n}\nmsg.replay = true;\nreturn msg;","outputs":1,"noerr":0,"x":648,"y":531,"wires":[["cec3d107.0177d"]]}]
