[{"id":"a1d936f0.8fd578","type":"tab","label":"QR Print"},{"id":"63ae84bb.e9d88c","type":"tab","label":"processing_scale1"},{"id":"59e54d37.cb5764","type":"tab","label":"Дашборд Брутто"},{"id":"24fc6997.927b06","type":"tab","label":"Tablo"},{"id":"a813fd3f.bf0ba","type":"serial-port","z":"","serialport":"/dev/avto","serialbaud":"9600","databits":"8","parity":"none","stopbits":"1","newline":"500","bin":"false","out":"time","addchar":false},{"id":"a90f0abd.b4e328","type":"serial-port","z":"","serialport":"/dev/tablo","serialbaud":"9600","databits":"8","parity":"none","stopbits":"1","newline":"20","bin":"false","out":"time","addchar":false},{"id":"dff105eb.c968d8","type":"socket-io-event","z":"","addr":"getWeight"},{"id":"b580037.dcccd","type":"socket-io-server","z":"","port":"4001"},{"id":"b8711d8c.b1f1e","type":"serial-port","z":"","serialport":"/dev/ttyACM0","serialbaud":"9600","databits":"8","parity":"none","stopbits":"1","newline":"50","bin":"false","out":"time","addchar":false},{"id":"8ef2bae5.dbc728","type":"ui_group","z":"","name":"Вага","tab":"62f9341f.7e661c","order":1,"disp":true,"width":"4"},{"id":"3d45906f.4a34b","type":"ui_group","z":"","name":"Default","tab":"","disp":true,"width":"6"},{"id":"969eecfd.bcbd7","type":"ui_group","z":"","name":"Статус","tab":"62f9341f.7e661c","order":2,"disp":true,"width":"7"},{"id":"62f9341f.7e661c","type":"ui_tab","z":"","name":"Prod","icon":"dashboard","order":2},{"id":"7a2b7e8.828798","type":"ui_group","z":"","name":"Данные","tab":"62f9341f.7e661c","order":4,"disp":true,"width":"8"},{"id":"5955c878.c39c88","type":"ui_group","z":"","name":"Таймер","tab":"62f9341f.7e661c","order":3,"disp":true,"width":"5"},{"id":"ec317965.a021a8","type":"ui_group","z":"","name":"Данные транспортного средства","tab":"62f9341f.7e661c","order":6,"disp":true,"width":"9"},{"id":"293e3139.8c771e","type":"ui_group","z":"","name":"Текст","tab":"62f9341f.7e661c","order":5,"disp":true,"width":"9"},{"id":"a2adcf32.29894","type":"serial-port","z":"","serialport":"/dev/avto","serialbaud":"9600","databits":"8","parity":"none","stopbits":"1","newline":"500","bin":"false","out":"time","addchar":false},{"id":"624b2132.a5725","type":"serial-port","z":"","serialport":"/dev/tablo","serialbaud":"9600","databits":"8","parity":"none","stopbits":"1","newline":"20","bin":"false","out":"time","addchar":false},{"id":"a78fc2f.59d4b4","type":"socket-io-event","z":"","addr":"getWeight"},{"id":"528fca50.9b6374","type":"socket-io-server","z":"","port":"4001"},{"id":"93137f98.35b7b","type":"serial-port","z":"","serialport":"/dev/ttyACM0","serialbaud":"9600","databits":"8","parity":"none","stopbits":"1","newline":"50","bin":"false","out":"time","addchar":false},{"id":"ec5daa5b.96a128","type":"ui_group","z":"","name":"Інформація","tab":"62f9341f.7e661c","disp":true,"width":"16"},{"id":"674fe5af.825ddc","type":"function","z":"59e54d37.cb5764","name":"Counter","func":"var count = flow.get(\"delay\");\n\ncount = count - 1;\n\nmsg.payload = count;\nflow.set(\"delay\", count);\n\nif(count === 0){\nflow.set(\"delay\", 30); \nflow.set(\"triger_route\", false);\nflow.set(\"status_code\", 0);\n\n\n}\nreturn msg;","outputs":1,"noerr":0,"x":248.71429061889648,"y":612.8571586608887,"wires":[["82420fc0.0a576","308f748c.398f6c"]]},{"id":"e84dbf61.e3cab","type":"inject","z":"59e54d37.cb5764","name":"","topic":"","payload":"","payloadType":"date","repeat":"1","crontab":"","once":false,"x":122.85714721679688,"y":705.7142581939697,"wires":[["e4f2fec3.18847"]]},{"id":"2b4c6d49.719402","type":"function","z":"59e54d37.cb5764","name":"init","func":"flow.set(\"delay\", 30);\nflow.set(\"triger_route\", false);\nflow.set(\"status_code\", 0);\nreturn msg;","outputs":1,"noerr":0,"x":287,"y":26,"wires":[[]]},{"id":"aec06adb.d4f288","type":"inject","z":"59e54d37.cb5764","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"x":134,"y":27,"wires":[["2b4c6d49.719402"]]},{"id":"e4f2fec3.18847","type":"switch","z":"59e54d37.cb5764","name":"","property":"triger_route","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":98.5714225769043,"y":612.8571491241455,"wires":[["674fe5af.825ddc"]]},{"id":"7b984263.da4e6c","type":"serial in","z":"63ae84bb.e9d88c","name":"Сканер весов 2","serial":"93137f98.35b7b","x":100,"y":120,"wires":[["9ae41a8b.ec4b78","4d747ea1.cee81"]]},{"id":"9bb712e.9948cf","type":"http request","z":"63ae84bb.e9d88c","name":"","method":"POST","ret":"txt","url":"http://192.168.16.145/nplves/hs/PerimeterControl/api/SmartScales/GetWeigt","tls":"","x":830,"y":180,"wires":[["3812fe42.963df2","8e235082.8c37a","85abf94.be69308"]]},{"id":"53380242.e2d82c","type":"link in","z":"59e54d37.cb5764","name":"","links":["a34cf53e.cd6aa8","871e44bb.43e278"],"x":55,"y":380,"wires":[["9a29ae39.b154f","ebf1b3f2.e886"]]},{"id":"21049af7.ee84f6","type":"http in","z":"63ae84bb.e9d88c","name":"","url":"/sendOnBoard","method":"post","swaggerDoc":"","x":150,"y":1020,"wires":[["3cc9663b.a3ac7a","218219f5.314276","a19c7536.2586c8","279a49b9.733256"]]},{"id":"bdd6e6.0230a918","type":"function","z":"63ae84bb.e9d88c","name":"info from Отримаєм з 1С","func":"flow.set(\"tusk_number\", msg.payload.task_id);\nflow.set(\"route_id\", msg.payload.route_id);\nflow.set(\"route_uat_guid\", msg.payload.route_uat_guid);\nflow.set(\"recipient_guid\", msg.payload.recipient_guid);\nflow.set(\"nomenclature_guid\", msg.payload.nomenclature_guid);\n\n\nflow.set(\"time_in\", msg.payload.time_in);\nflow.set(\"time_out\", msg.payload.time_out);\nflow.set(\"plant_id\", msg.payload.plant_id);\nreturn msg;","outputs":1,"noerr":0,"x":1429.2857055664062,"y":611.1427612304688,"wires":[[]]},{"id":"3cc9663b.a3ac7a","type":"http response","z":"63ae84bb.e9d88c","name":"","x":430,"y":980,"wires":[]},{"id":"a34cf53e.cd6aa8","type":"link out","z":"63ae84bb.e9d88c","name":"3 1c для табло","links":["53380242.e2d82c"],"x":515,"y":900,"wires":[]},{"id":"fec898c2.9bbfb8","type":"debug","z":"63ae84bb.e9d88c","name":"sendOnBoard","active":false,"console":"true","complete":"payload","x":600,"y":1020,"wires":[]},{"id":"82420fc0.0a576","type":"function","z":"59e54d37.cb5764","name":"Clear monitor","func":"if(msg.payload === 0){\n\nmsg.payload = {};\n    return msg;\n}\n\n","outputs":1,"noerr":0,"x":421.42862701416016,"y":617.1428475379944,"wires":[["5839a64a.0de4f8","3da685d5.2f6dba","8fb8612a.77add"]]},{"id":"5839a64a.0de4f8","type":"function","z":"59e54d37.cb5764","name":"cleade date ","func":"msg.payload = {\n        disp_text:`<p class=\"blink\" align=\"center\">Сканируйте пропуск</p>`,\n        board_text: \"\"\n    };\nreturn msg;","outputs":1,"noerr":0,"x":635.7142639160156,"y":605.7143287658691,"wires":[["d351692b.efa278"]]},{"id":"871e44bb.43e278","type":"link out","z":"63ae84bb.e9d88c","name":"ожидайте","links":["f072a1c.619226","53380242.e2d82c"],"x":1155,"y":220,"wires":[]},{"id":"9ae41a8b.ec4b78","type":"debug","z":"63ae84bb.e9d88c","name":"qr with scanner","active":true,"console":"true","complete":"payload","x":330,"y":120,"wires":[]},{"id":"4d747ea1.cee81","type":"delay","z":"63ae84bb.e9d88c","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"10","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":180,"y":180,"wires":[["f79257cc.589f28"]]},{"id":"3da685d5.2f6dba","type":"debug","z":"59e54d37.cb5764","name":"Clear monitor","active":true,"console":"true","complete":"payload","x":642.8571662902832,"y":654.2857723236084,"wires":[]},{"id":"fc327319.c52da","type":"link in","z":"63ae84bb.e9d88c","name":"очитска перемених","links":["8fb8612a.77add"],"x":75,"y":740,"wires":[["c6498b5f.2a9b78"]]},{"id":"e689ac4e.53eb3","type":"function","z":"63ae84bb.e9d88c","name":"clear r,t,q","func":"flow.set(\"route_id\", \"\");\nflow.set(\"tusk_number\", \"\");\nflow.set(\"qr_code\", \"\");\nflow.set(\"route_uat_guid\", \"\");\nflow.set(\"recipient_guid\", \"\");\nflow.set(\"nomenclature_guid\",\"\");\n\nflow.set(\"time_in\", \"\");\nflow.set(\"time_out\", \"\");\nflow.set(\"plant_id\", \"\");\n\n\n//нові змінні\n\nflow.set(\"disp_text\", \"\");\nflow.set(\"board_text\", \"\");\n//error message\nflow.set(\"ТекстОшибкиТабло\", \"\");\nflow.set(\"КраткоеОписаниеОшибки\", \"\");\nflow.set(\"ПолноеОписаниеОшибки\", \"\");\nflow.set(\"qr_code_2\",\"\");\nreturn msg;\n","outputs":1,"noerr":0,"x":520,"y":740,"wires":[[]]},{"id":"8fb8612a.77add","type":"link out","z":"59e54d37.cb5764","name":"","links":["fc327319.c52da"],"x":572.7142581939697,"y":703.1428451538086,"wires":[]},{"id":"c6498b5f.2a9b78","type":"function","z":"63ae84bb.e9d88c","name":"send 1C","func":"var qr = flow.get(\"qr_code\");\nmsg.payload = {\n    truck_id:qr,\n    device_id:\"barcode3\",\n};\nmsg.replay = false;//після таймера для обнулення і щоб результат не в\n//виводився на дашборд\nreturn msg;","outputs":1,"noerr":0,"x":180,"y":740,"wires":[["debc512e.bc82d","96f1b5d9.316998"]]},{"id":"debc512e.bc82d","type":"delay","z":"63ae84bb.e9d88c","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":360,"y":740,"wires":[["e689ac4e.53eb3"]]},{"id":"3812fe42.963df2","type":"function","z":"63ae84bb.e9d88c","name":"","func":"var replat = msg.replay;\nif(replat === true){\n\nreturn msg;\n}","outputs":1,"noerr":0,"x":1030,"y":260,"wires":[["871e44bb.43e278","29a8b99e.e32296"]]},{"id":"29a8b99e.e32296","type":"debug","z":"63ae84bb.e9d88c","name":"","active":false,"console":"false","complete":"payload","x":1210,"y":260,"wires":[]},{"id":"f79257cc.589f28","type":"function","z":"63ae84bb.e9d88c","name":"check last qr code","func":"var last_qr = flow.get(\"qr_code\");\nvar qr = msg.payload;\nvar len_qr = qr.length;\n\nqr = qr.substring(0,len_qr - 1);\n\nmsg.qr = qr;\n\nif ((last_qr) && (last_qr !== qr)){\n    msg.stop = true;\n}else{\n    msg.stop = false;\n}\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":180,"wires":[["f2ef2a59.b86728"]]},{"id":"f2ef2a59.b86728","type":"switch","z":"63ae84bb.e9d88c","name":"","property":"stop","propertyType":"msg","rules":[{"t":"false"}],"checkall":"true","outputs":1,"x":530,"y":180,"wires":[["233aec4d.6bebc4"]]},{"id":"233aec4d.6bebc4","type":"function","z":"63ae84bb.e9d88c","name":"send 1C","func":"msg.payload = {\n    truck_id:msg.qr,\n    device_id:\"barcode3\",\n    //device_id: msg.payload.device_id \n};\nmsg.replay = true;\nflow.set(\"qr_code\", msg.qr);\nreturn msg;","outputs":1,"noerr":0,"x":660,"y":180,"wires":[["9bb712e.9948cf","80bcaaba.109768","4149f16b.42148"]]},{"id":"b12476c2.328be8","type":"debug","z":"63ae84bb.e9d88c","name":"send 1C","active":true,"console":"true","complete":"payload","x":770,"y":120,"wires":[]},{"id":"567a7d89.72e1c4","type":"inject","z":"63ae84bb.e9d88c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"x":370,"y":700,"wires":[["e689ac4e.53eb3"]]},{"id":"3f3a3db1.895042","type":"http in","z":"a1d936f0.8fd578","name":"","url":"/sendToPrinter","method":"post","swaggerDoc":"","x":203,"y":110.71430206298828,"wires":[["236fb207.42435e","c595776.2e16e88","66f13414.92adac","165c78b4.a8b407"]]},{"id":"b5f6fdb9.b71b5","type":"function","z":"a1d936f0.8fd578","name":"query params","func":"//var pdf = msg.payload.pdf;\n//msg.payload = new Buffer(pdf);\n//msg.payload = pdf;\nmsg.filename     = \"/distr/data/print\"+\".pdf\";\n\nreturn msg;","outputs":1,"noerr":0,"x":537.2857208251953,"y":112.28573036193848,"wires":[["95ab863f.385b68","9d534365.2e0fd"]]},{"id":"95ab863f.385b68","type":"file","z":"a1d936f0.8fd578","name":"","filename":"","appendNewline":true,"createDir":false,"overwriteFile":"true","x":708.8571243286133,"y":114.14292526245117,"wires":[]},{"id":"236fb207.42435e","type":"debug","z":"a1d936f0.8fd578","name":"","active":true,"console":"false","complete":"true","x":499,"y":157.85712432861328,"wires":[]},{"id":"c595776.2e16e88","type":"http response","z":"a1d936f0.8fd578","name":"","x":503.1428527832031,"y":77,"wires":[]},{"id":"9d534365.2e0fd","type":"debug","z":"a1d936f0.8fd578","name":"","active":false,"console":"false","complete":"true","x":710,"y":160,"wires":[]},{"id":"5bb35196.1666f","type":"inject","z":"a1d936f0.8fd578","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":204,"y":294.7143020629883,"wires":[["3d479f98.7427c"]]},{"id":"ad2c02d7.ebba8","type":"debug","z":"a1d936f0.8fd578","name":"","active":true,"console":"false","complete":"false","x":504,"y":281.7143020629883,"wires":[]},{"id":"3d479f98.7427c","type":"exec","z":"a1d936f0.8fd578","command":"ls data","addpay":false,"append":"","useSpawn":"","timer":"","name":"","x":349,"y":304.2143020629883,"wires":[["ad2c02d7.ebba8"],[],[]]},{"id":"66f13414.92adac","type":"base64","z":"a1d936f0.8fd578","name":"","action":"","property":"payload","x":372,"y":206.71430206298828,"wires":[["b5f6fdb9.b71b5","4b9c00f8.94cd6"]]},{"id":"ba855ab1.eac1c8","type":"debug","z":"a1d936f0.8fd578","name":"pdf","active":true,"console":"true","complete":"payload","x":682,"y":204.71429443359375,"wires":[]},{"id":"80bcaaba.109768","type":"json","z":"63ae84bb.e9d88c","name":"","x":630,"y":120,"wires":[["b12476c2.328be8"]]},{"id":"5b17bcc3.018c24","type":"debug","z":"63ae84bb.e9d88c","name":"Обнулення","active":false,"console":"true","complete":"payload","x":514.7142715454102,"y":789.2857036590576,"wires":[]},{"id":"218219f5.314276","type":"json","z":"63ae84bb.e9d88c","name":"","x":430,"y":1020,"wires":[["fec898c2.9bbfb8"]]},{"id":"96f1b5d9.316998","type":"json","z":"63ae84bb.e9d88c","name":"","x":356.2856903076172,"y":778.714241027832,"wires":[["5b17bcc3.018c24"]]},{"id":"d97262dc.29b87","type":"debug","z":"a1d936f0.8fd578","name":"sendToPrinter","active":true,"console":"true","complete":"payload","x":522,"y":27,"wires":[]},{"id":"165c78b4.a8b407","type":"function","z":"a1d936f0.8fd578","name":"get pdf","func":"msg.payload = \"get pdf\";\nreturn msg;","outputs":1,"noerr":0,"x":335,"y":25,"wires":[["d97262dc.29b87"]]},{"id":"8e235082.8c37a","type":"function","z":"63ae84bb.e9d88c","name":"parse res","func":"var text = msg.payload;\n\nmsg.payload = {\n    textz: text,\n    qr:msg.qr,\n    statusCode:msg.statusCode,\n    \n};\n\n//delete msg.payload;\ndelete msg.qr;\ndelete msg.statusCode;\ndelete msg.headers;\ndelete msg.responseUrl;\ndelete msg._msgid;\n\nreturn msg;","outputs":1,"noerr":0,"x":1020,"y":100,"wires":[["91f0596b.278788"]]},{"id":"aa8fa066.36f8f","type":"debug","z":"63ae84bb.e9d88c","name":"res 1C","active":true,"console":"true","complete":"payload","x":1280,"y":100,"wires":[]},{"id":"91f0596b.278788","type":"json","z":"63ae84bb.e9d88c","name":"","x":1150,"y":100,"wires":[["aa8fa066.36f8f"]]},{"id":"a19c7536.2586c8","type":"debug","z":"63ae84bb.e9d88c","name":"sendOnBoard","active":true,"console":"true","complete":"payload","x":460,"y":1060,"wires":[]},{"id":"4b9c00f8.94cd6","type":"base64","z":"a1d936f0.8fd578","name":"","action":"","property":"payload","x":538,"y":207,"wires":[["ba855ab1.eac1c8"]]},{"id":"1ee311ea.a73f5e","type":"comment","z":"63ae84bb.e9d88c","name":"Отримаєм з 1С","info":"","x":120.00001525878906,"y":975.7142477035522,"wires":[]},{"id":"9f7bd594.6a6088","type":"comment","z":"63ae84bb.e9d88c","name":"Очистка змінних після таймера","info":"","x":170,"y":660,"wires":[]},{"id":"dc1fe4bb.32a068","type":"function","z":"59e54d37.cb5764","name":"triger_route","func":"function formatDate(date) {\n    var d = new Date(date),\n        month = '' + (d.getMonth() + 1),\n        day = '' + d.getDate(),\n        year = d.getFullYear(),\n        hours = d.getHours(),\n        minutes= d.getMinutes();\n        \n\n    if (month.length < 2) \n        month = '0' + month;\n    if (day.length < 2) \n        day = '0' + day;\n    if (hours.length < 2) \n        hours = '0' + hours;\n    if (minutes.length < 2) \n        minutes = '0' + minutes;\n    \n\n    return [day,month,year].join('-')+\" \"+hours+\":0\"+minutes;\n}\n\nvar message_type = msg.payload.message_type;//1 коротке 2 довге\n\n    if(message_type == 1){\n        flow.set(\"triger_route\", true);\n        \n        var task_id = msg.payload.task_id;\n        var route_id = msg.payload.route_id;\n        \n        var time_in  = new Date(msg.payload.time_in);\n        var time_out = new Date(msg.payload.time_out);\n        \n        \n        var typeof_time_in = typeof(msg.payload.time_in);\n        var typeof_time_out = typeof(msg.payload.time_out);\n        \n        \n        if(typeof_time_in == \"string\"){\n           time_in =  msg.payload.time_in;\n        }else{\n           time_in = formatDate(time_in); \n        }\n        if(typeof_time_out == \"string\"){\n           time_out =  msg.payload.time_out;\n        }else{\n            time_out = formatDate(time_out) \n        }\n//            time_in:\"Время на поле: \" + formatDate(time_in),\n//            time_out:\"Время с поля: \" + \"\"+formatDate(time_out)        \n        \n        \n        var driver_1 = msg.payload.driver;\n        var driver_id_1 = msg.payload.driver_id;\n        var truck1_1 = msg.payload.truck1;\n        var truck2_1 = msg.payload.truck2;\n        var contractor_1 = msg.payload.contractor;\n        var text_1 = msg.payload.text;\n        //var upload_point = msg.payload.upload_point;\n        var route_name = msg.payload.route_name;\n        flow.set(\"route_id\", route_id);\n        flow.set(\"task_id\", task_id);\n        \n        msg.statusCode = 200;\n        \n        msg.payload = {\n            task_id:\"Номер задачі: \" + task_id,\n            route_id:\"Маршрут: \" + route_name,\n            time_in:\"Время на поле: \" + time_in,\n            time_out:\"Время с поля: \" + \"\"+time_out,\n            truck1:\"Автомобиль: \" + truck1_1,\n            truck2:\"Прицеп: \" + truck2_1,\n            driver:\"Водитель: \" + driver_1,\n            driver_id:\"Номер удостоверения: \" + driver_id_1,\n            contractor:\"Контрагент получатель груза: \" + contractor_1,\n            text: text_1\n        };\n        \n        delete msg.res;\n        delete msg.req;\n        //flow.set(\"delay\", 60);\n        return msg;\n    }else if(message_type == 2){\n        flow.set(\"triger_route\", true);\n        \n        var weight = msg.payload.weight;\n        var truck1 = msg.payload.truck1;\n        var truck2 = msg.payload.truck2;\n        var driver = msg.payload.driver;\n        var driver_id = msg.payload.driver_id;\n        var route = msg.payload.route;\n        var contractor = msg.payload.contractor;\n        var weight_delta = msg.payload.weight_delta;\n        var route_id_two = flow.get(\"route_id\");\n        var task_id_two = flow.get(\"task_id\");\n        var text = msg.payload.text;\n        msg.statusCode = 200;\n        \n        msg.payload = {\n        weight:\"Вес: \" + weight,\n        truck1:\"Автомобиль: \" + truck1,\n        truck2:\"Прицеп: \" + truck2,\n        driver:\"Водитель: \" + driver,\n        driver_id:\"Номер удостоверения: \" + driver_id,\n        route:\"Маршрут: \" + route,\n        contractor:\"Контрагент получатель груза: \" + contractor,\n        weight_delta:\"Отклонение: \" + weight_delta,\n        route_id:\"Номер маршрута: \" + route_id_two,\n        task_id: \"Номер задачі: \" + task_id_two,\n        text: msg.payload.text\n        };\n        \n        \n        delete msg.res;\n        delete msg.req;\n        return msg;\n    }else if(message_type == 3){\n        flow.set(\"triger_route\", true);\n        \n        var weight = msg.payload.weight;\n        var truck1 = msg.payload.truck1;\n        var truck2 = msg.payload.truck2;\n        var driver = msg.payload.driver;\n        var driver_id = msg.payload.driver_id;\n        var route = msg.payload.route;\n        var contractor = msg.payload.contractor;\n        var weight_delta = msg.payload.weight_delta;\n        var route_id_two = msg.payload.task_id;\n        var task_id_two = msg.payload.route_id;\n        var text = msg.payload.text;\n        msg.statusCode = 200;\n        \n        msg.payload = {\n        weight:\"Вес: \" + weight,\n        truck1:\"Автомобиль: \" + truck1,\n        truck2:\"Прицеп: \" + truck2,\n        driver:\"Водитель: \" + driver,\n        driver_id:\"Номер удостоверения: \" + driver_id,\n        route:\"Маршрут: \" + route,\n        contractor:\"Контрагент получатель груза: \" + contractor,\n        weight_delta:\"Отклонение: \" + weight_delta,\n        //route_id:\"Номер маршрута: \" + route_id_two,\n        //task_id: \"Номер задачі: \" + task_id_two,\n        text:text\n        }\n        \n        \n        delete msg.res;\n        delete msg.req;\n        return msg;\n    }else if(msg.statusCode != 200){\n        flow.set(\"triger_route\", true);\n        flow.set(\"respons_scan_send\", msg.payload);\n        \n        /*msg.payload.time_out = \"\";\n        msg.payload.truck_id = \"\";\n        msg.payload.route_id = \"\";\n        msg.payload.time_in = \"\";\n        msg.payload.weight=\"\";\n        msg.payload.truck1=\"\";\n        msg.payload.truck2=\"\" ;\n        msg.payload.driver=\"\";\n        msg.payload.driver_id=\"\";\n        msg.payload.route=\"\";\n        msg.payload.contractor=\"\";\n        msg.payload.weight_delta=\"\";\n        */\n        msg.statusCode = 403;\n        delete msg.res;\n        delete msg.req;\n        return msg;\n    }\n","outputs":1,"noerr":0,"x":786,"y":384,"wires":[["55dd3b36.0983e4","136d08a0.fec307"]]},{"id":"136d08a0.fec307","type":"debug","z":"59e54d37.cb5764","name":"","active":true,"console":"false","complete":"true","x":958,"y":423,"wires":[]},{"id":"55dd3b36.0983e4","type":"function","z":"59e54d37.cb5764","name":"check successful","func":"if(msg.statusCode == 200){\n    msg.payload = \"Данные успешно получены\";\n}\nreturn msg;","outputs":1,"noerr":0,"x":999,"y":385,"wires":[[]]},{"id":"d351692b.efa278","type":"ui_template","z":"59e54d37.cb5764","group":"ec5daa5b.96a128","name":"","order":0,"width":"16","height":"9","format":"<style>\n   .blink {\n    animation: blink 2s infinite; /* Параметры анимации */\n    color: red;\n    font-size: 250%;\n   }\n   @keyframes blink {\n    from { opacity: 1; /* Непрозрачный текст */ }\n    to { opacity: 0; /* Прозрачный текст */ }\n   }\n   /* Нормальная інформация */\n   .disp_text {\n    font-size: 150%;    \n   }\n   /* Ошибка */\n   .fullerror_table {\n    color: red;\n    font-size: 150%;    \n   }\n   \n   \n</style>\n\n\n\n\n\n<div ng-bind-html=\"msg.payload.disp_text\"></div>","storeOutMessages":true,"fwdInMessages":true,"x":680,"y":140,"wires":[[]]},{"id":"9a29ae39.b154f","type":"function","z":"59e54d37.cb5764","name":"triger_route","func":"flow.set(\"triger_route\", true);//включив таймер\n\nif(msg.statusCode == 200){\n    msg.payload = JSON.parse(msg.payload);\n    let board_text= msg.payload.board_text;//зовнішнє табло\n    let disp_text= msg.payload.disp_text;//дашборд\n\n    msg.payload = {\n        disp_text:`<p class=\"disp_text\">${disp_text}</p>`,\n        board_text: board_text\n    };\n\n}else if(msg.statusCode != 200){\n    msg.payload = JSON.parse(msg.payload);\n    let errorTable = msg.payload.ТекстОшибкиТабло;\n    let shortErrorTable = msg.payload.КраткоеОписаниеОшибки;\n    let fullErrorTable = msg.payload.ПолноеОписаниеОшибки;\n    \n    msg.payload = {\n       disp_text:`<p class=\"fullerror_table\">${shortErrorTable}</p>`,\n       board_text: shortErrorTable\n    };\n} else {\n    msg.payload = {\n       disp_text: `<p class=\"default_error\">\"Ошибка сети, обратитесь к адмінистратору\"</p>`,\n       board_text: `Ошибка сети, обратитесь к адмінистратору`\n    };\n}\nreturn msg;\n/*\nРезультат.Вставить(\"ТекстОшибкиТабло\",\"\");\n  Результат.Вставить(\"КраткоеОписаниеОшибки\",\"\");\n  Результат.Вставить(\"ПолноеОписаниеОшибки\",\"\");\nякщо код 200: тоді така сама структура, як в sendOnBoard\n*/","outputs":1,"noerr":0,"x":190,"y":380,"wires":[["4862f916.86cde8","5df6a287.8ba67c","e3323615.687838"]]},{"id":"33ec72f5.f5367e","type":"inject","z":"59e54d37.cb5764","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"x":150,"y":140,"wires":[["c83b20c4.3516a"]]},{"id":"c83b20c4.3516a","type":"function","z":"59e54d37.cb5764","name":"Сканируйте пропуск","func":"msg.payload = {\n    disp_text: `<p class=\"blink\" align=\"center\">Сканируйте пропуск</p>`\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":360,"y":140,"wires":[["d351692b.efa278"]]},{"id":"279a49b9.733256","type":"function","z":"63ae84bb.e9d88c","name":"new","func":"flow.set(\"disp_text\", msg.payload.disp_text);\nflow.set(\"board_text\", msg.payload.board_text);\n//error message\nflow.set(\"ТекстОшибкиТабло\", msg.payload.ТекстОшибкиТабло);\nflow.set(\"КраткоеОписаниеОшибки\", msg.payload.КраткоеОписаниеОшибки);\nflow.set(\"ПолноеОписаниеОшибки\", msg.payload.ПолноеОписаниеОшибки);\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":900,"wires":[["a34cf53e.cd6aa8"]]},{"id":"3dd7e4c2.f9273c","type":"inject","z":"63ae84bb.e9d88c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":100,"y":860,"wires":[["4729d991.30c6c8"]]},{"id":"4729d991.30c6c8","type":"function","z":"63ae84bb.e9d88c","name":"200","func":"msg.payload = {\n    board_text:\"/sendOnBoard Текст информация = 200\",\n    disp_text: \"/sendOnBoard Текст информация = 200\",\n}\nmsg.statusCode = 200;\nreturn msg;","outputs":1,"noerr":0,"x":230,"y":860,"wires":[["279a49b9.733256"]]},{"id":"8c5073ed.d0973","type":"inject","z":"63ae84bb.e9d88c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":100,"y":900,"wires":[["9ecbf2ab.c5aea"]]},{"id":"9ecbf2ab.c5aea","type":"function","z":"63ae84bb.e9d88c","name":"!= 200","func":"msg.payload = {\n    \"ТекстОшибкиТабло\":\"ТекстОшибкиТабло\",\n    \"КраткоеОписаниеОшибки\":\"КраткоеОписаниеОшибки\",\n    \"ПолноеОписаниеОшибки\":\"ПолноеОписаниеОшибки\"\n};\nmsg.statusCode = 400;\nreturn msg;","outputs":1,"noerr":0,"x":230,"y":900,"wires":[["279a49b9.733256"]]},{"id":"ebf1b3f2.e886","type":"debug","z":"59e54d37.cb5764","name":"","active":true,"console":"false","complete":"true","x":170,"y":340,"wires":[]},{"id":"308f748c.398f6c","type":"debug","z":"59e54d37.cb5764","name":"","active":true,"console":"false","complete":"true","x":450,"y":582,"wires":[]},{"id":"fa768242.15da9","type":"comment","z":"59e54d37.cb5764","name":"Таймер","info":"","x":149.99999999999997,"y":551.9999999999999,"wires":[]},{"id":"b06b46f5.753fa8","type":"inject","z":"63ae84bb.e9d88c","name":"","topic":"","payload":"ТТ0006ТТ","payloadType":"str","repeat":"","crontab":"","once":false,"x":185.71428680419922,"y":257.4285888671875,"wires":[["4d747ea1.cee81"]]},{"id":"af35d1ca.a12ae","type":"function","z":"63ae84bb.e9d88c","name":"send 1C","func":"var task_id = flow.get(\"tusk_number\");\nvar route_id = flow.get(\"route_id\");\nvar route_uat_guid = flow.get(\"route_uat_guid\");\nvar nomenclature_guid = flow.get(\"nomenclature_guid\");\nvar recipient_guid = flow.get(\"recipient_guid\");\nvar time_in = flow.get(\"time_in\");\nvar time_out = flow.get(\"time_out\");\nvar plant_id = flow.get(\"plant_id\");\n\nmsg.payload = {\n    truck_id:msg.qr,\n    weight:flow.get(\"weight_qr\"),\n    stable: true,\n    device_id:\"barcode3\",\n    route_id: route_id,\n    task_id:task_id,\n    route_uat_guid:route_uat_guid,\n    recipient_guid: recipient_guid,\n    nomenclature_guid:nomenclature_guid,\n    time_in: time_in,\n    time_out: time_out,\n    plant_id: plant_id\n};\nmsg.replay = true;\nflow.set(\"qr_code\", msg.qr);\nreturn msg;","outputs":1,"noerr":0,"x":1362,"y":464,"wires":[[]]},{"id":"b05fa95e.520418","type":"function","z":"63ae84bb.e9d88c","name":"send 1C","func":"var qr = flow.get(\"qr_code\");\nvar task_id = flow.get(\"tusk_number\");\nmsg.payload = {\n    truck_id:qr,\n    weight:0,\n    stable: true,\n    device_id:\"barcode3\",\n    route_id: 0,\n    task_id:0\n};\nmsg.replay = false;\nreturn msg;","outputs":1,"noerr":0,"x":1380,"y":544,"wires":[[]]},{"id":"7ec400c3.de2b9","type":"comment","z":"63ae84bb.e9d88c","name":"Очистка змінних після таймера","info":"","x":1396,"y":504,"wires":[]},{"id":"51dd3b3f.3c0ea4","type":"comment","z":"63ae84bb.e9d88c","name":"Авторизація для 1С =","info":"Авторизація для 1С відправки після сканування\nLogin: apiuser\npassword: apiuser","x":1080,"y":140,"wires":[]},{"id":"85abf94.be69308","type":"debug","z":"63ae84bb.e9d88c","name":"","active":true,"console":"false","complete":"true","x":1050,"y":180,"wires":[]},{"id":"a1f3af64.0465a","type":"inject","z":"63ae84bb.e9d88c","name":"","topic":"","payload":"ТТ0002ТТ ","payloadType":"str","repeat":"","crontab":"","once":false,"x":192,"y":294,"wires":[["4d747ea1.cee81"]]},{"id":"1a12ea6.a8eee16","type":"http in","z":"63ae84bb.e9d88c","name":"","url":"/rfid","method":"post","swaggerDoc":"","x":140,"y":440,"wires":[["435f5e6.f4202a","c76ba87c.9f5298","93376d50.97a11"]]},{"id":"82dfbf02.9409b","type":"function","z":"63ae84bb.e9d88c","name":"приводиш до нормального формату","func":"msg.replay = true;\nflow.set(\"qr_code_2\", msg.payload.truck_id);\nreturn msg;","outputs":1,"noerr":0,"x":490,"y":480,"wires":[["9bb712e.9948cf","5406c53e.04635c","4149f16b.42148"]]},{"id":"4862f916.86cde8","type":"function","z":"59e54d37.cb5764","name":"","func":"delete msg.replay;\ndelete msg.statusCode;\ndelete msg.headers;\ndelete msg.responseUrl;\ndelete msg.req;\ndelete msg.res;\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":340,"wires":[["d351692b.efa278"]]},{"id":"5df6a287.8ba67c","type":"debug","z":"59e54d37.cb5764","name":"","active":true,"console":"false","complete":"true","x":430,"y":380,"wires":[]},{"id":"435f5e6.f4202a","type":"function","z":"63ae84bb.e9d88c","name":"check last qr code","func":"var last_qr = flow.get(\"qr_code_2\");\n//парсю джейсон  \"{\"truck_id\":\"300833B2DDD9014000000000\",\"device_id\":\"192.168.16.70\"}\"\n//var inDate = JSON.parse(msg.payload);\nvar inDate = msg.payload;\nvar qr = inDate.truck_id;\nvar len_qr = qr.length;\n\n//qr = qr.substring(0,len_qr - 1);\n\nmsg.qr = qr;\n\nif ((last_qr) && (last_qr !== qr)){\n    msg.stop = true;\n}else{\n    msg.stop = false;\n}\nmsg.payload = inDate;\nreturn msg;","outputs":1,"noerr":0,"x":410,"y":440,"wires":[["4d0ab7f2.2d9d18","3b1ffd2d.977322"]]},{"id":"4d0ab7f2.2d9d18","type":"switch","z":"63ae84bb.e9d88c","name":"","property":"stop","propertyType":"msg","rules":[{"t":"false"}],"checkall":"true","outputs":1,"x":590,"y":440,"wires":[["82dfbf02.9409b"]]},{"id":"5c6dfe36.8d137","type":"inject","z":"24fc6997.927b06","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":124,"y":214,"wires":[["f8fe5fa6.8e92b"]]},{"id":"18fc1a1d.229966","type":"template","z":"24fc6997.927b06","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<?xml version=\"1.0\"?>\n<ledscreens>\n    <ledscreen num=\"1\" strcount=\"1\">\n       <textstring color=\"clRed\" fontname=\"Arial\" fontsize=\"10\">{{payload.board_text}}</textstring>\n    </ledscreen>\n</ledscreens>","x":406,"y":214,"wires":[["831969a.3870598","24241f83.637ed"]]},{"id":"831969a.3870598","type":"debug","z":"24fc6997.927b06","name":"","active":true,"console":"false","complete":"true","x":556,"y":175,"wires":[]},{"id":"238c1467.5f94ec","type":"debug","z":"24fc6997.927b06","name":"","active":true,"console":"false","complete":"true","x":786,"y":214,"wires":[]},{"id":"f8fe5fa6.8e92b","type":"function","z":"24fc6997.927b06","name":"","func":"msg.headers = {};\nmsg.headers['content-type'] = 'application/xml';\n\ndelete msg.qr;\ndelete msg.stop;\ndelete msg.replay;\n\ndelete msg.statusCode;\nreturn msg;","outputs":1,"noerr":0,"x":266,"y":214,"wires":[["18fc1a1d.229966"]]},{"id":"e3a3a471.bf60b8","type":"inject","z":"24fc6997.927b06","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":136,"y":294,"wires":[["6c4183c.2d18d7c"]]},{"id":"6c4183c.2d18d7c","type":"function","z":"24fc6997.927b06","name":"","func":"msg.payload = '<?xml version=\"1.0\"?><ledscreens><ledscreen num=\"1\" strcount=\"2\"><textstring color=\"clRed\" fontname=\"Arial\" fontsize=\"10\">String 1</textstring><textstring color=\"clGreen\" fontname=\"Times New Roman\" fontsize=\"10\">String 2</textstring></ledscreen></ledscreens>';\nmsg.headers = {};\nmsg.headers['content-type'] = 'application/xml';\n\nreturn msg;","outputs":1,"noerr":0,"x":266,"y":294,"wires":[[]]},{"id":"24241f83.637ed","type":"http request","z":"24fc6997.927b06","name":"","method":"POST","ret":"txt","url":"192.168.16.9:5505","tls":"","x":579,"y":212,"wires":[["238c1467.5f94ec"]]},{"id":"2c729a1d.f8a716","type":"template","z":"24fc6997.927b06","name":"2 r","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<?xml version=\"1.0\"?>\n<ledscreens>\n    <ledscreen num=\"1\" strcount=\"2\">\n       <textstring color=\"clRed\" fontname=\"Arial\" fontsize=\"10\">{{payload.s1}}</textstring>\n       <textstring color=\"clGreen\" fontname=\"Times New Roman\" fontsize=\"10\">{{payload.s2}}</textstring>\n    </ledscreen>\n</ledscreens>","x":394,"y":291,"wires":[[]]},{"id":"a62cb4d6.dca948","type":"link in","z":"24fc6997.927b06","name":"send on board IN","links":["e3323615.687838"],"x":55,"y":120,"wires":[["8446d3b1.09a63"]]},{"id":"e3323615.687838","type":"link out","z":"59e54d37.cb5764","name":"send on board","links":["a62cb4d6.dca948"],"x":335,"y":420,"wires":[]},{"id":"8446d3b1.09a63","type":"debug","z":"24fc6997.927b06","name":"","active":true,"console":"false","complete":"false","x":240,"y":100,"wires":[]},{"id":"7b8a93a2.25513c","type":"comment","z":"63ae84bb.e9d88c","name":"Віртуальний зчитувач з 1С","info":"","x":140,"y":340,"wires":[]},{"id":"c76ba87c.9f5298","type":"debug","z":"63ae84bb.e9d88c","name":"","active":true,"console":"false","complete":"true","x":370,"y":400,"wires":[]},{"id":"5406c53e.04635c","type":"debug","z":"63ae84bb.e9d88c","name":"","active":true,"console":"false","complete":"true","x":630,"y":540,"wires":[]},{"id":"3b1ffd2d.977322","type":"debug","z":"63ae84bb.e9d88c","name":"","active":false,"console":"false","complete":"true","x":590,"y":400,"wires":[]},{"id":"93376d50.97a11","type":"http response","z":"63ae84bb.e9d88c","name":"","x":370,"y":360,"wires":[]},{"id":"5409d28a.bf700c","type":"http in","z":"63ae84bb.e9d88c","name":"","url":"/123","method":"get","swaggerDoc":"","x":270,"y":1180,"wires":[["a254a117.972c7"]]},{"id":"566f8507.b5c03c","type":"http response","z":"63ae84bb.e9d88c","name":"","x":650,"y":1180,"wires":[]},{"id":"7c0779a5.7d74f8","type":"file","z":"63ae84bb.e9d88c","name":"","filename":"info_rfid.txt","appendNewline":true,"createDir":true,"overwriteFile":"false","x":1250,"y":360,"wires":[]},{"id":"b5806303.4089","type":"function","z":"63ae84bb.e9d88c","name":"log req","func":"msg.payload = \"req ||\" + msg.payload + \"|| \" + new Date();\nreturn msg;","outputs":1,"noerr":0,"x":1090,"y":360,"wires":[["7c0779a5.7d74f8"]]},{"id":"e2a22cd4.83c9f","type":"inject","z":"63ae84bb.e9d88c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":900,"y":920,"wires":[["c297443a.85ddc8"]]},{"id":"c297443a.85ddc8","type":"file in","z":"63ae84bb.e9d88c","name":"","filename":"info_rfid.txt","format":"utf8","x":1050,"y":920,"wires":[["d3220bb4.21abf8"]]},{"id":"d3220bb4.21abf8","type":"debug","z":"63ae84bb.e9d88c","name":"","active":true,"console":"false","complete":"false","x":1230,"y":920,"wires":[]},{"id":"f74e94f4.a2ea18","type":"function","z":"63ae84bb.e9d88c","name":"log res ","func":"var res1C = JSON.parse(msg.payload);\nlet logs = \"\";\nif(msg.statusCode == 200){\n    msg.payload = JSON.parse(msg.payload);\n    let disp_text= msg.payload.disp_text;//дашборд\n\n    logs = disp_text + \"\";\n\n}else if(msg.statusCode != 200){\n    msg.payload = JSON.parse(msg.payload);\n    let shortErrorTable = msg.payload.КраткоеОписаниеОшибки;\n\n    logs = shortErrorTable + \"\";\n}\n\nmsg.payload = \"res ||   \" + logs + \"  ||  \" + new Date();\nreturn msg;","outputs":1,"noerr":0,"x":1010,"y":40,"wires":[["1967e86c.d2a378"]]},{"id":"1967e86c.d2a378","type":"file","z":"63ae84bb.e9d88c","name":"","filename":"info_rfid.txt","appendNewline":true,"createDir":true,"overwriteFile":"false","x":1190,"y":40,"wires":[]},{"id":"4149f16b.42148","type":"json","z":"63ae84bb.e9d88c","name":"","x":950,"y":360,"wires":[["b5806303.4089","b9c1662c.145918"]]},{"id":"b9c1662c.145918","type":"debug","z":"63ae84bb.e9d88c","name":"","active":true,"console":"false","complete":"true","x":1090,"y":440,"wires":[]},{"id":"8222defc.1a3f1","type":"inject","z":"63ae84bb.e9d88c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":900,"y":960,"wires":[["d0668578.b9ce38"]]},{"id":"d0668578.b9ce38","type":"file","z":"63ae84bb.e9d88c","name":"","filename":"info_rfid.txt","appendNewline":true,"createDir":true,"overwriteFile":"delete","x":1250,"y":960,"wires":[]},{"id":"f81cf404.3431b8","type":"inject","z":"63ae84bb.e9d88c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":640,"y":620,"wires":[["a9d96751.e8a778"]]},{"id":"a9d96751.e8a778","type":"function","z":"63ae84bb.e9d88c","name":"test","func":"msg.payload = {\n\t\"truck_id\": \"300833B2DDD9014000000000\",\n\t\"device_id\": \"192.168.16.70\"\n};\nmsg.replay = true;\nreturn msg;","outputs":1,"noerr":0,"x":790,"y":620,"wires":[["9bb712e.9948cf","4149f16b.42148"]]},{"id":"a254a117.972c7","type":"file in","z":"63ae84bb.e9d88c","name":"","filename":"info_rfid.txt","format":"utf8","x":490,"y":1180,"wires":[["566f8507.b5c03c"]]},{"id":"a4b7f943.361708","type":"comment","z":"63ae84bb.e9d88c","name":"Логування","info":"","x":880,"y":860,"wires":[]},{"id":"8c74121c.6d85d","type":"inject","z":"a1d936f0.8fd578","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":240,"y":400,"wires":[["253e7a54.895206"]]},{"id":"253e7a54.895206","type":"exec","z":"a1d936f0.8fd578","command":"date","addpay":false,"append":"","useSpawn":"","timer":"","name":"","x":385,"y":409.5,"wires":[["ad2c02d7.ebba8"],[],[]]}]
