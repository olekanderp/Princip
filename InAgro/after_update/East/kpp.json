[{"id":"5ed4ea1c.bb4e54","type":"tab","label":"QR Print"},{"id":"5153fb9b.53f564","type":"tab","label":"ТАбло Брутто"},{"id":"cf294ef.40e5bb","type":"tab","label":"processing_scale1"},{"id":"fb712b76.e247e8","type":"tab","label":"Дашборд Брутто"},{"id":"323f2f7b.e4073","type":"tab","label":"ТЕСТИ"},{"id":"575af3c7.2b8edc","type":"serial-port","z":"","serialport":"/dev/avto","serialbaud":"9600","databits":"8","parity":"none","stopbits":"1","newline":"500","bin":"false","out":"time","addchar":false},{"id":"ea09b784.95d748","type":"serial-port","z":"","serialport":"/dev/tablo","serialbaud":"9600","databits":"8","parity":"none","stopbits":"1","newline":"20","bin":"false","out":"time","addchar":false},{"id":"c7cb4205.fb9f5","type":"socket-io-event","z":"","addr":"getWeight"},{"id":"7e3d7011.f73a2","type":"socket-io-server","z":"","port":"4001"},{"id":"920b623a.7906c","type":"serial-port","z":"","serialport":"/dev/ttyACM0","serialbaud":"9600","databits":"8","parity":"none","stopbits":"1","newline":"50","bin":"false","out":"time","addchar":false},{"id":"baaf9648.806e88","type":"ui_group","z":"","name":"Вага","tab":"1be87e3d.e12cd2","order":1,"disp":true,"width":"4"},{"id":"114ac327.aafd0d","type":"ui_group","z":"","name":"Default","tab":"","disp":true,"width":"6"},{"id":"4dbe020b.62cb3c","type":"ui_group","z":"","name":"Статус","tab":"1be87e3d.e12cd2","order":2,"disp":true,"width":"7"},{"id":"1be87e3d.e12cd2","type":"ui_tab","z":"","name":"Prod","icon":"dashboard","order":2},{"id":"cd89c3fa.7bb48","type":"ui_group","z":"","name":"Данные","tab":"1be87e3d.e12cd2","order":4,"disp":true,"width":"8"},{"id":"b0e193fe.383bd","type":"ui_group","z":"","name":"Таймер","tab":"1be87e3d.e12cd2","order":3,"disp":true,"width":"5"},{"id":"d91eb3f5.f3a5f","type":"ui_group","z":"","name":"Данные транспортного средства","tab":"1be87e3d.e12cd2","order":6,"disp":true,"width":"9"},{"id":"a1c43702.bf17d8","type":"ui_group","z":"","name":"Текст","tab":"1be87e3d.e12cd2","order":5,"disp":true,"width":"9"},{"id":"7b287e47.9ec9d","type":"ui_group","z":"","name":"Інформація","tab":"f35f7b96.fa0e48","disp":true,"width":"16"},{"id":"f35f7b96.fa0e48","type":"ui_tab","z":"","name":"Prod","icon":"dashboard","order":1},{"id":"9072d49e.188e78","type":"comment","z":"5153fb9b.53f564","name":"Весова 2","info":"","x":98,"y":23,"wires":[]},{"id":"4eb1988b.09d438","type":"function","z":"fb712b76.e247e8","name":"Counter","func":"var count = flow.get(\"delay\");\n\ncount = count - 1;\n\nmsg.payload = count;\nflow.set(\"delay\", count);\n\nif(count === 0){\nflow.set(\"delay\", 30); \nflow.set(\"triger_route\", false);\nflow.set(\"status_code\", 0);\n\n\n}\nreturn msg;","outputs":1,"noerr":0,"x":140,"y":680,"wires":[["9a056cc0.2d3b","4aeb24e2.cca21c"]]},{"id":"6a4154cf.60982c","type":"inject","z":"fb712b76.e247e8","name":"","topic":"","payload":"","payloadType":"date","repeat":"1","crontab":"","once":false,"x":110,"y":600,"wires":[["638700be.e1a41"]]},{"id":"cf570956.616498","type":"function","z":"fb712b76.e247e8","name":"init","func":"flow.set(\"delay\", 30);\nflow.set(\"triger_route\", false);\nflow.set(\"status_code\", 0);\nreturn msg;","outputs":1,"noerr":0,"x":287,"y":26,"wires":[[]]},{"id":"1395b0ea.d3c75f","type":"inject","z":"fb712b76.e247e8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"x":134,"y":27,"wires":[["cf570956.616498"]]},{"id":"9dab2302.a586b","type":"function","z":"fb712b76.e247e8","name":"triger_route","func":"flow.set(\"triger_route\", true);//включив таймер\n\nif(msg.statusCode == 200){\n    msg.payload = JSON.parse(msg.payload);\n    let board_text= msg.payload.board_text;//зовнішнє табло\n    let disp_text= msg.payload.disp_text;//дашборд\n\n    msg.payload = {\n        disp_text:`<p class=\"disp_text\">${disp_text}</p>`,\n        board_text: board_text\n    };\n\n}else if(msg.statusCode != 200){\n    msg.payload = JSON.parse(msg.payload);\n    let errorTable = msg.payload.ТекстОшибкиТабло;\n    let shortErrorTable = msg.payload.КраткоеОписаниеОшибки;\n    let fullErrorTable = msg.payload.ПолноеОписаниеОшибки;\n    \n    msg.payload = {\n       disp_text:`<p class=\"fullerror_table\">${shortErrorTable}</p>`,\n       board_text: shortErrorTable\n    };\n} else {\n    msg.payload = {\n       disp_text: `<p class=\"default_error\">\"Ошибка сети, обратитесь к адмінистратору\"</p>`,\n       board_text: `Ошибка сети, обратитесь к адмінистратору`\n    };\n}\nreturn msg;\n/*\nРезультат.Вставить(\"ТекстОшибкиТабло\",\"\");\n  Результат.Вставить(\"КраткоеОписаниеОшибки\",\"\");\n  Результат.Вставить(\"ПолноеОписаниеОшибки\",\"\");\nякщо код 200: тоді така сама структура, як в sendOnBoard\n*/","outputs":1,"noerr":0,"x":150,"y":420,"wires":[["290502bf.c4212e","ffe039e0.446f98"]]},{"id":"9a056cc0.2d3b","type":"debug","z":"fb712b76.e247e8","name":"Counter","active":true,"console":"true","complete":"payload","x":550,"y":680,"wires":[]},{"id":"638700be.e1a41","type":"switch","z":"fb712b76.e247e8","name":"","property":"triger_route","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","outputs":1,"x":110,"y":640,"wires":[["4eb1988b.09d438"]]},{"id":"9a908110.8ad7b","type":"serial in","z":"cf294ef.40e5bb","name":"Сканер весов 2","serial":"920b623a.7906c","x":100,"y":180,"wires":[["278059.a12a9fa8","864e2bac.0bf508"]]},{"id":"adf64a5.fa0efb8","type":"http request","z":"cf294ef.40e5bb","name":"","method":"POST","ret":"txt","url":"http://192.168.5.50/east-ves/hs/PerimeterControl/api/SmartScales/GetWeigt","tls":"","x":810,"y":240,"wires":[["cc17cbeb.2674d8","74f0b865.0fd758"]]},{"id":"73d36876.26f2a8","type":"link in","z":"fb712b76.e247e8","name":"","links":["ef9bd34b.c16c5","e90b4c84.f8022"],"x":35,"y":420,"wires":[["9dab2302.a586b"]]},{"id":"f96bc9f4.facd98","type":"function","z":"fb712b76.e247e8","name":"check successful","func":"if(msg.statusCode == 200){\n    msg.payload = \"Данные успешно получены\";\n}\nreturn msg;","outputs":1,"noerr":0,"x":1030,"y":500,"wires":[["34e09db7.7294f2"]]},{"id":"bc0b711d.abc94","type":"link out","z":"fb712b76.e247e8","name":"блокування сканера","links":["63ce8818.b93b18"],"x":1335,"y":500,"wires":[]},{"id":"34e09db7.7294f2","type":"function","z":"fb712b76.e247e8","name":"block scaner","func":"if(msg.statusCode != 403){\n    msg.payload = 1;\n}\nreturn msg;\n","outputs":1,"noerr":0,"x":1210,"y":500,"wires":[["bc0b711d.abc94","bb1b8a32.d5f138"]]},{"id":"bb1b8a32.d5f138","type":"debug","z":"fb712b76.e247e8","name":"","active":false,"console":"false","complete":"true","x":1370,"y":540,"wires":[]},{"id":"f2d727a9.276a38","type":"inject","z":"323f2f7b.e4073","name":"","topic":"","payload":"Сканируйте пропуск","payloadType":"str","repeat":"","crontab":"","once":false,"x":126,"y":101,"wires":[["a0c222f9.d32fa"]]},{"id":"a0c222f9.d32fa","type":"function","z":"323f2f7b.e4073","name":"triger_route","func":"\n    flow.set(\"triger_route\", true);\n    msg.payload = {\n        task_id:\"Номер задачі: \" + 1234,\n        route_id:\"Номер Маршрута: \" + 1234234,\n        time_in:\"Время на поле: \" + 12414,\n        time_out:\"Время с поля: \" + 12421414\n   \n    };\n    msg.statusCode = 200;\n    return msg;\n    \n    \n    \n","outputs":1,"noerr":0,"x":319,"y":101,"wires":[[]]},{"id":"ff8f1bc.6c6a6e8","type":"debug","z":"323f2f7b.e4073","name":"","active":true,"console":"false","complete":"false","x":667,"y":102,"wires":[]},{"id":"49f0a6ce.f89288","type":"function","z":"323f2f7b.e4073","name":"triger_route","func":"\n    flow.set(\"triger_route\", true);\n    msg.payload = {\n\n        time_out:\"Время с поля: \" + 12421414\n   \n    };\n    msg.statusCode = 200;\n    return msg;\n    \n    \n    \n","outputs":1,"noerr":0,"x":359,"y":156,"wires":[[]]},{"id":"b11dda0.9ac1f28","type":"inject","z":"323f2f7b.e4073","name":"","topic":"","payload":"Сканируйте пропуск","payloadType":"str","repeat":"","crontab":"","once":false,"x":140,"y":178,"wires":[["49f0a6ce.f89288"]]},{"id":"29acdb3a.c1a654","type":"http in","z":"cf294ef.40e5bb","name":"","url":"/sendOnBoard","method":"post","swaggerDoc":"","x":170,"y":980,"wires":[["ed5ab5c7.cc5268","32f21ce1.1d1794","3514d9b7.dfe8a6","1d4d55d6.0a7e6a"]]},{"id":"ed5ab5c7.cc5268","type":"function","z":"cf294ef.40e5bb","name":"new","func":"flow.set(\"disp_text\", msg.payload.disp_text);\nflow.set(\"board_text\", msg.payload.board_text);\n//error message\nflow.set(\"ТекстОшибкиТабло\", msg.payload.ТекстОшибкиТабло);\nflow.set(\"КраткоеОписаниеОшибки\", msg.payload.КраткоеОписаниеОшибки);\nflow.set(\"ПолноеОписаниеОшибки\", msg.payload.ПолноеОписаниеОшибки);\nreturn msg;","outputs":1,"noerr":0,"x":410,"y":980,"wires":[["ef9bd34b.c16c5"]]},{"id":"32f21ce1.1d1794","type":"http response","z":"cf294ef.40e5bb","name":"","x":430,"y":880,"wires":[]},{"id":"ef9bd34b.c16c5","type":"link out","z":"cf294ef.40e5bb","name":"3 1c для табло","links":["73d36876.26f2a8"],"x":495,"y":980,"wires":[]},{"id":"8c885d9c.c820b","type":"debug","z":"cf294ef.40e5bb","name":"sendOnBoard","active":true,"console":"true","complete":"payload","x":560,"y":940,"wires":[]},{"id":"4aeb24e2.cca21c","type":"function","z":"fb712b76.e247e8","name":"Clear monitor","func":"if(msg.payload === 0){\n\nmsg.payload = {};\n    return msg;\n}\n\n","outputs":1,"noerr":0,"x":220,"y":720,"wires":[["7cbf3380.414dec","a7fd9c21.77ad","736c8f1c.c5427","ec3ad2df.7e838"]]},{"id":"7cbf3380.414dec","type":"function","z":"fb712b76.e247e8","name":"cleade date ","func":"msg.payload = \"\";\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":780,"wires":[[]]},{"id":"e90b4c84.f8022","type":"link out","z":"cf294ef.40e5bb","name":"ожидайте","links":["62c8aca.1d09b54","73d36876.26f2a8"],"x":1095,"y":240,"wires":[]},{"id":"278059.a12a9fa8","type":"debug","z":"cf294ef.40e5bb","name":"qr with scanner","active":true,"console":"true","complete":"payload","x":330,"y":120,"wires":[]},{"id":"864e2bac.0bf508","type":"delay","z":"cf294ef.40e5bb","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"5","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":180,"y":240,"wires":[["5d234331.792a0c"]]},{"id":"5ffc4b70.2c01a4","type":"inject","z":"323f2f7b.e4073","name":"","topic":"","payload":"2020-06-12T16:00:00Z","payloadType":"str","repeat":"","crontab":"","once":false,"x":140,"y":300,"wires":[["e0501179.e80a4"]]},{"id":"fc2bd66d.0f40e8","type":"debug","z":"323f2f7b.e4073","name":"","active":true,"console":"false","complete":"false","x":470,"y":260,"wires":[]},{"id":"e0501179.e80a4","type":"function","z":"323f2f7b.e4073","name":"","func":"var str_d = new Date(msg.payload);\nstr_d.toString();\n\n\n\nvar getFullYear = str_d.getFullYear();\nvar month = str_d.getMonth() + 1;\nvar getDate = str_d.getDate();\nvar getHours = str_d.getHours();\nvar getMinutes = str_d.getMinutes();\n\n\n\nmsg.payload = {\n    month: str_d.getMonth() + 1,\n    getFullYear: getFullYear,\n    getDate:getDate\n}\n\n\nvar date = getFullYear + \".\" + month + \".\" + getDate + \" \" + getHours + \":\" + getMinutes;\nmsg.payload = date;\nreturn msg;","outputs":1,"noerr":0,"x":290,"y":260,"wires":[["fc2bd66d.0f40e8"]]},{"id":"a7fd9c21.77ad","type":"debug","z":"fb712b76.e247e8","name":"Clear monitor","active":true,"console":"true","complete":"payload","x":560,"y":780,"wires":[]},{"id":"a8dbe0f3.b5769","type":"link in","z":"cf294ef.40e5bb","name":"очитска перемених","links":["736c8f1c.c5427"],"x":55,"y":440,"wires":[["36b98067.d6202"]]},{"id":"a3b168be.1bb6c8","type":"function","z":"cf294ef.40e5bb","name":"clear r,t,q","func":"flow.set(\"route_id\", \"\");\nflow.set(\"tusk_number\", \"\");\nflow.set(\"qr_code\", \"\");\nflow.set(\"route_uat_guid\", \"\");\nflow.set(\"recipient_guid\", \"\");\nflow.set(\"nomenclature_guid\",\"\");\n\nflow.set(\"time_in\", \"\");\nflow.set(\"time_out\", \"\");\nflow.set(\"plant_id\", \"\");\n\n\n//нові змінні\n\nflow.set(\"disp_text\", \"\");\nflow.set(\"board_text\", \"\");\n//error message\nflow.set(\"ТекстОшибкиТабло\", \"\");\nflow.set(\"КраткоеОписаниеОшибки\", \"\");\nflow.set(\"ПолноеОписаниеОшибки\", \"\");\nflow.set(\"qr_code_2\",\"\");\nreturn msg;\n","outputs":1,"noerr":0,"x":460,"y":440,"wires":[[]]},{"id":"736c8f1c.c5427","type":"link out","z":"fb712b76.e247e8","name":"","links":["a8dbe0f3.b5769"],"x":1215,"y":720,"wires":[]},{"id":"36b98067.d6202","type":"function","z":"cf294ef.40e5bb","name":"send 1C","func":"var qr = flow.get(\"qr_code\");\nvar task_id = flow.get(\"tusk_number\");\nmsg.payload = {\n    truck_id:qr,\n    weight:0,\n    stable: true,\n    device_id:\"barcode3\",\n    route_id: 0,\n    task_id:0\n};\nmsg.replay = false;\nreturn msg;","outputs":1,"noerr":0,"x":160,"y":440,"wires":[["e6613d4a.533d2","ed909e20.d4f84","929fbabe.2c2a58"]]},{"id":"e6613d4a.533d2","type":"delay","z":"cf294ef.40e5bb","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":320,"y":440,"wires":[["a3b168be.1bb6c8"]]},{"id":"883476b2.401508","type":"function","z":"323f2f7b.e4073","name":"send 1C","func":"var to_do_route_uat_guid = flow.get(\"to_first\");\n\n\nvar qr = msg.payload.qr;\n\nvar route_id = msg.payload.route_id;\nvar task_id = msg.payload.task_id;\nvar route_uat_guid = msg.payload.route_uat_guid;\n//if(qr != global.get(\"qr_code\")){\n//   route_id = null ;\n//   task_id = null;\n//}\n\n\n    if(to_do_route_uat_guid === false){\n          msg.payload = {\n            truck_id:qr,\n            weight:flow.get(\"weight_qr\"),\n            stable: true,\n            device_id:\"barcode2\",\n            route_id: route_id,\n            task_id:task_id\n          }  \n          flow.set(\"to_first\", true);\n    }else if(to_do_route_uat_guid === true){\n        msg.payload = {\n            truck_id:qr,\n            weight:flow.get(\"weight_qr\"),\n            stable: true,\n            device_id:\"barcode2\",\n            route_id: route_id,\n            task_id:task_id,\n            route_uat_guid: route_uat_guid\n            } \n            flow.set(\"to_first\", false);\n  \n    }\n\n\n\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":468,"y":390,"wires":[["3911317e.8f609e"]]},{"id":"6d1b2c91.8ad4b4","type":"inject","z":"323f2f7b.e4073","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":97,"y":377,"wires":[["e3eb7400.439918"]]},{"id":"e3eb7400.439918","type":"function","z":"323f2f7b.e4073","name":"","func":"msg.payload = {\n    truck_id:1234,\n    weight:123,\n    stable: true,\n    device_id:\"barcode2\",\n    route_id: 11234,\n    task_id:121234,\n    route_uat_guid: \"route_uat_guid\",\n    qr:\"Fd45455\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":230,"y":395,"wires":[["883476b2.401508","5deee5c9.d9086c"]]},{"id":"5deee5c9.d9086c","type":"debug","z":"323f2f7b.e4073","name":"","active":true,"console":"false","complete":"false","x":388,"y":336,"wires":[]},{"id":"3911317e.8f609e","type":"debug","z":"323f2f7b.e4073","name":"","active":true,"console":"false","complete":"false","x":631,"y":389,"wires":[]},{"id":"bec59f37.3cdf7","type":"inject","z":"323f2f7b.e4073","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":149,"y":498,"wires":[["18f854d9.fa919b"]]},{"id":"18f854d9.fa919b","type":"function","z":"323f2f7b.e4073","name":"","func":"flow.set(\"to_first\", false);\nreturn msg;","outputs":1,"noerr":0,"x":282,"y":516,"wires":[[]]},{"id":"5ae92803.ad8f48","type":"inject","z":"cf294ef.40e5bb","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"x":110,"y":40,"wires":[["fd533778.c57a28"]]},{"id":"fd533778.c57a28","type":"function","z":"cf294ef.40e5bb","name":"to_first","func":"flow.set(\"to_first\", false);\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":40,"wires":[[]]},{"id":"cc17cbeb.2674d8","type":"function","z":"cf294ef.40e5bb","name":"","func":"var replat = msg.replay;\nif(replat === true){\n\nreturn msg;\n}","outputs":1,"noerr":0,"x":970,"y":240,"wires":[["e90b4c84.f8022","8c18e498.488378"]]},{"id":"8c18e498.488378","type":"debug","z":"cf294ef.40e5bb","name":"","active":true,"console":"false","complete":"payload","x":1150,"y":280,"wires":[]},{"id":"5d234331.792a0c","type":"function","z":"cf294ef.40e5bb","name":"check last qr code","func":"var last_qr = flow.get(\"qr_code\");\nvar qr = msg.payload;\nvar len_qr = qr.length;\n\nqr = qr.substring(0,len_qr - 1);\n\nmsg.qr = qr;\n\nif ((last_qr) && (last_qr !== qr)){\n    msg.stop = true;\n}else{\n    msg.stop = false;\n}\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":240,"wires":[["3e96691b.bc9686"]]},{"id":"3e96691b.bc9686","type":"switch","z":"cf294ef.40e5bb","name":"","property":"stop","propertyType":"msg","rules":[{"t":"false"}],"checkall":"true","outputs":1,"x":530,"y":240,"wires":[["701728e3.55acd8"]]},{"id":"701728e3.55acd8","type":"function","z":"cf294ef.40e5bb","name":"send 1C","func":"msg.payload = {\n    truck_id:msg.qr,\n    device_id:\"barcode3\",\n    //device_id: msg.payload.device_id \n};\nmsg.replay = true;\nflow.set(\"qr_code\", msg.qr);\nreturn msg;","outputs":1,"noerr":0,"x":660,"y":240,"wires":[["adf64a5.fa0efb8","676af77.62bf608"]]},{"id":"a745795a.f2d038","type":"debug","z":"cf294ef.40e5bb","name":"send 1C","active":false,"console":"true","complete":"payload","x":930,"y":320,"wires":[]},{"id":"4aece957.97d608","type":"inject","z":"cf294ef.40e5bb","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"x":310,"y":400,"wires":[["a3b168be.1bb6c8"]]},{"id":"d8c4deaa.6a927","type":"http in","z":"5ed4ea1c.bb4e54","name":"","url":"/sendToPrinter","method":"post","swaggerDoc":"","x":203,"y":110.71430206298828,"wires":[["cc052495.1823b8","463b0559.d40f7c","7616523e.375a4c","d2c11d97.fb211"]]},{"id":"ab72f82c.c59368","type":"function","z":"5ed4ea1c.bb4e54","name":"query params","func":"//var pdf = msg.payload.pdf;\n//msg.payload = new Buffer(pdf);\n//msg.payload = pdf;\nmsg.filename     = \"/distr/data/print\"+\".pdf\";\n\nreturn msg;","outputs":1,"noerr":0,"x":537.2857208251953,"y":112.28573036193848,"wires":[["40304718.7917e8","7d7677cf.671e08"]]},{"id":"40304718.7917e8","type":"file","z":"5ed4ea1c.bb4e54","name":"","filename":"","appendNewline":true,"createDir":false,"overwriteFile":"true","x":708.8571243286133,"y":114.14292526245117,"wires":[]},{"id":"cc052495.1823b8","type":"debug","z":"5ed4ea1c.bb4e54","name":"","active":false,"console":"false","complete":"true","x":499,"y":157.85712432861328,"wires":[]},{"id":"463b0559.d40f7c","type":"http response","z":"5ed4ea1c.bb4e54","name":"","x":503.1428527832031,"y":77,"wires":[]},{"id":"7d7677cf.671e08","type":"debug","z":"5ed4ea1c.bb4e54","name":"","active":false,"console":"false","complete":"true","x":692,"y":160.71430206298828,"wires":[]},{"id":"8a44054a.045708","type":"inject","z":"5ed4ea1c.bb4e54","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":204,"y":294.7143020629883,"wires":[["ea151046.d52b8"]]},{"id":"52adff68.6e9a2","type":"debug","z":"5ed4ea1c.bb4e54","name":"","active":false,"console":"false","complete":"false","x":504,"y":281.7143020629883,"wires":[]},{"id":"ea151046.d52b8","type":"exec","z":"5ed4ea1c.bb4e54","command":"ls data","addpay":false,"append":"","useSpawn":"","timer":"","name":"","x":349,"y":304.2143020629883,"wires":[["52adff68.6e9a2"],[],[]]},{"id":"7616523e.375a4c","type":"base64","z":"5ed4ea1c.bb4e54","name":"","action":"","property":"payload","x":372,"y":206.71430206298828,"wires":[["c722db83.ca0968","ab72f82c.c59368"]]},{"id":"c722db83.ca0968","type":"debug","z":"5ed4ea1c.bb4e54","name":"","active":false,"console":"false","complete":"true","x":505,"y":202.71430206298828,"wires":[]},{"id":"676af77.62bf608","type":"json","z":"cf294ef.40e5bb","name":"","x":790,"y":320,"wires":[["a745795a.f2d038"]]},{"id":"5c8391b0.de5b8","type":"debug","z":"cf294ef.40e5bb","name":"Обнулення","active":false,"console":"true","complete":"payload","x":460,"y":480,"wires":[]},{"id":"3514d9b7.dfe8a6","type":"json","z":"cf294ef.40e5bb","name":"","x":410,"y":940,"wires":[["8c885d9c.c820b"]]},{"id":"ed909e20.d4f84","type":"json","z":"cf294ef.40e5bb","name":"","x":310,"y":480,"wires":[["5c8391b0.de5b8"]]},{"id":"8f6592de.4083b","type":"debug","z":"5ed4ea1c.bb4e54","name":"sendToPrinter","active":false,"console":"true","complete":"payload","x":522,"y":27,"wires":[]},{"id":"d2c11d97.fb211","type":"function","z":"5ed4ea1c.bb4e54","name":"get pdf","func":"msg.payload = \"get pdf\";\nreturn msg;","outputs":1,"noerr":0,"x":335,"y":25,"wires":[["8f6592de.4083b"]]},{"id":"74f0b865.0fd758","type":"function","z":"cf294ef.40e5bb","name":"parse res","func":"var text = msg.payload;\n\nmsg.payload = {\n    textz: text,\n    qr:msg.qr,\n    statusCode:msg.statusCode,\n    \n};\n\n//delete msg.payload;\ndelete msg.qr;\ndelete msg.statusCode;\ndelete msg.headers;\ndelete msg.responseUrl;\ndelete msg._msgid;\n\nreturn msg;","outputs":1,"noerr":0,"x":840,"y":180,"wires":[["7d544561.90402c"]]},{"id":"5f695abc.4e76d4","type":"debug","z":"cf294ef.40e5bb","name":"res 1C","active":false,"console":"true","complete":"payload","x":1100,"y":180,"wires":[]},{"id":"7d544561.90402c","type":"json","z":"cf294ef.40e5bb","name":"","x":970,"y":180,"wires":[["5f695abc.4e76d4"]]},{"id":"1d4d55d6.0a7e6a","type":"debug","z":"cf294ef.40e5bb","name":"sendOnBoard","active":true,"console":"true","complete":"payload","x":440,"y":1020,"wires":[]},{"id":"b4f741a3.ef263","type":"http in","z":"cf294ef.40e5bb","name":"","url":"/rfid","method":"post","swaggerDoc":"","x":160,"y":680,"wires":[["870b546a.7201c8","69c468b.519e898","b12a5fac.d8398"]]},{"id":"7f77ae94.b02bd","type":"function","z":"cf294ef.40e5bb","name":"приводиш до нормального формату","func":"msg.replay = true;\nflow.set(\"qr_code_2\", msg.payload.truck_id);\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":720,"wires":[["d0eb2100.a1e5b","adf64a5.fa0efb8"]]},{"id":"870b546a.7201c8","type":"function","z":"cf294ef.40e5bb","name":"check last qr code","func":"var last_qr = flow.get(\"qr_code_2\");\n//парсю джейсон  \"{\"truck_id\":\"300833B2DDD9014000000000\",\"device_id\":\"192.168.16.70\"}\"\nvar inDate = JSON.parse(msg.payload);\nvar qr = inDate.truck_id;\nvar len_qr = qr.length;\n\n//qr = qr.substring(0,len_qr - 1);\n\nmsg.qr = qr;\n\nif ((last_qr) && (last_qr !== qr)){\n    msg.stop = true;\n}else{\n    msg.stop = false;\n}\nmsg.payload = inDate;\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":680,"wires":[["15fe5da7.948e12","b785fcc4.2e5a8"]]},{"id":"15fe5da7.948e12","type":"switch","z":"cf294ef.40e5bb","name":"","property":"stop","propertyType":"msg","rules":[{"t":"false"}],"checkall":"true","outputs":1,"x":610,"y":680,"wires":[["7f77ae94.b02bd"]]},{"id":"564e278a.208048","type":"comment","z":"cf294ef.40e5bb","name":"Віртуальний зчитувач з 1С","info":"","x":160,"y":580,"wires":[]},{"id":"69c468b.519e898","type":"debug","z":"cf294ef.40e5bb","name":"","active":true,"console":"false","complete":"true","x":390,"y":640,"wires":[]},{"id":"d0eb2100.a1e5b","type":"debug","z":"cf294ef.40e5bb","name":"","active":true,"console":"false","complete":"true","x":650,"y":780,"wires":[]},{"id":"b785fcc4.2e5a8","type":"debug","z":"cf294ef.40e5bb","name":"","active":false,"console":"false","complete":"true","x":610,"y":640,"wires":[]},{"id":"b12a5fac.d8398","type":"http response","z":"cf294ef.40e5bb","name":"","x":390,"y":600,"wires":[]},{"id":"99ccff21.6f7e6","type":"function","z":"cf294ef.40e5bb","name":"clear r,t,q old","func":"flow.set(\"route_id\", \"\");\nflow.set(\"tusk_number\", \"\");\nflow.set(\"qr_code\", \"\");\nflow.set(\"route_uat_guid\", \"\");\nflow.set(\"recipient_guid\", \"\");\nflow.set(\"nomenclature_guid\",\"\");\n\n\nflow.set(\"time_in\", \"\");\nflow.set(\"time_out\", \"\");\nflow.set(\"plant_id\", \"\");\nreturn msg;\n","outputs":1,"noerr":0,"x":470,"y":400,"wires":[[]]},{"id":"8098c54.561c538","type":"function","z":"cf294ef.40e5bb","name":"send 1C old","func":"var task_id = flow.get(\"tusk_number\");\nvar route_id = flow.get(\"route_id\");\nvar route_uat_guid = flow.get(\"route_uat_guid\");\nvar nomenclature_guid = flow.get(\"nomenclature_guid\");\nvar recipient_guid = flow.get(\"recipient_guid\");\nvar time_in = flow.get(\"time_in\");\nvar time_out = flow.get(\"time_out\");\nvar plant_id = flow.get(\"plant_id\");\n\nmsg.payload = {\n    truck_id:msg.qr,\n    weight:flow.get(\"weight_qr\"),\n    stable: true,\n    device_id:\"barcode3\",\n    route_id: route_id,\n    task_id:task_id,\n    route_uat_guid:route_uat_guid,\n    recipient_guid: recipient_guid,\n    nomenclature_guid:nomenclature_guid,\n    time_in: time_in,\n    time_out: time_out,\n    plant_id: plant_id\n};\nmsg.replay = true;\nflow.set(\"qr_code\", msg.qr);\nreturn msg;","outputs":1,"noerr":0,"x":670,"y":200,"wires":[[]]},{"id":"ba230852.6e4958","type":"function","z":"cf294ef.40e5bb","name":"old","func":"flow.set(\"tusk_number\", msg.payload.task_id);\nflow.set(\"route_id\", msg.payload.route_id);\nflow.set(\"route_uat_guid\", msg.payload.route_uat_guid);\nflow.set(\"recipient_guid\", msg.payload.recipient_guid);\nflow.set(\"nomenclature_guid\", msg.payload.nomenclature_guid);\n\n\nflow.set(\"time_in\", msg.payload.time_in);\nflow.set(\"time_out\", msg.payload.time_out);\nflow.set(\"plant_id\", msg.payload.plant_id);\nreturn msg;","outputs":1,"noerr":0,"x":170,"y":940,"wires":[[]]},{"id":"929fbabe.2c2a58","type":"function","z":"cf294ef.40e5bb","name":"send 1C","func":"var qr = flow.get(\"qr_code\");\nvar task_id = flow.get(\"tusk_number\");\nmsg.payload = {\n    truck_id:qr,\n    weight:0,\n    stable: true,\n    device_id:\"barcode3\",\n    route_id: 0,\n    task_id:0\n};\nmsg.replay = false;\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":320,"wires":[[]]},{"id":"51501738.8e7288","type":"comment","z":"cf294ef.40e5bb","name":"Отримаєм з 1С","info":"","x":120,"y":900,"wires":[]},{"id":"be508e0e.f6cd2","type":"function","z":"fb712b76.e247e8","name":"triger_route old","func":"function formatDate(date) {\n    var d = new Date(date),\n        month = '' + (d.getMonth() + 1),\n        day = '' + d.getDate(),\n        year = d.getFullYear(),\n        hours = d.getHours(),\n        minutes= d.getMinutes();\n        \n\n    if (month.length < 2) \n        month = '0' + month;\n    if (day.length < 2) \n        day = '0' + day;\n    if (hours.length < 2) \n        hours = '0' + hours;\n    if (minutes.length < 2) \n        minutes = '0' + minutes;\n    \n\n    return [day,month,year].join('-')+\" \"+hours+\":0\"+minutes;\n}\n\nvar message_type = msg.payload.message_type;//1 коротке 2 довге\n\n    if(message_type == 1){\n        flow.set(\"triger_route\", true);\n        \n        var task_id = msg.payload.task_id;\n        var route_id = msg.payload.route_id;\n        \n        var time_in  = new Date(msg.payload.time_in);\n        var time_out = new Date(msg.payload.time_out);\n        \n        var typeof_time_in = typeof(msg.payload.time_in);\n        var typeof_time_out = typeof(msg.payload.time_out);\n        \n        \n        if(typeof_time_in == \"string\"){\n           time_in =  msg.payload.time_in;\n        }else{\n           time_in = formatDate(time_in); \n        }\n        if(typeof_time_out == \"string\"){\n           time_out =  msg.payload.time_out;\n        }else{\n            time_out = formatDate(time_out) \n        }\n//            time_in:\"Время на поле: \" + formatDate(time_in),\n//\n        \n        \n        \n        var driver_1 = msg.payload.driver;\n        var driver_id_1 = msg.payload.driver_id;\n        var truck1_1 = msg.payload.truck1;\n        var truck2_1 = msg.payload.truck2;\n        var contractor_1 = msg.payload.contractor;\n        var text_1 = msg.payload.text;\n        //var upload_point = msg.payload.upload_point;\n        var route_name = msg.payload.route_name;\n        flow.set(\"route_id\", route_id);\n        flow.set(\"task_id\", task_id);\n        \n        msg.statusCode = 200;\n        \n        msg.payload = {\n            task_id:\"Номер задачі: \" + task_id,\n            route_id:\"Маршрут: \" + route_name,\n            time_in:\"Время на поле: \" + time_in,\n            time_out:\"Время с поля: \" + \"\"+time_out,\n            truck1:\"Автомобиль: \" + truck1_1,\n            truck2:\"Прицеп: \" + truck2_1,\n            driver:\"Водитель: \" + driver_1,\n            driver_id:\"Номер удостоверения: \" + driver_id_1,\n            contractor:\"Контрагент получатель груза: \" + contractor_1,\n            text: text_1\n        };\n        \n        delete msg.res;\n        delete msg.req;\n        //flow.set(\"delay\", 60);\n        return msg;\n    }else if(message_type == 2){\n        flow.set(\"triger_route\", true);\n        \n        var weight = msg.payload.weight;\n        var truck1 = msg.payload.truck1;\n        var truck2 = msg.payload.truck2;\n        var driver = msg.payload.driver;\n        var driver_id = msg.payload.driver_id;\n        var route = msg.payload.route;\n        var contractor = msg.payload.contractor;\n        var weight_delta = msg.payload.weight_delta;\n        var route_id_two = flow.get(\"route_id\");\n        var task_id_two = flow.get(\"task_id\");\n        var text = msg.payload.text;\n        msg.statusCode = 200;\n        \n        msg.payload = {\n        weight:\"Вес: \" + weight,\n        truck1:\"Автомобиль: \" + truck1,\n        truck2:\"Прицеп: \" + truck2,\n        driver:\"Водитель: \" + driver,\n        driver_id:\"Номер удостоверения: \" + driver_id,\n        route:\"Маршрут: \" + route,\n        contractor:\"Контрагент получатель груза: \" + contractor,\n        weight_delta:\"Отклонение: \" + weight_delta,\n        route_id:\"Номер маршрута: \" + route_id_two,\n        task_id: \"Номер задачі: \" + task_id_two,\n        text: msg.payload.text\n        };\n        \n        \n        delete msg.res;\n        delete msg.req;\n        return msg;\n    }else if(message_type == 3){\n        flow.set(\"triger_route\", true);\n        \n        var weight = msg.payload.weight;\n        var truck1 = msg.payload.truck1;\n        var truck2 = msg.payload.truck2;\n        var driver = msg.payload.driver;\n        var driver_id = msg.payload.driver_id;\n        var route = msg.payload.route;\n        var contractor = msg.payload.contractor;\n        var weight_delta = msg.payload.weight_delta;\n        var route_id_two = msg.payload.task_id;\n        var task_id_two = msg.payload.route_id;\n        var text = msg.payload.text;\n        msg.statusCode = 200;\n        \n        msg.payload = {\n        weight:\"Вес: \" + weight,\n        truck1:\"Автомобиль: \" + truck1,\n        truck2:\"Прицеп: \" + truck2,\n        driver:\"Водитель: \" + driver,\n        driver_id:\"Номер удостоверения: \" + driver_id,\n        route:\"Маршрут: \" + route,\n        contractor:\"Контрагент получатель груза: \" + contractor,\n        weight_delta:\"Отклонение: \" + weight_delta,\n        //route_id:\"Номер маршрута: \" + route_id_two,\n        //task_id: \"Номер задачі: \" + task_id_two,\n        text:text\n        }\n        \n        \n        delete msg.res;\n        delete msg.req;\n        return msg;\n    }else if(msg.statusCode != 200){\n        flow.set(\"triger_route\", true);\n        flow.set(\"respons_scan_send\", msg.payload);\n        \n        /*msg.payload.time_out = \"\";\n        msg.payload.truck_id = \"\";\n        msg.payload.route_id = \"\";\n        msg.payload.time_in = \"\";\n        msg.payload.weight=\"\";\n        msg.payload.truck1=\"\";\n        msg.payload.truck2=\"\" ;\n        msg.payload.driver=\"\";\n        msg.payload.driver_id=\"\";\n        msg.payload.route=\"\";\n        msg.payload.contractor=\"\";\n        msg.payload.weight_delta=\"\";\n        */\n        msg.statusCode = 403;\n        delete msg.res;\n        delete msg.req;\n        return msg;\n    }\n","outputs":1,"noerr":0,"x":760,"y":500,"wires":[["f96bc9f4.facd98"]]},{"id":"36e4cf80.5341c","type":"inject","z":"fb712b76.e247e8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"x":130,"y":120,"wires":[["dcf96432.a86aa8"]]},{"id":"dcf96432.a86aa8","type":"function","z":"fb712b76.e247e8","name":"Сканируйте пропуск","func":"msg.payload = {\n    disp_text: `<p class=\"blink\" align=\"center\">Сканируйте пропуск</p>`\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":120,"wires":[["aa8ace81.83971"]]},{"id":"aa8ace81.83971","type":"ui_template","z":"fb712b76.e247e8","group":"7b287e47.9ec9d","name":"","order":0,"width":"16","height":"9","format":"<style>\n   .blink {\n    animation: blink 2s infinite; /* Параметры анимации */\n    color: red;\n    font-size: 250%;\n   }\n   @keyframes blink {\n    from { opacity: 1; /* Непрозрачный текст */ }\n    to { opacity: 0; /* Прозрачный текст */ }\n   }\n   /* Нормальная інформация */\n   .disp_text {\n    font-size: 150%;    \n   }\n   /* Ошибка */\n   .fullerror_table {\n    color: red;\n    font-size: 150%;    \n   }\n   \n   \n</style>\n\n\n\n\n\n<div ng-bind-html=\"msg.payload.disp_text\"></div>","storeOutMessages":true,"fwdInMessages":true,"x":660,"y":120,"wires":[[]]},{"id":"290502bf.c4212e","type":"function","z":"fb712b76.e247e8","name":"","func":"delete msg.replay;\ndelete msg.statusCode;\ndelete msg.headers;\ndelete msg.responseUrl;\ndelete msg.req;\ndelete msg.res;\nreturn msg;","outputs":1,"noerr":0,"x":410,"y":320,"wires":[["aa8ace81.83971"]]},{"id":"ec3ad2df.7e838","type":"function","z":"fb712b76.e247e8","name":"cleade date ","func":"msg.payload = {\n        disp_text:`<p class=\"blink\" align=\"center\">Сканируйте пропуск</p>`,\n        board_text: \"\"\n    };\nreturn msg;","outputs":1,"noerr":0,"x":290,"y":840,"wires":[["aa8ace81.83971"]]},{"id":"f9863cd6.79cf1","type":"inject","z":"cf294ef.40e5bb","name":"","topic":"","payload":"TT0002 ","payloadType":"str","repeat":"","crontab":"","once":false,"x":90,"y":320,"wires":[["864e2bac.0bf508"]]},{"id":"a74f3fb4.0227","type":"inject","z":"5153fb9b.53f564","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":140,"y":240,"wires":[["1e930791.a47908"]]},{"id":"9fa1ada3.a2775","type":"template","z":"5153fb9b.53f564","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<?xml version=\"1.0\"?>\n<ledscreens>\n    <ledscreen num=\"1\" strcount=\"1\">\n       <textstring color=\"clRed\" fontname=\"Arial\" fontsize=\"10\">{{payload.board_text}}</textstring>\n    </ledscreen>\n</ledscreens>","x":422,"y":240,"wires":[["19e55c42.fdbea4","e19be113.45eaa"]]},{"id":"19e55c42.fdbea4","type":"debug","z":"5153fb9b.53f564","name":"","active":true,"console":"false","complete":"true","x":572,"y":201,"wires":[]},{"id":"cf17b692.d6f0e8","type":"debug","z":"5153fb9b.53f564","name":"","active":true,"console":"false","complete":"true","x":802,"y":240,"wires":[]},{"id":"1e930791.a47908","type":"function","z":"5153fb9b.53f564","name":"","func":"msg.headers = {};\nmsg.headers['content-type'] = 'application/xml';\n\ndelete msg.qr;\ndelete msg.stop;\ndelete msg.replay;\n\ndelete msg.statusCode;\nreturn msg;","outputs":1,"noerr":0,"x":282,"y":240,"wires":[["9fa1ada3.a2775"]]},{"id":"90688a84.483df8","type":"inject","z":"5153fb9b.53f564","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":152,"y":320,"wires":[["f8609ced.3e4ca"]]},{"id":"f8609ced.3e4ca","type":"function","z":"5153fb9b.53f564","name":"","func":"msg.payload = '<?xml version=\"1.0\"?><ledscreens><ledscreen num=\"1\" strcount=\"2\"><textstring color=\"clRed\" fontname=\"Arial\" fontsize=\"10\">String 1</textstring><textstring color=\"clGreen\" fontname=\"Times New Roman\" fontsize=\"10\">String 2</textstring></ledscreen></ledscreens>';\nmsg.headers = {};\nmsg.headers['content-type'] = 'application/xml';\n\nreturn msg;","outputs":1,"noerr":0,"x":282,"y":320,"wires":[[]]},{"id":"e19be113.45eaa","type":"http request","z":"5153fb9b.53f564","name":"","method":"POST","ret":"txt","url":"192.168.5.25:5505","tls":"","x":595,"y":238,"wires":[["cf17b692.d6f0e8"]]},{"id":"1cce160b.4e004a","type":"template","z":"5153fb9b.53f564","name":"2 r","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<?xml version=\"1.0\"?>\n<ledscreens>\n    <ledscreen num=\"1\" strcount=\"2\">\n       <textstring color=\"clRed\" fontname=\"Arial\" fontsize=\"10\">{{payload.s1}}</textstring>\n       <textstring color=\"clGreen\" fontname=\"Times New Roman\" fontsize=\"10\">{{payload.s2}}</textstring>\n    </ledscreen>\n</ledscreens>","x":410,"y":317,"wires":[[]]},{"id":"ebde422d.2bb8f","type":"link in","z":"5153fb9b.53f564","name":"send on board IN","links":["e3323615.687838","ffe039e0.446f98"],"x":71,"y":146,"wires":[["f8abae1f.7e576","1e930791.a47908"]]},{"id":"f8abae1f.7e576","type":"debug","z":"5153fb9b.53f564","name":"","active":true,"console":"false","complete":"false","x":256,"y":126,"wires":[]},{"id":"ffe039e0.446f98","type":"link out","z":"fb712b76.e247e8","name":"send on board","links":["ebde422d.2bb8f"],"x":275,"y":320,"wires":[]}]
